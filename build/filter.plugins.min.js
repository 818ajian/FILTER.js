/**
*
*   FILTER.js Plugins
*   @version: 0.9.6
*   @dependencies: Filter.js
*
*   JavaScript Image Processing Library (Plugins)
*   https://github.com/foo123/FILTER.js
*
**/!function(e,n){"use strict";"object"==typeof module&&module.exports?module.exports=n.call(e,module.$deps&&module.$deps.FILTER||require("./FILTER".toLowerCase())):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified("FILTER_PLUGINS")?define("FILTER_PLUGINS",["module","FILTER"],function(r,t){return n.moduleUri=r.uri,n.call(e,t),t}):(n.call(e,e.FILTER)||1)&&"function"==typeof define&&define.amd&&define(function(){return e.FILTER})}(this,function e(n){"use strict";var r=n.getPath(e.moduleUri);return!function(e){var n=e._notSupportClamp;e.Create({name:"NoiseFilter",min:-127,max:127,init:function(e,n){var r=this;r.min=e||-127,r.max=n||127},path:r,serialize:function(){var e=this;return{min:e.min,max:e.max}},unserialize:function(e){var n=this;return n.min=e.min,n.max=e.max,n},apply:function(r,t,a){var i,o,l,s,c,u,f,h,d=this,p=e.Util.Math.random,y=d.max-d.min,m=d.min,v=r.length;if(n)for(i=0;v>i;i+=4)l=r[i],s=r[i+1],c=r[i+2],o=y*p()+m,u=l+o,f=s+o,h=c+o,0>u?u=0:u>255&&(u=255),0>f?f=0:f>255&&(f=255),0>h?h=0:h>255&&(h=255),r[i]=0|u,r[i+1]=0|f,r[i+2]=0|h;else for(i=0;v>i;i+=4)l=r[i],s=r[i+1],c=r[i+2],o=y*p()+m,u=l+o,f=s+o,h=c+o,r[i]=0|u,r[i+1]=0|f,r[i+2]=0|h;return r}})}(n),!function(e){var n=e.MODE;e.Create({name:"PerlinNoiseFilter",mode:n.GRAY,_baseX:1,_baseY:1,_octaves:1,_offsets:null,_seed:0,_stitch:!1,_fractal:!0,_perlin:!1,path:r,init:function(e,r,t,a,i,o,l,s){var c=this;c.mode=n.GRAY,c._baseX=e||1,c._baseY=r||1,c._seed=l||0,c._stitch=!!a,c._fractal=!1!==i,c._perlin=!!s,c.octaves(t||1,o)},seed:function(e){var n=this;return n._seed=e||0,n},octaves:function(e,n){var r=this;for(r._octaves=e||1,r._offsets=n?n.slice(0):[];r._offsets.length<r._octaves;)r._offsets.push([0,0]);return r},seamless:function(e){return arguments.length||(e=!0),this._stitch=!!e,this},colors:function(e){return arguments.length||(e=!0),this.mode=e?n.COLOR:n.GRAY,this},turbulence:function(e){return arguments.length||(e=!0),this._fractal=!e,this},simplex:function(){return this._perlin=!1,this},perlin:function(){return this._perlin=!0,this},serialize:function(){var e=this;return{_baseX:e._baseX,_baseY:e._baseY,_octaves:e._octaves,_offsets:e._offsets,_seed:e._seed||0,_stitch:e._stitch,_fractal:e._fractal,_perlin:e._perlin}},unserialize:function(e){var n=this;return n._baseX=e._baseX,n._baseY=e._baseY,n._octaves=e._octaves,n._offsets=e._offsets,n._seed=e._seed||0,n._stitch=e._stitch,n._fractal=e._fractal,n._perlin=e._perlin,n},apply:function(r,t,a){var i=this,o=e.Util.Image.perlin;return o?(i._seed&&(o.seed(i._seed),i._seed=0),o(r,t,a,i._stitch,n.COLOR!==i.mode,i._baseX,i._baseY,i._octaves,i._offsets,1,.5,i._perlin)):r}})}(n),!function(e,n){var t=e.MODE,a=e.Util.Array.typed,i=Math.floor;e.Create({name:"GradientFilter",colors:null,stops:null,angle:0,centerX:0,centerY:0,radiusX:1,radiusY:1,path:r,dispose:function(){var e=this;return e.colors=null,e.stops=null,e.angle=null,e.centerX=null,e.centerY=null,e.radiusX=null,e.radiusY=null,e.$super("dispose"),e},setColors:function(n,r){var t=this;if(n&&n.length){var a=e.Color.Gradient.stops(n,r);t.colors=a[0],t.stops=a[1]}return t},serialize:function(){var e=this;return{angle:e.angle,centerX:e.centerX,centerY:e.centerY,radiusX:e.radiusX,radiusY:e.radiusY,colors:e.colors,stops:e.stops}},unserialize:function(e){var n=this;return n.angle=e.angle||0,n.centerX=e.centerX||0,n.centerY=e.centerY||0,n.radiusX=e.radiusX||1,n.radiusY=e.radiusY||1,n.colors=a(e.colors,Array),n.stops=a(e.stops,Array),n},linear:function(e,n,r){var a=this;return a.mode=t.LINEAR,a.setColors(e,n),a.angle=r||0,a},radial:function(e,n,r,a,i,o){var l=this;return l.mode=t.RADIAL,l.setColors(e,n),l.centerX=r||0,l.centerY=a||0,l.radiusX=i||1,l.radiusY=o||1,l},apply:function(n,r,a){var o=this;return o.colors?t.RADIAL===o.mode?e.Color.Gradient.radial(n,r,a,o.colors,o.stops,i((o.centerX||0)*(r-1)),i((o.centerY||0)*(a-1)),o.radiusX,o.radiusY,e.Color.Gradient.interpolate):e.Color.Gradient.linear(n,r,a,o.colors,o.stops,o.angle,e.Color.Gradient.interpolate):n}})}(n),!function(e){var n=Math.min,t=Math.floor,a=e.CHANNEL,i=e.MODE;e.Create({name:"ChannelCopyFilter",srcChannel:a.R,dstChannel:a.R,centerX:0,centerY:0,color:0,hasInputs:!0,path:r,init:function(e,n,r,t,i){var o=this;o.srcChannel=e||a.R,o.dstChannel=n||a.R,o.centerX=r||0,o.centerY=t||0,o.color=i||0},dispose:function(){var e=this;return e.srcChannel=null,e.dstChannel=null,e.centerX=null,e.centerY=null,e.color=null,e.$super("dispose"),e},serialize:function(){var e=this;return{srcChannel:e.srcChannel,dstChannel:e.dstChannel,centerX:e.centerX,centerY:e.centerY,color:e.color}},unserialize:function(e){var n=this;return n.srcChannel=e.srcChannel,n.dstChannel=e.dstChannel,n.centerX=e.centerX,n.centerY=e.centerY,n.color=e.color,n},apply:function(e,r,a){var o,l=this;if(o=l.input("source"),!o)return e;var s,c,u,f,h,d,p,y,m,v,g=o[0],_=o[1],C=o[2],b=e.length,w=(g.length,l.srcChannel),Y=l.dstChannel,x=l.centerX||0,X=l.centerY||0,F=_>>>1,A=C>>>1,I=n(r,_),R=n(a,C),S=l.color||0,M=l.mode,L=i.COLOR32,O=i.COLOR8,z=i.COLORMASK32,T=i.COLORMASK8;for(L===M||z===M?(v=S>>>24&255,p=S>>>16&255,y=S>>>8&255,m=255&S):O!==M&&T!==M||(S&=255),x=t(x*(r-1))-F,X=t(X*(a-1))-A,c=0,u=0,s=0;b>s;s+=4,c++)c>=r&&(c=0,u++),h=c-x,d=u-X,0>h||h>=I||0>d||d>=R?L===M?(e[s]=p,e[s+1]=y,e[s+2]=m,e[s+3]=v):z===M?(e[s]=p&e[s],e[s+1]=y&e[s+1],e[s+2]=m&e[s+2],e[s+3]=v&e[s+3]):O===M?e[s+Y]=S:T===M&&(e[s+Y]=S&e[s+w]):(f=h+d*_<<2,e[s+Y]=g[f+w]);return e}})}(n),!function(e){var n=e._notSupportClamp,t=e.Array32F,a=e.MODE,i=Math.min,o=Math.max;e.Create({name:"HistogramEqualizeFilter",path:r,mode:a.INTENSITY,init:function(e){var n=this;n.mode=e||a.INTENSITY},_apply_rgb:function(e,r,a){var l,s,c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y=0,x=0,X=0,F=255,A=255,I=255,R=e.length,S=R>>>2;for(d=new t(256),p=new t(256),y=new t(256),w=0;R>w;w+=4)l=e[w],s=e[w+1],c=e[w+2],d[l]++,p[s]++,y[c]++,Y=o(l,Y),x=o(s,x),X=o(c,X),F=i(l,F),A=i(s,A),I=i(c,I);for(m=v=g=0,w=0;256>w;w+=32)m+=d[w],d[w]=m,m+=d[w+1],d[w+1]=m,m+=d[w+2],d[w+2]=m,m+=d[w+3],d[w+3]=m,m+=d[w+4],d[w+4]=m,m+=d[w+5],d[w+5]=m,m+=d[w+6],d[w+6]=m,m+=d[w+7],d[w+7]=m,m+=d[w+8],d[w+8]=m,m+=d[w+9],d[w+9]=m,m+=d[w+10],d[w+10]=m,m+=d[w+11],d[w+11]=m,m+=d[w+12],d[w+12]=m,m+=d[w+13],d[w+13]=m,m+=d[w+14],d[w+14]=m,m+=d[w+15],d[w+15]=m,m+=d[w+16],d[w+16]=m,m+=d[w+17],d[w+17]=m,m+=d[w+18],d[w+18]=m,m+=d[w+19],d[w+19]=m,m+=d[w+20],d[w+20]=m,m+=d[w+21],d[w+21]=m,m+=d[w+22],d[w+22]=m,m+=d[w+23],d[w+23]=m,m+=d[w+24],d[w+24]=m,m+=d[w+25],d[w+25]=m,m+=d[w+26],d[w+26]=m,m+=d[w+27],d[w+27]=m,m+=d[w+28],d[w+28]=m,m+=d[w+29],d[w+29]=m,m+=d[w+30],d[w+30]=m,m+=d[w+31],d[w+31]=m,v+=p[w],p[w]=v,v+=p[w+1],p[w+1]=v,v+=p[w+2],p[w+2]=v,v+=p[w+3],p[w+3]=v,v+=p[w+4],p[w+4]=v,v+=p[w+5],p[w+5]=v,v+=p[w+6],p[w+6]=v,v+=p[w+7],p[w+7]=v,v+=p[w+8],p[w+8]=v,v+=p[w+9],p[w+9]=v,v+=p[w+10],p[w+10]=v,v+=p[w+11],p[w+11]=v,v+=p[w+12],p[w+12]=v,v+=p[w+13],p[w+13]=v,v+=p[w+14],p[w+14]=v,v+=p[w+15],p[w+15]=v,v+=p[w+16],p[w+16]=v,v+=p[w+17],p[w+17]=v,v+=p[w+18],p[w+18]=v,v+=p[w+19],p[w+19]=v,v+=p[w+20],p[w+20]=v,v+=p[w+21],p[w+21]=v,v+=p[w+22],p[w+22]=v,v+=p[w+23],p[w+23]=v,v+=p[w+24],p[w+24]=v,v+=p[w+25],p[w+25]=v,v+=p[w+26],p[w+26]=v,v+=p[w+27],p[w+27]=v,v+=p[w+28],p[w+28]=v,v+=p[w+29],p[w+29]=v,v+=p[w+30],p[w+30]=v,v+=p[w+31],p[w+31]=v,g+=y[w],y[w]=g,g+=y[w+1],y[w+1]=g,g+=y[w+2],y[w+2]=g,g+=y[w+3],y[w+3]=g,g+=y[w+4],y[w+4]=g,g+=y[w+5],y[w+5]=g,g+=y[w+6],y[w+6]=g,g+=y[w+7],y[w+7]=g,g+=y[w+8],y[w+8]=g,g+=y[w+9],y[w+9]=g,g+=y[w+10],y[w+10]=g,g+=y[w+11],y[w+11]=g,g+=y[w+12],y[w+12]=g,g+=y[w+13],y[w+13]=g,g+=y[w+14],y[w+14]=g,g+=y[w+15],y[w+15]=g,g+=y[w+16],y[w+16]=g,g+=y[w+17],y[w+17]=g,g+=y[w+18],y[w+18]=g,g+=y[w+19],y[w+19]=g,g+=y[w+20],y[w+20]=g,g+=y[w+21],y[w+21]=g,g+=y[w+22],y[w+22]=g,g+=y[w+23],y[w+23]=g,g+=y[w+24],y[w+24]=g,g+=y[w+25],y[w+25]=g,g+=y[w+26],y[w+26]=g,g+=y[w+27],y[w+27]=g,g+=y[w+28],y[w+28]=g,g+=y[w+29],y[w+29]=g,g+=y[w+30],y[w+30]=g,g+=y[w+31],y[w+31]=g;if(u=(Y-F)/S,f=(x-A)/S,h=(X-I)/S,n)for(w=0;R>w;w+=4)l=e[w],s=e[w+1],c=e[w+2],_=d[l]*u+F,C=p[s]*f+A,b=y[c]*h+I,_=0>_?0:_>255?255:_,C=0>C?0:C>255?255:C,b=0>b?0:b>255?255:b,e[w]=~~_,e[w+1]=~~C,e[w+2]=~~b;else for(w=0;R>w;w+=4)l=e[w],s=e[w+1],c=e[w+2],_=d[l]*u+F,C=p[s]*f+A,b=y[c]*h+I,e[w]=~~_,e[w+1]=~~C,e[w+2]=~~b;return e},apply:function(e,r,l){var s=this;if(a.RGB===s.mode)return s._apply_rgb(e,r,l);var c,u,f,h,d,p,y,m,v,g,_=0,C=255,b=e.length,w=b>>>2,Y=a.GRAY===s.mode;if(m=new t(256),Y)for(g=0;b>g;g+=4)c=e[g],m[c]++,_=o(c,_),C=i(c,C);else for(g=0;b>g;g+=4)c=e[g],u=e[g+1],f=e[g+2],h=~~(0+.299*c+.587*u+.114*f),d=~~(128-.168736*c-.331264*u+.5*f),p=~~(128+.5*c-.418688*u-.081312*f),p=0>p?0:p>255?255:p,h=0>h?0:h>255?255:h,d=0>d?0:d>255?255:d,e[g]=p,e[g+1]=h,e[g+2]=d,m[h]++,_=o(h,_),C=i(h,C);for(v=0,g=0;256>g;g+=32)v+=m[g],m[g]=v,v+=m[g+1],m[g+1]=v,v+=m[g+2],m[g+2]=v,v+=m[g+3],m[g+3]=v,v+=m[g+4],m[g+4]=v,v+=m[g+5],m[g+5]=v,v+=m[g+6],m[g+6]=v,v+=m[g+7],m[g+7]=v,v+=m[g+8],m[g+8]=v,v+=m[g+9],m[g+9]=v,v+=m[g+10],m[g+10]=v,v+=m[g+11],m[g+11]=v,v+=m[g+12],m[g+12]=v,v+=m[g+13],m[g+13]=v,v+=m[g+14],m[g+14]=v,v+=m[g+15],m[g+15]=v,v+=m[g+16],m[g+16]=v,v+=m[g+17],m[g+17]=v,v+=m[g+18],m[g+18]=v,v+=m[g+19],m[g+19]=v,v+=m[g+20],m[g+20]=v,v+=m[g+21],m[g+21]=v,v+=m[g+22],m[g+22]=v,v+=m[g+23],m[g+23]=v,v+=m[g+24],m[g+24]=v,v+=m[g+25],m[g+25]=v,v+=m[g+26],m[g+26]=v,v+=m[g+27],m[g+27]=v,v+=m[g+28],m[g+28]=v,v+=m[g+29],m[g+29]=v,v+=m[g+30],m[g+30]=v,v+=m[g+31],m[g+31]=v;if(y=(_-C)/w,n)if(Y)for(g=0;b>g;g+=4)c=~~(m[e[g]]*y+C),c=0>c?0:c>255?255:c,e[g]=c,e[g+1]=c,e[g+2]=c;else for(g=0;b>g;g+=4)h=m[e[g+1]]*y+C,d=e[g+2],p=e[g],c=~~(h+1.402*(p-128)),u=~~(h-.34414*(d-128)-.71414*(p-128)),f=~~(h+1.772*(d-128)),c=0>c?0:c>255?255:c,u=0>u?0:u>255?255:u,f=0>f?0:f>255?255:f,e[g]=c,e[g+1]=u,e[g+2]=f;else if(Y)for(g=0;b>g;g+=4)c=~~(m[e[g]]*y+C),e[g]=c,e[g+1]=c,e[g+2]=c;else for(g=0;b>g;g+=4)h=m[e[g+1]]*y+C,d=e[g+2],p=e[g],c=~~(h+1.402*(p-128)),u=~~(h-.34414*(d-128)-.71414*(p-128)),f=~~(h+1.772*(d-128)),e[g]=c,e[g+1]=u,e[g+2]=f;return e}})}(n),!function(e){var n,t=Math.sqrt,a=Math.min,i=Math.max,o=t(3);e.Create({name:"PixelateFilter",scale:1,pattern:"rectangular",init:function(e,n){var r=this;r.scale=e||1,r.pattern=n||"rectangular"},path:r,serialize:function(){var e=this;return{scale:e.scale,pattern:e.pattern}},unserialize:function(e){var n=this;return n.scale=e.scale,n.pattern=e.pattern,n},apply:function(r,t,a){var i=this,o=i.pattern;if(i.scale<=1||!o||!n[o])return r;i.scale>100&&(i.scale=100);var l=new e.ImArray(r.length);return n[o](i.scale,l,r,t,a),l}}),e.RectangularPixelateFilter=function(n){return new e.PixelateFilter(n,"rectangular")},e.TriangularPixelateFilter=function(n){return new e.PixelateFilter(n,"triangular")},e.RhomboidPixelateFilter=function(n){return new e.PixelateFilter(n,"rhomboidal")},e.HexagonalPixelateFilter=function(n){return new e.PixelateFilter(n,"hexagonal")},e.PixelateFilter.PATTERN=n={rectangular:function(e,n,r,i,o){var l,l,s,c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M=r.length,L=M>>>2,O=i-1,z=L-i;for(l=t(L)*e*.01|0,s=.5*l|0,c=l*i,u=s*i,C=b=w=Y=x=0,_=0;M>_;_+=4)X=C-w,F=b-x,A=a(O,X+l),I=a(z,F+c),R=a(O,X+s),S=a(z,F+u),f=R+S<<2,h=X+F<<2,d=X+I<<2,p=A+F<<2,y=A+I<<2,m=.125*(r[h]+r[d]+r[p]+r[y]+4*r[f]),v=.125*(r[h+1]+r[d+1]+r[p+1]+r[y+1]+4*r[f+1]),g=.125*(r[h+2]+r[d+2]+r[p+2]+r[y+2]+4*r[f+2]),n[_]=0|m,n[_+1]=0|v,n[_+2]=0|g,n[_+3]=r[_+3],C++,w++,C>=i&&(w=0,C=0,Y++,x+=i,b+=i,Y>=l&&(Y=0,x=0)),w>=l&&(w=0)},triangular:function(e,n,r,i,o){var l,s,c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M,L=r.length,O=L>>>2,z=i-1,T=O-i;for(l=t(O)*e*.0125|0,s=.5*l|0,c=.333*l|0,u=.666*l|0,f=l*i,h=s*i,b=w=Y=x=X=0,C=0;L>C;C+=4)F=b-Y,A=w-X,I=a(z,F+l),R=a(T,A+f),Y+x>l?(S=a(z,F+u),M=a(T,A+h),d=S+M<<2,p=I+R<<2):(S=a(z,F+c),M=a(T,A+h),d=S+M<<2,p=F+R<<2),y=F+A<<2,m=I+A<<2,v=.2*(r[p]+r[y]+r[m]+2*r[d]),g=.2*(r[p+1]+r[y+1]+r[m+1]+2*r[d+1]),_=.2*(r[p+2]+r[y+2]+r[m+2]+2*r[d+2]),n[C]=0|v,n[C+1]=0|g,n[C+2]=0|_,n[C+3]=r[C+3],b++,Y++,b>=i&&(Y=0,b=0,x++,X+=i,w+=i,x>=l&&(x=0,X=0)),Y>=l&&(Y=0)},rhomboidal:function(e,n,r,o,l){var s,c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M,L,O=r.length,z=O>>>2,T=o-1,E=z-o;for(s=t(z)*e*.007|0,c=2*s,u=s*o,f=c*o,w=Y=x=X=F=0,h=0,b=0;O>b;b+=4)h?x+X>c?(A=a(T,w-x+s),I=Y-F):x+s-X>s?(A=w-x,I=i(0,Y-F-u)):(A=i(0,w-x-s),I=Y-F):x+s-X>c?(A=a(T,w-x+s),I=i(0,Y-F-u)):x+X>s?(A=w-x,I=Y-F):(A=i(0,w-x-s),I=i(0,Y-F-u)),R=a(T,A+c),S=a(E,I+f),M=a(T,A+s),L=a(E,I+u),d=M+L<<2,p=M+I<<2,y=A+L<<2,m=R+L<<2,v=M+S<<2,g=.125*(r[p]+r[y]+r[m]+r[v]+4*r[d]),_=.125*(r[p+1]+r[y+1]+r[m+1]+r[v+1]+4*r[d+1]),C=.125*(r[p+2]+r[y+2]+r[m+2]+r[v+2]+4*r[d+2]),n[b]=0|g,n[b+1]=0|_,n[b+2]=0|C,n[b+3]=r[b+3],w++,x++,w>=o&&(x=0,w=0,X++,F+=o,Y+=o,X>=s&&(X=0,F=0,h=1-h)),x>=c&&(x=0)},hexagonal:function(e,n,r,l,s){var c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M,L,O,z,T,E,P,N,G,H,U,q=r.length,D=q>>>2,k=l-1,$=D-l;for(u=o*e*t(D)*.012|0,c=.5*u|0,f=.25*u|0,h=u-f,d=.25*u|0,p=d*l,F=A=I=R=S=0,H=U=1,X=0;q>X;X+=4)U?2===H?(M=i(0,F-I-f),L=A-S):1===H?o*I+d-R>c?(M=a(k,F-I+f),L=A-S):(M=i(0,F-I-c),L=a($,A-S+p)):c>o*I+R?(M=i(0,F-I-h),L=A-S):(M=F-I,L=a($,A-S+p)):2===H?(M=i(0,F-I-f),L=a($,A-S+p)):1===H?o*I+R>c?(M=a(k,F-I+f),L=a($,A-S+p)):(M=i(0,F-I-c),L=A-S):c>o*I+d-R?(M=i(0,F-I-h),L=a($,A-S+p)):(M=F-I,L=A-S),O=a(k,M+f),z=i(0,L-p),T=a(k,M+c),E=L,P=a(k,M+u),N=a($,L+p),G=a(k,M+h),y=T+E<<2,m=M+L<<2,v=O+z<<2,g=G+z<<2,_=P+L<<2,C=G+N<<2,b=O+N<<2,w=.125*(r[m]+r[v]+r[g]+r[_]+r[C]+r[b]+2*r[y]),Y=.125*(r[m+1]+r[v+1]+r[g+1]+r[_+1]+r[C+1]+r[b+1]+2*r[y+1]),x=.125*(r[m+2]+r[v+2]+r[g+2]+r[_+2]+r[C+2]+r[b+2]+2*r[y+2]),n[X]=0|w,n[X+1]=0|Y,n[X+2]=0|x,n[X+3]=r[X+3],F++,I++,F>=l&&(I=0,F=0,R++,S+=l,A+=l,H=0,R>=d&&(R=0,S=0,U=1-U)),I>=c&&(I=0,H=(H+1)%3)}}}(n),!function(e,n){var t=7/16,a=3/16,i=5/16,o=1/16,l=e.MODE,s=e.Array32F,c=e.Color.clamp,u=e.Color.intensity;e.Create({name:"HalftoneFilter",size:1,thresh:.4,mode:l.GRAY,init:function(e,n,r){var t=this;t.size=e||1,t.thresh=c(null==n?.4:n,0,1),t.mode=r||l.GRAY},path:r,threshold:function(e){return this.thresh=c(e,0,1),this},serialize:function(){var e=this;return{size:e.size,thresh:e.thresh}},unserialize:function(e){var n=this;return n.size=e.size,n.thresh=e.thresh,n},apply:function(e,n,r){var c,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M=this,L=e.length,O=L>>>2,z=new s(3*O),T=M.size,E=T*T,P=1/E,N=255*M.thresh,G=G<<1,H=l.RGB===M.mode,U=T*n,q=t,D=a,k=i,$=o;for(p=0,y=0,d=0;r>p;){if(_=C=b=0,H){for(m=0,v=0,g=0;T>v;)c=d+y+m+g<<2,f=3*(d+y+m+g),_+=e[c]+z[f],C+=e[c+1]+z[f+1],b+=e[c+2]+z[f+2],++m>=T&&(m=0,v++,g+=n);_*=P,C*=P,b*=P,h=u(_,C,b),h>N?(w=0|_,Y=0|C,x=0|b):(w=0,Y=0,x=0)}else{for(m=0,v=0,g=0;T>v;)c=d+y+m+g<<2,f=3*(d+y+m+g),_+=e[c]+z[f],++m>=T&&(m=0,v++,g+=n);h=_*P,h>N?(w=255,Y=255,x=255):(w=0,Y=0,x=0)}if(c=d+y<<2,X=e[c]-w,F=e[c+1]-Y,A=e[c+2]-x,n>d+T)for(I=q*X,R=q*F,S=q*A,m=T,v=0,g=0;T>v;)f=3*(d+y+m+g),z[f]+=I,z[f+1]+=R,z[f+2]+=S,++m>=G&&(m=T,v++,g+=n);if(r>p+T&&d>T)for(I=D*X,R=D*F,S=D*A,m=-T,v=T,g=0;G>v;)f=3*(d+y+m+g),z[f]+=I,z[f+1]+=R,z[f+2]+=S,++m>=0&&(m=-T,v++,g+=n);if(r>p+T)for(I=k*X,R=k*F,S=k*A,m=0,v=T,g=0;G>v;)f=3*(d+y+m+g),z[f]+=I,z[f+1]+=R,z[f+2]+=S,++m>=T&&(m=0,v++,g+=n);if(r>p+T&&n>d+T)for(I=$*X,R=$*F,S=$*A,m=T,v=T,g=0;G>v;)f=3*(d+y+m+g),z[f]+=I,z[f+1]+=R,z[f+2]+=S,++m>=G&&(m=T,v++,g+=n);for(m=0,v=0,g=0;T>v;)c=d+y+m+g<<2,e[c]=w,e[c+1]=Y,e[c+2]=x,++m>=T&&(m=0,v++,g+=n);d+=T,d>=n&&(d=0,p+=T,y+=U)}return e}})}(n),!function(e,n){var t=e.MODE,a=new e.ConvolutionMatrix([1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9]);e.Create({name:"DropShadowFilter",offsetX:null,offsetY:null,color:0,opacity:1,quality:1,onlyShadow:!1,path:r,init:function(e,n,r,t,a,i){var o=this;o.offsetX=e||0,o.offsetY=n||0,o.color=r||0,o.opacity=null==t?1:+t,o.quality=0|(a||1),o.onlyShadow=!!i},dispose:function(){var e=this;return e.offsetX=null,e.offsetY=null,e.color=null,e.opacity=null,e.quality=null,e.onlyShadow=null,e.$super("dispose"),e},serialize:function(){var e=this;return{offsetX:e.offsetX,offsetY:e.offsetY,color:e.color,opacity:e.opacity,quality:e.quality,onlyShadow:e.onlyShadow}},unserialize:function(e){var n=this;return n.offsetX=e.offsetX,n.offsetY=e.offsetY,n.color=e.color,n.opacity=e.opacity,n.quality=e.quality,n.onlyShadow=e.onlyShadow,n},apply:function(n,r,i){var o=this;if(!o._isOn)return n;var l,s,c,u,f,h,d,p,y,m,v,g=o.color||0,_=o.opacity,C=o.quality,b=o.onlyShadow,w=o.offsetX||0,Y=o.offsetY||0,x=n.length,X=x>>>2;if(0>_&&(_=0),_>1&&(_=1),0===_)return n;for(l=g>>>16&255,s=g>>>8&255,c=255&g,0>=C&&(C=1),C>3&&(C=3),v=new e.ImArray(x),u=0;x>u;u+=4)m=n[u+3],m>0&&(v[u]=l,v[u+1]=s,v[u+2]=c,v[u+3]=_*m|0);if(v=e.Util.Filter.integral_convolution(l===s&&s===c?t.GRAY:t.RGB,v,r,i,2,a,null,3,3,1,0,C),Y*=r,b)for(f=0,h=0,y=0;x>y;y+=4,f++)f>=r&&(f=0,h+=r),d=f+w,p=h+Y,0>d||d>=r||0>p||p>=X||(u=d+p<<2,n[u]=v[y],n[u+1]=v[y+1],n[u+2]=v[y+2],n[u+3]=v[y+3]);else for(f=0,h=0,y=0;x>y;y+=4,f++)f>=r&&(f=0,h+=r),d=f+w,p=h+Y,0>d||d>=r||0>p||p>=X||(u=d+p<<2,m=n[u+3],_=v[y+3],255!==m&&0!==_&&(_/=255,l=n[u]+(v[y]-n[u])*_,s=n[u+1]+(v[y+1]-n[u+1])*_,c=n[u+2]+(v[y+2]-n[u+2])*_,n[u]=0|l,n[u+1]=0|s,n[u+2]=0|c));return n}})}(n),!function(e){var n=(Math.sqrt,Math.exp,Math.log),t=Math.abs,a=Math.floor,i=e._notSupportClamp;e.Array32F;e.Create({name:"BokehFilter",centerX:0,centerY:0,radius:10,amount:10,init:function(e,n,r,t){var a=this;a.centerX=e||0,a.centerY=n||0,a.radius=r||10,a.amount=t||10},path:r,serialize:function(){var e=this;return{centerX:e.centerX,centerY:e.centerY,radius:e.radius,amount:e.amount}},unserialize:function(e){var n=this;return n.centerX=e.centerX,n.centerY=e.centerY,n.radius=e.radius,n.amount=e.amount,n},apply:function(r,o,l){var s=this;if(!s._isOn)return r;var c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M,L,O,z,T,E,P,N,G,H,U,q=r.length,D=s.centerX||0,k=s.centerY||0,$=s.radius,B=s.amount;if(0>=B)return r;for(c=q>>>2,N=0,G=o-1,H=0,U=c-o,D=a(D*(o-1)),k=a(k*(l-1)),f=(c<<1)+c,y=(o<<1)+o,u=new e.Array32F(f),m=0,v=0,g=0,h=d=p=0,g=0;o>g;g++,m+=4,v+=3)h+=r[m],d+=r[m+1],p+=r[m+2],u[v]=h,u[v+1]=d,u[v+2]=p;for(m=y+o,v=0,g=0,h=d=p=0,m=y+o;q>m;m+=4,v+=3,g++)g>=o&&(g=0,h=d=p=0),h+=r[m],d+=r[m+1],p+=r[m+2],u[v+y]=u[v]+h,u[v+y+1]=u[v+1]+d,u[v+y+2]=u[v+2]+p;for(g=0,_=0,C=0,m=0;q>m;m+=4,g++)g>=o&&(g=0,_++,C+=o),w=g-D,Y=_-k,b=t(w)+t(Y),x=b>$?0|n((b-$)*B):b/$+.5|0,x>0&&(X=x*o,F=.25/(x*x),A=g-x,I=C-X,R=g+x,S=C+X,N>A?A=N:R>G&&(R=G),H>I?I=H:S>U&&(S=U),M=A+I,z=R+S,L=R+I,O=A+S,M=(M<<1)+M,L=(L<<1)+L,O=(O<<1)+O,z=(z<<1)+z,T=F*(u[z]-u[L]-u[O]+u[M]),E=F*(u[z+1]-u[L+1]-u[O+1]+u[M+1]),P=F*(u[z+2]-u[L+2]-u[O+2]+u[M+2]),i&&(T=0>T?0:T>255?255:T,E=0>E?0:E>255?255:E,P=0>P?0:P>255?255:P),r[m]=0|T,r[m+1]=0|E,r[m+2]=0|P);return r}})}(n),!function(e){e.Create({name:"SeamlessTileFilter",type:2,init:function(e){var n=this;n.type=null==e?2:e||0},path:r,serialize:function(){var e=this;return{type:e.type}},unserialize:function(e){var n=this;return n.type=e.type,n},apply:function(n,r,t){var a,i,o,l,s,c,u,f,h,d,p,y,m,v,g,_=this,C=_.type,b=e.Interpolation.bilinear,w=e.ImArray,Y=e.Array8U,x=Math.sqrt;for(r!==t?n=b(n,r,t,y=r>t?r:t,y):y=r,m=Math.round(y/2),v=y*y,g=n.length,a=new w(g),i=new w(g),o=new Y(v),f=0,h=0,d=0;g>d;d+=4,f++)f>=y&&(f=0,h++),p=(f+m)%y+(h+m)%y*y<<2,a[p]=n[d],a[p+1]=n[d+1],a[p+2]=n[d+2],a[p+3]=n[d+3];if(0===C)for(f=0,h=0;m>f;h++)h>=m&&(h=0,f++),u=255-255*x((f-m)*(f-m)+(h-m)*(h-m))/m,u=1>u?1:u>255?255:u,o[f+h*y]=u,o[f+(y-1-h)*y]=u,o[y-1-f+h*y]=u,o[y-1-f+(y-1-h)*y]=u;else if(1===C)for(f=0,h=0;m>f;h++)h>=m&&(h=0,f++),u=255-255*(m+f>m+h?(h-m)/m:(f-y/2)/m),u=1>u?1:u>255?255:u,o[f+h*y]=u,o[f+(y-1-h)*y]=u,o[y-1-f+h*y]=u,o[y-1-f+(y-1-h)*y]=u;else for(f=0,h=0;m>f;h++)h>=m&&(h=0,f++),u=255-255*(m+f>m+h?x((h-y)*(h-y)+(f-y)*(f-y))/(1.13*y):x((f-y)*(f-y)+(h-y)*(h-y))/(1.13*y)),u=1>u?1:u>255?255:u,o[f+h*y]=u,o[f+(y-1-h)*y]=u,o[y-1-f+h*y]=u,o[y-1-f+(y-1-h)*y]=u;for(h=0,f=0;y>h;f++)f>=y&&(f=0,h++),p=f+h*y,l=o[p],s=o[(f+m)%y+(h+m)%y*y],c=l+s,l/=c,s/=c,p<<=2,i[p]=~~(l*n[p]+s*a[p]),i[p+1]=~~(l*n[p+1]+s*a[p+1]),i[p+2]=~~(l*n[p+2]+s*a[p+2]),i[p+3]=n[p+3];return r!==t&&(i=b(i,y,y,r,t)),i}})}(n),!function(e){var n=e.MODE;e.Create({name:"ColorFillFilter",x:0,y:0,color:null,border:null,tolerance:1e-6,mode:n.COLOR,path:r,init:function(e,r,t,a,i){var o=this;o.x=e||0,o.y=r||0,o.color=t||0,o.tolerance=null==a?1e-6:+a,o.border=null!=i?i||0:null,o.mode=n.COLOR},serialize:function(){var e=this;return{color:e.color,border:e.border,x:e.x,y:e.y,tolerance:e.tolerance}},unserialize:function(e){var n=this;return n.color=e.color,n.border=e.border,n.x=e.x,n.y=e.y,n.tolerance=e.tolerance,n},apply:function(r,t,a){var i,o,l,s,c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M=this,L=M.mode||n.COLOR,O=M.color||0,z=M.border,T=null!=z,E=M.x||0,P=M.y||0,N=e.Color.RGB2HSV,G=e.Color.HSV2RGB;if(0>E||E>=t||0>P||P>=a)return r;if(E<<=2,P=P*t<<2,h=E+P,v=r[h],g=r[h+1],_=r[h+2],X=0,F=1,p=O>>>16&255,y=O>>>8&255,m=255&O,T){if(C=z>>>16&255,b=z>>>8&255,w=255&z,v===C&&g===b&&_===w)return r;v=C,g=b,_=w,X=1,F=0}else if(n.COLOR===L&&v===p&&g===y&&_===m)return r;if(x=e.Util.Filter.dissimilarity_rgb(v,g,_,X,F,255*(M.tolerance>=1?.999:M.tolerance)),A=e.MachineLearning.flood_region(r,t,a,2,x,8,E,P),R=A.mask,n.MASK===L||n.COLORMASK===L)for(S=n.MASK===L,i=0,o=0,h=0,d=r.length;d>h;h+=4,i++)i>=t&&(i=0,o+=t),f=i+o,R[f>>>5]&1<<(31&f)?S&&(r[h]=p,r[h+1]=y,r[h+2]=m):(r[h]=0,r[h+1]=0,r[h+2]=0);else if(n.HUE===L)for(I=A.box,l=I[0]>>>2,s=I[1]>>>2,c=I[2]>>2,u=I[3]>>>2,Y=new e.Array32F(3),i=l,o=s;u>=o;)f=i+o,R[f>>>5]&1<<(31&f)&&(h=f<<2,Y[0]=r[h],Y[1]=r[h+1],Y[2]=r[h+2],N(Y,0,1),Y[0]=O,G(Y,0,1),r[h]=0|Y[0],r[h+1]=0|Y[1],r[h+2]=0|Y[2]),++i>c&&(i=l,o+=t);else for(I=A.box,l=I[0]>>>2,s=I[1]>>>2,c=I[2]>>2,u=I[3]>>>2,i=l,o=s;u>=o;)f=i+o,R[f>>>5]&1<<(31&f)&&(h=f<<2,r[h]=p,r[h+1]=y,r[h+2]=m),++i>c&&(i=l,o+=t);return r}}),e.FloodFillFilter=e.ColorFillFilter,e.Create({name:"PatternFillFilter",x:0,y:0,offsetX:0,offsetY:0,tolerance:1e-6,border:null,mode:n.TILE,hasInputs:!0,path:r,init:function(e,r,t,a,i,o,l){var s=this;s.x=e||0,s.y=r||0,s.offsetX=a||0,s.offsetY=i||0,t&&s.setInput("pattern",t),s.tolerance=null==o?1e-6:+o,s.border=null!=l?l||0:null,s.mode=n.TILE},dispose:function(){var e=this;return e.x=null,e.y=null,e.offsetX=null,e.offsetY=null,e.tolerance=null,e.border=null,e.$super("dispose"),e},serialize:function(){var e=this;return{x:e.x,y:e.y,offsetX:e.offsetX,offsetY:e.offsetY,tolerance:e.tolerance,border:e.border}},unserialize:function(e){var n=this;return n.x=e.x,n.y=e.y,n.offsetX=e.offsetX,n.offsetY=e.offsetY,n.tolerance=e.tolerance,n.border=e.border,n},apply:function(r,t,a){var i,o=this,l=o.x||0,s=o.y||0;if(0>l||l>=t||0>s||s>=a)return r;if(i=o.input("pattern"),!i)return r;var c,u,f,h,d,p,y,m,v,g,_,C,b,w,Y,x,X,F,A,I,R,S,M,L,O,z,T=o.mode||n.TILE,E=o.border,P=null!=E,N=i[0],G=i[1],H=i[2],U=o.offsetX||0,q=o.offsetY||0;if(l<<=2,s=s*t<<2,g=l+s,c=r[g],u=r[g+1],f=r[g+2],R=0,S=1,P){if(h=E>>>16&255,d=E>>>8&255,p=255&E,c===h&&u===d&&f===p)return r;c=h,u=d,f=p,R=1,S=0}if(I=e.Util.Filter.dissimilarity_rgb(c,u,f,R,S,255*(o.tolerance>=1?.999:o.tolerance)),M=e.MachineLearning.flood_region(r,t,a,2,I,8,l,s),O=M.mask,L=M.box,w=L[0]>>>2,Y=L[1]>>>2,x=L[2]>>>2,X=L[3]>>>2,n.STRETCH===T)for(F=G/(x-w+1),A=H/(X-Y+t),y=w,m=Y;X>=m;)v=y+m,O[v>>>5]&1<<(31&v)&&(g=v<<2,C=F*(y-w)|0,b=A*(m-Y)|0,_=C+b*G<<2,r[g]=N[_],r[g+1]=N[_+1],r[g+2]=N[_+2]),++y>x&&(y=w,m+=t);else for(0>U&&(U+=G),0>q&&(q+=H),x=x-w+1,y=0,m=0,z=Y;X>=z;)v=y+w+z,O[v>>>5]&1<<(31&v)&&(g=v<<2,C=(y+U)%G,b=(m+q)%H,_=C+b*G<<2,r[g]=N[_],r[g+1]=N[_+1],r[g+2]=N[_+2]),++y>=x&&(y=0,z+=t,m++);return r}})}(n),!function(e,n){function t(e,n,r){return s(e-n)<=r}function a(e,n,r){return e===n||-1!==e&&-1!==n&&s((e>>16&255)-(n>>16&255))<=r&&s((e>>8&255)-(n>>8&255))<=r&&s((255&e)-(255&n))<=r}var i=e.MODE,o=Math.min,l=Math.max,s=Math.abs,c=Math.cos,u=e.CONST.toRad;e.Create({name:"ConnectedComponentsFilter",connectivity:4,tolerance:1e-6,mode:i.COLOR,color:null,invert:!1,box:null,init:function(e,n,r,t){var a=this;a.connectivity=8===e?8:4,a.tolerance=null==n?1e-6:+n,a.color=null==r?null:+r,a.invert=!!t,a.mode=i.COLOR},path:r,serialize:function(){var e=this;return{connectivity:e.connectivity,tolerance:e.tolerance,color:e.color,invert:e.invert}},unserialize:function(e){var n=this;return n.connectivity=e.connectivity,n.tolerance=e.tolerance,n.color=e.color,n.invert=e.invert,n},apply:function(n,r,s){var f,h,d,p=this,y=n.length,m=y>>>2,v=p.mode||i.COLOR,g=p.color,_=o(.999,l(0,p.tolerance||0)),C=new e.Array32F(m),b=e.Color.hue,w=e.Color.intensity;if(i.HUE===v)for(d=t,null!=g&&(g=c(u*g)),f=0,h=0;y>f;f+=4,h++)C[h]=0===n[f+3]?1e4:c(u*b(n[f],n[f+1],n[f+2]));else if(i.INTENSITY===v)for(d=t,_*=255,f=0,h=0;y>f;f+=4,h++)C[h]=0===n[f+3]?1e4:w(n[f],n[f+1],n[f+2]);else for(d=a,_=255*_|0,f=0,h=0;y>f;f+=4,h++)C[h]=0===n[f+3]?-1:n[f]<<16|n[f+1]<<8|n[f+2];return e.MachineLearning.connected_components(n,r,s,2,C,p.connectivity,d,_,g,p.invert)}})}(n),!function(e){var n=100,t=1e3,a=n*t,i=Math.round;e.Create({name:"CannyEdgesFilter",low:2.5,high:7.5,lowpass:!0,path:r,init:function(e,n,r){var t=this;t.low=arguments.length<1?2.5:+e,t.high=arguments.length<2?7.5:+n,t.lowpass=arguments.length<3?!0:!!r},thresholds:function(e,n,r){var t=this;return t.low=+e,t.high=+n,arguments.length>2&&(t.lowpass=!!r),t},serialize:function(){var e=this;return{low:e.low,high:e.high,lowpass:e.lowpass}},unserialize:function(e){var n=this;return n.low=e.low,n.high=e.high,n.lowpass=e.lowpass,n},apply:function(r,o,l){var s=this;return e.Util.Filter.gradient(r,o,l,2,0,s.lowpass,0,i(s.low*n),i(s.high*n),n,t,a)}})}(n),!function(e,n){function t(e,n,r,t,a,i,o,l,s,c,d,p,v,g,_,C,b){var w,Y,x,X,F,A,I,R,S,M,L,O,z,T,E,P,N,G,H,U,q,D,k,$,B,K,j,V,W,J,Q,Z,ee,ne,re,D,te,ae,ie,oe,le,se,ce,ue,fe,he,de,pe,ye,me,ve,ge,_e,Ce,be=null!=_,we=i-t+1|0,Ye=o-a+1|0,xe=n*r,Xe=xe-1,Fe=l.stages,Ae=Fe.length,Ie=l.size1,Re=l.size2;for(k=n-1,$=xe-n,I=0|t,R=0|a,Y=f(we/Ie,Ye/Re),w=s;Y>=w;w*=c)for(F=w*Ie|0,x=F*d|0,A=w*Re|0,X=A*d|0,z=A*n,T=X*n,S=R*T,H=we-F,U=Ye-A,B=F*A,K=1/B,L=R,O=S;U>L;L+=X,O+=T)for(M=I;H>M;M+=x)if(E=M-1+O-n,P=E+F,N=E+z,G=N+F,E=f(Xe,u(0,E)),P=f(Xe,u(0,P)),N=f(Xe,u(0,N)),G=f(Xe,u(0,G)),!(be&&(J=K*(_[G]-_[N]-_[P]+_[E]),C>J||J>b))){for(j=K*(p[G]-p[N]-p[P]+p[E]),V=K*(g[G]-g[N]-g[P]+g[E]),W=V-j*j,W=W>1?h(W):W,Q=!1,q=0;Ae>q;q++){for(Z=Fe[q],ee=Z.thres,ne=Z.trees,re=ne.length,Ce=0,D=0;re>D;D++)for(ae=ne[D].feats,te=0;;){if(ie=ae[te],oe=ie.rects,le=oe.length,se=ie.thres,ce=0,ie.tilt)for(ue=0;le>ue;ue++)fe=oe[ue],he=M+w*fe[0]|0,de=(L-1+w*fe[1]|0)*n,pe=M+w*(fe[0]+fe[2])|0,ye=(L-1+w*(fe[1]+fe[2])|0)*n,me=M+w*(fe[0]-fe[3])|0,ve=(L-1+w*(fe[1]+fe[3])|0)*n,ge=M+w*(fe[0]+fe[2]-fe[3])|0,_e=(L-1+w*(fe[1]+fe[2]+fe[3])|0)*n,he=f(k,u(0,he)),pe=f(k,u(0,pe)),me=f(k,u(0,me)),ge=f(k,u(0,ge)),de=f($,u(0,de)),ye=f($,u(0,ye)),ve=f($,u(0,ve)),_e=f($,u(0,_e)),ce+=fe[4]*(v[ge+_e]-v[me+ve]-v[pe+ye]+v[he+de]);else for(ue=0;le>ue;ue++)fe=oe[ue],he=M-1+w*fe[0]|0,pe=M-1+w*(fe[0]+fe[2])|0,de=n*(L-1+w*fe[1]|0),ye=n*(L-1+w*(fe[1]+fe[3])|0),he=f(k,u(0,he)),pe=f(k,u(0,pe)),de=f($,u(0,de)),ye=f($,u(0,ye)),ce+=fe[4]*(p[pe+ye]-p[he+ye]-p[pe+de]+p[he+de]);if(se*W>ce*K){if(ie.has_l){Ce+=ie.l_val;break}te=ie.l_node}else{if(ie.has_r){Ce+=ie.r_val;break}te=ie.r_node}}if(Q=Ce>ee,!Q)break}Q&&(e.count===e.length&&m.apply(e,new Array(y)),e[e.count++]=[M,L,F,A])}}function a(e,n,r){var t=u(n[2],e[2])*r,a=u(n[3],e[3])*r;return c(e[0]-n[0])<=t&&c(e[1]-n[1])<=a&&c(e[2]-n[2])<=t&&c(e[3]-n[3])<=a}function i(e,n){return e.x1>=n.x1&&e.y1>=n.y1&&e.x2<=n.x2&&e.y2<=n.y2}function o(e){e.x1=e.x1+.5|0,e.y1=e.y1+.5|0,e.x2=e.x2+.5|0,e.y2=e.y2+.5|0}function l(e,n){return n.area-e.area}function s(e,n,r){var t,s,c,u,f,h,d,p,y,m,v,g=e.length,_=new Array(g),C=[],b=0,w=!1;for(c=0;g>c;c++)_[c]=0;for(c=0;g>c;c++){for(w=!1,u=0;c>u;u++)a(e[u],e[c],r)&&(w=!0,_[c]=_[u]);w||(_[c]=b,b++)}for(t=new Array(b),s=new Array(b),c=0;b>c;c++)t[c]=0,s[c]=[0,0,0,0];for(c=0;g>c;c++)d=_[c],t[d]++,s[d][0]+=e[c][0],s[d][1]+=e[c][1],s[d][2]+=e[c][2],s[d][3]+=e[c][3];for(c=0;b>c;c++)f=t[c],f>=n&&(h=1/(f+f),p=h*(2*s[c][0]+f),y=h*(2*s[c][1]+f),m=h*(2*s[c][2]+f),v=h*(2*s[c][3]+f),C.push({x1:p,y1:y,x2:p+m-1,y2:y+v-1,x:p,y:y,width:m,height:v,area:0,inside:0}));for(g=C.length,c=0;g>c;c++)for(u=c+1;g>u;u++)!C[c].inside&&i(C[c],C[u])?C[c].inside=1:!C[u].inside&&i(C[u],C[c])&&(C[u].inside=1);for(c=g;--c>=0;)C[c].inside?C.splice(c,1):(o(C[c]),C[c].area=C[c].width*C[c].height);return C.sort(l)}var c=Math.abs,u=Math.max,f=Math.min,h=(Math.floor,Math.round,Math.sqrt),d=(e.Util.Array.typed,e.Util.Array.typed_obj),p="hasOwnProperty",y=10,m=Array.prototype.push;e.Util.Filter.haar_detect=t,e.Util.Filter.merge_features=s,e.Create({name:"HaarDetectorFilter",_update:!1,hasMeta:!0,haardata:null,tolerance:.2,baseScale:1,scaleIncrement:1.25,stepIncrement:.5,minNeighbors:1,doCannyPruning:!0,cannyLow:20,cannyHigh:100,_haarchanged:!1,init:function(e,r,t,a,i,o,l){var s=this;s.haardata=e||null,s.baseScale=n===r?1:+r,s.scaleIncrement=n===t?1.25:+t,s.stepIncrement=n===a?.5:+a,s.minNeighbors=n===i?1:+i,s.doCannyPruning=n===o?!0:!!o,s.tolerance=null==l?.2:+l,s._haarchanged=!!s.haardata},path:r,dispose:function(){var e=this;return e.haardata=null,e.$super("dispose"),e},haar:function(e){var n=this;return n.haardata=e,n._haarchanged=!0,n},params:function(e){var n=this;return e&&(e[p]("haardata")&&(n.haardata=e.haardata,n._haarchanged=!0),e[p]("baseScale")&&(n.baseScale=+e.baseScale),e[p]("scaleIncrement")&&(n.scaleIncrement=+e.scaleIncrement),e[p]("stepIncrement")&&(n.stepIncrement=+e.stepIncrement),e[p]("minNeighbors")&&(n.minNeighbors=+e.minNeighbors),e[p]("doCannyPruning")&&(n.doCannyPruning=!!e.doCannyPruning),e[p]("tolerance")&&(n.tolerance=+e.tolerance),e[p]("cannyLow")&&(n.cannyLow=+e.cannyLow),e[p]("cannyHigh")&&(n.cannyHigh=+e.cannyHigh),e[p]("selection")&&(n.selection=e.selection||null)),n},serialize:function(){var e,n=this;return e={baseScale:n.baseScale,scaleIncrement:n.scaleIncrement,stepIncrement:n.stepIncrement,minNeighbors:n.minNeighbors,doCannyPruning:n.doCannyPruning,tolerance:n.tolerance,cannyLow:n.cannyLow,cannyHigh:n.cannyHigh},n._haarchanged&&(e.haardata=d(n.haardata),n._haarchanged=!1),e},unserialize:function(e){var n=this;return e[p]("haardata")&&(n.haardata=d(e.haardata,1)),n.baseScale=e.baseScale,n.scaleIncrement=e.scaleIncrement,n.stepIncrement=e.stepIncrement,n.minNeighbors=e.minNeighbors,n.doCannyPruning=e.doCannyPruning,n.tolerance=e.tolerance,n.cannyLow=e.cannyLow,n.cannyHigh=e.cannyHigh,n},metaData:function(n){return n&&e.isWorker?d(this.meta):this.meta},setMetaData:function(e,n){return this.meta=n&&"string"==typeof e?d(e,1):e,this},apply:function(n,r,t,a){var i=this;if(!i.haardata)return n;var o,l,s,c,h,d=n.length,p=d>>>2,m=i.selection||null,v=e.Array32F,g=null,_=null,C=null,b=null,w=e.Util.Filter;return m?m[4]?(o=f(r-1,u(0,m[0]*(r-1))),l=f(t-1,u(0,m[1]*(t-1))),s=f(r-1,u(0,m[2]*(r-1))),c=f(t-1,u(0,m[3]*(t-1)))):(o=f(r-1,u(0,m[0])),l=f(t-1,u(0,m[1])),s=f(r-1,u(0,m[2])),c=f(t-1,u(0,m[3]))):(o=0,l=0,s=r-1,c=t-1),a&&a.haarfilter_SAT?(g=a.haarfilter_SAT,_=a.haarfilter_SAT2,C=a.haarfilter_RSAT):(w.sat(n,r,t,2,0,g=new v(p),_=new v(p),C=new v(p)),a&&(a.haarfilter_SAT=g,a.haarfilter_SAT2=_,a.haarfilter_RSAT=C)),i.doCannyPruning&&(a&&a.haarfilter_GSAT?b=a.haarfilter_GSAT:(b=w.gradient(n,r,t,2,0,1,1),a&&(a.haarfilter_GSAT=b))),h=new Array(y),h.count=0,w.haar_detect(h,r,t,o,l,s,c,i.haardata,i.baseScale,i.scaleIncrement,i.stepIncrement,g,C,_,b,i.cannyLow,i.cannyHigh),h.length>h.count&&(h.length=h.count),i.meta={objects:w.merge_features(h,i.minNeighbors,i.tolerance)},n}})}(n),n});