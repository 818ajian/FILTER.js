/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.2
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(c){function n(c,e){var c=c||{},a;for(a in e)e&&Object.prototype.hasOwnProperty.call(e,a)&&(c[a]=e[a]);return c}c.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;c.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;c.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;c.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;c.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;c.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;c.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;c.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;c.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:c.Array8U;c._notSupportTypedArrays=!c.ImArray.set;c.CONSTANTS={PI:Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI};c.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};c.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};c.LUMA=new c.Array32F([0.212671,0.71516,0.072169]);c.Filter=function(){};c.Filter.prototype={_apply:function(){},apply:function(){},
reset:function(){}};c.CompositeFilter=function(c){this._stack=typeof c!="undefined"&&c.length?c:[]};c.CompositeFilter.prototype={_stack:[],_apply:function(c,e,a){if(!this._stack.length)return c;for(var b=this._stack,d=b.length,g=0,j;g<d;)(j=b[g++])&&(c=j._apply(c,e,a));return c},apply:function(c){if(!this._stack.length)return c;return c.setData(this._apply(im=c.getData(),c.width,c.height))},filters:function(c){if(c)this._stack=c;return this},push:function(c){this._stack.push(c);return this},pop:function(){return this._stack.pop()},
shift:function(){return this._stack.shift()},unshift:function(c){this._stack.unshift(c);return this},concat:function(c){return this.push(c)},getAt:function(c){return this._stack.length>c?this._stack[c]:null},setAt:function(c,e){this._stack.length>c&&(this._stack[c]=e);return this},insertAt:function(c,e){this._stack.splice(c,0,e);return this},removeAt:function(c){this._stack.splice(c,1);return this},remove:function(c){for(var e=this._stack.length;--e>=0;)c===this._stack[e]&&this._stack.splice(e,1);
return this},reset:function(){this._stack.length=0;return this}};c.Create=function(c){var e=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},c=n({init:function(){},reset:function(){return this},apply:function(a){return a}},c);c._apply=c.apply;c.apply=function(a){return a.setData(this._apply(a.getData(),a.width,a.height))};e.prototype=n(e.prototype,c);return e}})(FILTER);
(function(c){var n=Math.sqrt,k=Math.min,e=Math.max;c.Color={blend:function(a,b,d){return{r:a.r-~~((a.r-b.r)*d+0.5),g:a.g-~~((a.g-b.g)*d+0.5),b:a.b-~~((a.b-b.b)*d+0.5)}},toGray:function(a,b,d){var g=c.LUMA;return~~(g[0]*a+g[1]*b+g[2]*d)},distance:function(a,b){var d=a.r-b.r,g=a.g-b.g,c=a.b-b.b;return n(d*d+g*g+c*c)},RGB2Color:function(a){return a.r<<16|a.g<<8|a.b&255},RGBA2Color:function(a){return a.a<<24|a.r<<16|a.g<<8|a.b&255},Color2RGBA:function(a){a=~~a;return{r:a>>16&255,g:a>>8&255,b:a&255,a:a>>
24&255}},RGB2YCbCr:function(a){var b=a.r,d=a.g,a=a.b;return{y:~~(0+0.299*b+0.587*d+0.114*a),cb:~~(128-0.168736*b-0.331264*d+0.5*a),cr:~~(128+0.5*b-0.418688*d-0.081312*a)}},YCbCr2RGB:function(a){var b=a.y,d=a.cb,a=a.cr;return{r:~~(b+1.402*(a-128)),g:~~(b-0.34414*(d-128)-0.71414*(a-128)),b:~~(b+1.772*(d-128))}},RGB2HSV:function(a){var b,d,g,c;d=a.r;g=a.g;c=a.b;b=k(d,g,c);a=e(d,g,c);b=a-b;if(a==0)return{h:0,s:0,v:a};d=d==a?(g-c)/b:g==a?2+(c-d)/b:4+(d-g)/b;d*=60;d<0&&(d+=360);return{h:d,s:b/a,v:a}},HSV2RGB:function(a){var b,
d,g,c,f;g=a.h;f=a.s;a=a.v;if(f==0)return b=d=a,{r:b,g:d,b:a};g/=60;b=~~g;d=g-b;g=a*(1-f);c=a*(1-f*d);f=a*(1-f*(1-d));switch(b){case 0:b=a;d=f;a=g;break;case 1:b=c;d=a;a=g;break;case 2:b=g;d=a;a=f;break;case 3:b=g;d=c;break;case 4:b=f;d=g;break;default:b=a,d=g,a=c}return{r:b,g:d,b:a}}}})(FILTER);
(function(c){function n(d,a){var b=document.createElement("canvas");b.width=d||0;b.height=a||0;return b}var k,e=Math.min,a=c.ImArray;k={normal:function(d){return d},lighten:function(d,a){return a>d?a:d},darken:function(d,a){return a>d?d:a},multiply:function(d,a){return d*a*0.003921568627451},average:function(d,a){return 0.5*(d+a)},add:function(d,a){return Math.min(255,d+a)},substract:function(d,a){return d+a<255?0:d+a-255},difference:function(d,a){return Math.abs(d-a)},negation:function(d,a){return 255-
Math.abs(255-d-a)},screen:function(d,a){return 255-((255-d)*(255-a)>>8)},exclusion:function(d,a){return d+a-2*d*a*0.003921568627451},overlay:function(d,a){return a<128?2*d*a*0.003921568627451:255-2*(255-d)*(255-a)*0.003921568627451},softLight:function(d,a){return a<128?2*((d>>1)+64)*a*0.003921568627451:255-2*(255-((d>>1)+64))*(255-a)*0.003921568627451},hardLight:function(d,a){return d<128?2*a*d*0.003921568627451:255-2*(255-a)*(255-d)*0.003921568627451},colorDodge:function(d,a){return a==255?a:Math.min(255,
(d<<8)/(255-a))},colorBurn:function(d,a){return a==0?a:Math.max(0,255-(255-d<<8)/a)},linearLight:function(d,a){return a<128?k.linearBurn(d,2*a):k.linearDodge(d,2*(a-128))},vividLight:function(d,a){return a<128?k.colorBurn(d,2*a):k.colorDodge(d,2*(a-128))},pinLight:function(d,a){return a<128?k.darken(d,2*a):k.lighten(d,2*(a-128))},hardMix:function(d,a){return k.vividLight(d,a)<128?0:255},reflect:function(d,a){return a==255?a:Math.min(255,d*d/(255-a))},glow:function(d,a){return d==255?d:Math.min(255,
a*a/(255-d))},phoenix:function(d,a){return Math.min(d,a)-Math.max(d,a)+255}};k.linearDodge=k.add;k.linearBurn=k.substract;c.blendModes=k;var b=c._notSupportTypedArrays;c.Image=function(d,a){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=n(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=n(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(d,a)};
c.Image.prototype={width:0,height:0,canvasElement:null,domElement:null,clear:function(){var d=this.context;d.clearRect(0,0,this.width,this.height);this.imageData=d.getImageData(0,0,this.width,this.height);return this},fill:function(d,a,b,c,h){var c=c||this.width,h=h||this.height,s=this.context;s.fillStyle=d||0;s.fillRect(a||0,b||0,c,h);this.imageData=s.getImageData(0,0,this.width,this.height);return this},draw:function(){return this},getPixel:function(d,a){var b=~~(a*this.width+d+0.5),c=this.imageData.data;
return{red:c[b],green:c[b+1],blue:c[b+2],alpha:c[b+3]}},setPixel:function(d,b,c,f,h,s){this.context.putImageData(new a([c&255,f&255,h&255,s&255]),d,b);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new a(this.imageData.data)},_setData:function(d){for(var a=this.imageData.data,b=d.length,c=0,h;c<b;)h=~~d[c],h>255?h=255:h<0&&(h=0),a[c]=h,c++},setData:function(d){b?this._setData(d):this.imageData.data.set(d);
this.context.putImageData(this.imageData,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(d){this.context.putImageData(d,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setWidth:function(d){this._tmpCanvas.width=this.canvasElement.width=this.width=d;this.context=
this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setHeight:function(d){this._tmpCanvas.height=this.canvasElement.height=this.height=d;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setImage:function(d,a){if(typeof d=="undefined"||d==null)return this;var b=
this,c;d instanceof Image||d instanceof HTMLCanvasElement||d instanceof HTMLVideoElement?(c=d,this.width=d instanceof HTMLVideoElement?d.videoWidth:d.width,this.height=d instanceof HTMLVideoElement?d.videoHeight:d.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,this.context=this.canvasElement.getContext("2d"),this.context.drawImage(c,0,0),this.imageData=this.context.getImageData(0,0,this.width,this.height),this._integralRefresh=
this._histogramRefresh=!0):(c=new Image,c.onload=function(){b.width=c.width;b.height=c.height;b._tmpCanvas.width=b.canvasElement.width=b.width;b._tmpCanvas.height=b.canvasElement.height=b.height;b.context=b.canvasElement.getContext("2d");b.context.drawImage(c,0,0);b.imageData=b.context.getImageData(0,0,b.width,b.height);b._histogramRefresh=!0;b._integralRefresh=!0;typeof a!="undefined"&&a.call(b)},c.src=d);c.crossOrigin="";return this},blend:function(a,b,c,f,h){typeof b=="undefined"&&(b="normal");
typeof c=="undefined"&&(c=1);c>1&&(c=1);c<0&&(c=0);typeof f=="undefined"&&(f=0);typeof h=="undefined"&&(h=0);var s=0,r=0;f<0&&(s=-f,f=0);h<0&&(r=-h,h=0);if(!(f>=this.width||h>=this.height)){b=k[b];if(b==void 0||b==null)return this;var o=e(this.width,a.width-s),t=e(this.height,a.height-r),u=this.context.getImageData(f,h,o,t),s=a.context.getImageData(s,r,o,t),a=u.data,s=s.data,m,z,q,p=1-c,v=s.length,A;for(A=0;A<v;A+=4)m=a[A],z=a[A+1],q=a[A+2],r=b(s[A],m),o=b(s[A+1],z),t=b(s[A+2],q),a[A]=r*c+m*p,a[A+
1]=o*c+z*p,a[A+2]=t*c+q*p;this.context.putImageData(u,f,h);this._integralRefresh=this._histogramRefresh=!0;return this}},_refresh:function(){this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},copy:function(a){this.setData(a.getData());this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},clone:function(){return new c.Image(this.canvasElement)},integral:function(){this._integralRefresh&&this._computeIntegral();
return this._integral},_computeIntegral:function(){var a=this.width,b=a*this.height,j=a<<2,f=new c.Array32F(b),h=new c.Array32F(b),b=new c.Array32F(b),s=this.getPixelData().data,r,o,e,k,m,z;for(k=m=z=e=o=r=0;e<a;)k+=s[r],m+=s[r+1],z+=s[r+2],f[o]=k,h[o]=m,b[o]=z,r+=4,o++,e++;r=j;for(k=m=z=e=0;r<imLen;)k+=s[r],m+=s[r+1],z+=s[r+2],f[o]=f[o-a]+k,h[o]=h[o-a]+m,b[o]=b[o-a]+z,r+=4,o++,e++,e>=a&&(k=m=z=e=0);this._integral=[f,h,b];this._integralRefresh=!1},histogram:function(){this._histogramRefresh&&this._computeHistogram();
return this._histogram},_computeHistogram:function(){for(var a=this.getPixelData().data,b=0,j=a.length,f,h,s,r=0,o=0,e=0,k=255,m=255,z=255,q=new c.Array32F(256),p=new c.Array32F(256),v=new c.Array32F(256),A=1/(j>>2),b=0;b<256;)q[b]=0,p[b]=0,v[b]=0,b++;for(b=0;b<j;)f=a[b],h=a[b+1],s=a[b+2],q[f]+=A,p[h]+=A,v[s]+=A,f>r&&(r=f),f<k&&(k=f),h>o&&(o=h),h<m&&(m=h),s>e&&(e=s),s<z&&(z=s),b+=4;this._histogram=[q,p,v];this._histogramRefresh=!1},createImageData:function(a,b){this._tmpCanvas.width=this.canvasElement.width=
this.width=a;this._tmpCanvas.height=this.canvasElement.height=this.height=b;this.context=this.canvasElement.getContext("2d");this.context.createImageData(a,b);return this.imageData=this.context.getImageData(0,0,this.width,this.height)},scale:function(a,b){var a=a||1,b=b||a,c=this._tmpCanvas.getContext("2d");c.scale(a,b);c.drawImage(this.canvasElement,0,0);this.canvasElement.width=this.width=~~(a*this.width+0.5);this.canvasElement.height=this.height=~~(b*this.height+0.5);this.context.drawImage(this._tmpCanvas,
0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipHorizontal:function(){var a=this._tmpCanvas.getContext("2d");a.translate(this.width,0);a.scale(-1,1);a.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=
!0;return this},flipVertical:function(){var a=this._tmpCanvas.getContext("2d");a.translate(0,this.height);a.scale(1,-1);a.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this}}})(FILTER);
(function(c){c.CustomFilter=function(c){this._handler=c};c.CustomFilter.prototype={_handler:null,_apply:function(c,k,e){if(!this._handler)return c;return this._handler.call(this,c,k,e)},apply:function(c){if(!this._handler)return c;return c.setData(this._handler.call(this,c.getData(),c.width,c.height))}}})(FILTER);
(function(c){var n=c.Array32F,k=c.CONSTANTS.toRad,e=c._notSupportTypedArrays;c.ColorMatrixFilter=function(a){this._matrix=typeof a!="undefined"&&a.length?new n(a):null};c.ColorMatrixFilter.prototype={_matrix:null,channel:function(a,b){var d=(typeof b=="undefined"?0:b)?1:0;switch(a){case c.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case c.CHANNEL.BLUE:return this.concat([0,0,d,0,0,0,0,d,0,0,0,0,1,0,0,0,0,0,0,255]);case c.CHANNEL.GREEN:return this.concat([0,d,0,0,
0,0,1,0,0,0,0,d,0,0,0,0,0,0,0,255]);default:return this.concat([1,0,0,0,0,d,0,0,0,0,d,0,0,0,0,0,0,0,0,255])}},redChannel:function(a){return this.channel(c.CHANNEL.RED,a)},greenChannel:function(a){return this.channel(c.CHANNEL.GREEN,a)},blueChannel:function(a){return this.channel(c.CHANNEL.BLUE,a)},alphaChannel:function(){return this.channel(c.CHANNEL.ALPHA,!0)},maskChannel:function(a){switch(a){case c.CHANNEL.ALPHA:return this;case c.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,1,0]);case c.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(a,b){switch(a){case c.CHANNEL.ALPHA:switch(b){case c.CHANNEL.ALPHA:return this;case c.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case c.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case c.CHANNEL.BLUE:switch(b){case c.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case c.CHANNEL.BLUE:return this;case c.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case c.CHANNEL.GREEN:switch(b){case c.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case c.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case c.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(b){case c.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case c.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case c.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([c.LUMA[0],c.LUMA[1],c.LUMA[2],0,0,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,0,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(a,b){var d,g,e,f;typeof b=="undefined"&&(b=1);d=(a>>16&255)*0.00392156862745098;g=(a>>8&255)*0.00392156862745098;e=(a&255)*0.00392156862745098;f=1-b;return this.concat([f+b*d*c.LUMA[0],b*d*c.LUMA[1],b*d*c.LUMA[2],0,0,b*g*c.LUMA[0],f+b*g*c.LUMA[1],b*g*c.LUMA[2],0,0,b*e*c.LUMA[0],b*e*c.LUMA[1],f+b*e*c.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(a){var b,d,g;b=1-a;d=b*c.LUMA[0];g=b*c.LUMA[1];b*=c.LUMA[2];return this.concat([d+a,g,b,0,0,d,g+a,b,0,0,d,g,b+a,0,0,0,0,0,1,0])},contrast:function(a,b,d){typeof b=="undefined"&&(b=a);typeof d=="undefined"&&(d=a);a+=1;b+=1;d+=1;this._log=!0;return this.concat([a,0,0,0,128*(1-a),0,b,0,0,128*(1-b),0,0,d,0,128*(1-d),0,0,0,1,0])},brightness:function(a,b,d){typeof b=="undefined"&&(b=a);typeof d=="undefined"&&(d=a);return this.concat([1,0,0,0,a,0,1,0,0,b,0,0,1,0,d,
0,0,0,1,0])},adjustHue:function(a){a*=k;var b=Math.cos(a),a=Math.sin(a);return this.concat([c.LUMA[0]+b*(1-c.LUMA[0])+a*-c.LUMA[0],c.LUMA[1]+b*-c.LUMA[1]+a*-c.LUMA[1],c.LUMA[2]+b*-c.LUMA[2]+a*(1-c.LUMA[2]),0,0,c.LUMA[0]+b*-c.LUMA[0]+a*0.143,c.LUMA[1]+b*(1-c.LUMA[1])+a*0.14,c.LUMA[2]+b*-c.LUMA[2]+a*-0.283,0,0,c.LUMA[0]+b*-c.LUMA[0]+a*-(1-c.LUMA[0]),c.LUMA[1]+b*-c.LUMA[1]+a*c.LUMA[1],c.LUMA[2]+b*(1-c.LUMA[2])+a*c.LUMA[2],0,0,0,0,0,1,0])},average:function(a,b,d){typeof a=="undefined"&&(a=0.3333);typeof b==
"undefined"&&(b=0.3333);typeof d=="undefined"&&(d=0.3334);return this.concat([a,b,d,0,0,a,b,d,0,0,a,b,d,0,0,0,0,0,1,0])},quickContrastCorrection:function(a){typeof a=="undefined"&&(a=1.2);return this.concat([a,0,0,0,0,0,a,0,0,0,0,0,a,0,0,0,0,0,1,0])},quickSepia:function(a){typeof a=="undefined"&&(a=10);a>100&&(a=100);a*=2.55;return this.concat([c.LUMA[0],c.LUMA[1],c.LUMA[2],0,40,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,20,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,-a,0,0,0,1,0])},quickSepia2:function(a,b,d){typeof a==
"undefined"&&(a=1);typeof b=="undefined"&&(b=a);typeof d=="undefined"&&(d=a);return this.concat([a*0.5,0.5,0.5,0,0,0.33,b*0.33,0.33,0,0,0.25,0.25,d*0.25,0,0,0,0,0,1,0])},threshold:function(a,b){typeof b=="undefined"&&(b=256);return this.concat([c.LUMA[0]*b,c.LUMA[1]*b,c.LUMA[2]*b,0,-(b-1)*a,c.LUMA[0]*b,c.LUMA[1]*b,c.LUMA[2]*b,0,-(b-1)*a,c.LUMA[0]*b,c.LUMA[1]*b,c.LUMA[2]*b,0,-(b-1)*a,0,0,0,1,0])},threshold_rgb:function(a,b){typeof b=="undefined"&&(b=256);return this.concat([b,0,0,0,-(b-1)*a,0,b,0,
0,-(b-1)*a,0,0,b,0,-(b-1)*a,0,0,0,1,0])},threshold_alpha:function(a,b){typeof a=="undefined"&&(a=0.5);typeof b=="undefined"&&(b=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,b,-b*a])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(a,b){var d;if(this._matrix){d=
this._matrix;var c=a.getMatrix(),e=1-b,f=new n(20);f[0]=e*d[0]+b*c[0];f[1]=e*d[1]+b*c[1];f[2]=e*d[2]+b*c[2];f[3]=e*d[3]+b*c[3];f[4]=e*d[4]+b*c[4];f[5]=e*d[5]+b*c[5];f[6]=e*d[6]+b*c[6];f[7]=e*d[7]+b*c[7];f[8]=e*d[8]+b*c[8];f[9]=e*d[9]+b*c[9];f[10]=e*d[10]+b*c[10];f[11]=e*d[11]+b*c[11];f[12]=e*d[12]+b*c[12];f[13]=e*d[13]+b*c[13];f[14]=e*d[14]+b*c[14];f[15]=e*d[15]+b*c[15];f[16]=e*d[16]+b*c[16];f[17]=e*d[17]+b*c[17];f[18]=e*d[18]+b*c[18];f[19]=e*d[19]+b*c[19];d=f}else d=new n(a.getMatrix());this._matrix=
d;return this},concat:function(a){var b;if(this._matrix){b=this._matrix;var a=new n(a),c=new n(20),e,j,f,h,s;e=a[0];j=a[1];f=a[2];h=a[3];s=a[4];c[0]=e*b[0]+j*b[5]+f*b[10]+h*b[15];c[1]=e*b[1]+j*b[6]+f*b[11]+h*b[16];c[2]=e*b[2]+j*b[7]+f*b[12]+h*b[17];c[3]=e*b[3]+j*b[8]+f*b[13]+h*b[18];c[4]=e*b[4]+j*b[9]+f*b[14]+h*b[19]+s;e=a[5];j=a[6];f=a[7];h=a[8];s=a[9];c[5]=e*b[0]+j*b[5]+f*b[10]+h*b[15];c[6]=e*b[1]+j*b[6]+f*b[11]+h*b[16];c[7]=e*b[2]+j*b[7]+f*b[12]+h*b[17];c[8]=e*b[3]+j*b[8]+f*b[13]+h*b[18];c[9]=
e*b[4]+j*b[9]+f*b[14]+h*b[19]+s;e=a[10];j=a[11];f=a[12];h=a[13];s=a[14];c[10]=e*b[0]+j*b[5]+f*b[10]+h*b[15];c[11]=e*b[1]+j*b[6]+f*b[11]+h*b[16];c[12]=e*b[2]+j*b[7]+f*b[12]+h*b[17];c[13]=e*b[3]+j*b[8]+f*b[13]+h*b[18];c[14]=e*b[4]+j*b[9]+f*b[14]+h*b[19]+s;e=a[15];j=a[16];f=a[17];h=a[18];s=a[19];c[15]=e*b[0]+j*b[5]+f*b[10]+h*b[15];c[16]=e*b[1]+j*b[6]+f*b[11]+h*b[16];c[17]=e*b[2]+j*b[7]+f*b[12]+h*b[17];c[18]=e*b[3]+j*b[8]+f*b[13]+h*b[18];c[19]=e*b[4]+j*b[9]+f*b[14]+h*b[19]+s;b=c}else b=new n(a);this._matrix=
b;return this},combineWith:function(a){return this.concat(a.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(a){this._matrix=a;return this},_apply:function(a){if(!this._matrix)return a;for(var b=a.length,c=this._matrix,g=0,j,f,h,s,r,o,t;g<b;)j=a[g],f=a[g+1],h=a[g+2],s=a[g+3],r=c[0]*j+c[1]*f+c[2]*h+c[3]*s+c[4],o=c[5]*j+c[6]*f+c[7]*h+c[8]*s+c[9],t=c[10]*j+c[11]*f+c[12]*h+c[13]*s+c[14],j=c[15]*j+c[16]*f+c[17]*h+c[18]*s+c[19],e&&(r<0?r=0:r>255&&(r=255),o<0?o=0:o>255&&(o=255),
t<0?t=0:t>255&&(t=255),j<0?j=0:j>255&&(j=255)),a[g]=~~r,a[g+1]=~~o,a[g+2]=~~t,a[g+3]=~~j,g+=4;return a},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(c){function n(c){var b=new a(256),d=0;if(c)for(;d<256;)b[d]=255-d,d++;else for(;d<256;)b[d]=d,d++;return b}function k(c){for(var b=new a(256),d=0;d<256;)b[d]=c,d++;return b}function e(c){if(c)return new a(c);return null}var a=c.ImArray,b=Math.pow,d=Math.exp,g=1/255,j=n(),f=n(1);c.TableLookupFilter=function(a,c,b,d){this._tableR=a||null;this._tableG=c||this._tableR;this._tableB=b||this._tableG;this._tableA=d||null};c.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(c,b,d){c.length||(c=[c]);b||(b=c);d||(d=b);var e=c.length,f=e+1,g=b.length,j=g+1,k=d.length,q=k+1,p=new a(256),v=new a(f),A=new a(256),H=new a(j),P=new a(256),U=new a(q),l,R=255/(f-1),M=255/(j-1),N=255/(q-1);for(l=0;l<f;)v[l]=~~(R*l),l++;c[0]=~~(255*c[0]);for(l=1;l<e;)c[l]=c[l-1]+~~(255*c[l]),l++;for(l=0;l<j;)H[l]=~~(M*l),l++;b[0]=~~(255*b[0]);for(l=1;l<g;)b[l]=b[l-1]+~~(255*b[l]),l++;for(l=0;l<q;)U[l]=~~(N*l),l++;d[0]=~~(255*d[0]);for(l=1;l<k;)d[l]=d[l-1]+~~(255*d[l]),l++;for(l=
0;l<256;){for(f=0;f<e&&l>c[f];)f++;p[l]=v[f];for(f=0;f<g&&l>b[f];)f++;A[l]=H[f];for(f=0;f<k&&l>d[f];)f++;P[l]=U[f];l++}return this.concat(p,A,P)},threshold:function(a,c,b){a=a||0.5;c=c||a;return this.thresholds([a],[c],[b||c])},quantize:function(c){typeof c=="undefined"&&(c=64);c<2&&(c=2);var b=new a(256),d=new a(c),e,f=255/(c-1),g=c/256;for(e=0;e<c;)d[e]=~~(f*e),e++;for(e=0;e<256;)b[e]=d[~~(g*e)],e++;return this.concat(b)},levels:function(a){return this.quantize(a)},posterize:function(a){return this.quantize(a)},
binarize:function(){return this.quantize(2)},solarize:function(c){typeof c=="undefined"&&(c=0.5);for(var b=0,d=new a(256),c=~~(c*256)-1,b=0;b<256;)d[b]=b>c?255-(b<<1):(b<<1)-255,b++;return this.concat(d)},invert:function(){return this.concat(f)},mask:function(c){var b=0,d=c>>16&255,e=c>>8&255;c&=255;tR=new a(256);tG=new a(256);tB=new a(256);for(b=0;b<256;)tR[b]=b&d,tG[b]=b&e,tB[b]=b&c,b++;return this.concat(tR,tG,tB)},replace:function(a,c){if(a==c)return this;var b=a>>16&255,d=a>>8&255,f=a&255,g=
c>>16&255,k=c>>8&255,z=c&255,q=e(j),p=e(j),v=e(j);q[b]=g;p[d]=k;v[f]=z;return this.concat(q,p,v)},extract:function(a,b,d){if(!b||!b.length)return this;var d=d||0,e=d>>8&255,f=d&255,d=k(d>>16&255),e=k(e),f=k(f);switch(a){case c.CHANNEL.BLUE:a=b[0];for(b=b[1];a<=b;)f[a]=a,a++;break;case c.CHANNEL.GREEN:a=b[0];for(b=b[1];a<=b;)e[a]=a,a++;break;default:a=b[0];for(b=b[1];a<=b;)d[a]=a,a++}return this.concat(d,e,f)},gammaCorrection:function(c,d,e){for(var c=c||1,d=d||c,e=e||d,c=1/c,d=1/d,e=1/e,f=new a(256),
j=new a(256),k=new a(256),m=0;m<256;)f[m]=~~(255*b(g*m,c)),j[m]=~~(255*b(g*m,d)),k[m]=~~(255*b(g*m,e)),m++;return this.concat(f,j,k)},exposure:function(c){typeof c=="undefined"&&(c=1);for(var b=0,e=new a(256),b=0;b<256;)e[b]=~~(255*(1-d(-c*b*g))),b++;return this.concat(e)},concat:function(a,c,b){if(!a)return this;var c=c||a,b=b||c,d=this._tableR||n(),f,g,j=e(d),k,q,p;if(c&&b){f=this._tableG||e(d);g=this._tableB||e(f);k=e(f);q=e(g);for(p=0;p<256;)d[p]=a[j[p]],f[p]=c[k[p]],g[p]=b[q[p]],p++;this._tableR=
d;this._tableG=f;this._tableB=g}else{for(p=0;p<256;)d[p]=a[j[p]],p++;this._tableB=this._tableG=this._tableR=d}return this},combineWith:function(a){return this.concat(a.getTable(0),a.getTable(1),a.getTable(2))},getTable:function(a){a=a||c.CHANNEL.RED;switch(a){case c.CHANNEL.ALPHA:return this._tableA;case c.CHANNEL.BLUE:return this._tableB;case c.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(a,b){b=b||c.CHANNEL.RED;switch(b){case c.CHANNEL.ALPHA:return this._tableA=
a,this;case c.CHANNEL.BLUE:return this._tableB=a,this;case c.CHANNEL.GREEN:return this._tableG=a,this;default:return this._tableR=a,this}},_apply:function(a){if(!this._tableR)return a;var c=a.length,b=0,d,e,f,g,j=this._tableR,k=this._tableG,p=this._tableB,v=this._tableA;if(v)for(;b<c;)d=a[b],e=a[b+1],f=a[b+2],g=a[b+3],a[b]=j[d],a[b+1]=k[e],a[b+2]=p[f],a[b+3]=v[g],b+=4;else for(;b<c;)d=a[b],e=a[b+1],f=a[b+2],a[b]=j[d],a[b+1]=k[e],a[b+2]=p[f],b+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(c){var n=c.ImArray,k=Math.min;c.DisplacementMapFilter=function(c){c&&this.setMap(c)};c.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:c.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(c){this._map=c;return this},_apply:function(e,a,b){if(!this._map)return e;var d=this._map.getData(),g=this._map.width,j=this._map.height,f=g*j,h=new c.Array16I(f<<1),s=k(g,a),r=k(j,b),o=
this.scaleX*0.00390625,t=this.scaleY*0.00390625,u=this.componentX,m=this.componentY,j=this.color>>24&255,z=this.color>>16&255,q=this.color>>8&255,p=this.color&255,v=~~this.startY,A=~~this.startX,H=this.mode,P=v*a,U=-A,l=-v,R=a-A-1,M=b-v-1,N,Q,V,X,Y,da=s*r<<2,D=new n(e),I=c.MODE.IGNORE,w=c.MODE.COLOR,S=c.MODE.WRAP;for(X=V=Q=N=r=0;r<f;)Y=Q+X<<2,h[N]=~~((d[Y+u]-128)*o),h[N+1]=~~((d[Y+m]-128)*t),r++,N+=2,Q++,Q>=g&&(Q=0,V++,X+=g);r=-4;Q=-1;for(ty2=X=V=0;r<da;)if(r+=4,Q++,Q>=s&&(Q=0,V++,X+=a,ty2+=g),!(V<
l||V>M||Q<U||Q>R)){o=Q+A;f=V+v;d=o+X+P<<2;N=Q+ty2<<1;srcx=o+h[N];srcy=f+h[N+1];if(srcy>=b||srcy<0||srcx>=a||srcx<0)switch(H){case I:continue;case w:D[d]=z;D[d+1]=q;D[d+2]=p;D[d+3]=j;continue;case S:srcy>M&&(srcy-=b);srcy<0&&(srcy+=b);srcx>R&&(srcx-=a);srcx<0&&(srcx+=a);break;default:srcy>M&&(srcy=M),srcy<0&&(srcy=0),srcx>R&&(srcx=R),srcx<0&&(srcx=0)}N=srcx+srcy*a<<2;D[d]=e[N];D[d+1]=e[N+1];D[d+2]=e[N+2];D[d+3]=e[N+3]}return D},apply:function(c){if(!this._map)return c;return c.setData(this._apply(c.getData(),
c.width,c.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(c){function n(a,c){var b,d,e,f,l,g=a.length,j=new r(g);for(e=d=b=f=0;f<g;)l=c-1-b+e<<2,j[f]=a[l],j[f+1]=a[l+1],j[f+2]=a[l+2],j[f+3]=a[l+3],f+=4,b++,b>=c&&(b=0,d++,e+=c);return j}function k(a,c,b){var d,e,f,l,g=a.length,j=new r(g);e=d=f=0;for(b=(b-1)*c;f<g;)l=d+b<<2,j[f]=a[l],j[f+1]=a[l+1],j[f+2]=a[l+2],j[f+3]=a[l+3],f+=4,d++,d>=c&&(d=0,e++,b-=c);return j}function e(a,c,b){var d,e,f,l,g,j=a.length,h=new r(j);e=d=l=0;for(b=(b-1)*c;l<j;)g=c-1-d+b<<2,h[l]=a[g],h[l+1]=a[g+1],h[l+2]=a[g+2],h[l+
3]=a[g+3],l+=4,d++,d>=c&&(d=0,e++,f+=c,b-=c);return h}function a(a,c,b){var d,e,f,l,g=a.length,j=new r(g),h=b*c;d=b=f=0;for(e=h-1;f<g;)l=d+e<<2,j[f]=a[l],j[f+1]=a[l+1],j[f+2]=a[l+2],j[f+3]=a[l+3],f+=4,b++,e-=c,b>=c&&(b=0,e=h-1,d++);return j}function b(a,c){var b,d,e,f,l,g=a.length,j=new r(g);for(e=d=b=f=0;f<g;)l=c-1-d+e<<2,j[f]=a[l],j[f+1]=a[l+1],j[f+2]=a[l+2],j[f+3]=a[l+3],f+=4,b++,e+=c,b>=c&&(e=b=0,d++);return j}function d(a,b,d){var f,e,g,l,j=a.length,h=new r(j),k=this.inverseTransform,o=this.mode,
s=c.MODE.WRAP,m;for(e=f=g=0;g<j;){m=k([f,e],b,d);l=~~m[0];m=~~m[1];if(0>l||l>=b||0>m||m>=d)switch(o){case s:m>=d&&(m-=d);m<0&&(m+=d);l>=b&&(l-=b);l<0&&(l+=b);break;default:m>=d&&(m=d-1),m<0&&(m=0),l>=b&&(l=b-1),l<0&&(l=0)}l=l+m*b<<2;h[g]=a[l];h[g+1]=a[l+1];h[g+2]=a[l+2];h[g+3]=a[l+3];g+=4;f++;f>=b&&(f=0,e++)}return h}function g(a,b,d){var f,e,g,l,j=b*d,h=a.length,k=new r(h),o=this.a,m=this.b,s=this.c,t=this.d,q=this.mode,D=c.MODE.WRAP,I,w=b-1,u=j-b;e=f=d=g=0;for(t*=b;g<h;){l=~~(o*d+s);I=~~(m*e+t);
if(0>l||l>w||0>I||I>u)switch(q){case D:I>u&&(I-=j);I<0&&(I+=j);l>=b&&(l-=b);l<0&&(l+=b);break;default:I>u&&(I=u),I<0&&(I=0),l>w&&(l=w),l<0&&(l=0)}l=l+I<<2;k[g]=a[l];k[g+1]=a[l+1];k[g+2]=a[l+2];k[g+3]=a[l+3];g+=4;d++;d>=b&&(d=0,f++,e+=b)}return k}function j(a,b,d){if(0>=this.radius)return a;var f,e,g,l,j=a.length,h=new r(a),k=this.centerX,s=this.centerY,q=this.radius,z=this.mode,Y=c.MODE.WRAP,n,D,I=this.angle/q,w=b-1,S=d-1;for(e=f=g=0;g<j;){n=f-k;D=e-s;l=o(n*n+D*D);if(l<q){D=t(D,n)+I*(q-l);n=~~(k+
l*m(D));D=~~(s+l*u(D));if(0>n||n>w||0>D||D>S)switch(z){case Y:D>S&&(D-=d);D<0&&(D+=d);n>w&&(n-=b);n<0&&(n+=b);break;default:D>S&&(D=S),D<0&&(D=0),n>w&&(n=w),n<0&&(n=0)}l=n+D*b<<2;h[g]=a[l];h[g+1]=a[l+1];h[g+2]=a[l+2];h[g+3]=a[l+3]}g+=4;f++;f>=b&&(f=0,e++)}return h}function f(a,b,d){if(0>=this.radius)return a;var f,e,g,l,j=a.length,h=new r(a),k=this.centerX,m=this.centerY;f=this.radius;var s=this.mode,t=c.MODE.WRAP,n,u=f*f,D=1-0.555556,I,w,S,G,E=b-1,x=d-1;for(e=f=g=0;g<j;){l=f-k;n=e-m;S=l*l;G=n*n;
I=S+G;if(I<u){w=u-I;I=o(w);l=z(l/o(S+w))*D;n=z(n/o(G+w))*D;l=~~(f-I*q(l));n=~~(e-I*q(n));if(0>l||l>E||0>n||n>x)switch(s){case t:n>x&&(n-=d);n<0&&(n+=d);l>E&&(l-=b);l<0&&(l+=b);break;default:n>x&&(n=x),n<0&&(n=0),l>E&&(l=E),l<0&&(l=0)}l=l+n*b<<2;h[g]=a[l];h[g+1]=a[l+1];h[g+2]=a[l+2];h[g+3]=a[l+3]}g+=4;f++;f>=b&&(f=0,e++)}return h}function h(a){return a}function s(a){return a}var r=c.ImArray,o=Math.sqrt,t=Math.atan2,u=Math.sin,m=Math.cos,z=Math.asin,q=Math.tan;c.GeometricMapFilter=function(a){this.generic(a)};
c.GeometricMapFilter.prototype={_map:null,inverseTransform:null,a:1,b:1,c:0,d:0,centerX:0,centerY:0,angle:0,radius:0,mode:c.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=d;return this},affine:function(a,b,c,d){this.a=a;this.b=b;this.c=c;this.d=d;this._map=g;return this},flipX:function(){this._map=n;return this},flipY:function(){this._map=k;return this},flipXY:function(){this._map=e;return this},rotateCW:function(){this._map=a;return this},rotateCCW:function(){this._map=b;return this},
polar:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=h;return this},cartesian:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=s;return this},twirl:function(a,b,c,d){this.angle=a||0;this.radius=b||0;this.centerX=c||0;this.centerY=d||0;this._map=j;return this},sphere:function(a,b,c){this.radius=a||0;this.centerX=b||0;this.centerY=c||0;this._map=f;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},
_apply:function(a,b,c){if(!this._map)return a;return this._map.call(this,a,b,c)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(c){function n(a,b,c,d){var f=a.length,e,g=new o(a.length),c=c||1,d=d||1;for(e=0;e<f;)g[e]=c*a[e]+d*b[e],e++;return g}function k(a,b){var c,d,f=a.length,e,g=[],j=0;for(c=0;c<f;c++)for(d=0;d<f;d++)e=a[c]*b[d],j+=e,g.push(e);return{kernel:g,sum:j}}function e(a){var b,c=Array(a);for(b=0;b<a;)c[b]=0,b++;c[a>>1]=1;return c}function a(a){var b,c=Array(a);for(b=0;b<a;)c[b]=1,b++;return c}function b(a){var b=u.length,c,d;a--;if(a<b)c=u[a].slice();else for(c=new o(u[b-1]);b<=a;){d=c.slice();c=[1];
i=0;for(il=d.length-1;i<il;i++)c.push(d[i]+d[i+1]);c.push(1);b<40&&u.push(c.slice());b++}return c}function d(a){var b,c=-(a>>1),d=Array(a);for(b=0;b<a;)d[b]=c,c++,b++;return d}function g(a){a=b(a);return k(a,a)}function j(a,c){var f=b(a),e=d(a);return 1==c?k(e.reverse(),f):k(f,e)}function f(b,c){var f=a(b),e=d(b);return 1==c?k(e.reverse(),f):k(f,e)}function h(a,b){var b=b||1,c=a*a,d,f=new o(c);for(d=0;d<c;)f[d]=b,d++;return f}function s(a,b,d,f,e,g,j,h,k,o){var m=a.length,s,q,p,n,w,v,u,z,x,C,F,T,
W,K,B,J,O,Z,$,L,ba,ca,aa;s=b*d;w=g*j;g>>=1;j=b*(j>>1);d=-g-1;z=-j-b;Z=b-1;$=s-b;s=(s<<1)+s;u=(b<<1)+b;o=o||1;aa=0;if(e){F=f[0];f=f[w>>1];f-=F;T=e[0];e=e[w>>1];for(W=e-T;aa<o;){v=new r(a);e=new c.Array32F(s);for(q=p=n=C=x=w=0;C<b;)q+=a[w],p+=a[w+1],n+=a[w+2],e[x]=q,e[x+1]=p,e[x+2]=n,w+=4,x+=3,C++;w=u+b;x=u;for(q=p=n=C=0;w<m;)q+=a[w],p+=a[w+1],n+=a[w+2],e[x]=e[x-u]+q,e[x+1]=e[x-u+1]+p,e[x+2]=e[x-u+2]+n,w+=4,x+=3,C++,C>=b&&(q=p=n=C=0);for(p=q=C=w=0;w<m;)K=C+d,B=p+z,J=C+g,O=p+j,K<0?K=0:J>Z&&(J=Z),B<0?
B=0:O>$&&(O=$),n=K+B,x=J+O,B=J+B,L=K+O,n=(n<<1)+n,B=(B<<1)+B,L=(L<<1)+L,x=(x<<1)+x,J=F*(e[x]-e[B]-e[L]+e[n])+f*a[w],O=F*(e[x+1]-e[B+1]-e[L+1]+e[n+1])+f*a[w+1],K=F*(e[x+2]-e[B+2]-e[L+2]+e[n+2])+f*a[w+2],ba=T*(e[x]-e[B]-e[L]+e[n])+W*a[w],ca=T*(e[x+1]-e[B+1]-e[L+1]+e[n+1])+W*a[w+1],x=T*(e[x+2]-e[B+2]-e[L+2]+e[n+2])+W*a[w+2],n=h*J+k*ba,B=h*O+k*ca,x=h*K+k*x,t&&(n<0?n=0:n>255&&(n=255),B<0?B=0:B>255&&(B=255),x<0?x=0:x>255&&(x=255)),v[w]=~~n,v[w+1]=~~B,v[w+2]=~~x,w+=4,C++,C>=b&&(C=0,q++,p+=b);a=v;aa++}}else{F=
f[0];f=f[w>>1];f-=F;h=h||1;for(k=k||0;aa<o;){v=new r(a);e=new c.Array32F(s);for(q=p=n=C=x=w=0;C<b;)q+=a[w],p+=a[w+1],n+=a[w+2],e[x]=q,e[x+1]=p,e[x+2]=n,w+=4,x+=3,C++;w=u+b;x=u;for(q=p=n=C=0;w<m;)q+=a[w],p+=a[w+1],n+=a[w+2],e[x]=e[x-u]+q,e[x+1]=e[x-u+1]+p,e[x+2]=e[x-u+2]+n,w+=4,x+=3,C++,C>=b&&(q=p=n=C=0);for(p=q=C=w=0;w<m;)K=C+d,B=p+z,J=C+g,O=p+j,K<0?K=0:J>Z&&(J=Z),B<0?B=0:O>$&&(O=$),n=K+B,x=J+O,B=J+B,L=K+O,n=(n<<1)+n,B=(B<<1)+B,L=(L<<1)+L,x=(x<<1)+x,J=F*(e[x]-e[B]-e[L]+e[n])+f*a[w],O=F*(e[x+1]-e[B+
1]-e[L+1]+e[n+1])+f*a[w+1],K=F*(e[x+2]-e[B+2]-e[L+2]+e[n+2])+f*a[w+2],n=h*J+k,B=h*O+k,x=h*K+k,t&&(n<0?n=0:n>255&&(n=255),B<0?B=0:B>255&&(B=255),x<0?x=0:x>255&&(x=255)),v[w]=~~n,v[w+1]=~~B,v[w+2]=~~x,w+=4,C++,C>=b&&(C=0,q++,p+=b);a=v;aa++}}return v}var r=c.ImArray,o=c.Array32F,t=c._notSupportTypedArrays,u=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],m=c.CONSTANTS.toRad,z=Math.abs,q=Math.sqrt,p=Math.sin,v=Math.cos;c.ConvolutionMatrixFilter=
function(a,b,c){typeof a!="undefined"&&a.length?(this.set(a,~~(q(a.length)+0.5),b||1),this._bias=c||0):(this._matrix=null,this._dim=0);this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0};c.ConvolutionMatrixFilter.prototype={_dim:0,_matrix:null,_factor:1,_bias:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(h(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,b){var a=typeof a=="undefined"?3:a%2?a:a+1,c=a*a,d=-(typeof b=="undefined"?1:b)/c,e=h(a,
d);e[c>>1]=1+d;this.set(e,a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},verticalBlur:function(b){var b=typeof b=="undefined"?3:b%2?b:b+1,c,d=b;c=e(d);d=a(d);c=k(d,c);return this.set(c.kernel,b,1/c.sum)},horizontalBlur:function(b){var b=typeof b=="undefined"?3:b%2?b:b+1,c,d=b;c=e(d);d=a(d);c=k(c,d);return this.set(c.kernel,b,1/c.sum)},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=g(a);return this.set(b.kernel,a,1/b.sum)},binomialHighPass:function(a){var a=
typeof a=="undefined"?3:a%2?a:a+1,b=g(a);return this.set(n(h(a),new o(b.kernel),1,-1/b.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},fastGauss:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(h(b),b,1/(b*b));this._doFast=a;return this},sharpen:function(a,b){a=typeof a=="undefined"?0.5:a;return a<=0?this.set([0,-2,0,-2,10,-2,0,-2,0],3,0.5):this.highPass(b,a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(f(a,0).kernel,
a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(f(a,1).kernel,a,1)},prewittDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=m;var c=v(a),d=p(a),e=f(b,0),g=f(b,1);return this.set(n(new o(e.kernel),new o(g.kernel),c,d),b,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=f(a,0),c=f(a,1);this.set(b.kernel,a,1);this._isGrad=!0;this._matrix2=new o(c.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},
gradDirectional:function(a,b){return this.prewittDirectional(a,b)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(j(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(j(a,1).kernel,a,1)},sobelDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=m;var c=v(a),d=p(a),e=j(b,0),f=j(b,1);return this.set(n(new o(e.kernel),new o(f.kernel),c,d),b,1)},sobel:function(a){var a=typeof a=="undefined"?
3:a%2?a:a+1,b=j(a,0),c=j(a,1);this.set(b.kernel,a,1);this._matrix2=new o(c.kernel);this._isGrad=!0;return this},laplace:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=h(a,-1),c=a*a;b[c>>1]=c-1;this.set(b,a,1);this._doFast=1;return this},emboss:function(a,b,c){var c=typeof c=="undefined"?3:c%2?c:c+1,a=typeof a=="undefined"?-0.25*Math.PI:a*m,b=b||1,d=b*v(a),a=-b*p(a),b=c,e=b*b,f=b>>1,g,j=new o(e),h,k,n;h=n=-f*d;k=-f*a;for(g=f=0;f<e;)j[f]=h+k,f++,g++,h+=d,g>=b&&(g=0,h=n,k+=a);j[c*c>>1]=1;return this.set(j,
c,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,b,c){this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;this._matrix=new o(a);this._dim=b;this._factor=c||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,b){this._matrix=a;this._dim=b;this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;return this},_apply:function(a,b,d){if(!this._matrix)return a;
if(this._doFast)return this._matrix2?s(a,b,d,this._matrix,this._matrix2,this._dim,this._dim,this._coeff1,this._coeff2,this._doFast):s(a,b,d,this._matrix,null,this._dim,this._dim,this._factor,this._bias,this._doFast);var e=this._dim,f=this._dim,g=e>>1,j=e*f,h=(f>>1)*b,f=this._matrix,k=this._factor,n=this._bias,o=this._matrix2,m,q=this._isGrad,p=new c.Array16I(j<<1),v=new c.Array8U(j),w=b*d,d=a.length,u=new r(d),G,E,x,C,F,T,W=b-1,K=w-b,B=this._coeff1,J=this._coeff2;for(C=x=w=E=G=0;E<j;)v[E]=w+x,p[G]=
w-g,p[G+1]=C-h,G+=2,E++,w++,w>=e&&(w=0,x+=e,C+=b);if(o)for(x=w=e=0;e<d;){for(E=G=k=n=T=g=h=C=0;E<j;)F=w+p[G],m=x+p[G+1],F>=0&&F<=W&&m>=0&&m<=K&&(F=F+m<<2,m=f[v[E]],C+=a[F]*m,h+=a[F+1]*m,g+=a[F+2]*m,m=o[v[E]],T+=a[F]*m,n+=a[F+1]*m,k+=a[F+2]*m),G+=2,E++;q?(G=z(C)+z(T),E=z(h)+z(n),g=z(g)+z(k)):(G=B*C+J*T,E=B*h+J*n,g=B*g+J*k);t&&(G<0?G=0:G>255&&(G=255),E<0?E=0:E>255&&(E=255),g<0?g=0:g>255&&(g=255));u[e]=~~G;u[e+1]=~~E;u[e+2]=~~g;u[e+3]=a[e+3];e+=4;w++;w>=b&&(w=0,x+=b)}else for(x=w=e=0;e<d;){for(E=G=g=
h=C=0;E<j;)F=w+p[G],m=x+p[G+1],F>=0&&F<=W&&m>=0&&m<=K&&(F=F+m<<2,m=f[v[E]],C+=a[F]*m,h+=a[F+1]*m,g+=a[F+2]*m),G+=2,E++;G=k*C+n;E=k*h+n;g=k*g+n;t&&(G<0?G=0:G>255&&(G=255),E<0?E=0:E>255&&(E=255),g<0?g=0:g>255&&(g=255));u[e]=~~G;u[e+1]=~~E;u[e+2]=~~g;u[e+3]=a[e+3];e+=4;w++;w>=b&&(w=0,x+=b)}return u},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(c){var n=c.ImArray,k=function(a,b,e){var f=this._dim,h=f>>1,k=f*f,r=h*b,o=new c.Array32I(k<<1),t=b*e,e=a.length,u=new n(e),m,z,q=[],p=[],v=[];k<<=1;var A=b-1,H=t-b;for(z=t=m=0;m<k;)o[m]=t-h,o[m+1]=z-r,m+=2,t++,t>=f&&(t=0,z+=b);for(z=t=f=0;f<e;){q.length=0;p.length=0;for(m=v.length=0;m<k;)h=t+o[m],r=z+o[m+1],h>=0&&h<=A&&r>=0&&r<=H&&(h=h+r<<2,q.push(a[h]),p.push(a[h+1]),v.push(a[h+2])),m+=2;q.sort();p.sort();v.sort();m=(q.length>>1)+1;(h=q.length%2)?(u[f]=q[m],u[f+1]=p[m],u[f+2]=v[m]):(u[f]=
~~(0.5*(q[m-1]+q[m])),u[f+1]=~~(0.5*(p[m-1]+p[m])),u[f+2]=~~(0.5*(v[m-1]+v[m])));u[f+3]=a[f+3];f+=4;t++;t>=b&&(t=0,y++,z+=b)}return u},e=function(a,b,e){var f=this._dim,h=f>>1,k=f*f,r=h*b,o=new c.Array32I(k<<1),t=b*e,e=a.length,u=new n(e),m,z,q,p,v,A;k<<=1;var H=b-1,P=t-b;for(z=m=t=0;t<k;)o[t]=m-h,o[t+1]=z-r,t+=2,m++,m>=f&&(m=0,z+=b);for(z=m=f=0;f<e;){for(t=A=r=h=0;t<k;)q=m+o[t],p=z+o[t+1],q>=0&&q<=H&&p>=0&&p<=P&&(v=q+p<<2,q=a[v],p=a[v+1],v=a[v+2],q>h&&(h=q),p>r&&(r=p),v>A&&(A=v)),t+=2;u[f]=h;u[f+
1]=r;u[f+2]=A;u[f+3]=a[f+3];f+=4;m++;m>=b&&(m=0,z+=b)}return u},a=function(a,b,e){var f=this._dim,h=f>>1,k=f*f,r=h*b,o=new c.Array32I(k<<1),t=b*e,e=a.length,u=new n(e),m,z,q,p,v,A;k<<=1;var H=b-1,P=t-b;for(z=m=t=0;t<k;)o[t]=m-h,o[t+1]=z-r,t+=2,m++,m>=f&&(m=0,z+=b);for(z=m=f=0;f<e;){A=r=h=255;for(t=0;t<k;)q=m+o[t],p=z+o[t+1],q>=0&&q<=H&&p>=0&&p<=P&&(v=q+p<<2,q=a[v],p=a[v+1],v=a[v+2],q<h&&(h=q),p<r&&(r=p),v<A&&(A=v)),t+=2;u[f]=h;u[f+1]=r;u[f+2]=A;u[f+3]=a[f+3];f+=4;m++;m>=b&&(m=0,z+=b)}return u},b=
function(a){return a};c.StatisticalFilter=function(){this._dim=0;this._apply=b};c.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=k;return this},erode:function(b){this._dim=typeof b=="undefined"?3:b;this._apply=a;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=e;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},
reset:function(){this._apply=b;this._dim=0;return this}}})(FILTER);(function(c){var n=c._notSupportTypedArrays;c.NoiseFilter=c.Create({min:-127,max:127,init:function(c,e){this.min=c||-127;this.max=e||127},apply:function(c){var e=this.max-this.min,a=Math.random,b=this.min,d,g=c.length,j,f,h,s;for(d=0;d<g;)f=c[d],h=c[d+1],s=c[d+2],j=e*a()+b,f+=j,h+=j,j=s+j,n&&(f<0?f=0:f>255&&(f=255),h<0?h=0:h>255&&(h=255),j<0?j=0:j>255&&(j=255)),c[d]=~~f,c[d+1]=~~h,c[d+2]=~~j,d+=4;return c}})})(FILTER);
(function(c){var n=c._notSupportTypedArrays;c.HistogramEqualizeFilter=c.Create({apply:function(k){var e,a,b,d;d=0;var g=255,j=new c.Array32F(256),f=new c.Array32F(256),h=0,s,r,o,t=k.length;o=t>>2;s=1/o;var u=Array(o);r=c.Color.RGB2YCbCr;var m=c.Color.YCbCr2RGB;for(o=0;o<256;)j[o]=0,f[o]=0,o++;for(h=o=0;o<t;){e=k[o];a=k[o+1];b=k[o+2];e=r({r:e,g:a,b:b});j[e.y]+=s;if(e.y>d)d=e.y;if(e.y<g)g=e.y;u[h]=e;o+=4;h++}for(o=h=0;o<256;)h+=j[o],f[o]=h,o++;d-=g;for(h=o=0;o<t;)e=u[h],e.y=f[e.y]*d+g,r=m(e),j=r.r,
s=r.g,r=r.b,n&&(j<0?j=0:j>255&&(j=255),s<0?s=0:s>255&&(s=255),r<0?r=0:r>255&&(r=255)),k[o]=~~j,k[o+1]=~~s,k[o+2]=~~r,o+=4,h++;return k}})})(FILTER);
(function(c){var n=c._notSupportTypedArrays;c.RGBHistogramEqualizeFilter=c.Create({apply:function(k){var e,a,b,d,g,j;j=g=d=0;var f=255,h=255,s=255,r=new c.Array32F(256),o=new c.Array32F(256),t=new c.Array32F(256),u=new c.Array32F(256),m=new c.Array32F(256),z=new c.Array32F(256),q,p=k.length,v=1/(p>>2);for(q=0;q<256;)r[q]=0,o[q]=0,t[q]=0,u[q]=0,m[q]=0,z[q]=0,q++;for(q=0;q<p;)e=k[q],a=k[q+1],b=k[q+2],r[e]+=v,o[a]+=v,t[b]+=v,e>d&&(d=e),e<f&&(f=e),a>g&&(g=a),a<h&&(h=a),b>j&&(j=b),b<s&&(s=b),q+=4;for(q=
b=a=e=0;q<256;)b+=r[q],u[q]=b,a+=o[q],m[q]=a,e+=t[q],z[q]=e,q++;d-=f;g-=h;j-=s;for(q=0;q<p;)e=k[q],a=k[q+1],b=k[q+2],e=u[e]*d+f,a=m[a]*g+h,b=z[b]*j+s,n&&(e<0?e=0:e>255&&(e=255),a<0?a=0:a>255&&(a=255),b<0?b=0:b>255&&(b=255)),k[q]=~~e,k[q+1]=~~a,k[q+2]=~~b,q+=4;return k}})})(FILTER);
(function(c){var n=Math.sqrt,k=c._notSupportTypedArrays;c.PixelateFilter=c.Create({scale:1,init:function(c){this.scale=c||1},apply:function(e,a,b){if(this.scale<=1)return e;if(this.scale>100)this.scale=100;var d=e.length,g=a*b,b=~~(n(g)*this.scale*0.01),j=b*b,f=1/j,h=b<<2,s=a*b;j<<=2;var r=new c.Array32F(g*3),o,t,u,m=(a<<1)+a,z,q,p,v,A,H,P,U,l,R,M;z=b-1;q=(b-1)*a;l=a-1;R=g-a;for(o=t=u=v=p=g=0;v<a;)o+=e[g],t+=e[g+1],u+=e[g+2],r[p]=o,r[p+1]=t,r[p+2]=u,g+=4,p+=3,v++;g=m+a;p=m;for(o=t=u=v=0;g<d;)o+=e[g],
t+=e[g+1],u+=e[g+2],r[p]=r[p-m]+o,r[p+1]=r[p-m+1]+t,r[p+2]=r[p-m+2]+u,g+=4,p+=3,v++,v>=a&&(o=t=u=v=0);for(m=v=g=0;g<d;){o=v;A=m;H=v+z;t=m+q;H>l&&(H=l);t>R&&(t=R);p=o+A;u=H+t;A=H+A;H=o+t;p=(p<<1)+p;A=(A<<1)+A;H=(H<<1)+H;u=(u<<1)+u;o=f*(r[u]-r[A]-r[H]+r[p]);t=f*(r[u+1]-r[A+1]-r[H+1]+r[p+1]);M=f*(r[u+2]-r[A+2]-r[H+2]+r[p+2]);k&&(o<0?o=0:o>255&&(o=255),t<0?t=0:t>255&&(t=255),M<0?M=0:M>255&&(M=255));o=~~o;t=~~t;M=~~M;p=g;A=v;H=m;U=v+b;u=g+j;for(u>d&&(u=d);p<u;)if(P=A+H<<2,e[P]=o,e[P+1]=t,e[P+2]=M,p+=4,
A++,A>=a||A>=U)A=v,H+=a;g+=h;v+=b;v>=a&&(v=0,m+=s)}return e}})})(FILTER);(function(c){var n=c._notSupportTypedArrays;c.HSVConverterFilter=c.Create({apply:function(k,e,a){for(var b,d,g=k.length,j=c.Color.RGB2HSV,e=0;e<g;)b=k[e],a=k[e+1],d=k[e+2],d=j({r:b,g:a,b:d}),a=d.h*0.7083333333333334,b=d.s*255,d=d.v,n&&(a<0?a=0:a>255&&(a=255),d<0?d=0:d>255&&(d=255),b<0?b=0:b>255&&(b=255)),k[e]=~~a,k[e+1]=~~d,k[e+2]=~~b,e+=4;return k}})})(FILTER);
(function(c){var n=c._notSupportTypedArrays;c.HueExtractorFilter=c.Create({range:null,background:0,init:function(c,e){this.range=c;this.range.sort();this.background=e||0},apply:function(k){if(!this.range||!this.range.length)return k;var e,a,b,d,g,j,f=k.length,h,s=c.Color.RGB2HSV,r=this.range[0],o=this.range[this.range.length-1];d=new c.ImArray(f);h=c.Color.Color2RGBA(this.background||0);for(j=0;j<f;)e=k[j],a=k[j+1],b=k[j+2],e=s({r:e,g:a,b:b}).h,e>=r&&e<=o?(e=k[j],a=k[j+1],b=k[j+2],g=k[j+3]):(e=h.r,
a=h.g,b=h.b,g=h.a),n&&(e<0?e=0:e>255&&(e=255),a<0?a=0:a>255&&(a=255),b<0?b=0:b>255&&(b=255),g<0?g=0:g>255&&(g=255)),d[j]=~~e,d[j+1]=~~a,d[j+2]=~~b,d[j+3]=~~g,j+=4;return d}})})(FILTER);
(function(c){c.AlphaMaskFilter=c.Create({alphaMask:null,centerX:0,centerY:0,init:function(c,k,e){this.alphaMask=c||null;this.centerX=k||0;this.centerY=e||0},apply:function(c,k,e){if(!this.alphaMask)return c;var a=this.alphaMask.getData(),b=c.length,d=this.alphaMask.width,g=this.alphaMask.height,j,f,h,s=Math.min(k,d),r=Math.min(e,g),o,t;o=this.centerX+(k-d>>1);t=this.centerY+(e-g>>1);for(j=g=e=0;e<b;)f=g-o,h=j-t,f>=0&&f<s&&h>=0&&h<r?(f=f+h*d<<2,c[e+3]=a[f+3]):c[e+3]=0,e+=4,g++,g>=k&&(g=0,j++);return c}})})(FILTER);
