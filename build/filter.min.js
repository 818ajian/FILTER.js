/**
*
*   FILTER.js
*   @version: 0.6.10
*   @dependencies: Classy.js
*
*   JavaScript Image Processing Library
*   https://github.com/foo123/FILTER.js
*
**/!function(t,e,i,n,r){var s="undefined"!=typeof global&&"[object global]"==={}.toString.call(global),a=!s&&"undefined"!=typeof navigator,h="function"==typeof importScripts&&navigator instanceof WorkerNavigator,l=Array,o=l.prototype,u=function(){var t=null;if(s)return t=__filename,{path:__dirname,file:__filename};if(h)t=self.location.href;else if(a){var e;(e=document.getElementsByTagName("script"))&&e.length&&(t=e[e.length-1].src)}return t?{path:t.split("/").slice(0,-1).join("/"),file:t}:{path:null,file:null}},c=u(),f=function(t,e){if(s)return e;if("."==e.charAt(0)){t=t.split("/"),e=e.split("/");var i,n=0,r=0,a=e.length,h=t.length;for(i=0;a>i;i++)if(/^\.\./.test(e[i]))n++,r++;else{if(!/^\./.test(e[i]))break;r++}n=n>=h?0:h-n,e=t.slice(0,n).concat(e.slice(r)).join("/")}return e};i=i?[].concat(i):[];var m,d,_,p=i.length,g=new l(p),v=new l(p),w=new l(p),A=new l(p);for(m=0;p>m;m++)g[m]=i[m][0],v[m]=i[m][1],w[m]=/\.js$/i.test(v[m])?f(c.path,v[m]):f(c.path,v[m]+".js");if("object"==typeof module&&module.exports){if(r===module.exports[e]){for(m=0;p>m;m++)A[m]=module.exports[g[m]]||require(w[m])[g[m]];d=n.apply(t,A),module.exports[e]=d||1}}else if("function"==typeof define&&define.amd)define(["exports"].concat(v),function(i){if(r===i[e]){for(var s=o.slice.call(arguments,1),a=s.length,h=0;a>h;h++)A[h]=i[g[h]]||s[h];d=n.apply(t,A),i[e]=d||1}});else if(h){for(m=0;p>m;m++)self[g[m]]||importScripts(w[m]),A[m]=self[g[m]];d=n.apply(t,A),self[e]=d||1}else if(r===t[e]){var y=function(t,e){_=_||document.getElementsByTagName("head")[0];var i=0,n=document.createElement("script");n.type="text/javascript",n.language="javascript",n.onload=n.onreadystatechange=function(){i||n.readyState&&"loaded"!=n.readyState&&"complete"!=n.readyState||(i=1,n.onload=n.onreadystatechange=null,_.removeChild(n),n=null,e&&e())},n.src=t,_.appendChild(n)},b=function(e,i,n){t[e]?n():y(i,n)},E=function(i){return function(){p>i&&(A[i]=t[g[i]]),++i<p?b(g[i],w[i],E(i)):(d=n.apply(t,A),t[e]=d||1)}};p?b(g[0],w[0],E(0)):(d=n.apply(t,A),t[e]=d||1)}}(this,"FILTER",[["Classy","./classy"]],function(t){var e=e||{VERSION:"0.6.10",Class:t.Class,Merge:t.Merge};return!function(t,e,i){"use strict";var n,r=Object.prototype,s=Function.prototype,a=Array.prototype,h=s.call.bind(a.slice),l=s.call.bind(r.toString),o=a.splice,u=a.concat,c=e.Merge,f="undefined"!=typeof global&&"[object global]"===l(global),m=!f&&"undefined"!=typeof navigator,d="function"==typeof importScripts&&navigator instanceof WorkerNavigator,_="function"==typeof Worker,p=navigator?navigator.userAgent:"",g=e.Browser={isNode:f,isBrowser:m,isWorker:d,supportsWorker:_,isPhantom:/PhantomJS/.test(p),isOpera:m&&/Opera|OPR\//.test(p),isFirefox:m&&/Firefox\//.test(p),isChrome:m&&/Chrome\//.test(p),isSafari:m&&/Apple Computer/.test(navigator.vendor),isKhtml:m&&/KHTML\//.test(p),isIE:m&&(/MSIE \d/.test(p)||/Trident\/\d/.test(p)),isGecko:m&&/gecko\/\d/i.test(p),isWebkit:m&&/WebKit\//.test(p),isMac_geLion:m&&/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(p),isMac_geMountainLion:m&&/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(p),isMobile:!1,isIOS:/AppleWebKit/.test(p)&&/Mobile\/\w+/.test(p),isWin:/windows/i.test(navigator.platform),isMac:!1,isIE_lt8:!1,isIE_lt9:!1,isQtWebkit:!1};g.isMobile=g.isIOS||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(p),g.isMac=g.isIOS||/Mac/.test(navigator.platform),g.isIE_lt8=g.isIE&&!d&&(null==document.documentMode||document.documentMode<8),g.isIE_lt9=g.isIE&&!d&&(null==document.documentMode||document.documentMode<9),g.isQtWebkit=g.isWebkit&&/Qt\/\d+\.\d+/.test(p),e.getPath=function(){var t,e=null;return f?{path:__dirname,file:__filename}:(d?e=self.location.href:m&&(t=document.getElementsByTagName("script"))&&t.length&&(e=t[t.length-1].src),e?{path:e.split("/").slice(0,-1).join("/"),file:""+e}:{path:null,file:null})};var v=e.devicePixelRatio=t.devicePixelRatio||1;e.getCanvas=e.createCanvas=function(t,e){var i=document.createElement("canvas");return t=t||0,e=e||0,i.style.width=t+"px",i.style.height=e+"px",i.width=t*v,i.height=e*v,i};var w=0;e.uuid=function(t){return[t||"fuuid",(new Date).getTime(),++w].join("_")};var A=e.URL=t.webkitURL||t.URL,y=function(t){return A.createObjectURL(new Blob([t||""],{type:"text/javascript"}))};e.useWebGL=!1,e.useWebGLSharedResources=!1,e.useWebGLIfAvailable=function(){},e.useWebGLSharedResourcesIfAvailable=function(){},e.Array=Array,e.Array32F="undefined"!=typeof Float32Array?Float32Array:Array,e.Array64F="undefined"!=typeof Float64Array?Float64Array:Array,e.Array8I="undefined"!=typeof Int8Array?Int8Array:Array,e.Array16I="undefined"!=typeof Int16Array?Int16Array:Array,e.Array32I="undefined"!=typeof Int32Array?Int32Array:Array,e.Array8U="undefined"!=typeof Uint8Array?Uint8Array:Array,e.Array16U="undefined"!=typeof Uint16Array?Uint16Array:Array,e.Array32U="undefined"!=typeof Uint32Array?Uint32Array:Array;var b=e._notSupportClamp="undefined"==typeof Uint8ClampedArray;if(e.ImArray=b?e.Array8U:Uint8ClampedArray,e.ImArrayCopy=g.isOpera?e.Array8U:e.ImArray,b&&"undefined"!=typeof CanvasPixelArray&&!CanvasPixelArray.prototype.set){var E=function(t,e){var i=t.length;for(e=parseInt(e,10)||0;--i>=0;)this[i+e]=t[i];return this};CanvasPixelArray.prototype.set=E}if(e.CONSTANTS={PI:Math.PI,PI2:2*Math.PI,PI_2:.5*Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI},e.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3},e.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4},e.LUMA=new e.Array32F([.212671,.71516,.072169]),d){var L=null;t.console={log:function(t){postMessage({event:"console.log",data:{output:t||""}})},error:function(t){postMessage({event:"console.error",data:{output:t||""}})}},onmessage=function(t){var i=t.data.event,n=t.data.data||null;switch(i){case"init":if(!(n&&n.filter&&e[n.filter]))throw new Error('Filter "'+n.filter+'" could not be created');L&&L.dispose(!0),L=new e[n.filter];break;case"import":n&&n["import"]&&n["import"].length&&importScripts(n["import"].join(","));break;case"params":L&&L.unserialize(n);break;case"apply":L&&(n&&n.im?(n.params&&L.unserialize(n.params),L.send("apply",{im:L._apply(n.im[0],n.im[1],n.im[2])})):L.send("apply",{im:null}));break;case"dispose":default:L&&L.dispose(!0),close()}}}n=e.log=console&&console.log?console.log:function(){},e.warning=function(t){n("WARNING: "+t)},e.error=function(t){n("ERROR: "+t)};var M=e.FilterWorkerInterface=e.Class({path:e.getPath(),name:null,_worker:null,_workerListeners:null,disposeWorker:function(){var t=this;return t._worker&&(t.send("dispose"),t._worker=null,t._workerListeners=null),t},serialize:function(){return{filter:this.name||null}},unserialize:function(){return this},sources:function(){var t=h(arguments);if(t.length){var e,i=[];for(e=0;e<t.length;e++)"function"==typeof t[e]?i.push(y(t[e].toString())):i.push(y(t[e]));this.send("import",{"import":i})}return this},scripts:function(){var t=h(arguments);return t.length&&this.send("import",{"import":t}),this},worker:function(t){var e,i=this;if(arguments.length||(t=!0),t=!!t,!1===t)return i._worker&&i.disposeWorker(),i;if(!i._worker){if(!_)throw new Error("Worker is not supported");i._workerListeners={},e=i._worker=new Worker(this.path.file),e.onmessage=function(t){if(t.data.event){var e=t.data.event,r=t.data.data||null;i._workerListeners&&i._workerListeners[e]&&i._workerListeners[e](r),("console.log"===e||"console.error"===e)&&n("Worker: "+r.output)}},e.onerror=function(t){if(!i._workerListeners||!i._workerListeners.error)throw new Error("Worker Error: "+t.message+" file: "+t.filename+" line: "+t.lineno);i._workerListeners.error(t)},i.send("init",{filter:i.name})}return i},bind:function(t,e){return t&&e&&this._workerListeners&&(this._workerListeners[t]=e.bind(this)),this},unbind:function(t){return t&&this._workerListeners&&this._workerListeners[t]&&delete this._workerListeners[t],this},send:function(t,e){return t&&(d?postMessage({event:t,data:e||null}):this._worker&&this._worker.postMessage({event:t,data:e||null})),this}}),C=e.Filter=e.Class(M,{name:"Filter",constructor:function(){},id:null,_isOn:!0,dispose:function(){return this.disposeWorker(),this},isOn:function(){return this._isOn},turnOn:function(t){return arguments.length||(t=!0),this._isOn=!!t,this},toggle:function(){return this._isOn=!this._isOn,this},reset:function(){return this},combineWith:function(){return this},_apply:function(t){return t},apply:function(t,e){if(t&&this._isOn){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._apply(i[0],i[1],i[2],t)),e&&e.call(this))}return t},toString:function(){return"[FILTER: "+this.name+"]"}}),N=e.CompositeFilter=e.Class(C,{name:"CompositeFilter",constructor:function(t){this._stack=t&&t.length?t.slice():[]},_stack:null,dispose:function(t){var e,i=this._stack;if(this.disposeWorker(),!0===t)for(e=0;e<i.length;e++)i[e]&&i[e].dispose(t),i[e]=null;return this._stack=null,this},serialize:function(){var t,e={filter:this.name,filters:[]},i=this._stack;for(t=0;t<i.length;t++)e.filters.push(i[t].serialize());return e},unserialize:function(t){if(t&&this.name===t.filter){var i,n,r=t.filters||[],s=[];for(i=0;i<r.length;i++){if(n=r[i]&&r[i].filter?e[r[i].filter]:null,!n)throw new Error('Filter "'+r[i].filter+'" could not be created');s.push((new n).unserialize(r[i]))}if(this._stack)for(i=0;i<this._stack.length;i++)this._stack[i]&&this._stack[i].dispose(!0),this._stack[i]=null;this._stack=s}return this},filters:function(t){return i!==t?(this._stack=t.slice(),this):this._stack.slice()},push:function(){var t=h(arguments),e=t.length;return e&&(this._stack=u.apply(this._stack,t)),this},pop:function(){return this._stack.pop()},shift:function(){return this._stack.shift()},unshift:function(){var t=h(arguments),e=t.length;return e&&o.apply(this._stack,[0,0].concat(t)),this},getAt:function(t){return this._stack.length>t?this._stack[t]:null},setAt:function(t,e){return this._stack.length>t?this._stack[t]=e:this._stack.push(e),this},insertAt:function(t){var e=h(arguments);return e.length,argslen>1&&(e.shift(),o.apply(this._stack,[t,0].concat(e))),this},removeAt:function(t){return this._stack.splice(t,1)},remove:function(t){for(var e=this._stack.length;--e>=0;)t===this._stack[e]&&this._stack.splice(e,1);return this},reset:function(){return this._stack.length=0,this},_apply:function(t,e,i,n){if(this._isOn&&this._stack.length){var r,s,a=this._stack,h=a.length;for(r=0;h>r;r++)s=a[r],s&&s._isOn&&(t=s._apply(t,e,i,n))}return t},apply:function(t,e){if(t&&this._isOn&&this._stack.length){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._apply(i[0],i[1],i[2],t)),e&&e.call(this))}return t},toString:function(){return["[FILTER: "+this.name+"]","[","    "+this._stack.join("\n    "),"]",""].join("\n")}});N.prototype.empty=N.prototype.reset,N.prototype.concat=N.prototype.push;var x=function(){return"[FILTER Plugin: "+this.name+"]"};e.Create=function(t){return t=c({init:function(){},name:"PluginFilter",toString:x,apply:function(t){return t}},t),t.constructor=t.init,t._apply=t.apply,delete t.init,delete t.apply,e.Class(C,t)}}(this,e),!function(t){"use strict";var e=Math.sqrt,n=Math.min,r=Math.max;t.Color={name:"ColorTransforms",clamp:function(t,e,i){return n(i,r(t,e))},clampPixel:function(t){return n(255,r(t,0))},ubyteToFloat:function(t){return.00392156862745098*t},ubyteColorToFloatColor:function(t){var e=t.length,n=new Array(e);for(i=0;e>i;i++)n[i]=.00392156862745098*t[i];return n},hexColorToFloatColor:function(t){var e,i,n,r;return e=255&t>>16,i=255&t>>8,n=255&t,r=255&t>>24,[.00392156862745098*e,.00392156862745098*i,.00392156862745098*n,.00392156862745098*r]},blend:function(t,e,i){return{r:t.r-~~((t.r-e.r)*i+.5),g:t.g-~~((t.g-e.g)*i+.5),b:t.b-~~((t.b-e.b)*i+.5)}},toGray:function(e,i,n){var r=t.LUMA;return~~(r[0]*e+r[1]*i+r[2]*n)},distance:function(t,i){var n=t.r-i.r,r=t.g-i.g,s=t.b-i.b;return e(n*n+r*r+s*s)},RGB2Color:function(t){return t.r<<16|t.g<<8|255&t.b},RGBA2Color:function(t){return t.a<<24|t.r<<16|t.g<<8|255&t.b},Color2RGBA:function(t){return t=~~t,{r:255&t>>>16,g:255&t>>>8,b:255&t,a:255&t>>>24}},RGB2YCbCr:function(t){var e,i,n,r=t.r,s=t.g,a=t.b;return e=~~(0+.299*r+.587*s+.114*a),i=~~(128-.168736*r-.331264*s+.5*a),n=~~(128+.5*r-.418688*s-.081312*a),{y:e,cb:i,cr:n}},YCbCr2RGB:function(t){var e,i,n,r=t.y,s=t.cb,a=t.cr;return e=~~(r+1.402*(a-128)),i=~~(r-.34414*(s-128)-.71414*(a-128)),n=~~(r+1.772*(s-128)),{r:e,g:i,b:n}},RGB2HSV:function(t){var e,i,s,a,h,l,o,u,c;return a=t.r,h=t.g,l=t.b,e=n(a,h,l),i=r(a,h,l),s=i-e,c=i,0==i?(u=0,o=0,{h:o,s:u,v:c}):(u=s/i,o=a==i?(h-l)/s:h==i?2+(l-a)/s:4+(a-h)/s,o*=60,0>o&&(o+=360),{h:o,s:u,v:c})},HSV2RGB:function(t){var e,i,n,r,s,a,h,l,o,u,c;if(o=t.h,u=t.s,c=t.v,0==u)return a=h=l=c,{r:a,g:h,b:l};switch(o/=60,e=~~o,i=o-e,n=c*(1-u),r=c*(1-u*i),s=c*(1-u*(1-i)),e){case 0:a=c,h=s,l=n;break;case 1:a=r,h=c,l=n;break;case 2:a=n,h=c,l=s;break;case 3:a=n,h=r,l=c;break;case 4:a=s,h=n,l=c;break;default:a=c,h=n,l=r}return{r:a,g:h,b:l}},toString:function(){return"[FILTER: "+this.name+"]"}}}(e),!function(t,e){"use strict";var i=t.devicePixelRatio,n=t.ImArray,r=t.Array32F,s=t.createCanvas,a=(t._notSupportTypedArrays,Math.min),h=Math.floor,l=t.blendModes={normal:function(t){return t},lighten:function(t,e){return e>t?e:t},darken:function(t,e){return e>t?t:e},multiply:function(t,e){return.003921568627451*t*e},average:function(t,e){return.5*(t+e)},add:function(t,e){return Math.min(255,t+e)},substract:function(t,e){return 255>t+e?0:t+e-255},difference:function(t,e){return Math.abs(t-e)},negation:function(t,e){return 255-Math.abs(255-t-e)},screen:function(t,e){return 255-((255-t)*(255-e)>>8)},exclusion:function(t,e){return t+e-.003921568627451*2*t*e},overlay:function(t,e){return 128>e?.003921568627451*2*t*e:255-.003921568627451*2*(255-t)*(255-e)},softLight:function(t,e){return 128>e?2*((t>>1)+64)*.003921568627451*e:255-.003921568627451*2*(255-((t>>1)+64))*(255-e)},hardLight:function(t,e){return 128>t?.003921568627451*2*e*t:255-.003921568627451*2*(255-e)*(255-t)},colorDodge:function(t,e){return 255==e?e:Math.min(255,(t<<8)/(255-e))},colorBurn:function(t,e){return 0==e?e:Math.max(0,255-(255-t<<8)/e)},linearLight:function(t,e){return 128>e?l.linearBurn(t,2*e):l.linearDodge(t,2*(e-128))},vividLight:function(t,e){return 128>e?l.colorBurn(t,2*e):l.colorDodge(t,2*(e-128))},pinLight:function(t,e){return 128>e?l.darken(t,2*e):l.lighten(t,2*(e-128))},hardMix:function(t,e){return l.vividLight(t,e)<128?0:255},reflect:function(t,e){return 255==e?e:Math.min(255,t*t/(255-e))},glow:function(t,e){return 255==t?t:Math.min(255,e*e/(255-t))},phoenix:function(t,e){return Math.min(t,e)-Math.max(t,e)+255}};l.linearDodge=l.add,l.linearBurn=l.substract;var o=1,u=2,c=4,f=8,m=t.Image=t.Class({name:"Image",constructor:function(t,e){this.width=0,this.height=0,this.context=null,this.selection=null,this.imageData=null,this.imageDataSel=null,this.domElement=this.canvasElement=s(this.width,this.height),this.context=this.canvasElement.getContext("2d"),this._tmpCanvas=null,this.webgl=null,this._histogram=null,this._integral=null,this._needsRefresh=0,t&&this.setImage(t,e)},width:0,height:0,canvasElement:null,domElement:null,context:null,selection:null,imageData:null,imageDataSel:null,webgl:null,_histogram:null,_integral:null,_needsRefresh:0,_tmpCanvas:null,select:function(t,i,n,r){return this.selection=[e===t?0:t,e===i?0:i,e===n?1:n,e===r?1:r],this._needsRefresh|=u,this},deselect:function(){return this.selection=null,this.imageDataSel=null,this._needsRefresh&=~u,this},setWidth:function(t){return this._setWidth(t),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},setHeight:function(t){return this._setHeight(t),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},setDimensions:function(t,e){return this._setDimensions(t,e),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},setImage:function(e,i){if(!e)return this;var n,r,s,a,h=this;return e instanceof Image||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?(n=e,s=n instanceof HTMLVideoElement?n.videoWidth:n.width,a=n instanceof HTMLVideoElement?n.videoHeight:n.height,r=h.context=h._setDimensions(s,a).canvasElement.getContext("2d"),r.drawImage(n,0,0),h._needsRefresh|=o|c|f,h.selection&&(h._needsRefresh|=u),h.webgl=t.useWebGL?new t.WebGL(h.canvasElement):null):(n=new Image,n.onload=function(){s=n.width,a=n.height,r=h.context=h._setDimensions(s,a).canvasElement.getContext("2d"),r.drawImage(n,0,0),h._needsRefresh|=o|c|f,h.selection&&(h._needsRefresh|=u),h.webgl=t.useWebGL?new t.WebGL(h.canvasElement):null,"undefined"!=typeof i&&i.call(h)},n.src=e),n.crossOrigin="",this},getPixel:function(t,e){this._needsRefresh&o&&this._refreshData();var i=~~(e*this.width+t+.5),n=this.imageData.data;return{r:n[i],g:n[i+1],b:n[i+2],a:n[i+3]}},setPixel:function(t,e,i,r,s,a){var h=new n([255&i,255&r,255&s,255&a]);return this.context.putImageData(h,t,e),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},getData:function(){return this._needsRefresh&o&&this._refreshData(),new n(this.imageData.data)},getSelectedData:function(){var t;return this.selection?(this._needsRefresh&u&&this._refreshDataSel(),t=this.imageDataSel):(this._needsRefresh&o&&this._refreshData(),t=this.imageData),[new n(t.data),t.width,t.height]},setData:function(t){return this._needsRefresh&o&&this._refreshData(),this.imageData.data.set(t),this.context.putImageData(this.imageData,0,0),this._needsRefresh|=c|f,this.selection&&(this._needsRefresh|=u),this},setSelectedData:function(t){if(this.selection){var e=this.selection,i=this.width-1,n=this.height-1,r=h(e[0]*i),s=h(e[1]*n);this._needsRefresh&u&&this._refreshDataSel(),this.imageDataSel.data.set(t),this.context.putImageData(this.imageDataSel,r,s),this._needsRefresh|=o}else this._needsRefresh&o&&this._refreshData(),this.imageData.data.set(t),this.context.putImageData(this.imageData,0,0),this.selection&&(this._needsRefresh|=u);return this._needsRefresh|=c|f,this},getPixelData:function(){return this._needsRefresh&o&&this._refreshData(),this.imageData},setPixelData:function(t){return this.context.putImageData(t,0,0),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},createImageData:function(t,e){return this.context=this._setDimensions(t,e).canvasElement.getContext("2d"),this.context.createImageData(t,e),this._needsRefresh|=o,this.selection&&(this._needsRefresh|=u),this},copy:function(t){return this.setData(t.getData()),this},clone:function(){return new m(this.canvasElement)},scale:function(t,e){if(t=t||1,e=e||t,1==t&&1==e)return this;this._tmpCanvas=this._tmpCanvas||this._getTmpCanvas();var n=this._tmpCanvas.getContext("2d");return n.scale(t,e),n.drawImage(this.canvasElement,0,0),this.width=~~(t*this.width+.5),this.height=~~(e*this.height+.5),this.canvasElement.style.width=this.width+"px",this.canvasElement.style.height=this.height+"px",this.canvasElement.width=this.width*i,this.canvasElement.height=this.height*i,this.context.drawImage(this._tmpCanvas,0,0),this._tmpCanvas.width=this.width,this._tmpCanvas.height=this.height,this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},flipHorizontal:function(){this._tmpCanvas=this._tmpCanvas||this._getTmpCanvas();var t=this._tmpCanvas.getContext("2d");return t.translate(this.width,0),t.scale(-1,1),t.drawImage(this.canvasElement,0,0),this.context.drawImage(this._tmpCanvas,0,0),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},flipVertical:function(){this._tmpCanvas=this._tmpCanvas||this._getTmpCanvas();var t=this._tmpCanvas.getContext("2d");return t.translate(0,this.height),t.scale(1,-1),t.drawImage(this.canvasElement,0,0),this.context.drawImage(this._tmpCanvas,0,0),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},clear:function(){if(this.width&&this.height){var t=this.context;t.clearRect(0,0,this.width,this.height),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u)}return this},fill:function(t,e,i,n,r){if(!n&&this.width&&!r&&this.height)return this;n&&!this.width&&r&&!this.height&&(this.context=this._setDimensions(n,r).canvasElement.getContext("2d"),this.context.createImageData(n,r)),t=t||0,e=e||0,i=i||0,n=n||this.width,r=r||this.height;var s=this.context;return s.fillStyle=t,s.fillRect(e,i,n,r),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},draw:function(){return this},blend:function(t,e,i,n,r){"undefined"==typeof e&&(e="normal"),"undefined"==typeof i&&(i=1),i>1?i=1:0>i&&(i=0),"undefined"==typeof n&&(n=0),"undefined"==typeof r&&(r=0);var s=0,h=0,m=this.context;if(0>n&&(s=-n,n=0),0>r&&(h=-r,r=0),n>=this.width||r>=this.height)return this;var d=l[e]||null;if(!d)return this;var _,p,g,v,w,A,y,b=a(this.width,t.width-s),E=a(this.height,t.height-h),L=this.context.getImageData(n,r,b,E),M=t.context.getImageData(s,h,b,E),C=L.data,N=M.data,x=1-i,R=N.length;for(y=0;R>y;y+=4)v=C[y],w=C[y+1],A=C[y+2],_=d(N[y],v),p=d(N[y+1],w),g=d(N[y+2],A),C[y]=_*i+v*x,C[y+1]=p*i+w*x,C[y+2]=g*i+A*x;return m.putImageData(L,n,r),this._needsRefresh|=o|c|f,this.selection&&(this._needsRefresh|=u),this},integral:function(){return this._needsRefresh&f&&this._computeIntegral(),this._integral},histogram:function(){return this._needsRefresh&c&&this._computeHistogram(),this._histogram},toString:function(){return"[FILTER Image: "+this.name+"]"},_getTmpCanvas:function(){var t=s(this.width,this.height);return t.width=this.width,t.height=this.height,t},_setDimensions:function(t,e){return this.canvasElement.style.width=t+"px",this.canvasElement.width=this.width=t*i,this.canvasElement.style.height=e+"px",this.canvasElement.height=this.height=e*i,this._tmpCanvas&&(this._tmpCanvas.style.width=this.canvasElement.style.width,this._tmpCanvas.width=this.canvasElement.width,this._tmpCanvas.style.height=this.canvasElement.style.height,this._tmpCanvas.height=this.canvasElement.height),this},_setWidth:function(t){return this.canvasElement.style.width=t+"px",this.canvasElement.width=this.width=t*i,this._tmpCanvas&&(this._tmpCanvas.style.width=this.canvasElement.style.width,this._tmpCanvas.width=this.canvasElement.width),this},_setHeight:function(t){return this.canvasElement.style.height=t+"px",this.canvasElement.height=this.height=t*i,this._tmpCanvas&&(this._tmpCanvas.style.height=this.canvasElement.style.height,this._tmpCanvas.height=this.canvasElement.height),this},_computeIntegral:function(){var t,e,i,n,s,a,h,l,o,u=this.width,c=(this.height,u<<2),m=this.getPixelData().data,d=m.length,_=d>>2;for(t=new r(_),e=new r(_),i=new r(_),l=0,h=0,n=s=a=0,o=0;u>o;o++,h+=4,l++)n+=m[h],s+=m[h+1],a+=m[h+2],t[l]=n,e[l]=s,i[l]=a;for(h=c,o=0,l=0,n=s=a=0,h=c;d>h;h+=4,l++,o++)o>=u&&(o=0,n=s=a=0),n+=m[h],s+=m[h+1],a+=m[h+2],t[l+u]=t[l]+n,e[l+u]=e[l]+s,i[l+u]=i[l]+a;return this._integral=[t,e,i],this._needsRefresh&=~f,this},_computeHistogram:function(){var t,e,i,n,s,a,h,l,o,u,f=this.getPixelData().data,m=f.length,d=0,_=0,p=0,g=255,v=255,w=255,A=1/(m>>2);for(t=new r(256),e=new r(256),i=new r(256),u=0;256>u;u+=4)t[u]=0,e[u]=0,i[u]=0,t[u+1]=0,e[u+1]=0,i[u+1]=0,t[u+2]=0,e[u+2]=0,i[u+2]=0,t[u+3]=0,e[u+3]=0,i[u+3]=0;for(u=0;m>u;u+=4)n=f[u],s=f[u+1],a=f[u+2],t[n]+=A,e[s]+=A,i[a]+=A,n>d?d=n:g>n&&(g=n),s>_?_=s:v>s&&(v=s),a>p?p=a:w>a&&(w=a);for(h=l=o=0,u=0;256>u;u+=4)h+=t[u],t[u]=h,l+=e[u],e[u]=l,o+=i[u],i[u]=o,h+=t[u+1],t[u+1]=h,l+=e[u+1],e[u+1]=l,o+=i[u+1],i[u+1]=o,h+=t[u+2],t[u+2]=h,l+=e[u+2],e[u+2]=l,o+=i[u+2],i[u+2]=o,h+=t[u+3],t[u+3]=h,l+=e[u+3],e[u+3]=l,o+=i[u+3],i[u+3]=o;return this._histogram=[t,e,i],this._needsRefresh&=~c,this},_refreshData:function(){return this.imageData=this.context.getImageData(0,0,this.width,this.height),this._needsRefresh&=~o,this},_refreshDataSel:function(){if(this.selection){var t=this.selection,e=this.width-1,i=this.height-1,n=h(t[0]*e),r=h(t[1]*i),s=h(t[2]*e)-n+1,a=h(t[3]*i)-r+1;this.imageDataSel=this.context.getImageData(n,r,s,a)}return this._needsRefresh&=~u,this}}),d=t.ScaledImage=t.Class(m,{name:"ScaledImage",constructor:function(t,e,i,n){this.scaleX=t||1,this.scaleY=e||this.scaleX,this.$super("constructor",i,n)},scaleX:1,scaleY:1,clone:function(){return new d(this.scaleX,this.scaleY,this.canvasElement)},setScale:function(t,i){return e!==t&&null!==t&&(this.scaleX=t),e===i&&e!==t&&null!==t?this.scaleY=t:null!==i&&(this.scaleY=i),this},setImage:function(e,i){if(!e)return this;var n,r,s,a,h,l,m=this,d=this.scaleX,_=this.scaleY;return e instanceof Image||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?(n=e,s=n instanceof HTMLVideoElement?n.videoWidth:n.width,a=n instanceof HTMLVideoElement?n.videoHeight:n.height,h=~~(d*s+.5),l=~~(_*a+.5),r=m.context=m._setDimensions(h,l).canvasElement.getContext("2d"),r.drawImage(n,0,0,s,a,0,0,h,l),m._needsRefresh|=o|c|f,m.selection&&(m._needsRefresh|=u),m.webgl=t.useWebGL?new t.WebGL(m.canvasElement):null):(n=new Image,n.onload=function(){s=n.width,a=n.height,h=~~(d*s+.5),l=~~(_*a+.5),r=m.context=m._setDimensions(s,a).canvasElement.getContext("2d"),r.drawImage(n,0,0,s,a,0,0,h,l),m._needsRefresh|=o|c|f,m.selection&&(m._needsRefresh|=u),m.webgl=t.useWebGL?new t.WebGL(m.canvasElement):null,"undefined"!=typeof i&&i.call(m)},n.src=e),n.crossOrigin="",this}})}(e),!function(t){"use strict";t.CustomFilter=t.Class(t.Filter,{name:"CustomFilter",constructor:function(t){this._handler=t?t.bind(this):null},_handler:null,dispose:function(){return this._worker=null,this._workerListeners=null,this._handler=null,this},worker:function(){return this._worker=null,this._workerListeners=null,this},_apply:function(t,e,i,n){return this._isOn&&this._handler?this._handler(t,e,i,n):t},apply:function(t){if(this._isOn&&this._handler){var e=t.getSelectedData();t.setSelectedData(this._handler(e[0],e[1],e[2],t))}return t}})}(e),!function(t,e){"use strict";function i(t,e){var i,n,r,s,h,l=new a(20);return i=e[0],n=e[1],r=e[2],s=e[3],h=e[4],l[0]=i*t[0]+n*t[5]+r*t[10]+s*t[15],l[1]=i*t[1]+n*t[6]+r*t[11]+s*t[16],l[2]=i*t[2]+n*t[7]+r*t[12]+s*t[17],l[3]=i*t[3]+n*t[8]+r*t[13]+s*t[18],l[4]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+h,i=e[5],n=e[6],r=e[7],s=e[8],h=e[9],l[5]=i*t[0]+n*t[5]+r*t[10]+s*t[15],l[6]=i*t[1]+n*t[6]+r*t[11]+s*t[16],l[7]=i*t[2]+n*t[7]+r*t[12]+s*t[17],l[8]=i*t[3]+n*t[8]+r*t[13]+s*t[18],l[9]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+h,i=e[10],n=e[11],r=e[12],s=e[13],h=e[14],l[10]=i*t[0]+n*t[5]+r*t[10]+s*t[15],l[11]=i*t[1]+n*t[6]+r*t[11]+s*t[16],l[12]=i*t[2]+n*t[7]+r*t[12]+s*t[17],l[13]=i*t[3]+n*t[8]+r*t[13]+s*t[18],l[14]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+h,i=e[15],n=e[16],r=e[17],s=e[18],h=e[19],l[15]=i*t[0]+n*t[5]+r*t[10]+s*t[15],l[16]=i*t[1]+n*t[6]+r*t[11]+s*t[16],l[17]=i*t[2]+n*t[7]+r*t[12]+s*t[17],l[18]=i*t[3]+n*t[8]+r*t[13]+s*t[18],l[19]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+h,l}function n(t,e,i){var n=1-i,r=new a(20);return r[0]=n*t[0]+i*e[0],r[1]=n*t[1]+i*e[1],r[2]=n*t[2]+i*e[2],r[3]=n*t[3]+i*e[3],r[4]=n*t[4]+i*e[4],r[5]=n*t[5]+i*e[5],r[6]=n*t[6]+i*e[6],r[7]=n*t[7]+i*e[7],r[8]=n*t[8]+i*e[8],r[9]=n*t[9]+i*e[9],r[10]=n*t[10]+i*e[10],r[11]=n*t[11]+i*e[11],r[12]=n*t[12]+i*e[12],r[13]=n*t[13]+i*e[13],r[14]=n*t[14]+i*e[14],r[15]=n*t[15]+i*e[15],r[16]=n*t[16]+i*e[16],r[17]=n*t[17]+i*e[17],r[18]=n*t[18]+i*e[18],r[19]=n*t[19]+i*e[19],r}var r=Math.sin,s=Math.cos,a=t.Array32F,h=t.CONSTANTS.toRad,l=(t.CONSTANTS.toDeg,t._notSupportClamp),o=t.ColorMatrixFilter=t.Class(t.Filter,{name:"ColorMatrixFilter",constructor:function(e){this._matrix=e&&e.length?new a(e):null,t.useWebGL&&(this._webglInstance=t.WebGLColorMatrixFilterInstance||null)},_matrix:null,_webglInstance:null,dispose:function(){var t=this;return t.disposeWorker(),t._webglInstance=null,t._matrix=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_matrix:t._matrix}}},unserialize:function(t){var e,i=this;return t&&i.name===t.filter&&(e=t.params,i._matrix=e._matrix),i},channel:function(i,n){n=n===e?!1:n;var r=n?1:0;switch(i){case t.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case t.CHANNEL.BLUE:return this.set([0,0,r,0,0,0,0,r,0,0,0,0,1,0,0,0,0,0,0,255]);case t.CHANNEL.GREEN:return this.set([0,r,0,0,0,0,1,0,0,0,0,r,0,0,0,0,0,0,0,255]);case t.CHANNEL.RED:default:return this.set([1,0,0,0,0,r,0,0,0,0,r,0,0,0,0,0,0,0,0,255])}},redChannel:function(e){return this.channel(t.CHANNEL.RED,e)},greenChannel:function(e){return this.channel(t.CHANNEL.GREEN,e)},blueChannel:function(e){return this.channel(t.CHANNEL.BLUE,e)},alphaChannel:function(){return this.channel(t.CHANNEL.ALPHA,!0)},maskChannel:function(e){switch(e){case t.CHANNEL.ALPHA:return this;case t.CHANNEL.BLUE:return this.set([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0]);case t.CHANNEL.GREEN:return this.set([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);case t.CHANNEL.RED:default:return this.set([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(e,i){switch(e){case t.CHANNEL.ALPHA:switch(i){case t.CHANNEL.ALPHA:return this;case t.CHANNEL.BLUE:return this.set([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case t.CHANNEL.GREEN:return this.set([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case t.CHANNEL.RED:default:return this.set([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}break;case t.CHANNEL.BLUE:switch(i){case t.CHANNEL.ALPHA:return this.set([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case t.CHANNEL.BLUE:return this;case t.CHANNEL.GREEN:return this.set([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case t.CHANNEL.RED:default:return this.set([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}break;case t.CHANNEL.GREEN:switch(i){case t.CHANNEL.ALPHA:return this.set([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case t.CHANNEL.BLUE:return this.set([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case t.CHANNEL.GREEN:return this;case t.CHANNEL.RED:default:return this.set([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0])}break;case t.CHANNEL.RED:default:switch(i){case t.CHANNEL.ALPHA:return this.set([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case t.CHANNEL.BLUE:return this.set([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case t.CHANNEL.GREEN:return this.set([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);case t.CHANNEL.RED:default:return this}}},desaturate:function(){return this.set([t.LUMA[0],t.LUMA[1],t.LUMA[2],0,0,t.LUMA[0],t.LUMA[1],t.LUMA[2],0,0,t.LUMA[0],t.LUMA[1],t.LUMA[2],0,0,0,0,0,1,0])},colorize:function(i,n){var r,s,a,h;return n===e&&(n=1),r=.00392156862745098*(255&i>>16),s=.00392156862745098*(255&i>>8),a=.00392156862745098*(255&i),h=1-n,this.set([h+n*r*t.LUMA[0],n*r*t.LUMA[1],n*r*t.LUMA[2],0,0,n*s*t.LUMA[0],h+n*s*t.LUMA[1],n*s*t.LUMA[2],0,0,n*a*t.LUMA[0],n*a*t.LUMA[1],h+n*a*t.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.set([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.set([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,-1,255])},saturate:function(e){var i,n,r,s;return i=1-e,n=i*t.LUMA[0],r=i*t.LUMA[1],s=i*t.LUMA[2],this.set([n+e,r,s,0,0,n,r+e,s,0,0,n,r,s+e,0,0,0,0,0,1,0])},contrast:function(t,i,n){return i===e&&(i=t),n===e&&(n=t),t+=1,i+=1,n+=1,this.set([t,0,0,0,128*(1-t),0,i,0,0,128*(1-i),0,0,n,0,128*(1-n),0,0,0,1,0])},brightness:function(t,i,n){return i===e&&(i=t),n===e&&(n=t),this.set([1,0,0,0,t,0,1,0,0,i,0,0,1,0,n,0,0,0,1,0])},adjustHue:function(e){e*=h;var i=s(e),n=r(e);return this.set([t.LUMA[0]+i*(1-t.LUMA[0])+n*-t.LUMA[0],t.LUMA[1]+i*-t.LUMA[1]+n*-t.LUMA[1],t.LUMA[2]+i*-t.LUMA[2]+n*(1-t.LUMA[2]),0,0,t.LUMA[0]+i*-t.LUMA[0]+.143*n,t.LUMA[1]+i*(1-t.LUMA[1])+.14*n,t.LUMA[2]+i*-t.LUMA[2]+n*-.283,0,0,t.LUMA[0]+i*-t.LUMA[0]+n*-(1-t.LUMA[0]),t.LUMA[1]+i*-t.LUMA[1]+n*t.LUMA[1],t.LUMA[2]+i*(1-t.LUMA[2])+n*t.LUMA[2],0,0,0,0,0,1,0])},average:function(t,i,n){return t===e&&(t=.3333),i===e&&(i=.3333),n===e&&(n=.3334),this.set([t,i,n,0,0,t,i,n,0,0,t,i,n,0,0,0,0,0,1,0])},quickContrastCorrection:function(t){return t===e&&(t=1.2),this.set([t,0,0,0,0,0,t,0,0,0,0,0,t,0,0,0,0,0,1,0])},sepia:function(t){return t===e&&(t=.5),t>1?t=1:0>t&&(t=0),this.set([1-.607*t,.769*t,.189*t,0,0,.349*t,1-.314*t,.168*t,0,0,.272*t,.534*t,1-.869*t,0,0,0,0,0,1,0])
},sepia2:function(i){return i===e&&(i=10),i>100&&(i=100),i*=2.55,this.set([t.LUMA[0],t.LUMA[1],t.LUMA[2],0,40,t.LUMA[0],t.LUMA[1],t.LUMA[2],0,20,t.LUMA[0],t.LUMA[1],t.LUMA[2],0,-i,0,0,0,1,0])},threshold:function(i,n){return n===e&&(n=256),this.set([t.LUMA[0]*n,t.LUMA[1]*n,t.LUMA[2]*n,0,-(n-1)*i,t.LUMA[0]*n,t.LUMA[1]*n,t.LUMA[2]*n,0,-(n-1)*i,t.LUMA[0]*n,t.LUMA[1]*n,t.LUMA[2]*n,0,-(n-1)*i,0,0,0,1,0])},threshold_rgb:function(t,i){return i===e&&(i=256),this.set([i,0,0,0,-(i-1)*t,0,i,0,0,-(i-1)*t,0,0,i,0,-(i-1)*t,0,0,0,1,0])},threshold_alpha:function(t,i){return t===e&&(t=.5),i===e&&(i=256),this.set([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,i,-i*t])},RGB2YCbCr:function(){return this.set([.5,-.418688,-.081312,0,128,.299,.587,.114,0,0,-.168736,-.331264,.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.set([1.402,1,0,0,-179.456,-.71414,1,-.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(t,e){return this._matrix=this._matrix?n(this._matrix,t.getMatrix(),e):new a(t.getMatrix()),this},set:function(t){return this._matrix=this._matrix?i(this._matrix,new a(t)):new a(t),this},reset:function(){return this._matrix=null,this},combineWith:function(t){return this.set(t.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(t){return this._matrix=new a(t),this},_apply:function(t){if(this._isOn&&this._matrix){var e,i,n,r,s,a,h,o,u,c,f,m,d,_,p,g,v,w,A,y,b,E=t.length,L=this._matrix,M=(E>>2)%4;if(l){for(e=0;E>e;e+=16)w=t[e],A=t[e+1],y=t[e+2],b=t[e+3],i=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],n=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],r=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],s=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],w=t[e+4],A=t[e+5],y=t[e+6],b=t[e+7],a=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],h=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],o=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],u=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],w=t[e+8],A=t[e+9],y=t[e+10],b=t[e+11],c=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],f=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],m=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],d=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],w=t[e+12],A=t[e+13],y=t[e+14],b=t[e+15],_=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],p=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],g=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],v=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],i=0>i?0:i>255?255:i,n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s,a=0>a?0:a>255?255:a,h=0>h?0:h>255?255:h,o=0>o?0:o>255?255:o,u=0>u?0:u>255?255:u,c=0>c?0:c>255?255:c,f=0>f?0:f>255?255:f,m=0>m?0:m>255?255:m,d=0>d?0:d>255?255:d,_=0>_?0:_>255?255:_,p=0>p?0:p>255?255:p,g=0>g?0:g>255?255:g,v=0>v?0:v>255?255:v,t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s,t[e+4]=~~a,t[e+5]=~~h,t[e+6]=~~o,t[e+7]=~~u,t[e+8]=~~c,t[e+9]=~~f,t[e+10]=~~m,t[e+11]=~~d,t[e+12]=~~_,t[e+13]=~~p,t[e+14]=~~g,t[e+15]=~~v;if(M)for(M<<=2,e=E-M;E>e;e+=4)w=t[e],A=t[e+1],y=t[e+2],b=t[e+3],i=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],n=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],r=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],s=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],i=0>i?0:i>255?255:i,n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s,t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s}else{for(e=0;E>e;e+=16)w=t[e],A=t[e+1],y=t[e+2],b=t[e+3],i=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],n=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],r=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],s=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],w=t[e+4],A=t[e+5],y=t[e+6],b=t[e+7],a=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],h=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],o=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],u=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],w=t[e+8],A=t[e+9],y=t[e+10],b=t[e+11],c=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],f=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],m=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],d=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],w=t[e+12],A=t[e+13],y=t[e+14],b=t[e+15],_=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],p=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],g=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],v=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s,t[e+4]=~~a,t[e+5]=~~h,t[e+6]=~~o,t[e+7]=~~u,t[e+8]=~~c,t[e+9]=~~f,t[e+10]=~~m,t[e+11]=~~d,t[e+12]=~~_,t[e+13]=~~p,t[e+14]=~~g,t[e+15]=~~v;if(M)for(M<<=2,e=E-M;E>e;e+=4)w=t[e],A=t[e+1],y=t[e+2],b=t[e+3],i=L[0]*w+L[1]*A+L[2]*y+L[3]*b+L[4],n=L[5]*w+L[6]*A+L[7]*y+L[8]*b+L[9],r=L[10]*w+L[11]*A+L[12]*y+L[13]*b+L[14],s=L[15]*w+L[16]*A+L[17]*y+L[18]*b+L[19],t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s}}return t},apply:function(t,e){if(this._isOn&&this._matrix)if(this._worker)this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:t.getSelectedData(),params:this.serialize()});else{var i=t.getSelectedData();t.setSelectedData(this._apply(i[0],i[1],i[2],t)),e&&e.call(this)}return t}});o.prototype.grayscale=o.prototype.desaturate,o.prototype.rotateHue=o.prototype.adjustHue,o.prototype.thresholdRgb=o.prototype.threshold_rgb,o.prototype.thresholdAlpha=o.prototype.threshold_alpha}(e),!function(t,e){"use strict";var i=t.ImArrayCopy,n=t.Color.clampPixel,r=function(t){var e=new i(256),n=0;if(t)for(;256>n;)e[n]=255-n,n++;else for(;256>n;)e[n]=n,n++;return e},s=function(t){for(var e=new i(256),n=0;256>n;)e[n]=t,n++;return e},a=function(t){return t?new i(t):null},h=Math.pow,l=Math.exp,o=1/255,u=r(),c=r(1),f=t.TableLookupFilter=t.Class(t.Filter,{name:"TableLookupFilter",constructor:function(t,e,i,n){this._tableR=t||null,this._tableG=e||this._tableR,this._tableB=i||this._tableG,this._tableA=n||null},_tableR:null,_tableG:null,_tableB:null,_tableA:null,dispose:function(){var t=this;return t.disposeWorker(),t._tableR=null,t._tableG=null,t._tableB=null,t._tableA=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_tableR:t._tableR,_tableG:t._tableG,_tableB:t._tableB,_tableA:t._tableA}}},unserialize:function(t){var e,i=this;return t&&i.name===t.filter&&(e=t.params,i._tableR=e._tableR,i._tableG=e._tableG,i._tableB=e._tableB,i._tableA=e._tableA),i},thresholds:function(t,e,r){t.length||(t=[t]),e||(e=t),r||(r=e);var s,a,h=t.length,l=h+1,o=e.length,u=o+1,c=r.length,f=c+1,m=new i(256),d=new i(l),_=new i(256),p=new i(u),g=new i(256),v=new i(f),w=255/(l-1),A=255/(u-1),y=255/(f-1);for(s=0;l>s;)d[s]=~~(w*s),s++;for(t[0]=~~(255*t[0]),s=1;h>s;)t[s]=t[s-1]+~~(255*t[s]),s++;for(s=0;u>s;)p[s]=~~(A*s),s++;for(e[0]=~~(255*e[0]),s=1;o>s;)e[s]=e[s-1]+~~(255*e[s]),s++;for(s=0;f>s;)v[s]=~~(y*s),s++;for(r[0]=~~(255*r[0]),s=1;c>s;)r[s]=r[s-1]+~~(255*r[s]),s++;for(s=0;256>s;){for(a=0;h>a&&s>t[a];)a++;for(m[s]=n(d[a]),a=0;o>a&&s>e[a];)a++;for(_[s]=n(p[a]),a=0;c>a&&s>r[a];)a++;g[s]=n(v[a]),s++}return this.set(m,_,g)},threshold:function(t,e,i){return t=t||.5,e=e||t,i=i||e,this.thresholds([t],[e],[i])},quantize:function(t){t===e&&(t=64),2>t&&(t=2);var r,s=new i(256),a=new i(t),h=255/(t-1),l=t/256;for(r=0;t>r;)a[r]=~~(h*r),r++;for(r=0;256>r;)s[r]=n(a[~~(l*r)]),r++;return this.set(s)},binarize:function(){return this.quantize(2)},solarize:function(t){t===e&&(t=.5);var r,s,a=0,h=new i(256),l=2/255;for(a=0;256>a;)r=l*a,s=r>t?255-255*r:255*r-255,h[a]=~~n(s),a++;return this.set(h)},solarize2:function(t){t===e&&(t=.5),t=1-t;var r,s,a=0,h=new i(256),l=2/255;for(a=0;256>a;)r=l*a,s=t>r?255-255*r:255*r-255,h[a]=~~n(s),a++;return this.set(h)},solarizeInverse:function(t){t===e&&(t=.5),t*=256;var n=0,r=new i(256);for(n=0;256>n;)r[n]=n>t?255-n:n,n++;return this.set(r)},invert:function(){return this.set(c)},mask:function(t){var e=0,r=255&t>>16,s=255&t>>8,a=255&t;for(tR=new i(256),tG=new i(256),tB=new i(256),e=0;256>e;)tR[e]=n(e&r),tG[e]=n(e&s),tB[e]=n(e&a),e++;return this.set(tR,tG,tB)},replace:function(t,e){if(t==e)return this;var i=255&t>>16,n=255&t>>8,r=255&t,s=255&e>>16,h=255&e>>8,l=255&e,o=a(u),c=a(u),f=a(u);return o[i]=s,c[n]=h,f[r]=l,this.set(o,c,f)},extract:function(e,i,r){if(!i||!i.length)return this;r=r||0;var a,h,l=255&r>>16,o=255&r>>8,u=255&r,c=s(l),f=s(o),m=s(u);switch(e){case t.CHANNEL.BLUE:for(a=i[0],h=i[1];h>=a;)m[a]=n(a),a++;break;case t.CHANNEL.GREEN:for(a=i[0],h=i[1];h>=a;)f[a]=n(a),a++;break;case t.CHANNEL.RED:default:for(a=i[0],h=i[1];h>=a;)c[a]=n(a),a++}return this.set(c,f,m)},gammaCorrection:function(t,e,r){t=t||1,e=e||t,r=r||e,t=1/t,e=1/e,r=1/r;for(var s=new i(256),a=new i(256),l=new i(256),u=0;256>u;)s[u]=n(~~(255*h(o*u,t))),a[u]=n(~~(255*h(o*u,e))),l[u]=n(~~(255*h(o*u,r))),u++;return this.set(s,a,l)},exposure:function(t){t===e&&(t=1);var r=0,s=new i(256);for(r=0;256>r;)s[r]=n(~~(255*(1-l(-t*r*o)))),r++;return this.set(s)},set:function(t,e,i){if(!t)return this;e=e||t,i=i||e;var s,h,l,o,u,c=this._tableR||r(),f=a(c);if(e&&i){for(s=this._tableG||a(c),h=this._tableB||a(s),l=a(s),o=a(h),u=0;256>u;)c[u]=n(t[n(f[u])]),s[u]=n(e[n(l[u])]),h[u]=n(i[n(o[u])]),u++;this._tableR=c,this._tableG=s,this._tableB=h}else{for(u=0;256>u;)c[u]=n(t[n(f[u])]),u++;this._tableR=c,this._tableG=this._tableR,this._tableB=this._tableR}return this},reset:function(){return this._tableR=this._tableG=this._tableB=this._tableA=null,this},combineWith:function(t){return this.set(t.getTable(0),t.getTable(1),t.getTable(2))},getTable:function(e){switch(e=e||t.CHANNEL.RED){case t.CHANNEL.ALPHA:return this._tableA;case t.CHANNEL.BLUE:return this._tableB;case t.CHANNEL.GREEN:return this._tableG;case t.CHANNEL.RED:default:return this._tableR}},setTable:function(e,i){switch(i=i||t.CHANNEL.RED){case t.CHANNEL.ALPHA:return this._tableA=e,this;case t.CHANNEL.BLUE:return this._tableB=e,this;case t.CHANNEL.GREEN:return this._tableG=e,this;case t.CHANNEL.RED:default:return this._tableR=e,this}},_apply:function(t){if(!this._isOn||!this._tableR)return t;var e,i,n,r,s,a=t.length,h=(a>>2)%4,l=this._tableR,o=this._tableG,u=this._tableB,c=this._tableA;if(c){for(e=0;a>e;e+=16)i=t[e],n=t[e+1],r=t[e+2],s=t[e+3],t[e]=l[i],t[e+1]=o[n],t[e+2]=u[r],t[e+3]=c[s],i=t[e+4],n=t[e+5],r=t[e+6],s=t[e+7],t[e+4]=l[i],t[e+5]=o[n],t[e+6]=u[r],t[e+7]=c[s],i=t[e+8],n=t[e+9],r=t[e+10],s=t[e+11],t[e+8]=l[i],t[e+9]=o[n],t[e+10]=u[r],t[e+11]=c[s],i=t[e+12],n=t[e+13],r=t[e+14],s=t[e+15],t[e+12]=l[i],t[e+13]=o[n],t[e+14]=u[r],t[e+15]=c[s];if(h)for(h<<=2,e=a-h;a>e;e+=4)i=t[e],n=t[e+1],r=t[e+2],s=t[e+3],t[e]=l[i],t[e+1]=o[n],t[e+2]=u[r],t[e+3]=c[s]}else{for(e=0;a>e;e+=16)i=t[e],n=t[e+1],r=t[e+2],t[e]=l[i],t[e+1]=o[n],t[e+2]=u[r],i=t[e+4],n=t[e+5],r=t[e+6],t[e+4]=l[i],t[e+5]=o[n],t[e+6]=u[r],i=t[e+8],n=t[e+9],r=t[e+10],t[e+8]=l[i],t[e+9]=o[n],t[e+10]=u[r],i=t[e+12],n=t[e+13],r=t[e+14],t[e+12]=l[i],t[e+13]=o[n],t[e+14]=u[r];if(h)for(h<<=2,e=a-h;a>e;e+=4)i=t[e],n=t[e+1],r=t[e+2],t[e]=l[i],t[e+1]=o[n],t[e+2]=u[r]}return t},apply:function(t,e){if(this._isOn&&this._tableR){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._apply(i[0],i[1],i[2],t)),e&&e.call(this))}return t}});f.prototype.posterize=f.prototype.levels=f.prototype.quantize}(e),!function(t){"use strict";var e=(t.ImArray,t.ImArrayCopy),i=t.Array16I,n=Math.min,r=(Math.max,Math.floor);t.DisplacementMapFilter=t.Class(t.Filter,{name:"DisplacementMapFilter",constructor:function(t){t&&this.setMap(t)},_map:null,map:null,scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,red:0,green:0,blue:0,alpha:0,mode:t.MODE.CLAMP,dispose:function(){var t=this;return t.disposeWorker(),t._map=null,t.map=null,t.scaleX=null,t.scaleY=null,t.startX=null,t.startY=null,t.componentX=null,t.componentY=null,t.color=null,t.red=null,t.green=null,t.blue=null,t.alpha=null,t.mode=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_map:t._map,scaleX:t.scaleX,scaleY:t.scaleY,startX:t.startX,startY:t.startY,componentX:t.componentX,componentY:t.componentY,color:t.color,red:t.red,green:t.green,blue:t.blue,alpha:t.alpha,mode:t.mode}}},unserialize:function(t){var e,i=this;return t&&i.name===t.filter&&(e=t.params,i.map=null,i._map=e._map,i.scaleX=e.scaleX,i.scaleY=e.scaleY,i.startX=e.startX,i.startY=e.startY,i.componentX=e.componentX,i.componentY=e.componentY,i.color=e.color,i.red=e.red,i.green=e.green,i.blue=e.blue,i.alpha=e.alpha,i.mode=e.mode),i},reset:function(){return this._map=null,this.map=null,this},getMap:function(){return this.map},setMap:function(t){return t&&(this.map=t,this._map={data:t.getData(),width:t.width,height:t.height}),this},setColor:function(t){return this.color=t,this.alpha=255&t>>24,this.red=255&t>>16,this.green=255&t>>8,this.blue=255&t,this},_apply:function(s,a,h){if(!this._isOn||!this._map)return s;var l,o,u,c,f,m,d,_,p,g,v,w,A,y,b,E,L,M,C,N,x,R,D,k,I,S,U,O,W,H,G,P=.00390625*this.scaleX,T=.00390625*this.scaleY,F=this.componentX,Y=this.componentY,B=this.alpha,X=this.red,z=this.green,j=this.blue,V=this.mode,q=t.MODE.IGNORE,Q=(t.MODE.CLAMP,t.MODE.COLOR),K=t.MODE.WRAP;for(l=this._map.data,o=this._map.width,u=this._map.height,c=l.length>>2,m=n(o,a),d=n(u,h),O=s.length,S=m*d<<2,U=O>>2,p=r(this.startX*(a-1)),_=r(this.startY*(h-1)),g=_*a,v=-p,w=-_,A=a-p-1,y=h-_-1,f=new i(c<<1),W=new e(s),E=0,L=0,M=0,C=0,b=0;c>b;b++,E+=2,L++)L>=o&&(L=0,M++,C+=o),D=L+C<<2,f[E]=r((l[D+F]-128)*P),f[E+1]=r((l[D+Y]-128)*T);for(L=0,M=0,C=0,N=0,b=0;S>b;b+=4,L++)if(L>=m&&(L=0,M++,C+=a,N+=o),!(w>M||M>y||v>L||L>A)){if(R=L+p,x=M+_,k=R+C+g<<2,E=L+N<<1,H=R+f[E],G=x+f[E+1],G>=h||0>G||H>=a||0>H){if(V==q)continue;if(V==Q){s[k]=X,s[k+1]=z,s[k+2]=j,s[k+3]=B;continue}V==K?(G>y?G-=h:0>G&&(G+=h),H>A?H-=a:0>H&&(H+=a)):(G>y?G=y:0>G&&(G=0),H>A?H=A:0>H&&(H=0))}I=H+G*a<<2,s[k]=W[I],s[k+1]=W[I+1],s[k+2]=W[I+2],s[k+3]=W[I+3]}return s},apply:function(t,e){if(this._isOn&&(this._map||this.map)){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._apply(i[0],i[1],i[2],t)),e&&e.call(this))}return t}})}(e),!function(t,e){"use strict";var i,n=t.ImArray,r=t.ImArrayCopy,s=t.CONSTANTS.PI,a=t.CONSTANTS.PI2,h=t.CONSTANTS.PI_2,l=1.5*s,o=Math.sqrt,u=Math.atan2,c=Math.atan,f=Math.sin,m=Math.cos,d=Math.floor,_=Math.asin,p=Math.tan,g=(Math.abs,Math.max);t.CONSTANTS.toRad,t.GeometricMapFilter=t.Class(t.Filter,{name:"GeometricMapFilter",constructor:function(t){t&&this.generic(t)},_map:null,_mapName:null,inverseTransform:null,matrix:null,centerX:0,centerY:0,angle:0,radius:0,wavelength:0,amplitude:0,phase:0,xAmplitude:0,yAmplitude:0,xWavelength:0,yWavelength:0,mode:t.MODE.CLAMP,dispose:function(){var t=this;return t.disposeWorker(),t._map=null,t._mapName=null,t.inverseTransform=null,t.matrix=null,t.centerX=null,t.centerY=null,t.angle=null,t.radius=null,t.wavelength=null,t.amplitude=null,t.phase=null,t.xAmplitude=null,t.yAmplitude=null,t.xWavelength=null,t.yWavelength=null,t.mode=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_mapName:t._mapName,matrix:t.matrix,centerX:t.centerX,centerY:t.centerY,angle:t.angle,radius:t.radius,wavelength:t.wavelength,amplitude:t.amplitude,phase:t.phase,xAmplitude:t.xAmplitude,yAmplitude:t.yAmplitude,xWavelength:t.xWavelength,yWavelength:t.yWavelength,mode:t.mode}}},unserialize:function(t){var e,n=this;return t&&n.name===t.filter&&(e=t.params,n.inverseTransform=null,n.matrix=e.matrix,n.centerX=e.centerX,n.centerY=e.centerY,n.angle=e.angle,n.radius=e.radius,n.wavelength=e.wavelength,n.amplitude=e.amplitude,n.phase=e.phase,n.xAmplitude=e.xAmplitude,n.yAmplitude=e.yAmplitude,n.xWavelength=e.xWavelength,n.yWavelength=e.yWavelength,n.mode=e.mode,n._mapName=e._mapName,n._map=null,n._mapName&&i[n._mapName]&&(n._map=i[n._mapName].bind(n))),n},generic:function(t){return t&&(this.inverseTransform=t,this._mapName="generic",this._map=i.generic.bind(this)),this},affine:function(t){return t&&(this.matrix=t,this._mapName="affine",this._map=i.affine.bind(this)),this},flipX:function(){return this._mapName="flipX",this._map=i.flipX.bind(this),this},flipY:function(){return this._mapName="flipY",this._map=i.flipY.bind(this),this},flipXY:function(){return this._mapName="flipXY",this._map=i.flipXY.bind(this),this},rotateCW:function(){return this._mapName="rotateCW",this._map=i.rotateCW.bind(this),this},rotateCCW:function(){return this._mapName="rotateCCW",this._map=i.rotateCCW.bind(this),this},polar:function(t,e){return this.centerX=t||0,this.centerY=e||0,this._mapName="polar",this._map=i.polar.bind(this),this},cartesian:function(t,e){return this.centerX=t||0,this.centerY=e||0,this._mapName="cartesian",this._map=i.cartesian.bind(this),this},twirl:function(t,e,n,r){return this.angle=t||0,this.radius=e||0,this.centerX=n||0,this.centerY=r||0,this._mapName="twirl",this._map=i.twirl.bind(this),this},sphere:function(t,e,n){return this.radius=t||0,this.centerX=e||0,this.centerY=n||0,this._mapName="sphere",this._map=i.sphere.bind(this),this},ripple:function(t,n,r,s,a,h){return this.radius=t!==e?t:50,this.centerX=a||0,this.centerY=h||0,this.wavelength=n!==e?n:16,this.amplitude=r!==e?r:10,this.phase=s||0,this._mapName="ripple",this._map=i.ripple.bind(this),this},reset:function(){return this._mapName=null,this._map=null,this},getMap:function(){return this._map},setMap:function(t){return this._mapName=null,this._map=t,this},_apply:function(t,e,i,n){return this._isOn&&this._map?this._map(t,e,i,n):t},apply:function(t,e){if(this._isOn&&this._map){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._map(i[0],i[1],i[2],t)),e&&e.call(this))}return t}}),i={generic:function(e,i,r){var s,a,h,l,o,u,c,f=e.length,m=new n(f),d=this.inverseTransform,_=this.mode,p=t.MODE.CLAMP,g=t.MODE.WRAP;for(s=0,a=0,h=0;f>h;h+=4,s++){if(s>=i&&(s=0,a++),o=d([s,a],i,r),u=~~o[0],c=~~o[1],0>u||u>=i||0>c||c>=r)switch(_){case g:c>=r?c-=r:0>c&&(c+=r),u>=i?u-=i:0>u&&(u+=i);break;case p:default:c>=r?c=r-1:0>c&&(c=0),u>=i?u=i-1:0>u&&(u=0)}l=u+c*i<<2,m[h]=e[l],m[h+1]=e[l+1],m[h+2]=e[l+2],m[h+3]=e[l+3]}return m},affine:function(e,i){var r,s,a,h,l,o,u,c,f,m=e.length,d=m>>2,_=new n(m),p=this.matrix,g=p[0],v=p[1],w=p[3],A=p[4],y=p[2],b=p[5],E=this.mode,L=t.MODE.CLAMP,M=t.MODE.WRAP,C=i-1,N=d-i;for(r=0,s=0,l=b*i,o=w*i,u=A*i,a=0;m>a;a+=4,r++){if(r>=i&&(r=0,s++),c=~~(g*r+v*s+y),f=~~(o*r+u*s+l),0>c||c>C||0>f||f>N)switch(E){case M:f>N?f-=d:0>f&&(f+=d),c>=i?c-=i:0>c&&(c+=i);break;case L:default:f>N?f=N:0>f&&(f=0),c>C?c=C:0>c&&(c=0)}h=c+f<<2,_[a]=e[h],_[a+1]=e[h+1],_[a+2]=e[h+2],_[a+3]=e[h+3]}return _},flipX:function(t,e){var i,r,s,a,h,l=t.length,o=new n(l);for(i=0,r=0,s=0,a=0;l>a;a+=4,i++)i>=e&&(i=0,r++,s+=e),h=e-1-i+s<<2,o[a]=t[h],o[a+1]=t[h+1],o[a+2]=t[h+2],o[a+3]=t[h+3];return o},flipY:function(t,e,i){var r,s,a,h,l,o=t.length,u=new n(o);for(r=0,s=0,a=(i-1)*e,h=0;o>h;h+=4,r++)r>=e&&(r=0,s++,a-=e),l=r+a<<2,u[h]=t[l],u[h+1]=t[l+1],u[h+2]=t[l+2],u[h+3]=t[l+3];return u},flipXY:function(t,e,i){var r,s,a,h,l,o,u=t.length,c=new n(u);for(r=0,s=0,h=(i-1)*e,l=0;u>l;l+=4,r++)r>=e&&(r=0,s++,a+=e,h-=e),o=e-1-r+h<<2,c[l]=t[o],c[l+1]=t[o+1],c[l+2]=t[o+2],c[l+3]=t[o+3];return c},rotateCW:function(t,e){var i,r,s,a,h,l=t.length,o=new n(l),u=l>>2;for(i=0,r=0,s=u-1,a=0;l>a;a+=4,i++,s-=e)i>=e&&(i=0,s=u-1,r++),h=r+s<<2,o[a]=t[h],o[a+1]=t[h+1],o[a+2]=t[h+2],o[a+3]=t[h+3];return o},rotateCCW:function(t,e){var i,r,s,a,h,l=t.length,o=new n(l);for(i=0,r=0,s=0,a=0;l>a;a+=4,i++,s+=e)i>=e&&(i=0,s=0,r++),h=e-1-r+s<<2,o[a]=t[h],o[a+1]=t[h+1],o[a+2]=t[h+2],o[a+3]=t[h+3];return o},twirl:function(e,i,n){if(0>=this.radius)return e;var s,a,h,l,c,_,p,g,v=e.length,w=new r(e),A=this.centerX,y=this.centerY,b=this.angle,E=this.radius,L=this.mode,M=t.MODE.CLAMP,C=t.MODE.WRAP,N=b/E,x=i-1,R=n-1;for(A=d(A*(i-1)),y=d(y*(n-1)),s=0,a=0,h=0;v>h;h+=4,s++)if(s>=i&&(s=0,a++),_=s-A,p=a-y,c=o(_*_+p*p),E>c){if(g=u(p,_)+N*(E-c),_=~~(A+c*m(g)),p=~~(y+c*f(g)),0>_||_>x||0>p||p>R)switch(L){case C:p>R?p-=n:0>p&&(p+=n),_>x?_-=i:0>_&&(_+=i);break;case M:default:p>R?p=R:0>p&&(p=0),_>x?_=x:0>_&&(_=0)}l=_+p*i<<2,e[h]=w[l],e[h+1]=w[l+1],e[h+2]=w[l+2],e[h+3]=w[l+3]}return e},sphere:function(e,i,n){if(0>=this.radius)return e;var s,a,h,l,u,c,f,m,g,v,w,A,y,b=e.length,E=new r(e),L=this.centerX,M=this.centerY,C=this.radius,N=this.mode,x=t.MODE.CLAMP,R=t.MODE.WRAP,D=C*C,k=.555556,I=1-k,S=i-1,U=n-1;for(L=d(L*(i-1)),M=d(M*(n-1)),s=0,a=0,h=0;b>h;h+=4,s++)if(s>=i&&(s=0,a++),u=s-L,c=a-M,A=u*u,y=c*c,f=A+y,D>f){if(v=D-f,w=o(v),m=_(u/o(A+v))*I,g=_(c/o(y+v))*I,u=~~(s-w*p(m)),c=~~(a-w*p(g)),0>u||u>S||0>c||c>U)switch(N){case R:c>U?c-=n:0>c&&(c+=n),u>S?u-=i:0>u&&(u+=i);break;case x:default:c>U?c=U:0>c&&(c=0),u>S?u=S:0>u&&(u=0)}l=u+c*i<<2,e[h]=E[l],e[h+1]=E[l+1],e[h+2]=E[l+2],e[h+3]=E[l+3]}return e},ripple:function(e,i,n){if(0>=this.radius)return e;var s,a,h,l,u,c,m,_,p,g,v,w=e.length,A=new r(e),y=t.MODE.CLAMP,b=t.MODE.WRAP,E=i-1,L=n-1,M=this.centerX,C=this.centerY,N=this.radius,x=this.mode,R=N*N,D=this.wavelength,k=this.amplitude,I=this.phase;for(M=d(M*(i-1)),C=d(C*(n-1)),s=0,a=0,h=0;w>h;h+=4,s++)if(s>=i&&(s=0,a++),c=s-M,m=a-C,g=c*c,v=m*m,p=g+v,R>p){if(u=o(p),_=k*f(2*u/D*Math.PI-I),_*=(N-u)/N,u&&(_*=D/u),c=~~(s+c*_),m=~~(a+m*_),0>c||c>E||0>m||m>L)switch(x){case b:m>L?m-=n:0>m&&(m+=n),c>E?c-=i:0>c&&(c+=i);break;case y:default:m>L?m=L:0>m&&(m=0),c>E?c=E:0>c&&(c=0)}l=c+m*i<<2,e[h]=A[l],e[h+1]=A[l+1],e[h+2]=A[l+2],e[h+3]=A[l+3]}return e},polar:function(e,i,n){var u,f,m,d,_,p,v,w,A,y,b,E,L=e.length,M=new r(e),C=t.MODE.CLAMP,N=t.MODE.WRAP,x=i-1,R=n-1,D=0,k=this.mode;for(b=~~(.5*i+.5),E=~~(.5*n+.5),y=g(E,b),u=0,f=0,m=0;L>m;m+=4,u++){if(u>=i&&(u=0,f++),d=u-b,_=f-E,A=0,d>=0?_>0?(A=s-c(d/_),D=o(d*d+_*_)):0>_?(A=c(d/_),D=o(d*d+_*_)):(A=h,D=d):0>d&&(0>_?(A=a-c(d/_),D=o(d*d+_*_)):_>0?(A=s+c(d/_),D=o(d*d+_*_)):(A=l,D=-d)),p=i-1-(i-1)/a*A,v=n*D/y,0>p||p>x||0>v||v>R)switch(k){case N:v>R?v-=n:0>v&&(v+=n),p>x?p-=i:0>p&&(p+=i);break;case C:default:v>R?v=R:0>v&&(v=0),p>x?p=x:0>p&&(p=0)}w=~~(p+.5)+~~(v+.5)*i<<2,e[m]=M[w],e[m+1]=M[w+1],e[m+2]=M[w+2],e[m+3]=M[w+3]}return e},cartesian:function(e,i,n){var o,u,c,d,_,p,v,w,A,y,b,E,L,M=e.length,C=new r(e),N=t.MODE.CLAMP,x=t.MODE.WRAP,R=i-1,D=n-1,k=0,I=this.mode;for(E=~~(.5*i+.5),L=~~(.5*n+.5),b=g(L,E),o=0,u=0,c=0;M>c;c+=4,o++){if(o>=i&&(o=0,u++),A=o/i*a,y=A>=l?a-A:A>=s?A-s:A>=h?s-A:A,k=b*(u/n),v=-k*f(y),w=k*m(y),A>=l?(d=E-v,_=L-w):A>=s?(d=E-v,_=L+w):A>=h?(d=E+v,_=L+w):(d=E+v,_=L-w),0>d||d>R||0>_||_>D)switch(I){case x:_>D?_-=n:0>_&&(_+=n),d>R?d-=i:0>d&&(d+=i);break;case N:default:_>D?_=D:0>_&&(_=0),d>R?d=R:0>d&&(d=0)}p=~~(d+.5)+~~(_+.5)*i<<2,e[c]=C[p],e[c+1]=C[p+1],e[c+2]=C[p+2],e[c+3]=C[p+3]}return e}}}(e),!function(t,e){"use strict";function i(t,e,i,n){var r,s=t.length,a=new A(t.length);for(i=i||1,n=n||1,r=0;s>r;)a[r]=i*t[r]+n*e[r],r++;return a}function n(t,e){var i,n,r,s=t.length,a=[],h=0;for(i=0;s>i;i++)for(n=0;s>n;n++)r=t[i]*e[n],h+=r,a.push(r);return{kernel:a,sum:h}}function r(t){var e,i=new Array(t);for(e=0;t>e;)i[e]=1,e++;return i}function s(t){var e,i,n,r,s=M.length;if(t--,s>t)e=new A(M[t]);else for(e=new A(M[s-1]);t>=s;){for(i=e,e=new A(i.length+1),e[0]=1,n=0,r=i.length-1;r>n;n++)e[n+1]=i[n]+i[n+1];e[i.length]=1,40>s&&M.push(new Array(e)),s++}return e}function a(t){var e,i=t>>1,n=-i,r=new Array(t);for(e=0;t>e;)r[e]=n,n++,e++;return r}function h(t){var e=s(t);return n(e,e)}function l(t,e){var i=s(t),r=a(t);return 1==e?n(r.reverse(),i):n(i,r)}function o(t,e){var i=r(t),s=a(t);return 1==e?n(s.reverse(),i):n(i,s)}function u(t,e,i){e=e||1,i=i||e;var n,r=t*t,s=r>>1,a=new A(r);for(n=0;r>n;)a[n]=e,n++;return a[s]=i,a}function c(t,e,i,n){var r,s,a,h,l,o=t*t,u=t>>1,c=o>>1,f=new A(o);for(h=0,r=0;u>=r;r++){for(s=0,l=0,a=0;u>=a;a++)f[c+r+s]=h+l,f[c-r-s]=-h-l,f[c-r+s]=-h+l,f[c+r-s]=h-l,s+=t,l+=i;h+=e}return f[c]=n||1,f}function f(t,e,i,n){var r,s,a,h,l,o,u=t*t,c=t>>1,f=u>>1,m=new A(u),d=new A(u),_=1/t,g=1e-8;for(p(e)>g?(l=1,o=i/e):(l=e/i,o=1),r=0,a=0,h=0,s=o*t;c>=r;)d[f+r]=~~(f+a+h+.5),d[f-r]=~~(f-a-h+.5),r++,a+=l,h+=s;for(r=0;c>=r;)m[d[f+r]]=m[d[f-r]]=_,r++;return m[f]=n||1,m}function m(t,e,i,n,r,s,a,h,l,o){var u,c,f,m,d,_,p,g,v,w,A,E,M,C,N,x,R,D,k,I,S,U,O,W,H,G,P,T,F,Y,B,X,z,j,V,q,Q,K,$,J,Z,te,ee,ie,ne,re,se,ae=t.length,he=ae>>2,le=s,oe=a;if(g=le*oe,_=le>>1,p=e*(oe>>1),A=-_-1,M=-p-e,E=_,C=p,Y=0,X=e-1,B=0,z=he-e,c=(he<<1)+he,w=(e<<1)+e,o=o||1,se=0,r)for(I=n[0],S=n[g>>1],U=S-I,O=r[0],W=r[g>>1],H=W-O;o>se;){for(v=new y(ae),u=new b(c),N=0,x=0,f=m=d=0,R=0;e>R;R++,N+=4,x+=3)f+=t[N],m+=t[N+1],d+=t[N+2],u[x]=f,u[x+1]=m,u[x+2]=d;for(x=0,R=0,f=m=d=0,N=w+e;ae>N;N+=4,x+=3,R++)R>=e&&(R=0,f=m=d=0),f+=t[N],m+=t[N+1],d+=t[N+2],u[x+w]=u[x]+f,u[x+w+1]=u[x+1]+m,u[x+w+2]=u[x+2]+d;for(R=0,D=0,k=0,N=0;ae>N;N+=4,R++)R>=e&&(R=0,D++,k+=e),G=R+A,P=k+M,T=R+E,F=k+C,G=Y>G?Y:G,T=T>X?X:T,P=B>P?B:P,F=F>z?z:F,j=G+P,Q=T+F,V=T+P,q=G+F,j=(j<<1)+j,V=(V<<1)+V,q=(q<<1)+q,Q=(Q<<1)+Q,Z=I*(u[Q]-u[V]-u[q]+u[j])+U*t[N],te=I*(u[Q+1]-u[V+1]-u[q+1]+u[j+1])+U*t[N+1],ee=I*(u[Q+2]-u[V+2]-u[q+2]+u[j+2])+U*t[N+2],ie=O*(u[Q]-u[V]-u[q]+u[j])+H*t[N],ne=O*(u[Q+1]-u[V+1]-u[q+1]+u[j+1])+H*t[N+1],re=O*(u[Q+2]-u[V+2]-u[q+2]+u[j+2])+H*t[N+2],K=h*Z+l*ie,$=h*te+l*ne,J=h*ee+l*re,L&&(K=0>K?0:K>255?255:K,$=0>$?0:$>255?255:$,J=0>J?0:J>255?255:J),v[N]=~~K,v[N+1]=~~$,v[N+2]=~~J,v[N+3]=t[N+3];t=v,se++}else for(I=n[0],S=n[g>>1],U=S-I;o>se;){for(v=new y(ae),u=new b(c),N=0,x=0,f=m=d=0,R=0;e>R;R++,N+=4,x+=3)f+=t[N],m+=t[N+1],d+=t[N+2],u[x]=f,u[x+1]=m,u[x+2]=d;for(x=0,R=0,f=m=d=0,N=w+e;ae>N;N+=4,x+=3,R++)R>=e&&(R=0,f=m=d=0),f+=t[N],m+=t[N+1],d+=t[N+2],u[x+w]=u[x]+f,u[x+w+1]=u[x+1]+m,u[x+w+2]=u[x+2]+d;for(R=0,D=0,k=0,N=0;ae>N;N+=4,R++)R>=e&&(R=0,D++,k+=e),G=R+A,P=k+M,T=R+E,F=k+C,G=Y>G?Y:G,T=T>X?X:T,P=B>P?B:P,F=F>z?z:F,j=G+P,Q=T+F,V=T+P,q=G+F,j=(j<<1)+j,V=(V<<1)+V,q=(q<<1)+q,Q=(Q<<1)+Q,Z=I*(u[Q]-u[V]-u[q]+u[j])+U*t[N],te=I*(u[Q+1]-u[V+1]-u[q+1]+u[j+1])+U*t[N+1],ee=I*(u[Q+2]-u[V+2]-u[q+2]+u[j+2])+U*t[N+2],K=h*Z+l,$=h*te+l,J=h*ee+l,L&&(K=0>K?0:K>255?255:K,$=0>$?0:$>255?255:$,J=0>J?0:J>255?255:J),v[N]=~~K,v[N+1]=~~$,v[N+2]=~~J,v[N+3]=t[N+3];t=v,se++}return v}function d(t,e,i,n,r,s,a,h,l){var o,u,c,f,m,d,_,p,g,v,w,A,b,M,C,N,x,R,D,k,I,S,U,O,W,H,G,P=t.length,T=P>>2;for(o=[r,n],u=[a,s],W=[l,h],N=e-1,x=T-e,G=2;G--;){for(_=new y(P),f=o[G],m=u[G],c=f.length,d=m.length,H=W[G],p=new E(m),w=0;d>w;w+=2)p[w+1]*=e;if(L)for(A=0,b=0,g=0;P>g;g+=4,A++){for(A>=e&&(A=0,b+=e),S=0,U=0,O=0,w=0,v=0;c>w;w++,v+=2)M=A+p[v],C=b+p[v+1],M>=0&&N>=M&&C>=0&&x>=C&&(srcOff=M+C<<2,I=f[w],S+=t[srcOff]*I,U+=t[srcOff+1]*I,O+=t[srcOff+2]*I);R=H*S,D=H*U,k=H*O,R=0>R?0:R>255?255:R,D=0>D?0:D>255?255:D,k=0>k?0:k>255?255:k,_[g]=~~R,_[g+1]=~~D,_[g+2]=~~k,_[g+3]=t[g+3]}else for(A=0,b=0,g=0;P>g;g+=4,A++){for(A>=e&&(A=0,b+=e),S=0,U=0,O=0,w=0,v=0;c>w;w++,v+=2)M=A+p[v],C=b+p[v+1],M>=0&&N>=M&&C>=0&&x>=C&&(srcOff=M+C<<2,I=f[w],S+=t[srcOff]*I,U+=t[srcOff+1]*I,O+=t[srcOff+2]*I);R=H*S,D=H*U,k=H*O,_[g]=~~R,_[g+1]=~~D,_[g+2]=~~k,_[g+3]=t[g+3]}t=_}return _}var _=(t.CONSTANTS.SQRT2,t.CONSTANTS.toRad),p=(t.CONSTANTS.toDeg,Math.abs),g=Math.sqrt,v=Math.sin,w=Math.cos,A=t.Array32F,y=t.ImArray,b=t.Array32F,E=t.Array16I,L=(t.Array8U,t._notSupportClamp),M=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],C=t.ConvolutionMatrixFilter=t.Class(t.Filter,{name:"ConvolutionMatrixFilter",constructor:function(e,i,n){this._coeff=new A([1,0]),e&&e.length?this.set(e,~~(g(e.length)+.5),i||1,n||0):(this._matrix=null,this._dim=0),this._matrix2=null,this._dim2=0,this._isGrad=!1,this._doIntegral=0,this._doSeparable=!1,t.useWebGL&&(this._webglInstance=t.WebGLConvolutionMatrixFilterInstance||null)},_dim:0,_dim2:0,_matrix:null,_matrix2:null,_mat:null,_mat2:null,_coeff:null,_isGrad:!1,_doIntegral:0,_doSeparable:!1,_indices:null,_indices2:null,_indicesf:null,_indicesf2:null,_webglInstance:null,dispose:function(){var t=this;return t.disposeWorker(),t._webglInstance=null,t._dim=null,t._dim2=null,t._matrix=null,t._matrix2=null,t._mat=null,t._mat2=null,t._coeff=null,t._isGrad=null,t._doIntegral=null,t._doSeparable=null,t._indices=null,t._indices2=null,t._indicesf=null,t._indicesf2=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_dim:t._dim,_dim2:t._dim2,_matrix:t._matrix,_matrix2:t._matrix2,_mat:t._mat,_mat2:t._mat2,_coeff:t._coeff,_isGrad:t._isGrad,_doIntegral:t._doIntegral,_doSeparable:t._doSeparable,_indices:t._indices,_indices2:t._indices2,_indicesf:t._indicesf,_indicesf2:t._indicesf2}}},unserialize:function(t){var e,i=this;return t&&i.name===t.filter&&(e=t.params,i._dim=e._dim,i._dim2=e._dim2,i._matrix=e._matrix,i._matrix2=e._matrix2,i._mat=e._mat,i._mat2=e._mat2,i._coeff=e._coeff,i._isGrad=e._isGrad,i._doIntegral=e._doIntegral,i._doSeparable=e._doSeparable,i._indices=e._indices,i._indices2=e._indices2,i._indicesf=e._indicesf,i._indicesf2=e._indicesf2),i},lowPass:function(t){return t=t===e?3:t%2?t:t+1,this.set(u(t),t,1/(t*t),0),this._doIntegral=1,this},highPass:function(t,i){t=t===e?3:t%2?t:t+1,i=i===e?1:i;var n=t*t,r=-i/n,s=u(t,r,1+r);return this.set(s,t,1,0),this._doIntegral=1,this},glow:function(t,i){return t=t===e?.5:t,this.highPass(i,-t)},sharpen:function(t,i){return t=t===e?.5:t,this.highPass(i,t)},verticalBlur:function(t){return t=t===e?3:t%2?t:t+1,this.set(r(t),1,1/t,0),this._dim2=t,this._doIntegral=1,this},horizontalBlur:function(t){return t=t===e?3:t%2?t:t+1,this.set(r(t),t,1/t,0),this._dim2=1,this._doIntegral=1,this},directionalBlur:function(t,i){i=i===e?3:i%2?i:i+1,t*=_;var n=w(t),r=-v(t),s=f(i,n,r,1/i);return this.set(s,i,1,0)},fastGauss:function(t,i){return i=i===e?3:i%2?i:i+1,t=~~(t||1),1>t?t=1:t>3&&(t=3),this.set(u(i),i,1/(i*i),0),this._doIntegral=t,this},binomialLowPass:function(t){t=t===e?3:t%2?t:t+1;var i=s(t),n=1<<t-1,r=1/n;this.set(i,t,r,r),this._matrix2=new A(i);var a=this._computeIndices(this._matrix2,this._dim2);return this._indices2=a[0],this._indicesf2=a[1],this._mat2=a[2],this._doSeparable=!0,this},binomialHighPass:function(t){t=t===e?3:t%2?t:t+1;var n=h(t);return this.set(i(u(t),new A(n.kernel),1,-1/n.sum),t,1,0)},prewittX:function(t){t=t===e?3:t%2?t:t+1;var i=o(t,0);return this.set(i.kernel,t,1,0)},prewittY:function(t){t=t===e?3:t%2?t:t+1;var i=o(t,1);return this.set(i.kernel,t,1,0)},prewittDirectional:function(t,n){n=n===e?3:n%2?n:n+1,t*=_;var r=w(t),s=v(t),a=o(n,0),h=o(n,1);return this.set(i(new A(a.kernel),new A(h.kernel),r,s),n,1,0)},prewitt:function(t){t=t===e?3:t%2?t:t+1;var i=o(t,0),n=o(t,1);this.set(i.kernel,t,1,0),this._isGrad=!0,this._matrix2=new A(n.kernel);var r=this._computeIndices(this._matrix2,this._dim2);return this._indices2=r[0],this._indicesf2=r[1],this._mat2=r[2],this},sobelX:function(t){t=t===e?3:t%2?t:t+1;var i=l(t,0);return this.set(i.kernel,t,1,0)},sobelY:function(t){t=t===e?3:t%2?t:t+1;var i=l(t,1);return this.set(i.kernel,t,1,0)},sobelDirectional:function(t,n){n=n===e?3:n%2?n:n+1,t*=_;var r=w(t),s=v(t),a=l(n,0),h=l(n,1);return this.set(i(new A(a.kernel),new A(h.kernel),r,s),n,1,0)},sobel:function(t){t=t===e?3:t%2?t:t+1;var i=l(t,0),n=l(t,1);this.set(i.kernel,t,1,0),this._matrix2=new A(n.kernel);var r=this._computeIndices(this._matrix2,this._dim2);return this._indices2=r[0],this._indicesf2=r[1],this._mat2=r[2],this._isGrad=!0,this},laplace:function(t){t=t===e?3:t%2?t:t+1;var i=t*t,n=u(t,-1,i-1);return this.set(n,t,1,0),this._doIntegral=1,this},emboss:function(t,i,n){n=n===e?3:n%2?n:n+1,t=t===e?-.25*Math.PI:t*_,i=i||1;var r=i*w(t),s=-i*v(t),a=c(n,r,s,1);return this.set(a,n,1,0)},edges:function(t){return t=t||1,this.set([0,t,0,t,-4*t,t,0,t,0],3,1,0)},set:function(t,e,i,n){this._matrix2=null,this._dim2=0,this._indices2=this._indicesf2=null,this._mat2=null,this._isGrad=!1,this._doIntegral=0,this._doSeparable=!1,this._matrix=new A(t),this._dim=e,this._coeff[0]=i||1,this._coeff[1]=n||0;var r=this._computeIndices(this._matrix,this._dim);return this._indices=r[0],this._indicesf=r[1],this._mat=r[2],this},_computeIndices:function(t,e){var i,n,r,s=[],a=[],h=[],l=t.length,o=e,u=o>>1;for(n=0,r=0,i=0;l>i;)a.push(n-u),a.push(r-u),t[i]&&(s.push(n-u),s.push(r-u),h.push(t[i])),i++,n++,n>=o&&(n=0,r++);return[new E(s),new E(a),new A(h)]},reset:function(){return this._matrix=this._matrix2=null,this._mat=this._mat2=null,this._dim=this._dim2=0,this._indices=this._indices2=this._indicesf=this._indicesf2=null,this._isGrad=!1,this._doIntegral=0,this._doSeparable=!1,this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(t,e){return this.set(t,e)},_apply:function(t,e,i){if(!this._isOn||!this._matrix)return t;
if(this._doIntegral)return this._matrix2?m(t,e,i,this._matrix,this._matrix2,this._dim,this._dim2,this._coeff[0],this._coeff[1],this._doIntegral):m(t,e,i,this._matrix,null,this._dim,this._dim,this._coeff[0],this._coeff[1],this._doIntegral);if(this._doSeparable)return d(t,e,i,this._mat,this._mat2,this._indices,this._indices2,this._coeff[0],this._coeff[1]);var n,r,s,a,h,l,o,u,c,f,_,g,v,w,A,b,M,C,N,x,R,D,k=t.length,I=k>>2,S=new y(k),U=e-1,O=I-e,W=this._coeff[0],H=this._coeff[1],G=this._matrix,P=this._matrix2,T=this._isGrad;if(P){for(x=this._indicesf.length,D=new E(this._indicesf),l=0;x>l;l+=2)D[l+1]*=e;for(R=G.length,o=0,u=0,a=0;k>a;a+=4,o++){for(o>=e&&(o=0,u+=e),g=0,v=0,w=0,A=0,b=0,M=0,l=0,h=0;R>l;l++,h+=2)c=o+D[h],f=u+D[h+1],c>=0&&U>=c&&f>=0&&O>=f&&(_=c+f<<2,C=G[l],g+=t[_]*C,v+=t[_+1]*C,w+=t[_+2]*C,N=P[l],A+=t[_]*N,b+=t[_+1]*N,M+=t[_+2]*N);T?(n=p(g)+p(A),r=p(v)+p(b),s=p(w)+p(M)):(n=W*g+H*A,r=W*v+H*b,s=W*w+H*M),L&&(n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s),S[a]=~~n,S[a+1]=~~r,S[a+2]=~~s,S[a+3]=t[a+3]}}else{for(x=this._indices.length,D=new E(this._indices),l=0;x>l;l+=2)D[l+1]*=e;for(G=this._mat,R=G.length,o=0,u=0,a=0;k>a;a+=4,o++){for(o>=e&&(o=0,u+=e),g=0,v=0,w=0,l=0,h=0;R>l;l++,h+=2)c=o+D[h],f=u+D[h+1],c>=0&&U>=c&&f>=0&&O>=f&&(_=c+f<<2,C=G[l],g+=t[_]*C,v+=t[_+1]*C,w+=t[_+2]*C);n=W*g+H,r=W*v+H,s=W*w+H,L&&(n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s),S[a]=~~n,S[a+1]=~~r,S[a+2]=~~s,S[a+3]=t[a+3]}}return S},apply:function(t,e){if(this._isOn&&this._matrix)if(this._worker)this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:t.getSelectedData(),params:this.serialize()});else{var i=t.getSelectedData();t.setSelectedData(this._apply(i[0],i[1],i[2],t)),e&&e.call(this)}return t}});C.prototype.bump=C.prototype.emboss,C.prototype.boxBlur=C.prototype.lowPass,C.prototype.gaussBlur=C.prototype.binomialLowPass,C.prototype.gradX=C.prototype.prewittX,C.prototype.gradY=C.prototype.prewittY,C.prototype.gradDirectional=C.prototype.prewittDirectional,C.prototype.grad=C.prototype.prewitt}(e),!function(t){"use strict";var e,i=t.ImArray,n=t.Array8U,r=t.Array32I,s=Math.sqrt,a=function(t){var e,i=t*t,r=new n(i);for(e=0;i>e;e++)r[e]=1;return r},h=a(3);t.MorphologicalFilter=t.Class(t.Filter,{name:"MorphologicalFilter",constructor:function(){this._filterName=null,this._filter=null,this._dim=0,this._structureElement=null,this._indices=null},_filterName:null,_filter:null,_dim:0,_structureElement:null,_indices:null,dispose:function(){var t=this;return t.disposeWorker(),t._filterName=null,t._filter=null,t._dim=null,t._structureElement=null,t._indices=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_filterName:t._filterName,_dim:t._dim,_structureElement:t._structureElement,_indices:t._indices}}},unserialize:function(t){var i,n=this;return t&&n.name===t.filter&&(i=t.params,n._dim=i._dim,n._structureElement=i._structureElement,n._indices=i._indices,n._filterName=i._filterName,n._filterName&&e[n._filterName]&&(n._filter=e[n._filterName].bind(n))),n},erode:function(t){return this.set(t,"erode")},dilate:function(t){return this.set(t,"dilate")},opening:function(t){return this.set(t,"open")},closing:function(t){return this.set(t,"close")},set:function(t,i){this._filterName=i,this._filter=e[i].bind(this),t&&t.length?(this._structureElement=new n(t),this._dim=~~(s(this._structureElement.length)+.5)):t&&t===t-0?(this._structureElement=a(t),this._dim=t):(this._structureElement=h,this._dim=3);var l,o,u,c=[],t=this._structureElement,f=t.length,m=this._dim,d=m>>1;for(o=0,u=0,l=0;f>l;)t[l]&&(c.push(o-d),c.push(u-d)),l++,o++,o>=m&&(o=0,u++);return this._indices=new r(c),this},reset:function(){return this._filterName=null,this._filter=null,this._dim=0,this._structureElement=null,this._indices=null,this},_apply:function(t,e,i){return this._isOn&&this._dim&&this._filter?this._filter(t,e,i):t},apply:function(t,e){if(this._isOn&&this._dim&&this._filter){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._filter(i[0],i[1],i[2],t)),e&&e.call(this))}return t}}),e={dilate:function(t,e){var n,s,a,h,l,o,u,c,f,m,d,_,p,g,v=this._structureElement,w=(v.length,this._dim,new r(this._indices)),A=t.length,y=A>>2,b=new i(A),E=w.length,L=E>>1,M=e-1,C=y-e;for(a=0;E>a;a+=2)w[a+1]*=e;for(h=0,l=0,n=0;A>n;n+=4,h++){for(h>=e&&(h=0,l+=e),_=0,p=0,g=0,s=0;L>s;s+=2)o=h+w[s],u=l+w[s+1],o>=0&&M>=o&&u>=0&&C>=u&&(c=o+u<<2,f=t[c],m=t[c+1],d=t[c+2],f>_&&(_=f),m>p&&(p=m),d>g&&(g=d));b[n]=_,b[n+1]=p,b[n+2]=g,b[n+3]=t[n+3]}return b},erode:function(t,e){var n,s,a,h,l,o,u,c,f,m,d,_,p,g,v=this._structureElement,w=(v.length,this._dim,new r(this._indices)),A=t.length,y=A>>2,b=new i(A),E=w.length,L=E>>1,M=e-1,C=y-e;for(a=0;E>a;a+=2)w[a+1]*=e;for(h=0,l=0,n=0;A>n;n+=4,h++){for(h>=e&&(h=0,l+=e),_=255,p=255,g=255,s=0;L>s;s+=2)o=h+w[s],u=l+w[s+1],o>=0&&M>=o&&u>=0&&C>=u&&(c=o+u<<2,f=t[c],m=t[c+1],d=t[c+2],_>f&&(_=f),p>m&&(p=m),g>d&&(g=d));b[n]=_,b[n+1]=p,b[n+2]=g,b[n+3]=t[n+3]}return b},open:function(t,e){var n,s,a,h,l,o,u,c,f,m,d,_,p,g,v=this._structureElement,w=(v.length,this._dim,new r(this._indices)),A=t.length,y=A>>2,b=new i(A),E=w.length,L=E>>1,M=e-1,C=y-e;for(a=0;E>a;a+=2)w[a+1]*=e;for(h=0,l=0,n=0;A>n;n+=4,h++){for(h>=e&&(h=0,l+=e),_=255,p=255,g=255,s=0;L>s;s+=2)o=h+w[s],u=l+w[s+1],o>=0&&M>=o&&u>=0&&C>=u&&(c=o+u<<2,f=t[c],m=t[c+1],d=t[c+2],_>f&&(_=f),p>m&&(p=m),g>d&&(g=d));b[n]=_,b[n+1]=p,b[n+2]=g,b[n+3]=t[n+3]}for(t=b,b=new i(A),h=0,l=0,n=0;A>n;n+=4,h++){for(h>=e&&(h=0,l+=e),_=255,p=255,g=255,s=0;L>s;s+=2)o=h+w[s],u=l+w[s+1],o>=0&&M>=o&&u>=0&&C>=u&&(c=o+u<<2,f=t[c],m=t[c+1],d=t[c+2],_>f&&(_=f),p>m&&(p=m),g>d&&(g=d));b[n]=_,b[n+1]=p,b[n+2]=g,b[n+3]=t[n+3]}return b},close:function(t,e){var n,s,a,h,l,o,u,c,f,m,d,_,p,g,v=this._structureElement,w=(v.length,this._dim,new r(this._indices)),A=t.length,y=A>>2,b=new i(A),E=w.length,L=E>>1,M=e-1,C=y-e;for(a=0;E>a;a+=2)w[a+1]*=e;for(h=0,l=0,n=0;A>n;n+=4,h++){for(h>=e&&(h=0,l+=e),_=255,p=255,g=255,s=0;L>s;s+=2)o=h+w[s],u=l+w[s+1],o>=0&&M>=o&&u>=0&&C>=u&&(c=o+u<<2,f=t[c],m=t[c+1],d=t[c+2],_>f&&(_=f),p>m&&(p=m),g>d&&(g=d));b[n]=_,b[n+1]=p,b[n+2]=g,b[n+3]=t[n+3]}for(t=b,b=new i(A),h=0,l=0,n=0;A>n;n+=4,h++){for(h>=e&&(h=0,l+=e),_=255,p=255,g=255,s=0;L>s;s+=2)o=h+w[s],u=l+w[s+1],o>=0&&M>=o&&u>=0&&C>=u&&(c=o+u<<2,f=t[c],m=t[c+1],d=t[c+2],_>f&&(_=f),p>m&&(p=m),g>d&&(g=d));b[n]=_,b[n+1]=p,b[n+2]=g,b[n+3]=t[n+3]}return b}}}(e),!function(t,e){"use strict";var i,n=t.ImArray,r=t.Array32I;Math.min,Math.max;var s=t.StatisticalFilter=t.Class(t.Filter,{name:"StatisticalFilter",constructor:function(){this._dim=0,this._indices=null,this._filterName=null,this._filter=null},_dim:0,_indices:null,_filter:null,_filterName:null,dispose:function(){var t=this;return t.disposeWorker(),t._dim=null,t._indices=null,t._filter=null,t._filterName=null,t},serialize:function(){var t=this;return{filter:t.name,params:{_filterName:t._filterName,_dim:t._dim,_indices:t._indices}}},unserialize:function(t){var e,n=this;return t&&n.name===t.filter&&(e=t.params,n._dim=e._dim,n._indices=e._indices,n._filterName=e._filterName,n._filterName&&i[n._filterName]&&(n._filter=i[n._filterName].bind(n))),n},median:function(t){return t=t===e?3:t%2?t:t+1,this.set(t,"median")},minimum:function(t){return t=t===e?3:t%2?t:t+1,this.set(t,"minimum")},maximum:function(t){return t=t===e?3:t%2?t:t+1,this.set(t,"maximum")},set:function(t,e){this._filterName=e,this._filter=i[e].bind(this),this._dim=t;var n,s,a,h=[],l=t*t,o=t,u=o>>1;for(s=0,a=0,n=0;l>n;)h.push(s-u),h.push(a-u),n++,s++,s>=o&&(s=0,a++);return this._indices=new r(h),this},reset:function(){return this._filterName=null,this._filter=null,this._dim=0,this._indices=null,this},_apply:function(t,e,i){return this._isOn&&this._dim?this._filter(t,e,i):t},apply:function(t,e){if(this._isOn&&this._dim){var i=t.getSelectedData();this._worker?this.bind("apply",function(i){this.unbind("apply"),i&&i.im&&t.setSelectedData(i.im),e&&e.call(this)}).send("apply",{im:i,params:this.serialize()}):(t.setSelectedData(this._filter(i[0],i[1],i[2],t)),e&&e.call(this))}return t}});s.prototype.erode=s.prototype.minimum,s.prototype.dilate=s.prototype.maximum,i={median:function(t,e){var i,s,a,h,l,o,u,c,f,m,d,_,p,g,v,w,A,y,b=this._dim,E=b*b,L=new r(this._indices),M=t.length,C=M>>2,N=new n(M),x=E<<1,R=e-1,D=C-e;for(c=[],f=[],m=[],s=0;x>s;s+=2)L[s+1]*=e;for(i=0,a=0,h=0;M>i;){for(c.length=0,f.length=0,m.length=0,s=0;x>s;)l=a+L[s],o=h+L[s+1],l>=0&&R>=l&&o>=0&&D>=o&&(u=l+o<<2,d=t[u],_=t[u+1],p=t[u+2],c.push(d),f.push(_),m.push(p)),s+=2;c.sort(),f.sort(),m.sort(),A=c.length,y=A>>1,g=A%2?c[y+1]:~~(.5*(c[y]+c[y+1])),A=f.length,y=A>>1,v=A%2?f[y+1]:~~(.5*(f[y]+f[y+1])),A=m.length,y=A>>1,w=A%2?m[y+1]:~~(.5*(m[y]+m[y+1])),N[i]=g,N[i+1]=v,N[i+2]=w,N[i+3]=t[i+3],i+=4,a++,a>=e&&(a=0,h+=e)}return N},maximum:function(t,e){var i,s,a,h,l,o,u,c,f,m,d,_,p,g=this._dim,v=g*g,w=new r(this._indices),A=t.length,y=A>>2,b=new n(A),E=v<<1,L=e-1,M=y-e;for(s=0;E>s;s+=2)w[s+1]*=e;for(i=0,a=0,h=0;A>i;){for(d=0,_=0,p=0,s=0;E>s;)l=a+w[s],o=h+w[s+1],l>=0&&L>=l&&o>=0&&M>=o&&(u=l+o<<2,c=t[u],f=t[u+1],m=t[u+2],c>d&&(d=c),f>_&&(_=f),m>p&&(p=m)),s+=2;b[i]=d,b[i+1]=_,b[i+2]=p,b[i+3]=t[i+3],i+=4,a++,a>=e&&(a=0,h+=e)}return b},minimum:function(t,e){var i,s,a,h,l,o,u,c,f,m,d,_,p,g=this._dim,v=g*g,w=new r(this._indices),A=t.length,y=A>>2,b=new n(A),E=v<<1,L=e-1,M=y-e;for(s=0;E>s;s+=2)w[s+1]*=e;for(i=0,a=0,h=0;A>i;){for(d=255,_=255,p=255,s=0;E>s;)l=a+w[s],o=h+w[s+1],l>=0&&L>=l&&o>=0&&M>=o&&(u=l+o<<2,c=t[u],f=t[u+1],m=t[u+2],d>c&&(d=c),_>f&&(_=f),p>m&&(p=m)),s+=2;b[i]=d,b[i+1]=_,b[i+2]=p,b[i+3]=t[i+3],i+=4,a++,a>=e&&(a=0,h+=e)}return b}}}(e),e});