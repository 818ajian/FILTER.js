/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.3
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(a){function o(a,e){var a=a||{},b;for(b in e)e&&Object.prototype.hasOwnProperty.call(e,b)&&(a[b]=e[b]);return a}a.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;a.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;a.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;a.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;a.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;a.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;a.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;a.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;a.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:a.Array8U;a._notSupportTypedArrays=!a.ImArray.set;a.CONSTANTS={PI:Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI};a.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};a.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};a.LUMA=new a.Array32F([0.212671,0.71516,0.072169]);a.Filter=function(){};a.Filter.prototype={_apply:function(){},apply:function(){},
reset:function(){}};a.CompositeFilter=function(a){this._stack=typeof a!="undefined"&&a.length?a:[]};a.CompositeFilter.prototype={_stack:[],_apply:function(a,e,b,c){if(!this._stack.length)return a;for(var d=this._stack,g=d.length,s=0,f;s<g;)(f=d[s++])&&(a=f._apply(a,e,b,c));return a},apply:function(a){if(!this._stack.length)return a;return a.setData(this._apply(im=a.getData(),a.width,a.height,a))},filters:function(a){if(a)this._stack=a;return this},push:function(a){this._stack.push(a);return this},
pop:function(){return this._stack.pop()},shift:function(){return this._stack.shift()},unshift:function(a){this._stack.unshift(a);return this},concat:function(a){return this.push(a)},getAt:function(a){return this._stack.length>a?this._stack[a]:null},setAt:function(a,e){this._stack.length>a&&(this._stack[a]=e);return this},insertAt:function(a,e){this._stack.splice(a,0,e);return this},removeAt:function(a){this._stack.splice(a,1);return this},remove:function(a){for(var e=this._stack.length;--e>=0;)a===
this._stack[e]&&this._stack.splice(e,1);return this},reset:function(){this._stack.length=0;return this}};a.Create=function(a){var e=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},a=o({init:function(){},reset:function(){return this},apply:function(b){return b}},a);a._apply=a.apply;a.apply=function(b){return b.setData(this._apply(b.getData(),b.width,b.height,b))};e.prototype=o(e.prototype,a);return e}})(FILTER);
(function(a){var o=Math.sqrt,h=Math.min,e=Math.max;a.Color={blend:function(b,c,d){return{r:b.r-~~((b.r-c.r)*d+0.5),g:b.g-~~((b.g-c.g)*d+0.5),b:b.b-~~((b.b-c.b)*d+0.5)}},toGray:function(b,c,d){var g=a.LUMA;return~~(g[0]*b+g[1]*c+g[2]*d)},distance:function(b,c){var d=b.r-c.r,g=b.g-c.g,a=b.b-c.b;return o(d*d+g*g+a*a)},RGB2Color:function(b){return b.r<<16|b.g<<8|b.b&255},RGBA2Color:function(b){return b.a<<24|b.r<<16|b.g<<8|b.b&255},Color2RGBA:function(b){b=~~b;return{r:b>>>16&255,g:b>>>8&255,b:b&255,
a:b>>>24&255}},RGB2YCbCr:function(b){var c=b.r,d=b.g,b=b.b;return{y:~~(0+0.299*c+0.587*d+0.114*b),cb:~~(128-0.168736*c-0.331264*d+0.5*b),cr:~~(128+0.5*c-0.418688*d-0.081312*b)}},YCbCr2RGB:function(b){var c=b.y,d=b.cb,b=b.cr;return{r:~~(c+1.402*(b-128)),g:~~(c-0.34414*(d-128)-0.71414*(b-128)),b:~~(c+1.772*(d-128))}},RGB2HSV:function(b){var c,d,g,a;d=b.r;g=b.g;a=b.b;c=h(d,g,a);b=e(d,g,a);c=b-c;if(b==0)return{h:0,s:0,v:b};d=d==b?(g-a)/c:g==b?2+(a-d)/c:4+(d-g)/c;d*=60;d<0&&(d+=360);return{h:d,s:c/b,v:b}},
HSV2RGB:function(b){var c,d,g,a,f;g=b.h;f=b.s;b=b.v;if(f==0)return c=d=b,{r:c,g:d,b:b};g/=60;c=~~g;d=g-c;g=b*(1-f);a=b*(1-f*d);f=b*(1-f*(1-d));switch(c){case 0:c=b;d=f;b=g;break;case 1:c=a;d=b;b=g;break;case 2:c=g;d=b;b=f;break;case 3:c=g;d=a;break;case 4:c=f;d=g;break;default:c=b,d=g,b=a}return{r:c,g:d,b:b}}}})(FILTER);
(function(a){function o(d,b){var c=document.createElement("canvas");c.width=d||0;c.height=b||0;return c}var h,e=Math.min,b=a.ImArray;h={normal:function(d){return d},lighten:function(d,b){return b>d?b:d},darken:function(d,b){return b>d?d:b},multiply:function(d,b){return d*b*0.003921568627451},average:function(d,b){return 0.5*(d+b)},add:function(d,b){return Math.min(255,d+b)},substract:function(d,b){return d+b<255?0:d+b-255},difference:function(d,b){return Math.abs(d-b)},negation:function(d,b){return 255-
Math.abs(255-d-b)},screen:function(d,b){return 255-((255-d)*(255-b)>>8)},exclusion:function(d,b){return d+b-2*d*b*0.003921568627451},overlay:function(d,b){return b<128?2*d*b*0.003921568627451:255-2*(255-d)*(255-b)*0.003921568627451},softLight:function(d,b){return b<128?2*((d>>1)+64)*b*0.003921568627451:255-2*(255-((d>>1)+64))*(255-b)*0.003921568627451},hardLight:function(d,b){return d<128?2*b*d*0.003921568627451:255-2*(255-b)*(255-d)*0.003921568627451},colorDodge:function(d,b){return b==255?b:Math.min(255,
(d<<8)/(255-b))},colorBurn:function(d,b){return b==0?b:Math.max(0,255-(255-d<<8)/b)},linearLight:function(d,b){return b<128?h.linearBurn(d,2*b):h.linearDodge(d,2*(b-128))},vividLight:function(d,b){return b<128?h.colorBurn(d,2*b):h.colorDodge(d,2*(b-128))},pinLight:function(d,b){return b<128?h.darken(d,2*b):h.lighten(d,2*(b-128))},hardMix:function(d,b){return h.vividLight(d,b)<128?0:255},reflect:function(d,b){return b==255?b:Math.min(255,d*d/(255-b))},glow:function(d,b){return d==255?d:Math.min(255,
b*b/(255-d))},phoenix:function(d,b){return Math.min(d,b)-Math.max(d,b)+255}};h.linearDodge=h.add;h.linearBurn=h.substract;a.blendModes=h;var c=a._notSupportTypedArrays;a.Image=function(d,b){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=o(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=o(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(d,b)};
a.Image.prototype={width:0,height:0,canvasElement:null,domElement:null,setWidth:function(b){this._tmpCanvas.width=this.canvasElement.width=this.width=b;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setHeight:function(b){this._tmpCanvas.height=this.canvasElement.height=this.height=b;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,
0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setImage:function(b,c){if(typeof b=="undefined"||b==null)return this;var a=this,f,j;b instanceof Image||b instanceof HTMLCanvasElement||b instanceof HTMLVideoElement?(f=b,this.width=f instanceof HTMLVideoElement?f.videoWidth:f.width,this.height=f instanceof HTMLVideoElement?f.videoHeight:f.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,
j=this.context=this.canvasElement.getContext("2d"),j.drawImage(b,0,0),this.imageData=j.getImageData(0,0,this.width,this.height),this._integralRefresh=this._histogramRefresh=!0):(f=new Image,f.onload=function(){a.width=f.width;a.height=f.height;a._tmpCanvas.width=a.canvasElement.width=a.width;a._tmpCanvas.height=a.canvasElement.height=a.height;j=a.context=a.canvasElement.getContext("2d");j.drawImage(f,0,0);a.imageData=a.context.getImageData(0,0,a.width,a.height);a._histogramRefresh=!0;a._integralRefresh=
!0;typeof c!="undefined"&&c.call(a)},f.src=b);f.crossOrigin="";return this},getPixel:function(b,c){var a=~~(c*this.width+b+0.5),f=this.imageData.data;return{r:f[a],g:f[a+1],b:f[a+2],a:f[a+3]}},setPixel:function(d,c,a,f,j,n){this.context.putImageData(new b([a&255,f&255,j&255,n&255]),d,c);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new b(this.imageData.data)},setData:function(b){c?this._setData(b):
this.imageData.data.set(b);this.context.putImageData(this.imageData,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(b){this.context.putImageData(b,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},createImageData:function(b,c){this._tmpCanvas.width=this.canvasElement.width=
this.width=b;this._tmpCanvas.height=this.canvasElement.height=this.height=c;this.context=this.canvasElement.getContext("2d");this.context.createImageData(b,c);return this.imageData=this.context.getImageData(0,0,this.width,this.height)},copy:function(b){this.setData(b.getData());this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},clone:function(){return new a.Image(this.canvasElement)},scale:function(b,c){b=b||1;c=c||b;if(1==b&&1==c)return this;var a=this._tmpCanvas.getContext("2d");
a.scale(b,c);a.drawImage(this.canvasElement,0,0);this.canvasElement.width=this.width=~~(b*this.width+0.5);this.canvasElement.height=this.height=~~(c*this.height+0.5);this.context.drawImage(this._tmpCanvas,0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipHorizontal:function(){var b=this._tmpCanvas.getContext("2d");b.translate(this.width,0);b.scale(-1,
1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipVertical:function(){var b=this._tmpCanvas.getContext("2d");b.translate(0,this.height);b.scale(1,-1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=
!0;return this},clear:function(){if(this.width&&this.height){var b=this.context;b.clearRect(0,0,this.width,this.height);this.imageData=b.getImageData(0,0,this.width,this.height)}return this},fill:function(b,c,a,f,j){if(!f&&this.width&&!j&&this.height)return this;else if(f&&!this.width&&j&&!this.height)this._tmpCanvas.width=this.canvasElement.width=this.width=f+c,this._tmpCanvas.height=this.canvasElement.height=this.height=j+a,this.context=this.canvasElement.getContext("2d"),this.context.createImageData(f,
j),this.imageData=this.context.getImageData(0,0,this.width,this.height);var f=f||this.width,j=j||this.height,n=this.context;n.fillStyle=b||0;n.fillRect(c||0,a||0,f,j);this.imageData=n.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},draw:function(){return this},blend:function(b,c,a,f,j){typeof c=="undefined"&&(c="normal");typeof a=="undefined"&&(a=1);a>1?a=1:a<0&&(a=0);typeof f=="undefined"&&(f=0);typeof j=="undefined"&&(j=0);var n=0,q=0,l=this.context;
f<0&&(n=-f,f=0);j<0&&(q=-j,j=0);if(f>=this.width||j>=this.height)return this;c=h[c];if(c==void 0||c==null)return this;var t=e(this.width,b.width-n),u=e(this.height,b.height-q),r=this.context.getImageData(f,j,t,u),n=b.context.getImageData(n,q,t,u),b=r.data,n=n.data,z,p,m,v=1-a,B=n.length,C;for(C=0;C<B;C+=4)z=b[C],p=b[C+1],m=b[C+2],q=c(n[C],z),t=c(n[C+1],p),u=c(n[C+2],m),b[C]=q*a+z*v,b[C+1]=t*a+p*v,b[C+2]=u*a+m*v;l.putImageData(r,f,j);this.imageData=l.getImageData(0,0,this.width,this.height);this._integralRefresh=
this._histogramRefresh=!0;return this},integral:function(){this._integralRefresh&&this._computeIntegral();return this._integral},histogram:function(){this._histogramRefresh&&this._computeHistogram();return this._histogram},_setData:function(b){for(var c=this.imageData.data,a=b.length,f=0;f<a;)c[f]=b[f],f++},_computeIntegral:function(){var b=this.width,c=b*this.height,e=b<<2,f=new a.Array32F(c),j=new a.Array32F(c),c=new a.Array32F(c),n=this.getPixelData().data,q,l,t,h,r,z;for(h=r=z=t=l=q=0;t<b;)h+=
n[q],r+=n[q+1],z+=n[q+2],f[l]=h,j[l]=r,c[l]=z,q+=4,l++,t++;q=e;for(h=r=z=t=0;q<imLen;)h+=n[q],r+=n[q+1],z+=n[q+2],f[l]=f[l-b]+h,j[l]=j[l-b]+r,c[l]=c[l-b]+z,q+=4,l++,t++,t>=b&&(h=r=z=t=0);this._integral=[f,j,c];this._integralRefresh=!1},_computeHistogram:function(){for(var b=this.getPixelData().data,c=0,e=b.length,f,j,n,q=0,l=0,t=0,h=255,r=255,z=255,p=new a.Array32F(256),m=new a.Array32F(256),v=new a.Array32F(256),B=1/(e>>2),c=0;c<256;)p[c]=0,m[c]=0,v[c]=0,c++;for(c=0;c<e;)f=b[c],j=b[c+1],n=b[c+2],
p[f]+=B,m[j]+=B,v[n]+=B,f>q&&(q=f),f<h&&(h=f),j>l&&(l=j),j<r&&(r=j),n>t&&(t=n),n<z&&(z=n),c+=4;this._histogram=[p,m,v];this._histogramRefresh=!1},_refresh:function(){this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this}}})(FILTER);
(function(a){a.CustomFilter=function(a){this._handler=a};a.CustomFilter.prototype={_handler:null,_apply:function(a,h,e,b){if(!this._handler)return a;return this._handler.call(this,a,h,e,b)},apply:function(a){if(!this._handler)return a;return a.setData(this._handler.call(this,a.getData(),a.width,a.height,a))}}})(FILTER);
(function(a){var o=a.Array32F,h=a.CONSTANTS.toRad,e=a._notSupportTypedArrays;a.ColorMatrixFilter=function(b){this._matrix=typeof b!="undefined"&&b.length?new o(b):null};a.ColorMatrixFilter.prototype={_matrix:null,channel:function(b,c){var d=(typeof c=="undefined"?0:c)?1:0;switch(b){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case a.CHANNEL.BLUE:return this.concat([0,0,d,0,0,0,0,d,0,0,0,0,1,0,0,0,0,0,0,255]);case a.CHANNEL.GREEN:return this.concat([0,d,0,0,
0,0,1,0,0,0,0,d,0,0,0,0,0,0,0,255]);default:return this.concat([1,0,0,0,0,d,0,0,0,0,d,0,0,0,0,0,0,0,0,255])}},redChannel:function(b){return this.channel(a.CHANNEL.RED,b)},greenChannel:function(b){return this.channel(a.CHANNEL.GREEN,b)},blueChannel:function(b){return this.channel(a.CHANNEL.BLUE,b)},alphaChannel:function(){return this.channel(a.CHANNEL.ALPHA,!0)},maskChannel:function(b){switch(b){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(b,c){switch(b){case a.CHANNEL.ALPHA:switch(c){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case a.CHANNEL.BLUE:switch(c){case a.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.BLUE:return this;case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case a.CHANNEL.GREEN:switch(c){case a.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(c){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case a.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(b,c){var d,g,e,f;typeof c=="undefined"&&(c=1);d=(b>>16&255)*0.00392156862745098;g=(b>>8&255)*0.00392156862745098;e=(b&255)*0.00392156862745098;f=1-c;return this.concat([f+c*d*a.LUMA[0],c*d*a.LUMA[1],c*d*a.LUMA[2],0,0,c*g*a.LUMA[0],f+c*g*a.LUMA[1],c*g*a.LUMA[2],0,0,c*e*a.LUMA[0],c*e*a.LUMA[1],f+c*e*a.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(b){var c,d,g;c=1-b;d=c*a.LUMA[0];g=c*a.LUMA[1];c*=a.LUMA[2];return this.concat([d+b,g,c,0,0,d,g+b,c,0,0,d,g,c+b,0,0,0,0,0,1,0])},contrast:function(b,c,a){typeof c=="undefined"&&(c=b);typeof a=="undefined"&&(a=b);b+=1;c+=1;a+=1;this._log=!0;return this.concat([b,0,0,0,128*(1-b),0,c,0,0,128*(1-c),0,0,a,0,128*(1-a),0,0,0,1,0])},brightness:function(b,c,a){typeof c=="undefined"&&(c=b);typeof a=="undefined"&&(a=b);return this.concat([1,0,0,0,b,0,1,0,0,c,0,0,1,0,a,
0,0,0,1,0])},adjustHue:function(b){b*=h;var c=Math.cos(b),b=Math.sin(b);return this.concat([a.LUMA[0]+c*(1-a.LUMA[0])+b*-a.LUMA[0],a.LUMA[1]+c*-a.LUMA[1]+b*-a.LUMA[1],a.LUMA[2]+c*-a.LUMA[2]+b*(1-a.LUMA[2]),0,0,a.LUMA[0]+c*-a.LUMA[0]+b*0.143,a.LUMA[1]+c*(1-a.LUMA[1])+b*0.14,a.LUMA[2]+c*-a.LUMA[2]+b*-0.283,0,0,a.LUMA[0]+c*-a.LUMA[0]+b*-(1-a.LUMA[0]),a.LUMA[1]+c*-a.LUMA[1]+b*a.LUMA[1],a.LUMA[2]+c*(1-a.LUMA[2])+b*a.LUMA[2],0,0,0,0,0,1,0])},average:function(b,c,a){typeof b=="undefined"&&(b=0.3333);typeof c==
"undefined"&&(c=0.3333);typeof a=="undefined"&&(a=0.3334);return this.concat([b,c,a,0,0,b,c,a,0,0,b,c,a,0,0,0,0,0,1,0])},quickContrastCorrection:function(b){typeof b=="undefined"&&(b=1.2);return this.concat([b,0,0,0,0,0,b,0,0,0,0,0,b,0,0,0,0,0,1,0])},quickSepia:function(b){typeof b=="undefined"&&(b=10);b>100&&(b=100);b*=2.55;return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,40,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,20,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,-b,0,0,0,1,0])},quickSepia2:function(b,c,a){typeof b==
"undefined"&&(b=1);typeof c=="undefined"&&(c=b);typeof a=="undefined"&&(a=b);return this.concat([b*0.5,0.5,0.5,0,0,0.33,c*0.33,0.33,0,0,0.25,0.25,a*0.25,0,0,0,0,0,1,0])},threshold:function(b,c){typeof c=="undefined"&&(c=256);return this.concat([a.LUMA[0]*c,a.LUMA[1]*c,a.LUMA[2]*c,0,-(c-1)*b,a.LUMA[0]*c,a.LUMA[1]*c,a.LUMA[2]*c,0,-(c-1)*b,a.LUMA[0]*c,a.LUMA[1]*c,a.LUMA[2]*c,0,-(c-1)*b,0,0,0,1,0])},threshold_rgb:function(b,c){typeof c=="undefined"&&(c=256);return this.concat([c,0,0,0,-(c-1)*b,0,c,0,
0,-(c-1)*b,0,0,c,0,-(c-1)*b,0,0,0,1,0])},threshold_alpha:function(b,c){typeof b=="undefined"&&(b=0.5);typeof c=="undefined"&&(c=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,c,-c*b])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(b,c){var a;if(this._matrix){a=
this._matrix;var g=b.getMatrix(),e=1-c,f=new o(20);f[0]=e*a[0]+c*g[0];f[1]=e*a[1]+c*g[1];f[2]=e*a[2]+c*g[2];f[3]=e*a[3]+c*g[3];f[4]=e*a[4]+c*g[4];f[5]=e*a[5]+c*g[5];f[6]=e*a[6]+c*g[6];f[7]=e*a[7]+c*g[7];f[8]=e*a[8]+c*g[8];f[9]=e*a[9]+c*g[9];f[10]=e*a[10]+c*g[10];f[11]=e*a[11]+c*g[11];f[12]=e*a[12]+c*g[12];f[13]=e*a[13]+c*g[13];f[14]=e*a[14]+c*g[14];f[15]=e*a[15]+c*g[15];f[16]=e*a[16]+c*g[16];f[17]=e*a[17]+c*g[17];f[18]=e*a[18]+c*g[18];f[19]=e*a[19]+c*g[19];a=f}else a=new o(b.getMatrix());this._matrix=
a;return this},concat:function(b){var a;if(this._matrix){a=this._matrix;var b=new o(b),d=new o(20),g,e,f,j,n;g=b[0];e=b[1];f=b[2];j=b[3];n=b[4];d[0]=g*a[0]+e*a[5]+f*a[10]+j*a[15];d[1]=g*a[1]+e*a[6]+f*a[11]+j*a[16];d[2]=g*a[2]+e*a[7]+f*a[12]+j*a[17];d[3]=g*a[3]+e*a[8]+f*a[13]+j*a[18];d[4]=g*a[4]+e*a[9]+f*a[14]+j*a[19]+n;g=b[5];e=b[6];f=b[7];j=b[8];n=b[9];d[5]=g*a[0]+e*a[5]+f*a[10]+j*a[15];d[6]=g*a[1]+e*a[6]+f*a[11]+j*a[16];d[7]=g*a[2]+e*a[7]+f*a[12]+j*a[17];d[8]=g*a[3]+e*a[8]+f*a[13]+j*a[18];d[9]=
g*a[4]+e*a[9]+f*a[14]+j*a[19]+n;g=b[10];e=b[11];f=b[12];j=b[13];n=b[14];d[10]=g*a[0]+e*a[5]+f*a[10]+j*a[15];d[11]=g*a[1]+e*a[6]+f*a[11]+j*a[16];d[12]=g*a[2]+e*a[7]+f*a[12]+j*a[17];d[13]=g*a[3]+e*a[8]+f*a[13]+j*a[18];d[14]=g*a[4]+e*a[9]+f*a[14]+j*a[19]+n;g=b[15];e=b[16];f=b[17];j=b[18];n=b[19];d[15]=g*a[0]+e*a[5]+f*a[10]+j*a[15];d[16]=g*a[1]+e*a[6]+f*a[11]+j*a[16];d[17]=g*a[2]+e*a[7]+f*a[12]+j*a[17];d[18]=g*a[3]+e*a[8]+f*a[13]+j*a[18];d[19]=g*a[4]+e*a[9]+f*a[14]+j*a[19]+n;a=d}else a=new o(b);this._matrix=
a;return this},combineWith:function(a){return this.concat(a.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(a){this._matrix=a;return this},_apply:function(a){if(!this._matrix)return a;for(var c=a.length,d=this._matrix,g=0,h,f,j,n,q,l,t;g<c;)h=a[g],f=a[g+1],j=a[g+2],n=a[g+3],q=d[0]*h+d[1]*f+d[2]*j+d[3]*n+d[4],l=d[5]*h+d[6]*f+d[7]*j+d[8]*n+d[9],t=d[10]*h+d[11]*f+d[12]*j+d[13]*n+d[14],h=d[15]*h+d[16]*f+d[17]*j+d[18]*n+d[19],e&&(q<0?q=0:q>255&&(q=255),l<0?l=0:l>255&&(l=255),
t<0?t=0:t>255&&(t=255),h<0?h=0:h>255&&(h=255)),a[g]=~~q,a[g+1]=~~l,a[g+2]=~~t,a[g+3]=~~h,g+=4;return a},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(a){function o(a){var d=new b(256),c=0;if(a)for(;c<256;)d[c]=255-c,c++;else for(;c<256;)d[c]=c,c++;return d}function h(a){for(var c=new b(256),d=0;d<256;)c[d]=a,d++;return c}function e(a){if(a)return new b(a);return null}var b=a.ImArray,c=Math.pow,d=Math.exp,g=1/255,s=o(),f=o(1);a.TableLookupFilter=function(a,b,c,d){this._tableR=a||null;this._tableG=b||this._tableR;this._tableB=c||this._tableG;this._tableA=d||null};a.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(a,c,d){a.length||(a=[a]);c||(c=a);d||(d=c);var e=a.length,f=e+1,g=c.length,h=g+1,s=d.length,p=s+1,m=new b(256),v=new b(f),B=new b(256),C=new b(h),P=new b(256),U=new b(p),k,R=255/(f-1),M=255/(h-1),N=255/(p-1);for(k=0;k<f;)v[k]=~~(R*k),k++;a[0]=~~(255*a[0]);for(k=1;k<e;)a[k]=a[k-1]+~~(255*a[k]),k++;for(k=0;k<h;)C[k]=~~(M*k),k++;c[0]=~~(255*c[0]);for(k=1;k<g;)c[k]=c[k-1]+~~(255*c[k]),k++;for(k=0;k<p;)U[k]=~~(N*k),k++;d[0]=~~(255*d[0]);for(k=1;k<s;)d[k]=d[k-1]+~~(255*d[k]),k++;for(k=
0;k<256;){for(f=0;f<e&&k>a[f];)f++;m[k]=v[f];for(f=0;f<g&&k>c[f];)f++;B[k]=C[f];for(f=0;f<s&&k>d[f];)f++;P[k]=U[f];k++}return this.concat(m,B,P)},threshold:function(a,b,c){a=a||0.5;b=b||a;return this.thresholds([a],[b],[c||b])},quantize:function(a){typeof a=="undefined"&&(a=64);a<2&&(a=2);var c=new b(256),d=new b(a),f,e=255/(a-1),g=a/256;for(f=0;f<a;)d[f]=~~(e*f),f++;for(f=0;f<256;)c[f]=d[~~(g*f)],f++;return this.concat(c)},levels:function(a){return this.quantize(a)},posterize:function(a){return this.quantize(a)},
binarize:function(){return this.quantize(2)},solarize:function(a){typeof a=="undefined"&&(a=0.5);for(var c=0,d=new b(256),a=~~(a*256)-1,c=0;c<256;)d[c]=c>a?255-(c<<1):(c<<1)-255,c++;return this.concat(d)},invert:function(){return this.concat(f)},mask:function(a){var c=0,d=a>>16&255,f=a>>8&255;a&=255;tR=new b(256);tG=new b(256);tB=new b(256);for(c=0;c<256;)tR[c]=c&d,tG[c]=c&f,tB[c]=c&a,c++;return this.concat(tR,tG,tB)},replace:function(a,b){if(a==b)return this;var c=a>>16&255,d=a>>8&255,f=a&255,g=
b>>16&255,h=b>>8&255,z=b&255,p=e(s),m=e(s),v=e(s);p[c]=g;m[d]=h;v[f]=z;return this.concat(p,m,v)},extract:function(b,c,d){if(!c||!c.length)return this;var d=d||0,f=d>>8&255,e=d&255,d=h(d>>16&255),f=h(f),e=h(e);switch(b){case a.CHANNEL.BLUE:b=c[0];for(c=c[1];b<=c;)e[b]=b,b++;break;case a.CHANNEL.GREEN:b=c[0];for(c=c[1];b<=c;)f[b]=b,b++;break;default:b=c[0];for(c=c[1];b<=c;)d[b]=b,b++}return this.concat(d,f,e)},gammaCorrection:function(a,d,f){for(var a=a||1,d=d||a,f=f||d,a=1/a,d=1/d,f=1/f,e=new b(256),
h=new b(256),s=new b(256),r=0;r<256;)e[r]=~~(255*c(g*r,a)),h[r]=~~(255*c(g*r,d)),s[r]=~~(255*c(g*r,f)),r++;return this.concat(e,h,s)},exposure:function(a){typeof a=="undefined"&&(a=1);for(var c=0,f=new b(256),c=0;c<256;)f[c]=~~(255*(1-d(-a*c*g))),c++;return this.concat(f)},concat:function(a,b,c){if(!a)return this;var b=b||a,c=c||b,d=this._tableR||o(),f,g,h=e(d),s,p,m;if(b&&c){f=this._tableG||e(d);g=this._tableB||e(f);s=e(f);p=e(g);for(m=0;m<256;)d[m]=a[h[m]],f[m]=b[s[m]],g[m]=c[p[m]],m++;this._tableR=
d;this._tableG=f;this._tableB=g}else{for(m=0;m<256;)d[m]=a[h[m]],m++;this._tableB=this._tableG=this._tableR=d}return this},combineWith:function(a){return this.concat(a.getTable(0),a.getTable(1),a.getTable(2))},getTable:function(b){b=b||a.CHANNEL.RED;switch(b){case a.CHANNEL.ALPHA:return this._tableA;case a.CHANNEL.BLUE:return this._tableB;case a.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(b,c){c=c||a.CHANNEL.RED;switch(c){case a.CHANNEL.ALPHA:return this._tableA=
b,this;case a.CHANNEL.BLUE:return this._tableB=b,this;case a.CHANNEL.GREEN:return this._tableG=b,this;default:return this._tableR=b,this}},_apply:function(a){if(!this._tableR)return a;var b=a.length,c=0,d,f,e,g,h=this._tableR,s=this._tableG,m=this._tableB,v=this._tableA;if(v)for(;c<b;)d=a[c],f=a[c+1],e=a[c+2],g=a[c+3],a[c]=h[d],a[c+1]=s[f],a[c+2]=m[e],a[c+3]=v[g],c+=4;else for(;c<b;)d=a[c],f=a[c+1],e=a[c+2],a[c]=h[d],a[c+1]=s[f],a[c+2]=m[e],c+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(a){var o=a.ImArray,h=Math.min;a.DisplacementMapFilter=function(a){a&&this.setMap(a)};a.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:a.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},_apply:function(e,b,c){if(!this._map)return e;var d=this._map.getData(),g=this._map.width,s=this._map.height,f=g*s,j=new a.Array16I(f<<1),n=h(g,b),q=h(s,c),l=
this.scaleX*0.00390625,t=this.scaleY*0.00390625,u=this.componentX,r=this.componentY,s=this.color>>24&255,z=this.color>>16&255,p=this.color>>8&255,m=this.color&255,v=~~this.startY,B=~~this.startX,C=this.mode,P=v*b,U=-B,k=-v,R=b-B-1,M=c-v-1,N,Q,V,X,Y,da=n*q<<2,E=new o(e),I=a.MODE.IGNORE,w=a.MODE.COLOR,S=a.MODE.WRAP;for(X=V=Q=N=q=0;q<f;)Y=Q+X<<2,j[N]=~~((d[Y+u]-128)*l),j[N+1]=~~((d[Y+r]-128)*t),q++,N+=2,Q++,Q>=g&&(Q=0,V++,X+=g);q=-4;Q=-1;for(ty2=X=V=0;q<da;)if(q+=4,Q++,Q>=n&&(Q=0,V++,X+=b,ty2+=g),!(V<
k||V>M||Q<U||Q>R)){l=Q+B;f=V+v;d=l+X+P<<2;N=Q+ty2<<1;srcx=l+j[N];srcy=f+j[N+1];if(srcy>=c||srcy<0||srcx>=b||srcx<0)switch(C){case I:continue;case w:E[d]=z;E[d+1]=p;E[d+2]=m;E[d+3]=s;continue;case S:srcy>M&&(srcy-=c);srcy<0&&(srcy+=c);srcx>R&&(srcx-=b);srcx<0&&(srcx+=b);break;default:srcy>M&&(srcy=M),srcy<0&&(srcy=0),srcx>R&&(srcx=R),srcx<0&&(srcx=0)}N=srcx+srcy*b<<2;E[d]=e[N];E[d+1]=e[N+1];E[d+2]=e[N+2];E[d+3]=e[N+3]}return E},apply:function(a){if(!this._map)return a;return a.setData(this._apply(a.getData(),
a.width,a.height,a))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function o(a,b){var c,d,f,e,k,g=a.length,h=new q(g);for(f=d=c=e=0;e<g;)k=b-1-c+f<<2,h[e]=a[k],h[e+1]=a[k+1],h[e+2]=a[k+2],h[e+3]=a[k+3],e+=4,c++,c>=b&&(c=0,d++,f+=b);return h}function h(a,b,c){var d,f,e,k,g=a.length,h=new q(g);f=d=e=0;for(c=(c-1)*b;e<g;)k=d+c<<2,h[e]=a[k],h[e+1]=a[k+1],h[e+2]=a[k+2],h[e+3]=a[k+3],e+=4,d++,d>=b&&(d=0,f++,c-=b);return h}function e(a,b,c){var d,f,e,k,g,h=a.length,j=new q(h);f=d=k=0;for(c=(c-1)*b;k<h;)g=b-1-d+c<<2,j[k]=a[g],j[k+1]=a[g+1],j[k+2]=a[g+2],j[k+
3]=a[g+3],k+=4,d++,d>=b&&(d=0,f++,e+=b,c-=b);return j}function b(a,b,c){var d,f,e,k,g=a.length,h=new q(g),j=c*b;d=c=e=0;for(f=j-1;e<g;)k=d+f<<2,h[e]=a[k],h[e+1]=a[k+1],h[e+2]=a[k+2],h[e+3]=a[k+3],e+=4,c++,f-=b,c>=b&&(c=0,f=j-1,d++);return h}function c(a,b){var c,d,f,e,k,g=a.length,h=new q(g);for(f=d=c=e=0;e<g;)k=b-1-d+f<<2,h[e]=a[k],h[e+1]=a[k+1],h[e+2]=a[k+2],h[e+3]=a[k+3],e+=4,c++,f+=b,c>=b&&(f=c=0,d++);return h}function d(b,c,d){var f,e,g,k,h=b.length,j=new q(h),l=this.inverseTransform,s=this.mode,
t=a.MODE.WRAP,n;for(e=f=g=0;g<h;){n=l([f,e],c,d);k=~~n[0];n=~~n[1];if(0>k||k>=c||0>n||n>=d)switch(s){case t:n>=d&&(n-=d);n<0&&(n+=d);k>=c&&(k-=c);k<0&&(k+=c);break;default:n>=d&&(n=d-1),n<0&&(n=0),k>=c&&(k=c-1),k<0&&(k=0)}k=k+n*c<<2;j[g]=b[k];j[g+1]=b[k+1];j[g+2]=b[k+2];j[g+3]=b[k+3];g+=4;f++;f>=c&&(f=0,e++)}return j}function g(b,c,d){var f,e,g,k,h=c*d,j=b.length,l=new q(j),n=this.a,s=this.b,t=this.c,r=this.d,p=this.mode,E=a.MODE.WRAP,I,w=c-1,u=h-c;e=f=d=g=0;for(r*=c;g<j;){k=~~(n*d+t);I=~~(s*e+r);
if(0>k||k>w||0>I||I>u)switch(p){case E:I>u&&(I-=h);I<0&&(I+=h);k>=c&&(k-=c);k<0&&(k+=c);break;default:I>u&&(I=u),I<0&&(I=0),k>w&&(k=w),k<0&&(k=0)}k=k+I<<2;l[g]=b[k];l[g+1]=b[k+1];l[g+2]=b[k+2];l[g+3]=b[k+3];g+=4;d++;d>=c&&(d=0,f++,e+=c)}return l}function s(b,c,d){if(0>=this.radius)return b;var f,e,g,k,h=b.length,j=new q(b),n=this.centerX,s=this.centerY,p=this.radius,z=this.mode,Y=a.MODE.WRAP,o,E,I=this.angle/p,w=c-1,S=d-1;for(e=f=g=0;g<h;){o=f-n;E=e-s;k=l(o*o+E*E);if(k<p){E=t(E,o)+I*(p-k);o=~~(n+
k*r(E));E=~~(s+k*u(E));if(0>o||o>w||0>E||E>S)switch(z){case Y:E>S&&(E-=d);E<0&&(E+=d);o>w&&(o-=c);o<0&&(o+=c);break;default:E>S&&(E=S),E<0&&(E=0),o>w&&(o=w),o<0&&(o=0)}k=o+E*c<<2;j[g]=b[k];j[g+1]=b[k+1];j[g+2]=b[k+2];j[g+3]=b[k+3]}g+=4;f++;f>=c&&(f=0,e++)}return j}function f(b,c,d){if(0>=this.radius)return b;var f,e,g,k,h=b.length,j=new q(b),n=this.centerX,s=this.centerY;f=this.radius;var t=this.mode,r=a.MODE.WRAP,o,u=f*f,E=1-0.555556,I,w,S,H,F=c-1,x=d-1;for(e=f=g=0;g<h;){k=f-n;o=e-s;S=k*k;H=o*o;
I=S+H;if(I<u){w=u-I;I=l(w);k=z(k/l(S+w))*E;o=z(o/l(H+w))*E;k=~~(f-I*p(k));o=~~(e-I*p(o));if(0>k||k>F||0>o||o>x)switch(t){case r:o>x&&(o-=d);o<0&&(o+=d);k>F&&(k-=c);k<0&&(k+=c);break;default:o>x&&(o=x),o<0&&(o=0),k>F&&(k=F),k<0&&(k=0)}k=k+o*c<<2;j[g]=b[k];j[g+1]=b[k+1];j[g+2]=b[k+2];j[g+3]=b[k+3]}g+=4;f++;f>=c&&(f=0,e++)}return j}function j(a){return a}function n(a){return a}var q=a.ImArray,l=Math.sqrt,t=Math.atan2,u=Math.sin,r=Math.cos,z=Math.asin,p=Math.tan;a.GeometricMapFilter=function(a){this.generic(a)};
a.GeometricMapFilter.prototype={_map:null,inverseTransform:null,a:1,b:1,c:0,d:0,centerX:0,centerY:0,angle:0,radius:0,mode:a.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=d;return this},affine:function(a,b,c,d){this.a=a;this.b=b;this.c=c;this.d=d;this._map=g;return this},flipX:function(){this._map=o;return this},flipY:function(){this._map=h;return this},flipXY:function(){this._map=e;return this},rotateCW:function(){this._map=b;return this},rotateCCW:function(){this._map=c;return this},
polar:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=j;return this},cartesian:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=n;return this},twirl:function(a,b,c,d){this.angle=a||0;this.radius=b||0;this.centerX=c||0;this.centerY=d||0;this._map=s;return this},sphere:function(a,b,c){this.radius=a||0;this.centerX=b||0;this.centerY=c||0;this._map=f;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},
_apply:function(a,b,c,d){if(!this._map)return a;return this._map.call(this,a,b,c,d)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height,a))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function o(a,b,c,d){var f=a.length,e,g=new l(a.length),c=c||1,d=d||1;for(e=0;e<f;)g[e]=c*a[e]+d*b[e],e++;return g}function h(a,b){var c,d,f=a.length,e,g=[],h=0;for(c=0;c<f;c++)for(d=0;d<f;d++)e=a[c]*b[d],h+=e,g.push(e);return{kernel:g,sum:h}}function e(a){var b,c=Array(a);for(b=0;b<a;)c[b]=0,b++;c[a>>1]=1;return c}function b(a){var b,c=Array(a);for(b=0;b<a;)c[b]=1,b++;return c}function c(a){var b=u.length,c,d;a--;if(a<b)c=u[a].slice();else for(c=new l(u[b-1]);b<=a;){d=c.slice();c=[1];
i=0;for(il=d.length-1;i<il;i++)c.push(d[i]+d[i+1]);c.push(1);b<40&&u.push(c.slice());b++}return c}function d(a){var b,c=-(a>>1),d=Array(a);for(b=0;b<a;)d[b]=c,c++,b++;return d}function g(a){a=c(a);return h(a,a)}function s(a,b){var f=c(a),e=d(a);return 1==b?h(e.reverse(),f):h(f,e)}function f(a,c){var f=b(a),e=d(a);return 1==c?h(e.reverse(),f):h(f,e)}function j(a,b){var b=b||1,c=a*a,d,f=new l(c);for(d=0;d<c;)f[d]=b,d++;return f}function n(b,c,d,f,e,g,h,j,l,n){var s=b.length,r,p,o,m,w,v,u,z,x,D,G,T,
W,K,A,J,O,Z,$,L,ba,ca,aa;r=c*d;w=g*h;g>>=1;h=c*(h>>1);d=-g-1;z=-h-c;Z=c-1;$=r-c;r=(r<<1)+r;u=(c<<1)+c;n=n||1;aa=0;if(e){G=f[0];f=f[w>>1];f-=G;T=e[0];e=e[w>>1];for(W=e-T;aa<n;){v=new q(b);e=new a.Array32F(r);for(p=o=m=D=x=w=0;D<c;)p+=b[w],o+=b[w+1],m+=b[w+2],e[x]=p,e[x+1]=o,e[x+2]=m,w+=4,x+=3,D++;w=u+c;x=u;for(p=o=m=D=0;w<s;)p+=b[w],o+=b[w+1],m+=b[w+2],e[x]=e[x-u]+p,e[x+1]=e[x-u+1]+o,e[x+2]=e[x-u+2]+m,w+=4,x+=3,D++,D>=c&&(p=o=m=D=0);for(o=p=D=w=0;w<s;)K=D+d,A=o+z,J=D+g,O=o+h,K<0?K=0:J>Z&&(J=Z),A<0?
A=0:O>$&&(O=$),m=K+A,x=J+O,A=J+A,L=K+O,m=(m<<1)+m,A=(A<<1)+A,L=(L<<1)+L,x=(x<<1)+x,J=G*(e[x]-e[A]-e[L]+e[m])+f*b[w],O=G*(e[x+1]-e[A+1]-e[L+1]+e[m+1])+f*b[w+1],K=G*(e[x+2]-e[A+2]-e[L+2]+e[m+2])+f*b[w+2],ba=T*(e[x]-e[A]-e[L]+e[m])+W*b[w],ca=T*(e[x+1]-e[A+1]-e[L+1]+e[m+1])+W*b[w+1],x=T*(e[x+2]-e[A+2]-e[L+2]+e[m+2])+W*b[w+2],m=j*J+l*ba,A=j*O+l*ca,x=j*K+l*x,t&&(m<0?m=0:m>255&&(m=255),A<0?A=0:A>255&&(A=255),x<0?x=0:x>255&&(x=255)),v[w]=~~m,v[w+1]=~~A,v[w+2]=~~x,w+=4,D++,D>=c&&(D=0,p++,o+=c);b=v;aa++}}else{G=
f[0];f=f[w>>1];f-=G;j=j||1;for(l=l||0;aa<n;){v=new q(b);e=new a.Array32F(r);for(p=o=m=D=x=w=0;D<c;)p+=b[w],o+=b[w+1],m+=b[w+2],e[x]=p,e[x+1]=o,e[x+2]=m,w+=4,x+=3,D++;w=u+c;x=u;for(p=o=m=D=0;w<s;)p+=b[w],o+=b[w+1],m+=b[w+2],e[x]=e[x-u]+p,e[x+1]=e[x-u+1]+o,e[x+2]=e[x-u+2]+m,w+=4,x+=3,D++,D>=c&&(p=o=m=D=0);for(o=p=D=w=0;w<s;)K=D+d,A=o+z,J=D+g,O=o+h,K<0?K=0:J>Z&&(J=Z),A<0?A=0:O>$&&(O=$),m=K+A,x=J+O,A=J+A,L=K+O,m=(m<<1)+m,A=(A<<1)+A,L=(L<<1)+L,x=(x<<1)+x,J=G*(e[x]-e[A]-e[L]+e[m])+f*b[w],O=G*(e[x+1]-e[A+
1]-e[L+1]+e[m+1])+f*b[w+1],K=G*(e[x+2]-e[A+2]-e[L+2]+e[m+2])+f*b[w+2],m=j*J+l,A=j*O+l,x=j*K+l,t&&(m<0?m=0:m>255&&(m=255),A<0?A=0:A>255&&(A=255),x<0?x=0:x>255&&(x=255)),v[w]=~~m,v[w+1]=~~A,v[w+2]=~~x,w+=4,D++,D>=c&&(D=0,p++,o+=c);b=v;aa++}}return v}var q=a.ImArray,l=a.Array32F,t=a._notSupportTypedArrays,u=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],r=a.CONSTANTS.toRad,z=Math.abs,p=Math.sqrt,m=Math.sin,v=Math.cos;a.ConvolutionMatrixFilter=
function(a,b,c){typeof a!="undefined"&&a.length?(this.set(a,~~(p(a.length)+0.5),b||1),this._bias=c||0):(this._matrix=null,this._dim=0);this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0};a.ConvolutionMatrixFilter.prototype={_dim:0,_matrix:null,_factor:1,_bias:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(j(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,b){var a=typeof a=="undefined"?3:a%2?a:a+1,c=a*a,d=-(typeof b=="undefined"?1:b)/c,e=j(a,
d);e[c>>1]=1+d;this.set(e,a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},verticalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,c,d=a;c=e(d);d=b(d);c=h(d,c);return this.set(c.kernel,a,1/c.sum)},horizontalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,c,d=a;c=e(d);d=b(d);c=h(c,d);return this.set(c.kernel,a,1/c.sum)},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=g(a);return this.set(b.kernel,a,1/b.sum)},binomialHighPass:function(a){var a=
typeof a=="undefined"?3:a%2?a:a+1,b=g(a);return this.set(o(j(a),new l(b.kernel),1,-1/b.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},fastGauss:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(j(b),b,1/(b*b));this._doFast=a;return this},sharpen:function(a,b){a=typeof a=="undefined"?0.5:a;return a<=0?this.set([0,-2,0,-2,10,-2,0,-2,0],3,0.5):this.highPass(b,a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(f(a,0).kernel,
a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(f(a,1).kernel,a,1)},prewittDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=r;var c=v(a),d=m(a),e=f(b,0),g=f(b,1);return this.set(o(new l(e.kernel),new l(g.kernel),c,d),b,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=f(a,0),c=f(a,1);this.set(b.kernel,a,1);this._isGrad=!0;this._matrix2=new l(c.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},
gradDirectional:function(a,b){return this.prewittDirectional(a,b)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(s(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(s(a,1).kernel,a,1)},sobelDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=r;var c=v(a),d=m(a),e=s(b,0),f=s(b,1);return this.set(o(new l(e.kernel),new l(f.kernel),c,d),b,1)},sobel:function(a){var a=typeof a=="undefined"?
3:a%2?a:a+1,b=s(a,0),c=s(a,1);this.set(b.kernel,a,1);this._matrix2=new l(c.kernel);this._isGrad=!0;return this},laplace:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=j(a,-1),c=a*a;b[c>>1]=c-1;this.set(b,a,1);this._doFast=1;return this},emboss:function(a,b,c){var c=typeof c=="undefined"?3:c%2?c:c+1,a=typeof a=="undefined"?-0.25*Math.PI:a*r,b=b||1,d=b*v(a),a=-b*m(a),b=c,e=b*b,f=b>>1,g,h=new l(e),j,n,s;j=s=-f*d;n=-f*a;for(g=f=0;f<e;)h[f]=j+n,f++,g++,j+=d,g>=b&&(g=0,j=s,n+=a);h[c*c>>1]=1;return this.set(h,
c,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,b,c){this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;this._matrix=new l(a);this._dim=b;this._factor=c||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,b){this._matrix=a;this._dim=b;this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;return this},_apply:function(b,c,d){if(!this._matrix)return b;
if(this._doFast)return this._matrix2?n(b,c,d,this._matrix,this._matrix2,this._dim,this._dim,this._coeff1,this._coeff2,this._doFast):n(b,c,d,this._matrix,null,this._dim,this._dim,this._factor,this._bias,this._doFast);var e=this._dim,f=this._dim,g=e>>1,h=e*f,j=(f>>1)*c,f=this._matrix,l=this._factor,m=this._bias,s=this._matrix2,o,p=this._isGrad,r=new a.Array16I(h<<1),v=new a.Array8U(h),w=c*d,d=b.length,u=new q(d),H,F,x,D,G,T,W=c-1,K=w-c,A=this._coeff1,J=this._coeff2;for(D=x=w=F=H=0;F<h;)v[F]=w+x,r[H]=
w-g,r[H+1]=D-j,H+=2,F++,w++,w>=e&&(w=0,x+=e,D+=c);if(s)for(x=w=e=0;e<d;){for(F=H=l=m=T=g=j=D=0;F<h;)G=w+r[H],o=x+r[H+1],G>=0&&G<=W&&o>=0&&o<=K&&(G=G+o<<2,o=f[v[F]],D+=b[G]*o,j+=b[G+1]*o,g+=b[G+2]*o,o=s[v[F]],T+=b[G]*o,m+=b[G+1]*o,l+=b[G+2]*o),H+=2,F++;p?(H=z(D)+z(T),F=z(j)+z(m),g=z(g)+z(l)):(H=A*D+J*T,F=A*j+J*m,g=A*g+J*l);t&&(H<0?H=0:H>255&&(H=255),F<0?F=0:F>255&&(F=255),g<0?g=0:g>255&&(g=255));u[e]=~~H;u[e+1]=~~F;u[e+2]=~~g;u[e+3]=b[e+3];e+=4;w++;w>=c&&(w=0,x+=c)}else for(x=w=e=0;e<d;){for(F=H=g=
j=D=0;F<h;)G=w+r[H],o=x+r[H+1],G>=0&&G<=W&&o>=0&&o<=K&&(G=G+o<<2,o=f[v[F]],D+=b[G]*o,j+=b[G+1]*o,g+=b[G+2]*o),H+=2,F++;H=l*D+m;F=l*j+m;g=l*g+m;t&&(H<0?H=0:H>255&&(H=255),F<0?F=0:F>255&&(F=255),g<0?g=0:g>255&&(g=255));u[e]=~~H;u[e+1]=~~F;u[e+2]=~~g;u[e+3]=b[e+3];e+=4;w++;w>=c&&(w=0,x+=c)}return u},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(a){var o=a.ImArray,h=function(b,c,e){var f=this._dim,h=f>>1,n=f*f,q=h*c,l=new a.Array32I(n<<1),t=c*e,e=b.length,u=new o(e),r,z,p=[],m=[],v=[];n<<=1;var B=c-1,C=t-c;for(z=t=r=0;r<n;)l[r]=t-h,l[r+1]=z-q,r+=2,t++,t>=f&&(t=0,z+=c);for(z=t=f=0;f<e;){p.length=0;m.length=0;for(r=v.length=0;r<n;)h=t+l[r],q=z+l[r+1],h>=0&&h<=B&&q>=0&&q<=C&&(h=h+q<<2,p.push(b[h]),m.push(b[h+1]),v.push(b[h+2])),r+=2;p.sort();m.sort();v.sort();r=(p.length>>1)+1;(h=p.length%2)?(u[f]=p[r],u[f+1]=m[r],u[f+2]=v[r]):(u[f]=
~~(0.5*(p[r-1]+p[r])),u[f+1]=~~(0.5*(m[r-1]+m[r])),u[f+2]=~~(0.5*(v[r-1]+v[r])));u[f+3]=b[f+3];f+=4;t++;t>=c&&(t=0,y++,z+=c)}return u},e=function(b,c,e){var f=this._dim,h=f>>1,n=f*f,q=h*c,l=new a.Array32I(n<<1),t=c*e,e=b.length,u=new o(e),r,z,p,m,v,B;n<<=1;var C=c-1,P=t-c;for(z=r=t=0;t<n;)l[t]=r-h,l[t+1]=z-q,t+=2,r++,r>=f&&(r=0,z+=c);for(z=r=f=0;f<e;){for(t=B=q=h=0;t<n;)p=r+l[t],m=z+l[t+1],p>=0&&p<=C&&m>=0&&m<=P&&(v=p+m<<2,p=b[v],m=b[v+1],v=b[v+2],p>h&&(h=p),m>q&&(q=m),v>B&&(B=v)),t+=2;u[f]=h;u[f+
1]=q;u[f+2]=B;u[f+3]=b[f+3];f+=4;r++;r>=c&&(r=0,z+=c)}return u},b=function(b,c,e){var f=this._dim,h=f>>1,n=f*f,q=h*c,l=new a.Array32I(n<<1),t=c*e,e=b.length,u=new o(e),r,z,p,m,v,B;n<<=1;var C=c-1,P=t-c;for(z=r=t=0;t<n;)l[t]=r-h,l[t+1]=z-q,t+=2,r++,r>=f&&(r=0,z+=c);for(z=r=f=0;f<e;){B=q=h=255;for(t=0;t<n;)p=r+l[t],m=z+l[t+1],p>=0&&p<=C&&m>=0&&m<=P&&(v=p+m<<2,p=b[v],m=b[v+1],v=b[v+2],p<h&&(h=p),m<q&&(q=m),v<B&&(B=v)),t+=2;u[f]=h;u[f+1]=q;u[f+2]=B;u[f+3]=b[f+3];f+=4;r++;r>=c&&(r=0,z+=c)}return u},c=
function(a){return a};a.StatisticalFilter=function(){this._dim=0;this._apply=c};a.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=h;return this},erode:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=b;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=e;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},
reset:function(){this._apply=c;this._dim=0;return this}}})(FILTER);(function(a){var o=a._notSupportTypedArrays;a.NoiseFilter=a.Create({min:-127,max:127,init:function(a,e){this.min=a||-127;this.max=e||127},apply:function(a){var e=this.max-this.min,b=Math.random,c=this.min,d,g=a.length,s,f,j,n;for(d=0;d<g;)f=a[d],j=a[d+1],n=a[d+2],s=e*b()+c,f+=s,j+=s,s=n+s,o&&(f<0?f=0:f>255&&(f=255),j<0?j=0:j>255&&(j=255),s<0?s=0:s>255&&(s=255)),a[d]=~~f,a[d+1]=~~j,a[d+2]=~~s,d+=4;return a}})})(FILTER);
(function(a){var o=a._notSupportTypedArrays;a.HistogramEqualizeFilter=a.Create({apply:function(h){var e,b,c,d;d=0;var g=255,s=new a.Array32F(256),f=new a.Array32F(256),j=0,n,q,l,t=h.length;l=t>>2;n=1/l;var u=Array(l);q=a.Color.RGB2YCbCr;var r=a.Color.YCbCr2RGB;for(l=0;l<256;)s[l]=0,f[l]=0,l++;for(j=l=0;l<t;){e=h[l];b=h[l+1];c=h[l+2];e=q({r:e,g:b,b:c});s[e.y]+=n;if(e.y>d)d=e.y;if(e.y<g)g=e.y;u[j]=e;l+=4;j++}for(l=j=0;l<256;)j+=s[l],f[l]=j,l++;d-=g;for(j=l=0;l<t;)e=u[j],e.y=f[e.y]*d+g,q=r(e),s=q.r,
n=q.g,q=q.b,o&&(s<0?s=0:s>255&&(s=255),n<0?n=0:n>255&&(n=255),q<0?q=0:q>255&&(q=255)),h[l]=~~s,h[l+1]=~~n,h[l+2]=~~q,l+=4,j++;return h}})})(FILTER);
(function(a){var o=a._notSupportTypedArrays;a.RGBHistogramEqualizeFilter=a.Create({apply:function(h){var e,b,c,d,g,s;s=g=d=0;var f=255,j=255,n=255,q=new a.Array32F(256),l=new a.Array32F(256),t=new a.Array32F(256),u=new a.Array32F(256),r=new a.Array32F(256),z=new a.Array32F(256),p,m=h.length,v=1/(m>>2);for(p=0;p<256;)q[p]=0,l[p]=0,t[p]=0,u[p]=0,r[p]=0,z[p]=0,p++;for(p=0;p<m;)e=h[p],b=h[p+1],c=h[p+2],q[e]+=v,l[b]+=v,t[c]+=v,e>d&&(d=e),e<f&&(f=e),b>g&&(g=b),b<j&&(j=b),c>s&&(s=c),c<n&&(n=c),p+=4;for(p=
c=b=e=0;p<256;)c+=q[p],u[p]=c,b+=l[p],r[p]=b,e+=t[p],z[p]=e,p++;d-=f;g-=j;s-=n;for(p=0;p<m;)e=h[p],b=h[p+1],c=h[p+2],e=u[e]*d+f,b=r[b]*g+j,c=z[c]*s+n,o&&(e<0?e=0:e>255&&(e=255),b<0?b=0:b>255&&(b=255),c<0?c=0:c>255&&(c=255)),h[p]=~~e,h[p+1]=~~b,h[p+2]=~~c,p+=4;return h}})})(FILTER);
(function(a){var o=Math.sqrt,h=a._notSupportTypedArrays;a.PixelateFilter=a.Create({scale:1,init:function(a){this.scale=a||1},apply:function(e,b,c){if(this.scale<=1)return e;if(this.scale>100)this.scale=100;var d=e.length,g=b*c,c=~~(o(g)*this.scale*0.01),s=c*c,f=1/s,j=c<<2,n=b*c;s<<=2;var q=new a.Array32F(g*3),l,t,u,r=(b<<1)+b,z,p,m,v,B,C,P,U,k,R,M;z=c-1;p=(c-1)*b;k=b-1;R=g-b;for(l=t=u=v=m=g=0;v<b;)l+=e[g],t+=e[g+1],u+=e[g+2],q[m]=l,q[m+1]=t,q[m+2]=u,g+=4,m+=3,v++;g=r+b;m=r;for(l=t=u=v=0;g<d;)l+=e[g],
t+=e[g+1],u+=e[g+2],q[m]=q[m-r]+l,q[m+1]=q[m-r+1]+t,q[m+2]=q[m-r+2]+u,g+=4,m+=3,v++,v>=b&&(l=t=u=v=0);for(r=v=g=0;g<d;){l=v;B=r;C=v+z;t=r+p;C>k&&(C=k);t>R&&(t=R);m=l+B;u=C+t;B=C+B;C=l+t;m=(m<<1)+m;B=(B<<1)+B;C=(C<<1)+C;u=(u<<1)+u;l=f*(q[u]-q[B]-q[C]+q[m]);t=f*(q[u+1]-q[B+1]-q[C+1]+q[m+1]);M=f*(q[u+2]-q[B+2]-q[C+2]+q[m+2]);h&&(l<0?l=0:l>255&&(l=255),t<0?t=0:t>255&&(t=255),M<0?M=0:M>255&&(M=255));l=~~l;t=~~t;M=~~M;m=g;B=v;C=r;U=v+c;u=g+s;for(u>d&&(u=d);m<u;)if(P=B+C<<2,e[P]=l,e[P+1]=t,e[P+2]=M,m+=4,
B++,B>=b||B>=U)B=v,C+=b;g+=j;v+=c;v>=b&&(v=0,r+=n)}return e}})})(FILTER);(function(a){var o=a._notSupportTypedArrays;a.HSVConverterFilter=a.Create({apply:function(h,e,b){for(var c,d,g=h.length,s=a.Color.RGB2HSV,e=0;e<g;)c=h[e],b=h[e+1],d=h[e+2],d=s({r:c,g:b,b:d}),b=d.h*0.7083333333333334,c=d.s*255,d=d.v,o&&(b<0?b=0:b>255&&(b=255),d<0?d=0:d>255&&(d=255),c<0?c=0:c>255&&(c=255)),h[e]=~~b,h[e+1]=~~d,h[e+2]=~~c,e+=4;return h}})})(FILTER);
(function(a){var o=a._notSupportTypedArrays;a.HueExtractorFilter=a.Create({range:null,background:0,init:function(a,e){this.range=a;this.background=e||0},apply:function(h){if(!this.range||!this.range.length)return h;var e,b,c,d,g,s,f=h.length,j,n=a.Color.RGB2HSV,q=this.range[0],l=this.range[this.range.length-1];d=new a.ImArray(f);j=a.Color.Color2RGBA(this.background||0);for(s=0;s<f;)e=h[s],b=h[s+1],c=h[s+2],e=n({r:e,g:b,b:c}).h,e>=q&&e<=l?(e=h[s],b=h[s+1],c=h[s+2],g=h[s+3]):(e=j.r,b=j.g,c=j.b,g=j.a),
o&&(e<0?e=0:e>255&&(e=255),b<0?b=0:b>255&&(b=255),c<0?c=0:c>255&&(c=255),g<0?g=0:g>255&&(g=255)),d[s]=~~e,d[s+1]=~~b,d[s+2]=~~c,d[s+3]=~~g,s+=4;return d}})})(FILTER);
(function(a){a.AlphaMaskFilter=a.Create({alphaMask:null,centerX:0,centerY:0,init:function(a,h,e){this.alphaMask=a||null;this.centerX=h||0;this.centerY=e||0},apply:function(a,h,e){if(!this.alphaMask)return a;var b=this.alphaMask.getData(),c=a.length,d=this.alphaMask.width,g=this.alphaMask.height,s,f,j,n=Math.min(h,d),q=Math.min(e,g),l,t;l=this.centerX+(h-d>>1);t=this.centerY+(e-g>>1);for(s=g=e=0;e<c;)f=g-l,j=s-t,f>=0&&f<n&&j>=0&&j<q?(f=f+j*d<<2,a[e+3]=b[f+3]):a[e+3]=0,e+=4,g++,g>=h&&(g=0,s++);return a}})})(FILTER);
(function(a){var o=a._notSupportTypedArrays;a.ThresholdFilter=a.Create({thresholds:null,quantizedColors:null,init:function(a,e){this.thresholds=a;this.quantizedColors=e||null},apply:function(h){if(!this.thresholds||!this.thresholds.length)return h;else if(!this.quantizedColors||!this.quantizedColors.length)return h;var e,b,c,d,g,s=h.length,f=a.Color.RGBA2Color,j=a.Color.Color2RGBA,n=this.thresholds,q=n.length,l=this.quantizedColors,t=l.length;for(g=0;g<s;){e=f({r:h[g],g:h[g+1],b:h[g+2],a:h[g+3]});
for(b=0;b<q&&e>n[b];)b++;e=b<t?l[b]:255;d=j(e);e=d.r;b=d.g;c=d.b;d=d.a;o&&(e<0?e=0:e>255&&(e=255),b<0?b=0:b>255&&(b=255),c<0?c=0:c>255&&(c=255),d<0?d=0:d>255&&(d=255));h[g]=~~e;h[g+1]=~~b;h[g+2]=~~c;h[g+3]=~~d;g+=4}return h}})})(FILTER);
