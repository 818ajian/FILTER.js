/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.1
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(a){function m(a,d){var a=a||{},b;for(b in d)d&&Object.prototype.hasOwnProperty.call(d,b)&&(a[b]=d[b]);return a}a.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;a.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;a.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;a.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;a.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;a.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;a.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;a.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;a.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:a.Array8U;a._notSupportTypedArrays=!a.ImArray.set;a.CONSTANTS={PI:Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI};a.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};a.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};a.LUMA=new a.Array32F([0.212671,0.71516,0.072169]);a.Filter=function(){};a.Filter.prototype={_apply:function(){},apply:function(){},
reset:function(){}};a.CompositeFilter=function(a){this._stack=typeof a!="undefined"&&a.length?a:[]};a.CompositeFilter.prototype={_stack:[],_apply:function(a,d,b){if(!this._stack.length)return a;for(var e=this._stack,c=e.length,f=0,h;f<c;)(h=e[f++])&&(a=h._apply(a,d,b));return a},apply:function(a){if(!this._stack.length)return a;return a.setData(this._apply(im=a.getData(),a.width,a.height))},filters:function(a){if(a)this._stack=a;return this},push:function(a){this._stack.push(a);return this},pop:function(){return this._stack.pop()},
shift:function(){return this._stack.shift()},unshift:function(a){this._stack.unshift(a);return this},concat:function(a){return this.push(a)},getAt:function(a){return this._stack.length>a?this._stack[a]:null},setAt:function(a,d){this._stack.length>a&&(this._stack[a]=d);return this},insertAt:function(a,d){this._stack.splice(a,0,d);return this},removeAt:function(a){this._stack.splice(a,1);return this},remove:function(a){for(var d=this._stack.length;--d>=0;)a===this._stack[d]&&this._stack.splice(d,1);
return this},reset:function(){this._stack.length=0;return this}};a.Create=function(a){var d=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},a=m({init:function(){},reset:function(){return this},apply:function(b){return b}},a);a._apply=a.apply;a.apply=function(b){return b.setData(this._apply(b.getData(),b.width,b.height))};d.prototype=m(d.prototype,a);return d}})(FILTER);
(function(a){var m=Math.sqrt,j=Math.min,d=Math.max;a.Color={blend:function(b,a,c){return{r:b.r-~~((b.r-a.r)*c+0.5),g:b.g-~~((b.g-a.g)*c+0.5),b:b.b-~~((b.b-a.b)*c+0.5)}},toGray:function(b,d,c){var f=a.LUMA;return~~(f[0]*b+f[1]*d+f[2]*c)},distance:function(b,a){var c=b.r-a.r,f=b.g-a.g,d=b.b-a.b;return m(c*c+f*f+d*d)},RGB2Color:function(b){return b.r<<16|b.g<<8|b.b&255},RGBA2Color:function(b){return b.a<<24|b.r<<16|b.g<<8|b.b&255},Color2RGBA:function(b){b=~~b;return{r:b>>16&255,g:b>>8&255,b:b&255,a:b>>
24&255}},RGB2YCbCr:function(b){var a=b.r,c=b.g,b=b.b;return{y:~~(0+0.299*a+0.587*c+0.114*b),cb:~~(128-0.168736*a-0.331264*c+0.5*b),cr:~~(128+0.5*a-0.418688*c-0.081312*b)}},YCbCr2RGB:function(b){var a=b.y,c=b.cb,b=b.cr;return{r:~~(a+1.402*(b-128)),g:~~(a-0.34414*(c-128)-0.71414*(b-128)),b:~~(a+1.772*(c-128))}},RGB2HSV:function(b){var a,c,f,h;c=b.r;f=b.g;h=b.b;a=j(c,f,h);b=d(c,f,h);a=b-a;if(b==0)return{h:0,s:0,v:b};c=c==b?(f-h)/a:f==b?2+(h-c)/a:4+(c-f)/a;c*=60;c<0&&(c+=360);return{h:c,s:a/b,v:b}},HSV2RGB:function(b){var a,
c,f,d,g;f=b.h;g=b.s;b=b.v;if(g==0)return a=c=b,{r:a,g:c,b:b};f/=60;a=~~f;c=f-a;f=b*(1-g);d=b*(1-g*c);g=b*(1-g*(1-c));switch(a){case 0:a=b;c=g;b=f;break;case 1:a=d;c=b;b=f;break;case 2:a=f;c=b;b=g;break;case 3:a=f;c=d;break;case 4:a=g;c=f;break;default:a=b,c=f,b=d}return{r:a,g:c,b:b}}}})(FILTER);
(function(a){function m(c,b){var a=document.createElement("canvas");a.width=c||0;a.height=b||0;return a}var j,d=Math.min,b=a.ImArray;j={normal:function(b){return b},lighten:function(b,a){return a>b?a:b},darken:function(b,a){return a>b?b:a},multiply:function(b,a){return b*a*0.003921568627451},average:function(b,a){return 0.5*(b+a)},add:function(b,a){return Math.min(255,b+a)},substract:function(b,a){return b+a<255?0:b+a-255},difference:function(b,a){return Math.abs(b-a)},negation:function(b,a){return 255-
Math.abs(255-b-a)},screen:function(b,a){return 255-((255-b)*(255-a)>>8)},exclusion:function(b,a){return b+a-2*b*a*0.003921568627451},overlay:function(b,a){return a<128?2*b*a*0.003921568627451:255-2*(255-b)*(255-a)*0.003921568627451},softLight:function(b,a){return a<128?2*((b>>1)+64)*a*0.003921568627451:255-2*(255-((b>>1)+64))*(255-a)*0.003921568627451},hardLight:function(b,a){return b<128?2*a*b*0.003921568627451:255-2*(255-a)*(255-b)*0.003921568627451},colorDodge:function(b,a){return a==255?a:Math.min(255,
(b<<8)/(255-a))},colorBurn:function(b,a){return a==0?a:Math.max(0,255-(255-b<<8)/a)},linearLight:function(b,a){return a<128?j.linearBurn(b,2*a):j.linearDodge(b,2*(a-128))},vividLight:function(b,a){return a<128?j.colorBurn(b,2*a):j.colorDodge(b,2*(a-128))},pinLight:function(b,a){return a<128?j.darken(b,2*a):j.lighten(b,2*(a-128))},hardMix:function(b,a){return j.vividLight(b,a)<128?0:255},reflect:function(b,a){return a==255?a:Math.min(255,b*b/(255-a))},glow:function(b,a){return b==255?b:Math.min(255,
a*a/(255-b))},phoenix:function(b,a){return Math.min(b,a)-Math.max(b,a)+255}};j.linearDodge=j.add;j.linearBurn=j.substract;a.blendModes=j;var e=a._notSupportTypedArrays;a.Image=function(b,a){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=m(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=m(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(b,a)};
a.Image.prototype={width:0,height:0,canvasElement:null,domElement:null,clear:function(){this.context.clearRect(0,0,this.width,this.height);return this},fill:function(b,a,d,e,k){var e=e||this.width,k=k||this.height,q=this.context;q.fillStyle=b||0;q.fillRect(a||0,d||0,e,k);this.imageData=q.getImageData(0,0,this.width,this.height);return this},draw:function(){return this},getPixel:function(b,a){var d=~~(a*this.width+b+0.5);return{red:this.imageData.data[d],green:this.imageData.data[d+1],blue:this.imageData.data[d+
2],alpha:this.imageData.data[d+3]}},setPixel:function(a,d,e,g,k,q){this.context.putImageData(new b([e,g,k,q]),a,d);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new b(this.imageData.data)},_setData:function(b){for(var a=this.imageData.data,d=b.length,e=0;e<d;)a[e]=b[e]&255,e++},setData:function(b){e?this._setData(b):this.imageData.data.set(b);this.context.putImageData(this.imageData,0,0);
this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(b){this.context.putImageData(b,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setWidth:function(b){this._tmpCanvas.width=this.canvasElement.width=this.width=b;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=
this._histogramRefresh=!0;return this},setHeight:function(b){this._tmpCanvas.height=this.canvasElement.height=this.height=b;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setImage:function(b,a){if(typeof b=="undefined"||b==null)return this;var d=this,e;b instanceof Image||b instanceof HTMLCanvasElement||b instanceof HTMLVideoElement?(e=b,this.width=b instanceof HTMLVideoElement?
b.videoWidth:b.width,this.height=b instanceof HTMLVideoElement?b.videoHeight:b.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,this.context=this.canvasElement.getContext("2d"),this.context.drawImage(e,0,0),this.imageData=this.context.getImageData(0,0,this.width,this.height),this._integralRefresh=this._histogramRefresh=!0):(e=new Image,e.onload=function(){d.width=e.width;d.height=e.height;d._tmpCanvas.width=d.canvasElement.width=
d.width;d._tmpCanvas.height=d.canvasElement.height=d.height;d.context=d.canvasElement.getContext("2d");d.context.drawImage(e,0,0);d.imageData=d.context.getImageData(0,0,d.width,d.height);d._histogramRefresh=!0;d._integralRefresh=!0;typeof a!="undefined"&&a.call(d)},e.src=b);e.crossOrigin="";return this},blend:function(b,a,e,g,k){typeof a=="undefined"&&(a="normal");typeof e=="undefined"&&(e=1);e>1&&(e=1);e<0&&(e=0);typeof g=="undefined"&&(g=0);typeof k=="undefined"&&(k=0);var q=0,v=0;g<0&&(q=-g,g=
0);k<0&&(v=-k,k=0);if(!(g>=this.width||k>=this.height)){a=j[a];if(a==void 0||a==null)return this;var o=d(this.width,b.width-q),l=d(this.height,b.height-v),m=this.context.getImageData(g,k,o,l),q=b.context.getImageData(q,v,o,l),b=m.data,q=q.data,w,p,s,n=1-e,x=q.length,A;for(A=0;A<x;A+=4)w=b[A],p=b[A+1],s=b[A+2],v=a(q[A],w),o=a(q[A+1],p),l=a(q[A+2],s),b[A]=v*e+w*n,b[A+1]=o*e+p*n,b[A+2]=l*e+s*n;this.context.putImageData(m,g,k);this._integralRefresh=this._histogramRefresh=!0;return this}},_refresh:function(){this.context=
this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},copy:function(b){this.setData(b.getData())},clone:function(){return new a.Image(this.canvasElement)},integral:function(){this._integralRefresh&&this._computeIntegral();return this._integral},_computeIntegral:function(){var b=this.width,d=b*this.height,e=b<<2,g=new a.Array32F(d),k=new a.Array32F(d),d=new a.Array32F(d),q=this.getPixelData().data,v,o,l,j,m,p;for(j=m=p=l=o=v=0;l<b;)j+=
q[v],m+=q[v+1],p+=q[v+2],g[o]=j,k[o]=m,d[o]=p,v+=4,o++,l++;v=e;for(j=m=p=l=0;v<imLen;)j+=q[v],m+=q[v+1],p+=q[v+2],g[o]=g[o-b]+j,k[o]=k[o-b]+m,d[o]=d[o-b]+p,v+=4,o++,l++,l>=b&&(j=m=p=l=0);this._integral=[g,k,d];this._integralRefresh=!1},histogram:function(){this._histogramRefresh&&this._computeHistogram();return this._histogram},_computeHistogram:function(){for(var b=this.getPixelData().data,d=0,e=b.length,g,k,q,v=0,o=0,l=0,j=255,m=255,p=255,s=new a.Array32F(256),n=new a.Array32F(256),x=new a.Array32F(256),
A=1/(e>>2),d=0;d<256;)s[d]=0,n[d]=0,x[d]=0,d++;for(d=0;d<e;)g=b[d],k=b[d+1],q=b[d+2],s[g]+=A,n[k]+=A,x[q]+=A,g>v&&(v=g),g<j&&(j=g),k>o&&(o=k),k<m&&(m=k),q>l&&(l=q),q<p&&(p=q),d+=4;this._histogram=[s,n,x];this._histogramRefresh=!1},createImageData:function(b,a){this._tmpCanvas.width=this.canvasElement.width=this.width=b;this._tmpCanvas.height=this.canvasElement.height=this.height=a;this.context=this.canvasElement.getContext("2d");this.context.createImageData(b,a);return this.imageData=this.context.getImageData(0,
0,this.width,this.height)},scale:function(b,a){var b=b||1,a=a||b,d=this._tmpCanvas.getContext("2d");d.scale(b,a);d.drawImage(this.canvasElement,0,0);this.canvasElement.width=this.width=~~(b*this.width+0.5);this.canvasElement.height=this.height=~~(a*this.height+0.5);this.context.drawImage(this._tmpCanvas,0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},
flipHorizontal:function(){var b=this._tmpCanvas.getContext("2d");b.translate(this.width,0);b.scale(-1,1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipVertical:function(){var b=this._tmpCanvas.getContext("2d");b.translate(0,this.height);b.scale(1,-1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=
this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this}}})(FILTER);(function(a){a.CustomFilter=function(a){this._handler=a};a.CustomFilter.prototype={_handler:null,_apply:function(a,j,d){if(!this._handler)return a;return this._handler.call(this,a,j,d)},apply:function(a){if(!this._handler)return a;return a.setData(this._handler.call(this,a.getData(),a.width,a.height))}}})(FILTER);
(function(a){var m=a.Array32F,j=a.CONSTANTS.toRad;a.ColorMatrixFilter=function(a){this._matrix=typeof a!="undefined"&&a.length?new m(a):null};a.ColorMatrixFilter.prototype={_matrix:null,channel:function(d,b){var e=(typeof b=="undefined"?0:b)?1:0;switch(d){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case a.CHANNEL.BLUE:return this.concat([0,0,e,0,0,0,0,e,0,0,0,0,1,0,0,0,0,0,0,255]);case a.CHANNEL.GREEN:return this.concat([0,e,0,0,0,0,1,0,0,0,0,e,0,0,0,0,0,0,
0,255]);default:return this.concat([1,0,0,0,0,e,0,0,0,0,e,0,0,0,0,0,0,0,0,255])}},redChannel:function(d){return this.channel(a.CHANNEL.RED,d)},greenChannel:function(d){return this.channel(a.CHANNEL.GREEN,d)},blueChannel:function(d){return this.channel(a.CHANNEL.BLUE,d)},alphaChannel:function(){return this.channel(a.CHANNEL.ALPHA,!0)},maskChannel:function(d){switch(d){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([1,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(d,b){switch(d){case a.CHANNEL.ALPHA:switch(b){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case a.CHANNEL.BLUE:switch(b){case a.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.BLUE:return this;case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case a.CHANNEL.GREEN:switch(b){case a.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(b){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case a.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(d,b){var e,c,f,h;typeof b=="undefined"&&(b=1);e=(d>>16&255)*0.00392156862745098;c=(d>>8&255)*0.00392156862745098;f=(d&255)*0.00392156862745098;h=1-b;return this.concat([h+b*e*a.LUMA[0],b*e*a.LUMA[1],b*e*a.LUMA[2],0,0,b*c*a.LUMA[0],h+b*c*a.LUMA[1],b*c*a.LUMA[2],0,0,b*f*a.LUMA[0],b*f*a.LUMA[1],h+b*f*a.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(d){var b,e,c;b=1-d;e=b*a.LUMA[0];c=b*a.LUMA[1];b*=a.LUMA[2];return this.concat([e+d,c,b,0,0,e,c+d,b,0,0,e,c,b+d,0,0,0,0,0,1,0])},contrast:function(a,b,e){typeof b=="undefined"&&(b=a);typeof e=="undefined"&&(e=a);a+=1;b+=1;e+=1;return this.concat([a,0,0,0,128*(1-a),0,b,0,0,128*(1-b),0,0,e,0,128*(1-e),0,0,0,1,0])},brightness:function(a,b,e){typeof b=="undefined"&&(b=a);typeof e=="undefined"&&(e=a);return this.concat([1,0,0,0,a,0,1,0,0,b,0,0,1,0,e,0,0,0,1,0])},
adjustHue:function(d){d*=j;var b=Math.cos(d),d=Math.sin(d);return this.concat([a.LUMA[0]+b*(1-a.LUMA[0])+d*-a.LUMA[0],a.LUMA[1]+b*-a.LUMA[1]+d*-a.LUMA[1],a.LUMA[2]+b*-a.LUMA[2]+d*(1-a.LUMA[2]),0,0,a.LUMA[0]+b*-a.LUMA[0]+d*0.143,a.LUMA[1]+b*(1-a.LUMA[1])+d*0.14,a.LUMA[2]+b*-a.LUMA[2]+d*-0.283,0,0,a.LUMA[0]+b*-a.LUMA[0]+d*-(1-a.LUMA[0]),a.LUMA[1]+b*-a.LUMA[1]+d*a.LUMA[1],a.LUMA[2]+b*(1-a.LUMA[2])+d*a.LUMA[2],0,0,0,0,0,1,0])},average:function(a,b,e){typeof a=="undefined"&&(a=0.3333);typeof b=="undefined"&&
(b=0.3333);typeof e=="undefined"&&(e=0.3334);return this.concat([a,b,e,0,0,a,b,e,0,0,a,b,e,0,0,0,0,0,1,0])},quickContrastCorrection:function(a){typeof a=="undefined"&&(a=1.2);return this.concat([a,0,0,0,0,0,a,0,0,0,0,0,a,0,0,0,0,0,1,0])},quickSepia:function(d){typeof d=="undefined"&&(d=10);d>100&&(d=100);d*=2.55;return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,40,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,20,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,-d,0,0,0,1,0])},quickSepia2:function(a,b,e){typeof a=="undefined"&&
(a=1);typeof b=="undefined"&&(b=a);typeof e=="undefined"&&(e=a);return this.concat([a*0.5,0.5,0.5,0,0,0.33,b*0.33,0.33,0,0,0.25,0.25,e*0.25,0,0,0,0,0,1,0])},threshold:function(d,b){typeof b=="undefined"&&(b=256);return this.concat([a.LUMA[0]*b,a.LUMA[1]*b,a.LUMA[2]*b,0,-(b-1)*d,a.LUMA[0]*b,a.LUMA[1]*b,a.LUMA[2]*b,0,-(b-1)*d,a.LUMA[0]*b,a.LUMA[1]*b,a.LUMA[2]*b,0,-(b-1)*d,0,0,0,1,0])},threshold_rgb:function(a,b){typeof b=="undefined"&&(b=256);return this.concat([b,0,0,0,-(b-1)*a,0,b,0,0,-(b-1)*a,0,
0,b,0,-(b-1)*a,0,0,0,1,0])},threshold_alpha:function(a,b){typeof a=="undefined"&&(a=0.5);typeof b=="undefined"&&(b=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,b,-b*a])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(a,b){var e;if(this._matrix){e=this._matrix;
var c=a.getMatrix(),f=1-b,h=new m(20);h[0]=f*e[0]+b*c[0];h[1]=f*e[1]+b*c[1];h[2]=f*e[2]+b*c[2];h[3]=f*e[3]+b*c[3];h[4]=f*e[4]+b*c[4];h[5]=f*e[5]+b*c[5];h[6]=f*e[6]+b*c[6];h[7]=f*e[7]+b*c[7];h[8]=f*e[8]+b*c[8];h[9]=f*e[9]+b*c[9];h[10]=f*e[10]+b*c[10];h[11]=f*e[11]+b*c[11];h[12]=f*e[12]+b*c[12];h[13]=f*e[13]+b*c[13];h[14]=f*e[14]+b*c[14];h[15]=f*e[15]+b*c[15];h[16]=f*e[16]+b*c[16];h[17]=f*e[17]+b*c[17];h[18]=f*e[18]+b*c[18];h[19]=f*e[19]+b*c[19];e=h}else e=new m(a.getMatrix());this._matrix=e;return this},
concat:function(a){var b;if(this._matrix){b=this._matrix;var a=new m(a),e=new m(20),c,f,h,g,k;c=a[0];f=a[1];h=a[2];g=a[3];k=a[4];e[0]=c*b[0]+f*b[5]+h*b[10]+g*b[15];e[1]=c*b[1]+f*b[6]+h*b[11]+g*b[16];e[2]=c*b[2]+f*b[7]+h*b[12]+g*b[17];e[3]=c*b[3]+f*b[8]+h*b[13]+g*b[18];e[4]=c*b[4]+f*b[9]+h*b[14]+g*b[19]+k;c=a[5];f=a[6];h=a[7];g=a[8];k=a[9];e[5]=c*b[0]+f*b[5]+h*b[10]+g*b[15];e[6]=c*b[1]+f*b[6]+h*b[11]+g*b[16];e[7]=c*b[2]+f*b[7]+h*b[12]+g*b[17];e[8]=c*b[3]+f*b[8]+h*b[13]+g*b[18];e[9]=c*b[4]+f*b[9]+h*
b[14]+g*b[19]+k;c=a[10];f=a[11];h=a[12];g=a[13];k=a[14];e[10]=c*b[0]+f*b[5]+h*b[10]+g*b[15];e[11]=c*b[1]+f*b[6]+h*b[11]+g*b[16];e[12]=c*b[2]+f*b[7]+h*b[12]+g*b[17];e[13]=c*b[3]+f*b[8]+h*b[13]+g*b[18];e[14]=c*b[4]+f*b[9]+h*b[14]+g*b[19]+k;c=a[15];f=a[16];h=a[17];g=a[18];k=a[19];e[15]=c*b[0]+f*b[5]+h*b[10]+g*b[15];e[16]=c*b[1]+f*b[6]+h*b[11]+g*b[16];e[17]=c*b[2]+f*b[7]+h*b[12]+g*b[17];e[18]=c*b[3]+f*b[8]+h*b[13]+g*b[18];e[19]=c*b[4]+f*b[9]+h*b[14]+g*b[19]+k;b=e}else b=new m(a);this._matrix=b;return this},
combineWith:function(a){return this.concat(a.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(a){this._matrix=a;return this},_apply:function(a){if(!this._matrix)return a;for(var b=a.length,e=this._matrix,c=0,f,h,g,k;c<b;)f=a[c],h=a[c+1],g=a[c+2],k=a[c+3],a[c]=e[0]*f+e[1]*h+e[2]*g+e[3]*k+e[4],a[c+1]=e[5]*f+e[6]*h+e[7]*g+e[8]*k+e[9],a[c+2]=e[10]*f+e[11]*h+e[12]*g+e[13]*k+e[14],a[c+3]=e[15]*f+e[16]*h+e[17]*g+e[18]*k+e[19],c+=4;return a},apply:function(a){if(!this._matrix)return a;
return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(a){function m(a){var c=new b(256),d=0;if(a)for(;d<256;)c[d]=255-d,d++;else for(;d<256;)c[d]=d,d++;return c}function j(a){for(var c=new b(256),d=0;d<256;)c[d]=a,d++;return c}function d(a){if(a)return new b(a);return null}var b=a.ImArray,e=Math.pow,c=Math.exp,f=1/255,h=m(),g=m(1);a.TableLookupFilter=function(a,b,c,d){this._tableR=a||null;this._tableG=b||this._tableR;this._tableB=c||this._tableG;this._tableA=d||null};a.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(a,c,d){a.length||(a=[a]);c||(c=a);d||(d=c);var e=a.length,f=e+1,g=c.length,h=g+1,j=d.length,m=j+1,n=new b(256),x=new b(f),A=new b(256),L=new b(h),P=new b(256),T=new b(m),r,Q=255/(f-1),W=255/(h-1),M=255/(m-1);for(r=0;r<f;)x[r]=~~(Q*r),r++;a[0]=~~(255*a[0]);for(r=1;r<e;)a[r]=a[r-1]+~~(255*a[r]),r++;for(r=0;r<h;)L[r]=~~(W*r),r++;c[0]=~~(255*c[0]);for(r=1;r<g;)c[r]=c[r-1]+~~(255*c[r]),r++;for(r=0;r<m;)T[r]=~~(M*r),r++;d[0]=~~(255*d[0]);for(r=1;r<j;)d[r]=d[r-1]+~~(255*d[r]),r++;for(r=
0;r<256;){for(f=0;f<e&&r>a[f];)f++;n[r]=x[f];for(f=0;f<g&&r>c[f];)f++;A[r]=L[f];for(f=0;f<j&&r>d[f];)f++;P[r]=T[f];r++}return this.concat(n,A,P)},threshold:function(a,b,c){a=a||0.5;b=b||a;return this.thresholds([a],[b],[c||b])},quantize:function(a){typeof a=="undefined"&&(a=64);a<2&&(a=2);var c=new b(256),d=new b(a),e,f=255/(a-1),g=a/256;for(e=0;e<a;)d[e]=~~(f*e),e++;for(e=0;e<256;)c[e]=d[~~(g*e)],e++;return this.concat(c)},levels:function(a){return this.quantize(a)},posterize:function(a){return this.quantize(a)},
binarize:function(){return this.quantize(2)},solarize:function(a){typeof a=="undefined"&&(a=0.5);for(var c=0,d=new b(256),a=~~(a*256)-1,c=0;c<256;)d[c]=c>a?255-(c<<1):(c<<1)-255,c++;return this.concat(d)},invert:function(){return this.concat(g)},mask:function(a){var c=0,d=a>>16&255,e=a>>8&255;a&=255;tR=new b(256);tG=new b(256);tB=new b(256);for(c=0;c<256;)tR[c]=c&d,tG[c]=c&e,tB[c]=c&a,c++;return this.concat(tR,tG,tB)},replace:function(a,b){if(a==b)return this;var c=a>>16&255,e=a>>8&255,f=a&255,g=
b>>16&255,j=b>>8&255,m=b&255,s=d(h),n=d(h),x=d(h);s[c]=g;n[e]=j;x[f]=m;return this.concat(s,n,x)},extract:function(b,c,d){if(!c||!c.length)return this;var d=d||0,e=d>>8&255,f=d&255,d=j(d>>16&255),e=j(e),f=j(f);switch(b){case a.CHANNEL.BLUE:b=c[0];for(c=c[1];b<=c;)f[b]=b,b++;break;case a.CHANNEL.GREEN:b=c[0];for(c=c[1];b<=c;)e[b]=b,b++;break;default:b=c[0];for(c=c[1];b<=c;)d[b]=b,b++}return this.concat(d,e,f)},gammaCorrection:function(a,c,d){for(var a=a||1,c=c||a,d=d||c,a=1/a,c=1/c,d=1/d,g=new b(256),
h=new b(256),j=new b(256),m=0;m<256;)g[m]=~~(255*e(f*m,a)),h[m]=~~(255*e(f*m,c)),j[m]=~~(255*e(f*m,d)),m++;return this.concat(g,h,j)},exposure:function(a){typeof a=="undefined"&&(a=1);for(var d=0,e=new b(256),d=0;d<256;)e[d]=~~(255*(1-c(-a*d*f))),d++;return this.concat(e)},concat:function(a,b,c){if(!a)return this;var b=b||a,c=c||b,e=this._tableR||m(),f,g,h=d(e),j,s,n;if(b&&c){f=this._tableG||d(e);g=this._tableB||d(f);j=d(f);s=d(g);for(n=0;n<256;)e[n]=a[h[n]],f[n]=b[j[n]],g[n]=c[s[n]],n++;this._tableR=
e;this._tableG=f;this._tableB=g}else{for(n=0;n<256;)e[n]=a[h[n]],n++;this._tableB=this._tableG=this._tableR=e}return this},combineWith:function(a){return this.concat(a.getTable(0),a.getTable(1),a.getTable(2))},getTable:function(b){b=b||a.CHANNEL.RED;switch(b){case a.CHANNEL.ALPHA:return this._tableA;case a.CHANNEL.BLUE:return this._tableB;case a.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(b,c){c=c||a.CHANNEL.RED;switch(c){case a.CHANNEL.ALPHA:return this._tableA=
b,this;case a.CHANNEL.BLUE:return this._tableB=b,this;case a.CHANNEL.GREEN:return this._tableG=b,this;default:return this._tableR=b,this}},_apply:function(a){if(!this._tableR)return a;var b=a.length,c=0,d,e,f,g,h=this._tableR,j=this._tableG,n=this._tableB,x=this._tableA;if(x)for(;c<b;)d=a[c],e=a[c+1],f=a[c+2],g=a[c+3],a[c]=h[d],a[c+1]=j[e],a[c+2]=n[f],a[c+3]=x[g],c+=4;else for(;c<b;)d=a[c],e=a[c+1],f=a[c+2],a[c]=h[d],a[c+1]=j[e],a[c+2]=n[f],c+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(a){var m=a.ImArray,j=Math.min;a.DisplacementMapFilter=function(a){a&&this.setMap(a)};a.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:a.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},_apply:function(d,b,e){if(!this._map)return d;var c=this._map.getData(),f=this._map.width,h=this._map.height,g=f*h,k=new a.Array16I(g<<1),q=j(f,b),v=j(h,e),o=
this.scaleX*0.00390625,l=this.scaleY*0.00390625,t=this.componentX,w=this.componentY,h=this.color>>24&255,p=this.color>>16&255,s=this.color>>8&255,n=this.color&255,x=~~this.startY,A=~~this.startX,L=this.mode,P=x*b,T=-A,r=-x,Q=b-A-1,W=e-x-1,M,O,U,X,Y,G=q*v<<2,C=new m(d),u=a.MODE.IGNORE,R=a.MODE.COLOR,F=a.MODE.WRAP;for(X=U=O=M=v=0;v<g;)Y=O+X<<2,k[M]=~~((c[Y+t]-128)*o),k[M+1]=~~((c[Y+w]-128)*l),v++,M+=2,O++,O>=f&&(O=0,U++,X+=f);v=-4;O=-1;for(ty2=X=U=0;v<G;)if(v+=4,O++,O>=q&&(O=0,U++,X+=b,ty2+=f),!(U<
r||U>W||O<T||O>Q)){o=O+A;g=U+x;c=o+X+P<<2;M=O+ty2<<1;srcx=o+k[M];srcy=g+k[M+1];if(srcy>=e||srcy<0||srcx>=b||srcx<0)switch(L){case u:continue;case R:C[c]=p;C[c+1]=s;C[c+2]=n;C[c+3]=h;continue;case F:srcy>W&&(srcy-=e);srcy<0&&(srcy+=e);srcx>Q&&(srcx-=b);srcx<0&&(srcx+=b);break;default:srcy>W&&(srcy=W),srcy<0&&(srcy=0),srcx>Q&&(srcx=Q),srcx<0&&(srcx=0)}M=srcx+srcy*b<<2;C[c]=d[M];C[c+1]=d[M+1];C[c+2]=d[M+2];C[c+3]=d[M+3]}return C},apply:function(a){if(!this._map)return a;return a.setData(this._apply(a.getData(),
a.width,a.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function m(a,b){var c,d,e,f,r,g=a.length,h=new v(g);for(e=d=c=f=0;f<g;)r=b-1-c+e<<2,h[f]=a[r],h[f+1]=a[r+1],h[f+2]=a[r+2],h[f+3]=a[r+3],f+=4,c++,c>=b&&(c=0,d++,e+=b);return h}function j(a,b,c){var d,e,f,r,g=a.length,h=new v(g);e=d=f=0;for(c=(c-1)*b;f<g;)r=d+c<<2,h[f]=a[r],h[f+1]=a[r+1],h[f+2]=a[r+2],h[f+3]=a[r+3],f+=4,d++,d>=b&&(d=0,e++,c-=b);return h}function d(a,b,c){var d,e,f,r,g,h=a.length,j=new v(h);e=d=r=0;for(c=(c-1)*b;r<h;)g=b-1-d+c<<2,j[r]=a[g],j[r+1]=a[g+1],j[r+2]=a[g+2],j[r+
3]=a[g+3],r+=4,d++,d>=b&&(d=0,e++,f+=b,c-=b);return j}function b(a,b,c){var d,e,f,r,g=a.length,h=new v(g),j=c*b;d=c=f=0;for(e=j-1;f<g;)r=d+e<<2,h[f]=a[r],h[f+1]=a[r+1],h[f+2]=a[r+2],h[f+3]=a[r+3],f+=4,c++,e-=b,c>=b&&(c=0,e=j-1,d++);return h}function e(a,b){var c,d,e,f,r,g=a.length,h=new v(g);for(e=d=c=f=0;f<g;)r=b-1-d+e<<2,h[f]=a[r],h[f+1]=a[r+1],h[f+2]=a[r+2],h[f+3]=a[r+3],f+=4,c++,e+=b,c>=b&&(e=c=0,d++);return h}function c(b,x,c){var d,e,f,r,g=b.length,h=new v(g),j=this.inverseTransform,k=this.mode,
m=a.MODE.WRAP,l;for(e=d=f=0;f<g;){l=j([d,e],x,c);r=~~l[0];l=~~l[1];if(0>r||r>=x||0>l||l>=c)switch(k){case m:l>=c&&(l-=c);l<0&&(l+=c);r>=x&&(r-=x);r<0&&(r+=x);break;default:l>=c&&(l=c-1),l<0&&(l=0),r>=x&&(r=x-1),r<0&&(r=0)}r=r+l*x<<2;h[f]=b[r];h[f+1]=b[r+1];h[f+2]=b[r+2];h[f+3]=b[r+3];f+=4;d++;d>=x&&(d=0,e++)}return h}function f(b,x,c){var d,e,f,g,h=x*c,j=b.length,k=new v(j),m=this.a,l=this.b,q=this.c,o=this.d,p=this.mode,s=a.MODE.WRAP,u,w=x-1,t=h-x;e=d=c=f=0;for(o*=x;f<j;){g=~~(m*c+q);u=~~(l*e+o);
if(0>g||g>w||0>u||u>t)switch(p){case s:u>t&&(u-=h);u<0&&(u+=h);g>=x&&(g-=x);g<0&&(g+=x);break;default:u>t&&(u=t),u<0&&(u=0),g>w&&(g=w),g<0&&(g=0)}g=g+u<<2;k[f]=b[g];k[f+1]=b[g+1];k[f+2]=b[g+2];k[f+3]=b[g+3];f+=4;c++;c>=x&&(c=0,d++,e+=x)}return k}function h(b,c,d){if(0>=this.radius)return b;var e,f,g,h,j=b.length,k=new v(b),m=this.centerX,q=this.centerY,p=this.radius,s=this.mode,Y=a.MODE.WRAP,G,C,u=this.angle/p,R=c-1,F=d-1;for(f=e=g=0;g<j;){G=e-m;C=f-q;h=o(G*G+C*C);if(h<p){C=l(C,G)+u*(p-h);G=~~(m+
h*w(C));C=~~(q+h*t(C));if(0>G||G>R||0>C||C>F)switch(s){case Y:C>F&&(C-=d);C<0&&(C+=d);G>R&&(G-=c);G<0&&(G+=c);break;default:C>F&&(C=F),C<0&&(C=0),G>R&&(G=R),G<0&&(G=0)}h=G+C*c<<2;k[g]=b[h];k[g+1]=b[h+1];k[g+2]=b[h+2];k[g+3]=b[h+3]}g+=4;e++;e>=c&&(e=0,f++)}return k}function g(b,c,d){if(0>=this.radius)return b;var e,f,g,h,j=b.length,k=new v(b),m=this.centerX,l=this.centerY;e=this.radius;var q=this.mode,w=a.MODE.WRAP,t,G=e*e,C=1-0.555556,u,R,F,H,z=c-1,B=d-1;for(f=e=g=0;g<j;){h=e-m;t=f-l;F=h*h;H=t*t;
u=F+H;if(u<G){R=G-u;u=o(R);h=p(h/o(F+R))*C;t=p(t/o(H+R))*C;h=~~(e-u*s(h));t=~~(f-u*s(t));if(0>h||h>z||0>t||t>B)switch(q){case w:t>B&&(t-=d);t<0&&(t+=d);h>z&&(h-=c);h<0&&(h+=c);break;default:t>B&&(t=B),t<0&&(t=0),h>z&&(h=z),h<0&&(h=0)}h=h+t*c<<2;k[g]=b[h];k[g+1]=b[h+1];k[g+2]=b[h+2];k[g+3]=b[h+3]}g+=4;e++;e>=c&&(e=0,f++)}return k}function k(a){return a}function q(a){return a}var v=a.ImArray,o=Math.sqrt,l=Math.atan2,t=Math.sin,w=Math.cos,p=Math.asin,s=Math.tan;a.GeometricMapFilter=function(a){this.generic(a)};
a.GeometricMapFilter.prototype={_map:null,inverseTransform:null,a:1,b:1,c:0,d:0,centerX:0,centerY:0,angle:0,radius:0,mode:a.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=c;return this},affine:function(a,b,c,d){this.a=a;this.b=b;this.c=c;this.d=d;this._map=f;return this},flipX:function(){this._map=m;return this},flipY:function(){this._map=j;return this},flipXY:function(){this._map=d;return this},rotateCW:function(){this._map=b;return this},rotateCCW:function(){this._map=e;return this},
polar:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=k;return this},cartesian:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=q;return this},twirl:function(a,b,c,d){this.angle=a||0;this.radius=b||0;this.centerX=c||0;this.centerY=d||0;this._map=h;return this},sphere:function(a,b,c){this.radius=a||0;this.centerX=b||0;this.centerY=c||0;this._map=g;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},
_apply:function(a,b,c){if(!this._map)return a;return this._map.call(this,a,b,c)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function m(a,b,c,d){var e=a.length,f,g=new o(a.length),c=c||1,d=d||1;for(f=0;f<e;)g[f]=c*a[f]+d*b[f],f++;return g}function j(a,b){var c,d,e=a.length,f,g=[],h=0;for(c=0;c<e;c++)for(d=0;d<e;d++)f=a[c]*b[d],h+=f,g.push(f);return{kernel:g,sum:h}}function d(a){var b,c=Array(a);for(b=0;b<a;)c[b]=0,b++;c[a>>1]=1;return c}function b(a){var b,c=Array(a);for(b=0;b<a;)c[b]=1,b++;return c}function e(a){var b=l.length,c,d;a--;if(a<b)c=l[a].slice();else for(c=new o(l[b-1]);b<=a;){d=c.slice();c=[1];
i=0;for(il=d.length-1;i<il;i++)c.push(d[i]+d[i+1]);c.push(1);b<40&&l.push(c.slice());b++}return c}function c(a){var b,c=-(a>>1),d=Array(a);for(b=0;b<a;)d[b]=c,c++,b++;return d}function f(a){a=e(a);return j(a,a)}function h(a,b){var d=e(a),f=c(a);return 1==b?j(f.reverse(),d):j(d,f)}function g(a,d){var e=b(a),f=c(a);return 1==d?j(f.reverse(),e):j(e,f)}function k(a,b){var b=b||1,c=a*a,d,e=new o(c);for(d=0;d<c;)e[d]=b,d++;return e}function q(b,c,d,e,f,g,h,j,k,m){var l=b.length,q,o,p,n,u,s,w,t,z,B,E,S,
V,J,D,I,N,Z,$,K,ba,ca,aa;q=c*d;u=g*h;g>>=1;h=c*(h>>1);d=-g-1;t=-h-c;Z=c-1;$=q-c;q=(q<<1)+q;w=(c<<1)+c;m=m||1;aa=0;if(f){E=e[0];e=e[u>>1];e-=E;S=f[0];f=f[u>>1];for(V=f-S;aa<m;){s=new v(b);f=new a.Array32F(q);for(o=p=n=B=z=u=0;B<c;)o+=b[u],p+=b[u+1],n+=b[u+2],f[z]=o,f[z+1]=p,f[z+2]=n,u+=4,z+=3,B++;u=w+c;z=w;for(o=p=n=B=0;u<l;)o+=b[u],p+=b[u+1],n+=b[u+2],f[z]=f[z-w]+o,f[z+1]=f[z-w+1]+p,f[z+2]=f[z-w+2]+n,u+=4,z+=3,B++,B>=c&&(o=p=n=B=0);for(p=o=B=u=0;u<l;)J=B+d,D=p+t,I=B+g,N=p+h,J<0?J=0:I>Z&&(I=Z),D<0?
D=0:N>$&&(N=$),n=J+D,z=I+N,D=I+D,K=J+N,n=(n<<1)+n,D=(D<<1)+D,K=(K<<1)+K,z=(z<<1)+z,J=E*(f[z]-f[D]-f[K]+f[n])+e*b[u],N=E*(f[z+1]-f[D+1]-f[K+1]+f[n+1])+e*b[u+1],I=E*(f[z+2]-f[D+2]-f[K+2]+f[n+2])+e*b[u+2],ba=S*(f[z]-f[D]-f[K]+f[n])+V*b[u],ca=S*(f[z+1]-f[D+1]-f[K+1]+f[n+1])+V*b[u+1],n=S*(f[z+2]-f[D+2]-f[K+2]+f[n+2])+V*b[u+2],s[u]=~~(j*J+k*ba),s[u+1]=~~(j*N+k*ca),s[u+2]=~~(j*I+k*n),u+=4,B++,B>=c&&(B=0,o++,p+=c);b=s;aa++}}else{E=e[0];e=e[u>>1];e-=E;j=j||1;for(k=k||0;aa<m;){s=new v(b);f=new a.Array32F(q);
for(o=p=n=B=z=u=0;B<c;)o+=b[u],p+=b[u+1],n+=b[u+2],f[z]=o,f[z+1]=p,f[z+2]=n,u+=4,z+=3,B++;u=w+c;z=w;for(o=p=n=B=0;u<l;)o+=b[u],p+=b[u+1],n+=b[u+2],f[z]=f[z-w]+o,f[z+1]=f[z-w+1]+p,f[z+2]=f[z-w+2]+n,u+=4,z+=3,B++,B>=c&&(o=p=n=B=0);for(p=o=B=u=0;u<l;)J=B+d,D=p+t,I=B+g,N=p+h,J<0?J=0:I>Z&&(I=Z),D<0?D=0:N>$&&(N=$),n=J+D,z=I+N,D=I+D,K=J+N,n=(n<<1)+n,D=(D<<1)+D,K=(K<<1)+K,z=(z<<1)+z,J=E*(f[z]-f[D]-f[K]+f[n])+e*b[u],N=E*(f[z+1]-f[D+1]-f[K+1]+f[n+1])+e*b[u+1],I=E*(f[z+2]-f[D+2]-f[K+2]+f[n+2])+e*b[u+2],s[u]=
~~(j*J+k),s[u+1]=~~(j*N+k),s[u+2]=~~(j*I+k),u+=4,B++,B>=c&&(B=0,o++,p+=c);b=s;aa++}}return s}var v=a.ImArray,o=a.Array32F,l=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],t=a.CONSTANTS.toRad,w=Math.abs,p=Math.sqrt,s=Math.sin,n=Math.cos;a.ConvolutionMatrixFilter=function(a,b,c){typeof a!="undefined"&&a.length?(this.set(a,~~(p(a.length)+0.5),b||1),this._bias=c||0):(this._matrix=null,this._dim=0);this._coeff1=this._coeff2=this._matrix2=
null;this._isGrad=!1;this._doFast=0};a.ConvolutionMatrixFilter.prototype={_dim:0,_matrix:null,_factor:1,_bias:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(k(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,b){var a=typeof a=="undefined"?3:a%2?a:a+1,c=a*a,d=-(typeof b=="undefined"?1:b)/c,f=k(a,d);f[c>>1]=1+d;this.set(f,a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},verticalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,c,f=
a;c=d(f);f=b(f);c=j(f,c);return this.set(c.kernel,a,1/c.sum)},horizontalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,c,f=a;c=d(f);f=b(f);c=j(c,f);return this.set(c.kernel,a,1/c.sum)},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=f(a);return this.set(b.kernel,a,1/b.sum)},binomialHighPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=f(a);return this.set(m(k(a),new o(b.kernel),1,-1/b.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},fastGauss:function(a,
b){b=typeof b=="undefined"?3:b%2?b:b+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(k(b),b,1/(b*b));this._doFast=a;return this},sharpen:function(a,b){a=typeof a=="undefined"?0.5:a;return a<=0?this.set([0,-2,0,-2,10,-2,0,-2,0],3,0.5):this.highPass(b,a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(g(a,0).kernel,a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(g(a,1).kernel,a,1)},prewittDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;
a*=t;var c=n(a),f=s(a),d=g(b,0),e=g(b,1);return this.set(m(new o(d.kernel),new o(e.kernel),c,f),b,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=g(a,0),c=g(a,1);this.set(b.kernel,a,1);this._isGrad=!0;this._matrix2=new o(c.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},gradDirectional:function(a,b){return this.prewittDirectional(a,b)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:
a%2?a:a+1;return this.set(h(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(h(a,1).kernel,a,1)},sobelDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=t;var c=n(a),f=s(a),d=h(b,0),e=h(b,1);return this.set(m(new o(d.kernel),new o(e.kernel),c,f),b,1)},sobel:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=h(a,0),c=h(a,1);this.set(b.kernel,a,1);this._matrix2=new o(c.kernel);this._isGrad=!0;return this},laplace:function(a){var a=typeof a=="undefined"?
3:a%2?a:a+1,b=k(a,-1),c=a*a;b[c>>1]=c-1;this.set(b,a,1);this._doFast=1;return this},emboss:function(a,b,c){var c=typeof c=="undefined"?3:c%2?c:c+1,a=typeof a=="undefined"?-0.25*Math.PI:a*t,b=b||1,f=b*n(a),a=-b*s(a),b=c,d=b*b,e=b>>1,g,h=new o(d),j,k,m;j=m=-e*f;k=-e*a;for(g=e=0;e<d;)h[e]=j+k,e++,g++,j+=f,g>=b&&(g=0,j=m,k+=a);h[c*c>>1]=1;return this.set(h,c,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,b,c){this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=
!1;this._doFast=0;this._matrix=new o(a);this._dim=b;this._factor=c||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,b){this._matrix=a;this._dim=b;this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;return this},_apply:function(b,c,f){if(!this._matrix)return b;if(this._doFast)return this._matrix2?q(b,c,f,this._matrix,this._matrix2,this._dim,this._dim,this._coeff1,this._coeff2,this._doFast):q(b,c,f,this._matrix,
null,this._dim,this._dim,this._factor,this._bias,this._doFast);var d=this._dim,e=this._dim,g=d>>1,h=d*e,j=(e>>1)*c,e=this._matrix,k=this._factor,m=this._bias,n=this._matrix2,l,p=this._isGrad,o=new a.Array16I(h<<1),s=new a.Array8U(h),u=c*f,f=b.length,t=new v(f),F,H,z,B,E,S,V=c-1,J=u-c,D=this._coeff1,I=this._coeff2;for(B=z=H=F=u=0;F<h;)s[F]=H+z,o[u]=H-g,o[u+1]=B-j,u+=2,F++,H++,H>=d&&(H=0,z+=d,B+=c);if(n)for(z=H=d=0;d<f;){for(F=u=S=m=k=B=j=g=0;F<h;)E=H+o[u],l=z+o[u+1],E>=0&&E<=V&&l>=0&&l<=J&&(E=E+l<<
2,l=e[s[F]],g+=b[E]*l,j+=b[E+1]*l,B+=b[E+2]*l,l=n[s[F]],k+=b[E]*l,m+=b[E+1]*l,S+=b[E+2]*l),u+=2,F++;p?(t[d]=~~(w(g)+w(k)),t[d+1]=~~(w(j)+w(m)),t[d+2]=~~(w(B)+w(S))):(t[d]=~~(D*g+I*k),t[d+1]=~~(D*j+I*m),t[d+2]=~~(D*B+I*S));t[d+3]=b[d+3];d+=4;H++;H>=c&&(H=0,z+=c)}else for(z=H=d=0;d<f;){for(F=u=B=j=g=0;F<h;)E=H+o[u],l=z+o[u+1],E>=0&&E<=V&&l>=0&&l<=J&&(E=E+l<<2,l=e[s[F]],g+=b[E]*l,j+=b[E+1]*l,B+=b[E+2]*l),u+=2,F++;t[d]=~~(k*g+m);t[d+1]=~~(k*j+m);t[d+2]=~~(k*B+m);t[d+3]=b[d+3];d+=4;H++;H>=c&&(H=0,z+=c)}return t},
apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(a){var m=a.ImArray,j=function(b,d,e){var g=this._dim,j=g>>1,q=g*g,v=j*d,o=new a.Array32I(q<<1),l=d*e,e=b.length,t=new m(e),w,p,s=[],n=[],x=[];q<<=1;var A=d-1,L=l-d;for(p=l=w=0;w<q;)o[w]=l-j,o[w+1]=p-v,w+=2,l++,l>=g&&(l=0,p+=d);for(p=l=g=0;g<e;){s.length=0;n.length=0;for(w=x.length=0;w<q;)j=l+o[w],v=p+o[w+1],j>=0&&j<=A&&v>=0&&v<=L&&(j=j+v<<2,s.push(b[j]),n.push(b[j+1]),x.push(b[j+2])),w+=2;s.sort();n.sort();x.sort();w=(s.length>>1)+1;(j=s.length%2)?(t[g]=s[w],t[g+1]=n[w],t[g+2]=x[w]):(t[g]=
~~(0.5*(s[w-1]+s[w])),t[g+1]=~~(0.5*(n[w-1]+n[w])),t[g+2]=~~(0.5*(x[w-1]+x[w])));t[g+3]=b[g+3];g+=4;l++;l>=d&&(l=0,y++,p+=d)}return t},d=function(b,d,e){var g=this._dim,j=g>>1,q=g*g,v=j*d,o=new a.Array32I(q<<1),l=d*e,e=b.length,t=new m(e),w,p,s,n,x,A;q<<=1;var L=d-1,P=l-d;for(p=w=l=0;l<q;)o[l]=w-j,o[l+1]=p-v,l+=2,w++,w>=g&&(w=0,p+=d);for(p=w=g=0;g<e;){for(l=A=v=j=0;l<q;)s=w+o[l],n=p+o[l+1],s>=0&&s<=L&&n>=0&&n<=P&&(x=s+n<<2,s=b[x],n=b[x+1],x=b[x+2],s>j&&(j=s),n>v&&(v=n),x>A&&(A=x)),l+=2;t[g]=j;t[g+
1]=v;t[g+2]=A;t[g+3]=b[g+3];g+=4;w++;w>=d&&(w=0,p+=d)}return t},b=function(b,d,e){var g=this._dim,j=g>>1,q=g*g,v=j*d,o=new a.Array32I(q<<1),l=d*e,e=b.length,t=new m(e),w,p,s,n,x,A;q<<=1;var L=d-1,P=l-d;for(p=w=l=0;l<q;)o[l]=w-j,o[l+1]=p-v,l+=2,w++,w>=g&&(w=0,p+=d);for(p=w=g=0;g<e;){A=v=j=255;for(l=0;l<q;)s=w+o[l],n=p+o[l+1],s>=0&&s<=L&&n>=0&&n<=P&&(x=s+n<<2,s=b[x],n=b[x+1],x=b[x+2],s<j&&(j=s),n<v&&(v=n),x<A&&(A=x)),l+=2;t[g]=j;t[g+1]=v;t[g+2]=A;t[g+3]=b[g+3];g+=4;w++;w>=d&&(w=0,p+=d)}return t},e=
function(a){return a};a.StatisticalFilter=function(){this._dim=0;this._apply=e};a.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=j;return this},erode:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=b;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=d;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},
reset:function(){this._apply=e;this._dim=0;return this}}})(FILTER);(function(a){a.NoiseFilter=a.Create({min:-127,max:127,init:function(a,j){this.min=a||-127;this.max=j||127},apply:function(a){var j=this.max-this.min,d=Math.random,b=this.min,e,c=a.length,f,h,g,k;for(e=0;e<c;)h=a[e],g=a[e+1],k=a[e+2],f=j*d()+b,a[e]=h+f,a[e+1]=g+f,a[e+2]=k+f,e+=4;return a}})})(FILTER);
(function(a){a.HistogramEqualizeFilter=a.Create({apply:function(m){var j,d,b,e;e=0;var c=255,f=new a.Array32F(256),h=new a.Array32F(256),g=0,k,q=m.length;k=q>>2;var v=1/k,o=Array(k),l=a.Color.RGB2YCbCr,t=a.Color.YCbCr2RGB;for(k=0;k<256;)f[k]=0,h[k]=0,k++;for(g=k=0;k<q;){j=m[k];d=m[k+1];b=m[k+2];j=l({r:j,g:d,b:b});f[j.y]+=v;if(j.y>e)e=j.y;if(j.y<c)c=j.y;o[g]=j;k+=4;g++}for(k=g=0;k<256;)g+=f[k],h[k]=g,k++;e-=c;for(g=k=0;k<q;)j=o[g],j.y=h[j.y]*e+c,f=t(j),m[k]=f.r,m[k+1]=f.g,m[k+2]=f.b,k+=4,g++;return m}})})(FILTER);
(function(a){a.RGBHistogramEqualizeFilter=a.Create({apply:function(m){var j,d,b,e,c,f;f=c=e=0;var h=255,g=255,k=255,q=new a.Array32F(256),v=new a.Array32F(256),o=new a.Array32F(256),l=new a.Array32F(256),t=new a.Array32F(256),w=new a.Array32F(256),p,s=m.length,n=1/(s>>2);for(p=0;p<256;)q[p]=0,v[p]=0,o[p]=0,l[p]=0,t[p]=0,w[p]=0,p++;for(p=0;p<s;)j=m[p],d=m[p+1],b=m[p+2],q[j]+=n,v[d]+=n,o[b]+=n,j>e&&(e=j),j<h&&(h=j),d>c&&(c=d),d<g&&(g=d),b>f&&(f=b),b<k&&(k=b),p+=4;for(p=j=d=b=0;p<256;)j+=q[p],l[p]=j,
d+=v[p],t[p]=d,b+=o[p],w[p]=b,p++;e-=h;c-=g;f-=k;for(p=0;p<s;)j=m[p],d=m[p+1],b=m[p+2],m[p]=l[j]*e+h,m[p+1]=t[d]*c+g,m[p+2]=w[b]*f+k,p+=4;return m}})})(FILTER);
(function(a){var m=Math.sqrt;a.PixelateFilter=a.Create({scale:1,init:function(a){this.scale=a||1},apply:function(j,d,b){if(this.scale<=1)return j;if(this.scale>100)this.scale=100;var e=j.length,c=d*b,b=~~(m(c)*this.scale*0.01),f=b*b,h=1/f,g=b<<2,k=d*b;f<<=2;var q=new a.Array32F(c*3),v,o,l,t=(d<<1)+d,w,p,s,n,x,A,L,P,T,r,Q;w=b-1;p=(b-1)*d;T=d-1;r=c-d;for(v=o=l=n=s=c=0;n<d;)v+=j[c],o+=j[c+1],l+=j[c+2],q[s]=v,q[s+1]=o,q[s+2]=l,c+=4,s+=3,n++;c=t+d;s=t;for(v=o=l=n=0;c<e;)v+=j[c],o+=j[c+1],l+=j[c+2],q[s]=
q[s-t]+v,q[s+1]=q[s-t+1]+o,q[s+2]=q[s-t+2]+l,c+=4,s+=3,n++,n>=d&&(v=o=l=n=0);for(t=n=c=0;c<e;){v=n;x=t;A=n+w;o=t+p;A>T&&(A=T);o>r&&(o=r);s=v+x;l=A+o;x=A+x;A=v+o;s=(s<<1)+s;x=(x<<1)+x;A=(A<<1)+A;l=(l<<1)+l;v=h*(q[l]-q[x]-q[A]+q[s]);o=h*(q[l+1]-q[x+1]-q[A+1]+q[s+1]);Q=h*(q[l+2]-q[x+2]-q[A+2]+q[s+2]);v=~~v;o=~~o;Q=~~Q;s=c;x=n;A=t;P=n+b;l=c+f;for(l>e&&(l=e);s<l;)if(L=x+A<<2,j[L]=v,j[L+1]=o,j[L+2]=Q,s+=4,x++,x>=d||x>=P)x=n,A+=d;c+=g;n+=b;n>=d&&(n=0,t+=k)}return j}})})(FILTER);
(function(a){a.HSVConverterFilter=a.Create({apply:function(m,j,d){for(var b,e,c=m.length,f=a.Color.RGB2HSV,j=0;j<c;)d=m[j],b=m[j+1],e=m[j+2],e=f({r:d,g:b,b:e}),d=e.h*0.7083333333333334,b=e.s*255,e=e.v,m[j]=d,m[j+1]=e,m[j+2]=b,j+=4;return m}})})(FILTER);
(function(a){a.HueExtractorFilter=a.Create({range:null,background:0,init:function(a,j){this.range=a;this.range.sort();this.background=j||0},apply:function(m){if(!this.range||!this.range.length)return m;var j,d,b,e,c,f=m.length,h,g=a.Color.RGB2HSV,k=this.range[0],q=this.range[this.range.length-1];e=new a.ImArray(f);h=a.Color.Color2RGBA(this.background||0);for(c=0;c<f;)j=m[c],d=m[c+1],b=m[c+2],j=g({r:j,g:d,b:b}).h,j>=k&&j<=q?(e[c]=m[c],e[c+1]=m[c+1],e[c+2]=m[c+2],e[c+3]=m[c+3]):(e[c]=h.r,e[c+1]=h.g,
e[c+2]=h.b,e[c+3]=h.a),c+=4;return e}})})(FILTER);
(function(a){a.AlphaMaskFilter=a.Create({alphaMask:null,centerX:0,centerY:0,init:function(a,j,d){this.alphaMask=a||null;this.centerX=j||0;this.centerY=d||0},apply:function(a,j,d){if(!this.alphaMask)return a;var b=this.alphaMask.getData(),e=a.length,c=this.alphaMask.width,f=this.alphaMask.height,h,g,k,q=Math.min(j,c),v=Math.min(d,f),o,l;o=this.centerX+(j-c>>1);l=this.centerY+(d-f>>1);for(h=f=d=0;d<e;)g=f-o,k=h-l,g>=0&&g<q&&k>=0&&k<v?(g=g+k*c<<2,a[d+3]=b[g+3]):a[d+3]=0,d+=4,f++,f>=j&&(f=0,h++);return a}})})(FILTER);
