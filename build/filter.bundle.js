/**
*
*   Classy
*   @version: 0.4.4
*
*   Object-Oriented mini-framework for JavaScript
*   https://github.com/foo123/classy.js
*
**/!function(e,t,r,n){r=r?[].concat(r):[];var o,l=r.length,a=new Array(l),i=new Array(l),c=new Array(l);for(o=0;l>o;o++)a[o]=r[o][0],i[o]=r[o][1];if("object"==typeof module&&module.exports){if("undefined"==typeof module.exports[t]){for(o=0;l>o;o++)c[o]=module.exports[a[o]]||require(i[o])[a[o]];module.exports[t]=n.apply(e,c)}}else if("function"==typeof define&&define.amd)define(["exports"].concat(i),function(r){if("undefined"==typeof r[t]){for(var o=Array.prototype.slice.call(arguments,1),l=0,i=o.length;i>l;l++)c[l]=r[a[l]];r[t]=n.apply(e,c)}});else if("undefined"==typeof e[t]){for(o=0;l>o;o++)c[o]=e[a[o]];e[t]=n.apply(e,c)}}(this,"Classy",null,function(){var e={};return function(e){var t=function(e,t,r){this.v=e||null,this.prev=t||null,r=r||null};t.prototype={constructor:t,v:null,prev:null,next:null};var r=Array.prototype,n=Object.prototype,o=r.slice,l=(r.splice,r.concat,n.toString),a=n.hasOwnProperty,i=n.propertyIsEnumerable,c=Object.keys,u=Object.defineProperty,f=function(e){return"function"==typeof e},p=function(e,t){if("object"!=typeof e||null===e)throw new TypeError("bad desc");var r={};if(a.call(e,"enumerable")&&(r.enumerable=!!t.enumerable),a.call(e,"configurable")&&(r.configurable=!!t.configurable),a.call(e,"value")&&(r.value=t.value),a.call(e,"writable")&&(r.writable=!!e.writable),a.call(e,"get")){var n=e.get;if(!f(n)&&"undefined"!==n)throw new TypeError("bad get");r.get=n}if(a.call(e,"set")){var o=e.set;if(!f(o)&&"undefined"!==o)throw new TypeError("bad set");r.set=o}if(("get"in r||"set"in r)&&("value"in r||"writable"in r))throw new TypeError("identity-confused descriptor");return r},s=Object.defineProperties||function(e,t){if("object"!=typeof e||null===e)throw new TypeError("bad obj");t=Object(t);for(var r=c(t),n=[],o=0;o<r.length;o++)n.push([r[o],p(t[r[o]],e)]);for(var o=0;o<n.length;o++)u(e,n[o][0],n[o][1]);return e},y=Object.create||function(e,t){var r,n=function(){};return n.prototype=e,r=new n,r.__proto__=e,"object"==typeof t&&s(r,t),r},b=function(e){var r=new t(e);return function(e){if(e&&r&&r.v){var n,l=this;if(e="constructor"==e?r.v:r.v.prototype[e])return r=new t(r.v.$super,r),n=e.apply(l,o.call(arguments,1)),r=r.prev,n}}},v=function(){var e,t,r,n,c,u,f,p,s=o.call(arguments);for(t=s.shift()||{},e=s.length,p=0;e>p;p++)if(r=s[p],r&&"object"==typeof r)for(f in r)a.call(r,f)&&i.call(r,f)&&(u=r[f],n=l.call(u),c=typeof u,t[f]="number"==c||u instanceof Number?0+u:u&&("[object Array]"==n||u instanceof Array||"string"==c||u instanceof String)?u.slice(0):u);return t},d=function(e,t){e=e||Object,t=t||{};var r=t.constructor?t.constructor:function(){};return r.prototype=y(e.prototype),r.prototype=v(r.prototype,t),s(r.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0},$class:{value:r,enumerable:!1,writable:!0,configurable:!0},$super:{value:b(e),enumerable:!1,writable:!0,configurable:!0}}),s(r,{$super:{value:e,enumerable:!1,writable:!0,configurable:!0},$static:{value:e.$static&&"object"==typeof e.$static?v(null,e.$static):null,enumerable:!1,writable:!0,configurable:!0}}),r},g=Mixin=v,m=function(){var e=o.call(arguments),t=e.length,r=null;if(t>=2){var n=typeof e[0];n="function"==n?{Extends:e[0]}:"object"==n?e[0]:{Extends:Object};var l,a,i=e[1]||{},c=e[2]||null,u={},f=n.Extends||n.extends||Object,p=n.Implements||n.implements,s=n.Mixin||n.mixin;if(p=p?[].concat(p):null,s=s?[].concat(s):null)for(l=0,a=s.length;a>l;l++)s[l].prototype&&(u=Mixin(u,s[l].prototype));if(p)for(l=0,a=p.length;a>l;l++)p[l].prototype&&(u=g(u,p[l].prototype));r=d(f,v(u,i)),c&&"object"==typeof c&&(r.$static=v(r.$static,c))}else r=d(Object,e[0]);return r};e.Classy={VERSION:"0.4.4",Class:m,Extends:d,Implements:g,Mixin:Mixin,Create:y,Merge:v}}(e),e.Classy});
/**
*
*   FILTER
*   @version: 0.6.8
*
*   JavaScript Image Processing Library
*   https://github.com/foo123/FILTER.js
*
**/!function(t,e,i,n){i=i?[].concat(i):[];var r,s=i.length,a=new Array(s),h=new Array(s),o=new Array(s);for(r=0;s>r;r++)a[r]=i[r][0],h[r]=i[r][1];if("object"==typeof module&&module.exports){if("undefined"==typeof module.exports[e]){for(r=0;s>r;r++)o[r]=module.exports[a[r]]||require(h[r])[a[r]];module.exports[e]=n.apply(t,o)}}else if("function"==typeof define&&define.amd)define(["exports"].concat(h),function(i){if("undefined"==typeof i[e]){for(var r=Array.prototype.slice.call(arguments,1),s=0,h=r.length;h>s;s++)o[s]=i[a[s]];i[e]=n.apply(t,o)}});else if("undefined"==typeof t[e]){for(r=0;s>r;r++)o[r]=t[a[r]];t[e]=n.apply(t,o)}}(this,"FILTER",[["Classy","./classy"]],function(t){var e=t.Class,n=n||{VERSION:"0.6.8"};return function(e,i){var n="undefined"!=typeof global&&"[object global]"=={}.toString.call(global)?!0:!1,r=!n&&window&&window.document&&window.navigator?!0:!1,s=!1,a=navigator?navigator.userAgent:"",h=i.Browser={isNode:n,isBrowser:r,isWorker:s,isPhantom:/PhantomJS/.test(a),isOpera:r&&/Opera|OPR\//.test(a),isFirefox:r&&/Firefox\//.test(a),isChrome:r&&/Chrome\//.test(a),isSafari:r&&/Apple Computer/.test(navigator.vendor),isKhtml:r&&/KHTML\//.test(a),isIE:r&&/MSIE \d/.test(a)||/Trident\/\d/.test(a),isGecko:r&&/gecko\/\d/i.test(a),isWebkit:r&&/WebKit\//.test(a),isMac_geLion:r&&/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(a),isMac_geMountainLion:r&&/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(a),isMobile:!1,isIOS:/AppleWebKit/.test(a)&&/Mobile\/\w+/.test(a),isWin:/windows/i.test(navigator.platform),isMac:!1,isIE_lt8:!1,isIE_lt9:!1,isQtWebkit:!1};h.isMobile=h.isIOS||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(a),h.isMac=h.isIOS||/Mac/.test(navigator.platform),h.isIE_lt8=h.isIE&&(null==document.documentMode||document.documentMode<8),h.isIE_lt9=h.isIE&&(null==document.documentMode||document.documentMode<9),h.isQtWebkit=h.isWebkit&&/Qt\/\d+\.\d+/.test(a),i.Array=Array,i.Array32F="undefined"!=typeof Float32Array?Float32Array:Array,i.Array64F="undefined"!=typeof Float64Array?Float64Array:Array,i.Array8I="undefined"!=typeof Int8Array?Int8Array:Array,i.Array16I="undefined"!=typeof Int16Array?Int16Array:Array,i.Array32I="undefined"!=typeof Int32Array?Int32Array:Array,i.Array8U="undefined"!=typeof Uint8Array?Uint8Array:Array,i.Array16U="undefined"!=typeof Uint16Array?Uint16Array:Array,i.Array32U="undefined"!=typeof Uint32Array?Uint32Array:Array;var o=i._notSupportClamp="undefined"==typeof Uint8ClampedArray;if(i.ImArray=o?i.Array8U:Uint8ClampedArray,i.ImArrayCopy=h.isOpera?i.Array8U:i.ImArray,o&&"undefined"!=typeof CanvasPixelArray&&!CanvasPixelArray.prototype.set){var u=function(t){for(var e=t.length,i=e;--i;)this[i]=t[i];return this};CanvasPixelArray.prototype.set=u}i.CONSTANTS={PI:Math.PI,PI2:2*Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI},i.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3},i.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4},i.LUMA=new i.Array32F([.212671,.71516,.072169]);var l=t.Merge,c=(Object.prototype.hasOwnProperty,Object.prototype.hasOwnProperty,Object.prototype.propertyIsEnumerable,Array.prototype.slice),f=Array.prototype.splice,d=Array.prototype.concat,_=i.log=console&&console.log?console.log:function(){};i.warning=function(t){_("WARNING: "+t)},i.error=function(t){_("ERROR: "+t)},i.useWebGL=!1,i.useWebGLSharedResources=!1,i.useWebGLIfAvailable=function(){},i.useWebGLSharedResourcesIfAvailable=function(){};var m=i.devicePixelRatio=window.devicePixelRatio||1;i.getCanvas=i.createCanvas=function(t,e){var i=document.createElement("canvas");return t=t||0,e=e||0,i.style.width=t+"px",i.style.height=e+"px",i.width=t*m,i.height=e*m,i};var p=0;i.getId=function(){return++p};var g=i.Filter=e({name:"AbstractFilter",constructor:function(){},id:null,_isOn:!0,isOn:function(){return this._isOn},turnOn:function(){return this._isOn=!0,this},turnOff:function(){return this._isOn=!1,this},toggle:function(){return this._isOn=!this._isOn,this},reset:function(){return this},combineWith:function(){return this},toString:function(){return"[FILTER: "+this.name+"]"},_apply:function(t){return t},apply:function(t){if(this._isOn){var e=t.getSelectedData();return t.setSelectedData(this._apply(e[0],e[1],e[2],t))}return t}}),v=i.CompositeFilter=e(g,{name:"CompositeFilter",constructor:function(t){this._stack=t&&t.length?t.slice():[]},_stack:null,getFilters:function(){return this._stack.slice()},setFilters:function(t){return t&&(this._stack=t.slice()),this},push:function(){var t=c.call(arguments),e=t.length;return e&&(this._stack=d.apply(this._stack,t)),this},pop:function(){return this._stack.pop()},shift:function(){return this._stack.shift()},unshift:function(){var t=c.call(arguments),e=t.length;return e&&f.apply(this._stack,[0,0].concat(t)),this},getAt:function(t){return this._stack.length>t?this._stack[t]:null},setAt:function(t,e){return this._stack.length>t?this._stack[t]=e:this._stack.push(e),this},insertAt:function(t){var e=c.call(arguments);return e.length,argslen>1&&(e.shift(),f.apply(this._stack,[t,0].concat(e))),this},removeAt:function(t){return this._stack.splice(t,1)},remove:function(t){for(var e=this._stack.length;--e>=0;)t===this._stack[e]&&this._stack.splice(e,1);return this},reset:function(){return this._stack.length=0,this},toString:function(){var t="",e=this._stack;return t+="[FILTER: "+this.name+"]"+"\n",t+="[\n",t+="    "+e.join("\n    ")+"\n",t+="]\n"},_apply:function(t,e,i,n){if(this._isOn&&this._stack.length){var r,s,a=this._stack,h=a.length;for(r=0;h>r;r++)s=a[r],s&&s._isOn&&(t=s._apply(t,e,i,n))}return t},apply:function(t){if(this._isOn&&this._stack.length){var e=t.getSelectedData();return t.setSelectedData(this._apply(e[0],e[1],e[2],t))}return t}});v.prototype.empty=v.prototype.reset,v.prototype.concat=v.prototype.push;var A=function(){return"[FILTER Plugin: "+this.name+"]"};i.Create=function(t){return t=l({init:function(){},name:"PluginFilter",toString:A,apply:function(t){return t}},t),t.constructor=t.init,t._apply=t.apply,delete t.init,delete t.apply,e(g,t)}}(e,n),function(t){var e=Math.sqrt,n=Math.min,r=Math.max;t.Color={name:"ColorTransforms",clamp:function(t,e,i){return n(i,r(t,e))},clampPixel:function(t){return n(255,r(t,0))},ubyteToFloat:function(t){return.00392156862745098*t},ubyteColorToFloatColor:function(t){var e=t.length,n=new Array(e);for(i=0;e>i;i++)n[i]=.00392156862745098*t[i];return n},hexColorToFloatColor:function(t){var e,i,n,r;return e=255&t>>16,i=255&t>>8,n=255&t,r=255&t>>24,[.00392156862745098*e,.00392156862745098*i,.00392156862745098*n,.00392156862745098*r]},blend:function(t,e,i){return{r:t.r-~~((t.r-e.r)*i+.5),g:t.g-~~((t.g-e.g)*i+.5),b:t.b-~~((t.b-e.b)*i+.5)}},toGray:function(e,i,n){var r=t.LUMA;return~~(r[0]*e+r[1]*i+r[2]*n)},distance:function(t,i){var n=t.r-i.r,r=t.g-i.g,s=t.b-i.b;return e(n*n+r*r+s*s)},RGB2Color:function(t){return t.r<<16|t.g<<8|255&t.b},RGBA2Color:function(t){return t.a<<24|t.r<<16|t.g<<8|255&t.b},Color2RGBA:function(t){return t=~~t,{r:255&t>>>16,g:255&t>>>8,b:255&t,a:255&t>>>24}},RGB2YCbCr:function(t){var e,i,n,r=t.r,s=t.g,a=t.b;return e=~~(0+.299*r+.587*s+.114*a),i=~~(128-.168736*r-.331264*s+.5*a),n=~~(128+.5*r-.418688*s-.081312*a),{y:e,cb:i,cr:n}},YCbCr2RGB:function(t){var e,i,n,r=t.y,s=t.cb,a=t.cr;return e=~~(r+1.402*(a-128)),i=~~(r-.34414*(s-128)-.71414*(a-128)),n=~~(r+1.772*(s-128)),{r:e,g:i,b:n}},RGB2HSV:function(t){var e,i,s,a,h,o,u,l,c;return a=t.r,h=t.g,o=t.b,e=n(a,h,o),i=r(a,h,o),s=i-e,c=i,0==i?(l=0,u=0,{h:u,s:l,v:c}):(l=s/i,u=a==i?(h-o)/s:h==i?2+(o-a)/s:4+(a-h)/s,u*=60,0>u&&(u+=360),{h:u,s:l,v:c})},HSV2RGB:function(t){var e,i,n,r,s,a,h,o,u,l,c;if(u=t.h,l=t.s,c=t.v,0==l)return a=h=o=c,{r:a,g:h,b:o};switch(u/=60,e=~~u,i=u-e,n=c*(1-l),r=c*(1-l*i),s=c*(1-l*(1-i)),e){case 0:a=c,h=s,o=n;break;case 1:a=r,h=c,o=n;break;case 2:a=n,h=c,o=s;break;case 3:a=n,h=r,o=c;break;case 4:a=s,h=n,o=c;break;default:a=c,h=n,o=r}return{r:a,g:h,b:o}},toString:function(){return"[FILTER: "+this.name+"]"}}}(n),function(t,e,i){var n=e.devicePixelRatio,r=e.ImArray,s=e.Array32F,a=e.createCanvas,h=(e._notSupportTypedArrays,Math.min),o=Math.floor,u=e.blendModes={normal:function(t){return t},lighten:function(t,e){return e>t?e:t},darken:function(t,e){return e>t?t:e},multiply:function(t,e){return.003921568627451*t*e},average:function(t,e){return.5*(t+e)},add:function(t,e){return Math.min(255,t+e)},substract:function(t,e){return 255>t+e?0:t+e-255},difference:function(t,e){return Math.abs(t-e)},negation:function(t,e){return 255-Math.abs(255-t-e)},screen:function(t,e){return 255-((255-t)*(255-e)>>8)},exclusion:function(t,e){return t+e-.003921568627451*2*t*e},overlay:function(t,e){return 128>e?.003921568627451*2*t*e:255-.003921568627451*2*(255-t)*(255-e)},softLight:function(t,e){return 128>e?2*((t>>1)+64)*.003921568627451*e:255-.003921568627451*2*(255-((t>>1)+64))*(255-e)},hardLight:function(t,e){return 128>t?.003921568627451*2*e*t:255-.003921568627451*2*(255-e)*(255-t)},colorDodge:function(t,e){return 255==e?e:Math.min(255,(t<<8)/(255-e))},colorBurn:function(t,e){return 0==e?e:Math.max(0,255-(255-t<<8)/e)},linearLight:function(t,e){return 128>e?u.linearBurn(t,2*e):u.linearDodge(t,2*(e-128))},vividLight:function(t,e){return 128>e?u.colorBurn(t,2*e):u.colorDodge(t,2*(e-128))},pinLight:function(t,e){return 128>e?u.darken(t,2*e):u.lighten(t,2*(e-128))},hardMix:function(t,e){return u.vividLight(t,e)<128?0:255},reflect:function(t,e){return 255==e?e:Math.min(255,t*t/(255-e))},glow:function(t,e){return 255==t?t:Math.min(255,e*e/(255-t))},phoenix:function(t,e){return Math.min(t,e)-Math.max(t,e)+255}};u.linearDodge=u.add,u.linearBurn=u.substract;var l=1,c=2,f=4,d=8,_=e.Image=t({name:"ImageProxy",constructor:function(t,e){this.width=0,this.height=0,this.context=null,this.selection=null,this.imageData=null,this.imageDataSel=null,this.domElement=this.canvasElement=a(this.width,this.height),this.context=this.canvasElement.getContext("2d"),this._tmpCanvas=null,this.webgl=null,this._histogram=null,this._integral=null,this._needsRefresh=0,t&&this.setImage(t,e)},width:0,height:0,canvasElement:null,domElement:null,context:null,selection:null,imageData:null,imageDataSel:null,webgl:null,_histogram:null,_integral:null,_needsRefresh:0,_tmpCanvas:null,select:function(t,e,n,r){return this.selection=[i===t?0:t,i===e?0:e,i===n?1:n,i===r?1:r],this._needsRefresh|=c,this},deselect:function(){return this.selection=null,this.imageDataSel=null,this._needsRefresh&=~c,this},setWidth:function(t){return this._setWidth(t),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},setHeight:function(t){return this._setHeight(t),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},setDimensions:function(t,e){return this._setDimensions(t,e),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},setImage:function(t,i){if(!t)return this;var n,r,s,a,h=this;return t instanceof Image||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?(n=t,s=n instanceof HTMLVideoElement?n.videoWidth:n.width,a=n instanceof HTMLVideoElement?n.videoHeight:n.height,r=h.context=h._setDimensions(s,a).canvasElement.getContext("2d"),r.drawImage(n,0,0),h._needsRefresh|=l|f|d,h.selection&&(h._needsRefresh|=c),h.webgl=e.useWebGL?new e.WebGL(h.canvasElement):null):(n=new Image,n.onload=function(){s=n.width,a=n.height,r=h.context=h._setDimensions(s,a).canvasElement.getContext("2d"),r.drawImage(n,0,0),h._needsRefresh|=l|f|d,h.selection&&(h._needsRefresh|=c),h.webgl=e.useWebGL?new e.WebGL(h.canvasElement):null,"undefined"!=typeof i&&i.call(h)},n.src=t),n.crossOrigin="",this},getPixel:function(t,e){this._needsRefresh&l&&this._refreshData();var i=~~(e*this.width+t+.5),n=this.imageData.data;return{r:n[i],g:n[i+1],b:n[i+2],a:n[i+3]}},setPixel:function(t,e,i,n,s,a){var h=new r([255&i,255&n,255&s,255&a]);return this.context.putImageData(h,t,e),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},getData:function(){return this._needsRefresh&l&&this._refreshData(),new r(this.imageData.data)},getSelectedData:function(){var t;return this.selection?(this._needsRefresh&c&&this._refreshDataSel(),t=this.imageDataSel):(this._needsRefresh&l&&this._refreshData(),t=this.imageData),[new r(t.data),t.width,t.height]},setData:function(t){return this._needsRefresh&l&&this._refreshData(),this.imageData.data.set(t),this.context.putImageData(this.imageData,0,0),this._needsRefresh|=f|d,this.selection&&(this._needsRefresh|=c),this},setSelectedData:function(t){if(this.selection){var e=this.selection,i=this.width-1,n=this.height-1,r=o(e[0]*i),s=o(e[1]*n);this._needsRefresh&c&&this._refreshDataSel(),this.imageDataSel.data.set(t),this.context.putImageData(this.imageDataSel,r,s),this._needsRefresh|=l}else this._needsRefresh&l&&this._refreshData(),this.imageData.data.set(t),this.context.putImageData(this.imageData,0,0),this.selection&&(this._needsRefresh|=c);return this._needsRefresh|=f|d,this},getPixelData:function(){return this._needsRefresh&l&&this._refreshData(),this.imageData},setPixelData:function(t){return this.context.putImageData(t,0,0),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},createImageData:function(t,e){return this.context=this._setDimensions(t,e).canvasElement.getContext("2d"),this.context.createImageData(t,e),this._needsRefresh|=l,this.selection&&(this._needsRefresh|=c),this},copy:function(t){return this.setData(t.getData()),this},clone:function(){return new _(this.canvasElement)},scale:function(t,e){if(t=t||1,e=e||t,1==t&&1==e)return this;this._tmpCanvas=this._tmpCanvas||this._getTmpCanvas();var i=this._tmpCanvas.getContext("2d");return i.scale(t,e),i.drawImage(this.canvasElement,0,0),this.width=~~(t*this.width+.5),this.height=~~(e*this.height+.5),this.canvasElement.style.width=this.width+"px",this.canvasElement.style.height=this.height+"px",this.canvasElement.width=this.width*n,this.canvasElement.height=this.height*n,this.context.drawImage(this._tmpCanvas,0,0),this._tmpCanvas.width=this.width,this._tmpCanvas.height=this.height,this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},flipHorizontal:function(){this._tmpCanvas=this._tmpCanvas||this._getTmpCanvas();var t=this._tmpCanvas.getContext("2d");return t.translate(this.width,0),t.scale(-1,1),t.drawImage(this.canvasElement,0,0),this.context.drawImage(this._tmpCanvas,0,0),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},flipVertical:function(){this._tmpCanvas=this._tmpCanvas||this._getTmpCanvas();var t=this._tmpCanvas.getContext("2d");return t.translate(0,this.height),t.scale(1,-1),t.drawImage(this.canvasElement,0,0),this.context.drawImage(this._tmpCanvas,0,0),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},clear:function(){if(this.width&&this.height){var t=this.context;t.clearRect(0,0,this.width,this.height),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c)}return this},fill:function(t,e,i,n,r){if(!n&&this.width&&!r&&this.height)return this;n&&!this.width&&r&&!this.height&&(this.context=this._setDimensions(n,r).canvasElement.getContext("2d"),this.context.createImageData(n,r)),t=t||0,e=e||0,i=i||0,n=n||this.width,r=r||this.height;var s=this.context;return s.fillStyle=t,s.fillRect(e,i,n,r),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},draw:function(){return this},blend:function(t,e,i,n,r){"undefined"==typeof e&&(e="normal"),"undefined"==typeof i&&(i=1),i>1?i=1:0>i&&(i=0),"undefined"==typeof n&&(n=0),"undefined"==typeof r&&(r=0);var s=0,a=0,o=this.context;if(0>n&&(s=-n,n=0),0>r&&(a=-r,r=0),n>=this.width||r>=this.height)return this;var _=u[e]||null;if(!_)return this;var m,p,g,v,A,w,y,E=h(this.width,t.width-s),M=h(this.height,t.height-a),L=this.context.getImageData(n,r,E,M),b=t.context.getImageData(s,a,E,M),C=L.data,x=b.data,R=1-i,D=x.length;for(y=0;D>y;y+=4)v=C[y],A=C[y+1],w=C[y+2],m=_(x[y],v),p=_(x[y+1],A),g=_(x[y+2],w),C[y]=m*i+v*R,C[y+1]=p*i+A*R,C[y+2]=g*i+w*R;return o.putImageData(L,n,r),this._needsRefresh|=l|f|d,this.selection&&(this._needsRefresh|=c),this},integral:function(){return this._needsRefresh&d&&this._computeIntegral(),this._integral},histogram:function(){return this._needsRefresh&f&&this._computeHistogram(),this._histogram},toString:function(){return"[FILTER Image: "+this.name+"]"},_getTmpCanvas:function(){var t=a(this.width,this.height);return t.width=this.width,t.height=this.height,t},_setDimensions:function(t,e){return this.canvasElement.style.width=t+"px",this.canvasElement.width=this.width=t*n,this.canvasElement.style.height=e+"px",this.canvasElement.height=this.height=e*n,this._tmpCanvas&&(this._tmpCanvas.style.width=this.canvasElement.style.width,this._tmpCanvas.width=this.canvasElement.width,this._tmpCanvas.style.height=this.canvasElement.style.height,this._tmpCanvas.height=this.canvasElement.height),this},_setWidth:function(t){return this.canvasElement.style.width=t+"px",this.canvasElement.width=this.width=t*n,this._tmpCanvas&&(this._tmpCanvas.style.width=this.canvasElement.style.width,this._tmpCanvas.width=this.canvasElement.width),this},_setHeight:function(t){return this.canvasElement.style.height=t+"px",this.canvasElement.height=this.height=t*n,this._tmpCanvas&&(this._tmpCanvas.style.height=this.canvasElement.style.height,this._tmpCanvas.height=this.canvasElement.height),this},_computeIntegral:function(){var t,e,i,n,r,a,h,o,u,l=this.width,c=(this.height,l<<2),f=this.getPixelData().data,_=f.length,m=_>>2;for(t=new s(m),e=new s(m),i=new s(m),o=0,h=0,n=r=a=0,u=0;l>u;u++,h+=4,o++)n+=f[h],r+=f[h+1],a+=f[h+2],t[o]=n,e[o]=r,i[o]=a;for(h=c,u=0,o=0,n=r=a=0,h=c;_>h;h+=4,o++,u++)u>=l&&(u=0,n=r=a=0),n+=f[h],r+=f[h+1],a+=f[h+2],t[o+l]=t[o]+n,e[o+l]=e[o]+r,i[o+l]=i[o]+a;return this._integral=[t,e,i],this._needsRefresh&=~d,this},_computeHistogram:function(){var t,e,i,n,r,a,h,o,u,l,c=this.getPixelData().data,d=c.length,_=0,m=0,p=0,g=255,v=255,A=255,w=1/(d>>2);for(t=new s(256),e=new s(256),i=new s(256),l=0;256>l;l+=4)t[l]=0,e[l]=0,i[l]=0,t[l+1]=0,e[l+1]=0,i[l+1]=0,t[l+2]=0,e[l+2]=0,i[l+2]=0,t[l+3]=0,e[l+3]=0,i[l+3]=0;for(l=0;d>l;l+=4)n=c[l],r=c[l+1],a=c[l+2],t[n]+=w,e[r]+=w,i[a]+=w,n>_?_=n:g>n&&(g=n),r>m?m=r:v>r&&(v=r),a>p?p=a:A>a&&(A=a);for(h=o=u=0,l=0;256>l;l+=4)h+=t[l],t[l]=h,o+=e[l],e[l]=o,u+=i[l],i[l]=u,h+=t[l+1],t[l+1]=h,o+=e[l+1],e[l+1]=o,u+=i[l+1],i[l+1]=u,h+=t[l+2],t[l+2]=h,o+=e[l+2],e[l+2]=o,u+=i[l+2],i[l+2]=u,h+=t[l+3],t[l+3]=h,o+=e[l+3],e[l+3]=o,u+=i[l+3],i[l+3]=u;return this._histogram=[t,e,i],this._needsRefresh&=~f,this},_refreshData:function(){return this.imageData=this.context.getImageData(0,0,this.width,this.height),this._needsRefresh&=~l,this},_refreshDataSel:function(){if(this.selection){var t=this.selection,e=this.width-1,i=this.height-1,n=o(t[0]*e),r=o(t[1]*i),s=o(t[2]*e)-n+1,a=o(t[3]*i)-r+1;this.imageDataSel=this.context.getImageData(n,r,s,a)}return this._needsRefresh&=~c,this}}),m=e.ScaledImage=t(_,{name:"ScaledImageProxy",constructor:function(t,e,i,n){this.scaleX=t||1,this.scaleY=e||this.scaleX,this.$super("constructor",i,n)},scaleX:1,scaleY:1,clone:function(){return new m(this.scaleX,this.scaleY,this.canvasElement)},setScale:function(t,e){return i!==t&&null!==t&&(this.scaleX=t),i===e&&i!==t&&null!==t?this.scaleY=t:null!==e&&(this.scaleY=e),this},setImage:function(t,i){if(!t)return this;var n,r,s,a,h,o,u=this,_=this.scaleX,m=this.scaleY;return t instanceof Image||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?(n=t,s=n instanceof HTMLVideoElement?n.videoWidth:n.width,a=n instanceof HTMLVideoElement?n.videoHeight:n.height,h=~~(_*s+.5),o=~~(m*a+.5),r=u.context=u._setDimensions(h,o).canvasElement.getContext("2d"),r.drawImage(n,0,0,s,a,0,0,h,o),u._needsRefresh|=l|f|d,u.selection&&(u._needsRefresh|=c),u.webgl=e.useWebGL?new e.WebGL(u.canvasElement):null):(n=new Image,n.onload=function(){s=n.width,a=n.height,h=~~(_*s+.5),o=~~(m*a+.5),r=u.context=u._setDimensions(s,a).canvasElement.getContext("2d"),r.drawImage(n,0,0,s,a,0,0,h,o),u._needsRefresh|=l|f|d,u.selection&&(u._needsRefresh|=c),u.webgl=e.useWebGL?new e.WebGL(u.canvasElement):null,"undefined"!=typeof i&&i.call(u)},n.src=t),n.crossOrigin="",this}})}(e,n),function(t,e){e.CustomFilter=t(e.Filter,{name:"CustomFilter",constructor:function(t){this._handler=t||null},_handler:null,_apply:function(t,e,i,n){return this._isOn&&this._handler?this._handler.call(this,t,e,i,n):t},apply:function(t){if(this._isOn&&this._handler){var e=t.getSelectedData();return t.setSelectedData(this._handler.call(this,e[0],e[1],e[2],t))}return t}})}(e,n),function(t,e,i){function n(t,e){var i,n,r,s,a,o=new h(20);return i=e[0],n=e[1],r=e[2],s=e[3],a=e[4],o[0]=i*t[0]+n*t[5]+r*t[10]+s*t[15],o[1]=i*t[1]+n*t[6]+r*t[11]+s*t[16],o[2]=i*t[2]+n*t[7]+r*t[12]+s*t[17],o[3]=i*t[3]+n*t[8]+r*t[13]+s*t[18],o[4]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+a,i=e[5],n=e[6],r=e[7],s=e[8],a=e[9],o[5]=i*t[0]+n*t[5]+r*t[10]+s*t[15],o[6]=i*t[1]+n*t[6]+r*t[11]+s*t[16],o[7]=i*t[2]+n*t[7]+r*t[12]+s*t[17],o[8]=i*t[3]+n*t[8]+r*t[13]+s*t[18],o[9]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+a,i=e[10],n=e[11],r=e[12],s=e[13],a=e[14],o[10]=i*t[0]+n*t[5]+r*t[10]+s*t[15],o[11]=i*t[1]+n*t[6]+r*t[11]+s*t[16],o[12]=i*t[2]+n*t[7]+r*t[12]+s*t[17],o[13]=i*t[3]+n*t[8]+r*t[13]+s*t[18],o[14]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+a,i=e[15],n=e[16],r=e[17],s=e[18],a=e[19],o[15]=i*t[0]+n*t[5]+r*t[10]+s*t[15],o[16]=i*t[1]+n*t[6]+r*t[11]+s*t[16],o[17]=i*t[2]+n*t[7]+r*t[12]+s*t[17],o[18]=i*t[3]+n*t[8]+r*t[13]+s*t[18],o[19]=i*t[4]+n*t[9]+r*t[14]+s*t[19]+a,o}function r(t,e,i){var n=1-i,r=new h(20);return r[0]=n*t[0]+i*e[0],r[1]=n*t[1]+i*e[1],r[2]=n*t[2]+i*e[2],r[3]=n*t[3]+i*e[3],r[4]=n*t[4]+i*e[4],r[5]=n*t[5]+i*e[5],r[6]=n*t[6]+i*e[6],r[7]=n*t[7]+i*e[7],r[8]=n*t[8]+i*e[8],r[9]=n*t[9]+i*e[9],r[10]=n*t[10]+i*e[10],r[11]=n*t[11]+i*e[11],r[12]=n*t[12]+i*e[12],r[13]=n*t[13]+i*e[13],r[14]=n*t[14]+i*e[14],r[15]=n*t[15]+i*e[15],r[16]=n*t[16]+i*e[16],r[17]=n*t[17]+i*e[17],r[18]=n*t[18]+i*e[18],r[19]=n*t[19]+i*e[19],r}var s=Math.sin,a=Math.cos,h=e.Array32F,o=e.CONSTANTS.toRad,u=(e.CONSTANTS.toDeg,e._notSupportClamp),l=e.ColorMatrixFilter=t(e.Filter,{name:"ColorMatrixFilter",constructor:function(t){this._matrix=t&&t.length?new h(t):null,e.useWebGL&&(this._webglInstance=e.WebGLColorMatrixFilterInstance)},_matrix:null,_webglInstance:null,channel:function(t,n){n=n===i?!1:n;var r=n?1:0;switch(t){case e.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case e.CHANNEL.BLUE:return this.set([0,0,r,0,0,0,0,r,0,0,0,0,1,0,0,0,0,0,0,255]);case e.CHANNEL.GREEN:return this.set([0,r,0,0,0,0,1,0,0,0,0,r,0,0,0,0,0,0,0,255]);case e.CHANNEL.RED:default:return this.set([1,0,0,0,0,r,0,0,0,0,r,0,0,0,0,0,0,0,0,255])}},redChannel:function(t){return this.channel(e.CHANNEL.RED,t)},greenChannel:function(t){return this.channel(e.CHANNEL.GREEN,t)},blueChannel:function(t){return this.channel(e.CHANNEL.BLUE,t)},alphaChannel:function(){return this.channel(e.CHANNEL.ALPHA,!0)},maskChannel:function(t){switch(t){case e.CHANNEL.ALPHA:return this;case e.CHANNEL.BLUE:return this.set([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0]);case e.CHANNEL.GREEN:return this.set([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);case e.CHANNEL.RED:default:return this.set([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(t,i){switch(t){case e.CHANNEL.ALPHA:switch(i){case e.CHANNEL.ALPHA:return this;case e.CHANNEL.BLUE:return this.set([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case e.CHANNEL.GREEN:return this.set([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case e.CHANNEL.RED:default:return this.set([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}break;case e.CHANNEL.BLUE:switch(i){case e.CHANNEL.ALPHA:return this.set([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case e.CHANNEL.BLUE:return this;case e.CHANNEL.GREEN:return this.set([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case e.CHANNEL.RED:default:return this.set([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}break;case e.CHANNEL.GREEN:switch(i){case e.CHANNEL.ALPHA:return this.set([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case e.CHANNEL.BLUE:return this.set([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case e.CHANNEL.GREEN:return this;case e.CHANNEL.RED:default:return this.set([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0])}break;case e.CHANNEL.RED:default:switch(i){case e.CHANNEL.ALPHA:return this.set([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case e.CHANNEL.BLUE:return this.set([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case e.CHANNEL.GREEN:return this.set([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);case e.CHANNEL.RED:default:return this}}},desaturate:function(){return this.set([e.LUMA[0],e.LUMA[1],e.LUMA[2],0,0,e.LUMA[0],e.LUMA[1],e.LUMA[2],0,0,e.LUMA[0],e.LUMA[1],e.LUMA[2],0,0,0,0,0,1,0])},colorize:function(t,n){var r,s,a,h;return n===i&&(n=1),r=.00392156862745098*(255&t>>16),s=.00392156862745098*(255&t>>8),a=.00392156862745098*(255&t),h=1-n,this.set([h+n*r*e.LUMA[0],n*r*e.LUMA[1],n*r*e.LUMA[2],0,0,n*s*e.LUMA[0],h+n*s*e.LUMA[1],n*s*e.LUMA[2],0,0,n*a*e.LUMA[0],n*a*e.LUMA[1],h+n*a*e.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.set([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.set([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,-1,255])},saturate:function(t){var i,n,r,s;return i=1-t,n=i*e.LUMA[0],r=i*e.LUMA[1],s=i*e.LUMA[2],this.set([n+t,r,s,0,0,n,r+t,s,0,0,n,r,s+t,0,0,0,0,0,1,0])},contrast:function(t,e,n){return e===i&&(e=t),n===i&&(n=t),t+=1,e+=1,n+=1,this.set([t,0,0,0,128*(1-t),0,e,0,0,128*(1-e),0,0,n,0,128*(1-n),0,0,0,1,0])},brightness:function(t,e,n){return e===i&&(e=t),n===i&&(n=t),this.set([1,0,0,0,t,0,1,0,0,e,0,0,1,0,n,0,0,0,1,0])},adjustHue:function(t){t*=o;var i=a(t),n=s(t);return this.set([e.LUMA[0]+i*(1-e.LUMA[0])+n*-e.LUMA[0],e.LUMA[1]+i*-e.LUMA[1]+n*-e.LUMA[1],e.LUMA[2]+i*-e.LUMA[2]+n*(1-e.LUMA[2]),0,0,e.LUMA[0]+i*-e.LUMA[0]+.143*n,e.LUMA[1]+i*(1-e.LUMA[1])+.14*n,e.LUMA[2]+i*-e.LUMA[2]+n*-.283,0,0,e.LUMA[0]+i*-e.LUMA[0]+n*-(1-e.LUMA[0]),e.LUMA[1]+i*-e.LUMA[1]+n*e.LUMA[1],e.LUMA[2]+i*(1-e.LUMA[2])+n*e.LUMA[2],0,0,0,0,0,1,0])},average:function(t,e,n){return t===i&&(t=.3333),e===i&&(e=.3333),n===i&&(n=.3334),this.set([t,e,n,0,0,t,e,n,0,0,t,e,n,0,0,0,0,0,1,0])},quickContrastCorrection:function(t){return t===i&&(t=1.2),this.set([t,0,0,0,0,0,t,0,0,0,0,0,t,0,0,0,0,0,1,0])},sepia:function(t){return t===i&&(t=.5),t>1?t=1:0>t&&(t=0),this.set([1-.607*t,.769*t,.189*t,0,0,.349*t,1-.314*t,.168*t,0,0,.272*t,.534*t,1-.869*t,0,0,0,0,0,1,0])},sepia2:function(t){return t===i&&(t=10),t>100&&(t=100),t*=2.55,this.set([e.LUMA[0],e.LUMA[1],e.LUMA[2],0,40,e.LUMA[0],e.LUMA[1],e.LUMA[2],0,20,e.LUMA[0],e.LUMA[1],e.LUMA[2],0,-t,0,0,0,1,0])},threshold:function(t,n){return n===i&&(n=256),this.set([e.LUMA[0]*n,e.LUMA[1]*n,e.LUMA[2]*n,0,-(n-1)*t,e.LUMA[0]*n,e.LUMA[1]*n,e.LUMA[2]*n,0,-(n-1)*t,e.LUMA[0]*n,e.LUMA[1]*n,e.LUMA[2]*n,0,-(n-1)*t,0,0,0,1,0])},threshold_rgb:function(t,e){return e===i&&(e=256),this.set([e,0,0,0,-(e-1)*t,0,e,0,0,-(e-1)*t,0,0,e,0,-(e-1)*t,0,0,0,1,0])},threshold_alpha:function(t,e){return t===i&&(t=.5),e===i&&(e=256),this.set([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,e,-e*t])},RGB2YCbCr:function(){return this.set([.5,-.418688,-.081312,0,128,.299,.587,.114,0,0,-.168736,-.331264,.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.set([1.402,1,0,0,-179.456,-.71414,1,-.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(t,e){return this._matrix=this._matrix?r(this._matrix,t.getMatrix(),e):new h(t.getMatrix()),this},set:function(t){return this._matrix=this._matrix?n(this._matrix,new h(t)):new h(t),this},reset:function(){return this._matrix=null,this},combineWith:function(t){return this.set(t.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(t){return this._matrix=new h(t),this},_apply:function(t){if(this._isOn&&this._matrix){var e,i,n,r,s,a,h,o,l,c,f,d,_,m,p,g,v,A,w,y,E,M=t.length,L=this._matrix,b=(M>>2)%4;if(u){for(e=0;M>e;e+=16)A=t[e],w=t[e+1],y=t[e+2],E=t[e+3],i=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],n=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],r=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],s=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],A=t[e+4],w=t[e+5],y=t[e+6],E=t[e+7],a=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],h=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],o=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],l=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],A=t[e+8],w=t[e+9],y=t[e+10],E=t[e+11],c=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],f=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],d=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],_=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],A=t[e+12],w=t[e+13],y=t[e+14],E=t[e+15],m=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],p=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],g=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],v=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],i=0>i?0:i>255?255:i,n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s,a=0>a?0:a>255?255:a,h=0>h?0:h>255?255:h,o=0>o?0:o>255?255:o,l=0>l?0:l>255?255:l,c=0>c?0:c>255?255:c,f=0>f?0:f>255?255:f,d=0>d?0:d>255?255:d,_=0>_?0:_>255?255:_,m=0>m?0:m>255?255:m,p=0>p?0:p>255?255:p,g=0>g?0:g>255?255:g,v=0>v?0:v>255?255:v,t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s,t[e+4]=~~a,t[e+5]=~~h,t[e+6]=~~o,t[e+7]=~~l,t[e+8]=~~c,t[e+9]=~~f,t[e+10]=~~d,t[e+11]=~~_,t[e+12]=~~m,t[e+13]=~~p,t[e+14]=~~g,t[e+15]=~~v;if(b)for(b<<=2,e=M-b;M>e;e+=4)A=t[e],w=t[e+1],y=t[e+2],E=t[e+3],i=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],n=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],r=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],s=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],i=0>i?0:i>255?255:i,n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s,t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s}else{for(e=0;M>e;e+=16)A=t[e],w=t[e+1],y=t[e+2],E=t[e+3],i=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],n=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],r=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],s=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],A=t[e+4],w=t[e+5],y=t[e+6],E=t[e+7],a=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],h=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],o=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],l=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],A=t[e+8],w=t[e+9],y=t[e+10],E=t[e+11],c=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],f=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],d=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],_=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],A=t[e+12],w=t[e+13],y=t[e+14],E=t[e+15],m=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],p=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],g=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],v=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s,t[e+4]=~~a,t[e+5]=~~h,t[e+6]=~~o,t[e+7]=~~l,t[e+8]=~~c,t[e+9]=~~f,t[e+10]=~~d,t[e+11]=~~_,t[e+12]=~~m,t[e+13]=~~p,t[e+14]=~~g,t[e+15]=~~v;if(b)for(b<<=2,e=M-b;M>e;e+=4)A=t[e],w=t[e+1],y=t[e+2],E=t[e+3],i=L[0]*A+L[1]*w+L[2]*y+L[3]*E+L[4],n=L[5]*A+L[6]*w+L[7]*y+L[8]*E+L[9],r=L[10]*A+L[11]*w+L[12]*y+L[13]*E+L[14],s=L[15]*A+L[16]*w+L[17]*y+L[18]*E+L[19],t[e]=~~i,t[e+1]=~~n,t[e+2]=~~r,t[e+3]=~~s}}return t},apply:function(t){if(this._isOn&&this._matrix){var e=t.getSelectedData();return t.setSelectedData(this._apply(e[0],e[1],e[2],t))}return t}});l.prototype.grayscale=l.prototype.desaturate,l.prototype.rotateHue=l.prototype.adjustHue,l.prototype.thresholdRgb=l.prototype.threshold_rgb,l.prototype.thresholdAlpha=l.prototype.threshold_alpha}(e,n),function(t,e,i){var n=e.ImArrayCopy,r=e.Color.clampPixel,s=function(t){var e=new n(256),i=0;if(t)for(;256>i;)e[i]=255-i,i++;else for(;256>i;)e[i]=i,i++;return e},a=function(t){for(var e=new n(256),i=0;256>i;)e[i]=t,i++;return e},h=function(t){return t?new n(t):null},o=Math.pow,u=Math.exp,l=1/255,c=s(),f=s(1),d=e.TableLookupFilter=t(e.Filter,{name:"TableLookupFilter",constructor:function(t,e,i,n){this._tableR=t||null,this._tableG=e||this._tableR,this._tableB=i||this._tableG,this._tableA=n||null},_tableR:null,_tableG:null,_tableB:null,_tableA:null,thresholds:function(t,e,i){t.length||(t=[t]),e||(e=t),i||(i=e);var s,a,h=t.length,o=h+1,u=e.length,l=u+1,c=i.length,f=c+1,d=new n(256),_=new n(o),m=new n(256),p=new n(l),g=new n(256),v=new n(f),A=255/(o-1),w=255/(l-1),y=255/(f-1);for(s=0;o>s;)_[s]=~~(A*s),s++;for(t[0]=~~(255*t[0]),s=1;h>s;)t[s]=t[s-1]+~~(255*t[s]),s++;for(s=0;l>s;)p[s]=~~(w*s),s++;for(e[0]=~~(255*e[0]),s=1;u>s;)e[s]=e[s-1]+~~(255*e[s]),s++;for(s=0;f>s;)v[s]=~~(y*s),s++;for(i[0]=~~(255*i[0]),s=1;c>s;)i[s]=i[s-1]+~~(255*i[s]),s++;for(s=0;256>s;){for(a=0;h>a&&s>t[a];)a++;for(d[s]=r(_[a]),a=0;u>a&&s>e[a];)a++;for(m[s]=r(p[a]),a=0;c>a&&s>i[a];)a++;
g[s]=r(v[a]),s++}return this.set(d,m,g)},threshold:function(t,e,i){return t=t||.5,e=e||t,i=i||e,this.thresholds([t],[e],[i])},quantize:function(t){t===i&&(t=64),2>t&&(t=2);var e,s=new n(256),a=new n(t),h=255/(t-1),o=t/256;for(e=0;t>e;)a[e]=~~(h*e),e++;for(e=0;256>e;)s[e]=r(a[~~(o*e)]),e++;return this.set(s)},binarize:function(){return this.quantize(2)},solarize:function(t){t===i&&(t=.5);var e,s,a=0,h=new n(256),o=2/255;for(a=0;256>a;)e=o*a,s=e>t?255-255*e:255*e-255,h[a]=~~r(s),a++;return this.set(h)},solarize2:function(t){t===i&&(t=.5),t=1-t;var e,s,a=0,h=new n(256),o=2/255;for(a=0;256>a;)e=o*a,s=t>e?255-255*e:255*e-255,h[a]=~~r(s),a++;return this.set(h)},solarizeInverse:function(t){t===i&&(t=.5),t*=256;var e=0,r=new n(256);for(e=0;256>e;)r[e]=e>t?255-e:e,e++;return this.set(r)},invert:function(){return this.set(f)},mask:function(t){var e=0,i=255&t>>16,s=255&t>>8,a=255&t;for(tR=new n(256),tG=new n(256),tB=new n(256),e=0;256>e;)tR[e]=r(e&i),tG[e]=r(e&s),tB[e]=r(e&a),e++;return this.set(tR,tG,tB)},replace:function(t,e){if(t==e)return this;var i=255&t>>16,n=255&t>>8,r=255&t,s=255&e>>16,a=255&e>>8,o=255&e,u=h(c),l=h(c),f=h(c);return u[i]=s,l[n]=a,f[r]=o,this.set(u,l,f)},extract:function(t,i,n){if(!i||!i.length)return this;n=n||0;var s,h,o=255&n>>16,u=255&n>>8,l=255&n,c=a(o),f=a(u),d=a(l);switch(t){case e.CHANNEL.BLUE:for(s=i[0],h=i[1];h>=s;)d[s]=r(s),s++;break;case e.CHANNEL.GREEN:for(s=i[0],h=i[1];h>=s;)f[s]=r(s),s++;break;case e.CHANNEL.RED:default:for(s=i[0],h=i[1];h>=s;)c[s]=r(s),s++}return this.set(c,f,d)},gammaCorrection:function(t,e,i){t=t||1,e=e||t,i=i||e,t=1/t,e=1/e,i=1/i;for(var s=new n(256),a=new n(256),h=new n(256),u=0;256>u;)s[u]=r(~~(255*o(l*u,t))),a[u]=r(~~(255*o(l*u,e))),h[u]=r(~~(255*o(l*u,i))),u++;return this.set(s,a,h)},exposure:function(t){t===i&&(t=1);var e=0,s=new n(256);for(e=0;256>e;)s[e]=r(~~(255*(1-u(-t*e*l)))),e++;return this.set(s)},set:function(t,e,i){if(!t)return this;e=e||t,i=i||e;var n,a,o,u,l,c=this._tableR||s(),f=h(c);if(e&&i){for(n=this._tableG||h(c),a=this._tableB||h(n),o=h(n),u=h(a),l=0;256>l;)c[l]=r(t[r(f[l])]),n[l]=r(e[r(o[l])]),a[l]=r(i[r(u[l])]),l++;this._tableR=c,this._tableG=n,this._tableB=a}else{for(l=0;256>l;)c[l]=r(t[r(f[l])]),l++;this._tableR=c,this._tableG=this._tableR,this._tableB=this._tableR}return this},reset:function(){return this._tableR=this._tableG=this._tableB=this._tableA=null,this},combineWith:function(t){return this.set(t.getTable(0),t.getTable(1),t.getTable(2))},getTable:function(t){switch(t=t||e.CHANNEL.RED){case e.CHANNEL.ALPHA:return this._tableA;case e.CHANNEL.BLUE:return this._tableB;case e.CHANNEL.GREEN:return this._tableG;case e.CHANNEL.RED:default:return this._tableR}},setTable:function(t,i){switch(i=i||e.CHANNEL.RED){case e.CHANNEL.ALPHA:return this._tableA=t,this;case e.CHANNEL.BLUE:return this._tableB=t,this;case e.CHANNEL.GREEN:return this._tableG=t,this;case e.CHANNEL.RED:default:return this._tableR=t,this}},_apply:function(t){if(!this._isOn||!this._tableR)return t;var e,i,n,r,s,a=t.length,h=(a>>2)%4,o=this._tableR,u=this._tableG,l=this._tableB,c=this._tableA;if(c){for(e=0;a>e;e+=16)i=t[e],n=t[e+1],r=t[e+2],s=t[e+3],t[e]=o[i],t[e+1]=u[n],t[e+2]=l[r],t[e+3]=c[s],i=t[e+4],n=t[e+5],r=t[e+6],s=t[e+7],t[e+4]=o[i],t[e+5]=u[n],t[e+6]=l[r],t[e+7]=c[s],i=t[e+8],n=t[e+9],r=t[e+10],s=t[e+11],t[e+8]=o[i],t[e+9]=u[n],t[e+10]=l[r],t[e+11]=c[s],i=t[e+12],n=t[e+13],r=t[e+14],s=t[e+15],t[e+12]=o[i],t[e+13]=u[n],t[e+14]=l[r],t[e+15]=c[s];if(h)for(h<<=2,e=a-h;a>e;e+=4)i=t[e],n=t[e+1],r=t[e+2],s=t[e+3],t[e]=o[i],t[e+1]=u[n],t[e+2]=l[r],t[e+3]=c[s]}else{for(e=0;a>e;e+=16)i=t[e],n=t[e+1],r=t[e+2],t[e]=o[i],t[e+1]=u[n],t[e+2]=l[r],i=t[e+4],n=t[e+5],r=t[e+6],t[e+4]=o[i],t[e+5]=u[n],t[e+6]=l[r],i=t[e+8],n=t[e+9],r=t[e+10],t[e+8]=o[i],t[e+9]=u[n],t[e+10]=l[r],i=t[e+12],n=t[e+13],r=t[e+14],t[e+12]=o[i],t[e+13]=u[n],t[e+14]=l[r];if(h)for(h<<=2,e=a-h;a>e;e+=4)i=t[e],n=t[e+1],r=t[e+2],t[e]=o[i],t[e+1]=u[n],t[e+2]=l[r]}return t},apply:function(t){if(this._isOn&&this._tableR){var e=t.getSelectedData();return t.setSelectedData(this._apply(e[0],e[1],e[2],t))}return t}});d.prototype.posterize=d.prototype.levels=d.prototype.quantize}(e,n),function(t,e){var i=(e.ImArray,e.ImArrayCopy),n=e.Array16I,r=Math.min,s=(Math.max,Math.floor);e.DisplacementMapFilter=t(e.Filter,{name:"DisplacementMapFilter",constructor:function(t){t&&this.setMap(t)},map:null,scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,red:0,green:0,blue:0,alpha:0,mode:e.MODE.CLAMP,combineWith:function(){return this},reset:function(){return this.map=null,this},getMap:function(){return this.map},setMap:function(t){return this.map=t,this},setColor:function(t){return this.color=t,this.alpha=255&t>>24,this.red=255&t>>16,this.green=255&t>>8,this.blue=255&t,this},_apply:function(t,a,h){if(!this._isOn||!this.map)return t;var o,u,l,c,f,d,_,m,p,g,v,A,w,y,E,M,L,b,C,x,R,D,N,I,U,O,S,k,H=.00390625*this.scaleX,P=.00390625*this.scaleY,G=this.componentX,F=this.componentY,T=this.alpha,W=this.red,B=this.green,Y=this.blue,X=this.mode,z=e.MODE.IGNORE,V=(e.MODE.CLAMP,e.MODE.COLOR),q=e.MODE.WRAP;for(o=this.map.getData(),u=this.map.width,l=this.map.height,c=o.length>>2,d=r(u,a),_=r(l,h),S=t.length,U=d*_<<2,O=S>>2,p=s(this.startX*(a-1)),m=s(this.startY*(h-1)),g=m*a,v=-p,A=-m,w=a-p-1,y=h-m-1,f=new n(c<<1),k=new i(t),M=0,L=0,b=0,C=0,E=0;c>E;E++,M+=2,L++)L>=u&&(L=0,b++,C+=u),D=L+C<<2,f[M]=s((o[D+G]-128)*H),f[M+1]=s((o[D+F]-128)*P);for(L=0,b=0,C=0,ty2=0,E=0;U>E;E+=4,L++)if(L>=d&&(L=0,b++,C+=a,ty2+=u),!(A>b||b>y||v>L||L>w)){if(R=L+p,x=b+m,N=R+C+g<<2,M=L+ty2<<1,srcx=R+f[M],srcy=x+f[M+1],srcy>=h||0>srcy||srcx>=a||0>srcx){if(X==z)continue;if(X==V){t[N]=W,t[N+1]=B,t[N+2]=Y,t[N+3]=T;continue}X==q?(srcy>y?srcy-=h:0>srcy&&(srcy+=h),srcx>w?srcx-=a:0>srcx&&(srcx+=a)):(srcy>y?srcy=y:0>srcy&&(srcy=0),srcx>w?srcx=w:0>srcx&&(srcx=0))}I=srcx+srcy*a<<2,t[N]=k[I],t[N+1]=k[I+1],t[N+2]=k[I+2],t[N+3]=k[I+3]}return t},apply:function(t){if(this._isOn&&this.map){var e=t.getSelectedData();return t.setSelectedData(this._apply(e[0],e[1],e[2],t))}return t}})}(e,n),function(t,e,i){function n(t,i,n){var r,s,a,h,o,u,l,c=t.length,f=new m(c),d=this.inverseTransform,_=this.mode,p=e.MODE.CLAMP,g=e.MODE.WRAP;for(r=0,s=0,a=0;c>a;a+=4,r++){if(r>=i&&(r=0,s++),o=d([r,s],i,n),u=~~o[0],l=~~o[1],0>u||u>=i||0>l||l>=n)switch(_){case g:l>=n?l-=n:0>l&&(l+=n),u>=i?u-=i:0>u&&(u+=i);break;case p:default:l>=n?l=n-1:0>l&&(l=0),u>=i?u=i-1:0>u&&(u=0)}h=u+l*i<<2,f[a]=t[h],f[a+1]=t[h+1],f[a+2]=t[h+2],f[a+3]=t[h+3]}return f}function r(t,i){var n,r,s,a,h,o,u,l,c,f=t.length,d=f>>2,_=new m(f),p=this.matrix,g=p[0],v=p[1],A=p[3],w=p[4],y=p[2],E=p[5],M=this.mode,L=e.MODE.CLAMP,b=e.MODE.WRAP,C=i-1,x=d-i;for(n=0,r=0,h=E*i,o=A*i,u=w*i,s=0;f>s;s+=4,n++){if(n>=i&&(n=0,r++),l=~~(g*n+v*r+y),c=~~(o*n+u*r+h),0>l||l>C||0>c||c>x)switch(M){case b:c>x?c-=d:0>c&&(c+=d),l>=i?l-=i:0>l&&(l+=i);break;case L:default:c>x?c=x:0>c&&(c=0),l>C?l=C:0>l&&(l=0)}a=l+c<<2,_[s]=t[a],_[s+1]=t[a+1],_[s+2]=t[a+2],_[s+3]=t[a+3]}return _}function s(t,e){var i,n,r,s,a,h=t.length,o=new m(h);for(i=0,n=0,r=0,s=0;h>s;s+=4,i++)i>=e&&(i=0,n++,r+=e),a=e-1-i+r<<2,o[s]=t[a],o[s+1]=t[a+1],o[s+2]=t[a+2],o[s+3]=t[a+3];return o}function a(t,e,i){var n,r,s,a,h,o=t.length,u=new m(o);for(n=0,r=0,s=(i-1)*e,a=0;o>a;a+=4,n++)n>=e&&(n=0,r++,s-=e),h=n+s<<2,u[a]=t[h],u[a+1]=t[h+1],u[a+2]=t[h+2],u[a+3]=t[h+3];return u}function h(t,e,i){var n,r,s,a,h,o,u=t.length,l=new m(u);for(n=0,r=0,a=(i-1)*e,h=0;u>h;h+=4,n++)n>=e&&(n=0,r++,s+=e,a-=e),o=e-1-n+a<<2,l[h]=t[o],l[h+1]=t[o+1],l[h+2]=t[o+2],l[h+3]=t[o+3];return l}function o(t,e){var i,n,r,s,a,h=t.length,o=new m(h),u=h>>2;for(i=0,n=0,r=u-1,s=0;h>s;s+=4,i++,r-=e)i>=e&&(i=0,r=u-1,n++),a=n+r<<2,o[s]=t[a],o[s+1]=t[a+1],o[s+2]=t[a+2],o[s+3]=t[a+3];return o}function u(t,e){var i,n,r,s,a,h=t.length,o=new m(h);for(i=0,n=0,r=0,s=0;h>s;s+=4,i++,r+=e)i>=e&&(i=0,r=0,n++),a=e-1-n+r<<2,o[s]=t[a],o[s+1]=t[a+1],o[s+2]=t[a+2],o[s+3]=t[a+3];return o}function l(t,i,n){if(0>=this.radius)return t;var r,s,a,h,o,u,l,c,f=t.length,d=new p(t),_=this.centerX,m=this.centerY,E=this.angle,M=this.radius,L=this.mode,b=e.MODE.CLAMP,C=e.MODE.WRAP,x=E/M,R=i-1,D=n-1;for(_=y(_*(i-1)),m=y(m*(n-1)),r=0,s=0,a=0;f>a;a+=4,r++)if(r>=i&&(r=0,s++),u=r-_,l=s-m,o=g(u*u+l*l),M>o){if(c=v(l,u)+x*(M-o),u=~~(_+o*w(c)),l=~~(m+o*A(c)),0>u||u>R||0>l||l>D)switch(L){case C:l>D?l-=n:0>l&&(l+=n),u>R?u-=i:0>u&&(u+=i);break;case b:default:l>D?l=D:0>l&&(l=0),u>R?u=R:0>u&&(u=0)}h=u+l*i<<2,t[a]=d[h],t[a+1]=d[h+1],t[a+2]=d[h+2],t[a+3]=d[h+3]}return t}function c(t,i,n){if(0>=this.radius)return t;var r,s,a,h,o,u,l,c,f,d,_,m,v,A=t.length,w=new p(t),L=this.centerX,b=this.centerY,C=this.radius,x=this.mode,R=e.MODE.CLAMP,D=e.MODE.WRAP,N=C*C,I=.555556,U=1-I,O=i-1,S=n-1;for(L=y(L*(i-1)),b=y(b*(n-1)),r=0,s=0,a=0;A>a;a+=4,r++)if(r>=i&&(r=0,s++),o=r-L,u=s-b,m=o*o,v=u*u,l=m+v,N>l){if(d=N-l,_=g(d),c=E(o/g(m+d))*U,f=E(u/g(v+d))*U,o=~~(r-_*M(c)),u=~~(s-_*M(f)),0>o||o>O||0>u||u>S)switch(x){case D:u>S?u-=n:0>u&&(u+=n),o>O?o-=i:0>o&&(o+=i);break;case R:default:u>S?u=S:0>u&&(u=0),o>O?o=O:0>o&&(o=0)}h=o+u*i<<2,t[a]=w[h],t[a+1]=w[h+1],t[a+2]=w[h+2],t[a+3]=w[h+3]}return t}function f(t,i,n){if(0>=this.radius)return t;var r,s,a,h,o,u,l,c,f,d,_,m=t.length,v=new p(t),w=e.MODE.CLAMP,E=e.MODE.WRAP,M=i-1,L=n-1,b=this.centerX,C=this.centerY,x=this.radius,R=this.mode,D=x*x,N=this.wavelength,I=this.amplitude,U=this.phase;for(b=y(b*(i-1)),C=y(C*(n-1)),r=0,s=0,a=0;m>a;a+=4,r++)if(r>=i&&(r=0,s++),u=r-b,l=s-C,d=u*u,_=l*l,f=d+_,D>f){if(o=g(f),c=I*A(2*o/N*Math.PI-U),c*=(x-o)/x,o&&(c*=N/o),u=~~(r+u*c),l=~~(s+l*c),0>u||u>M||0>l||l>L)switch(R){case E:l>L?l-=n:0>l&&(l+=n),u>M?u-=i:0>u&&(u+=i);break;case w:default:l>L?l=L:0>l&&(l=0),u>M?u=M:0>u&&(u=0)}h=u+l*i<<2,t[a]=v[h],t[a+1]=v[h+1],t[a+2]=v[h+2],t[a+3]=v[h+3]}return t}function d(t){return t}function _(t){return t}var m=e.ImArray,p=e.ImArrayCopy,g=(e.CONSTANTS.PI,Math.sqrt),v=Math.atan2,A=Math.sin,w=Math.cos,y=Math.floor,E=Math.asin,M=Math.tan;Math.abs,e.CONSTANTS.toRad,e.GeometricMapFilter=t(e.Filter,{name:"GeometricMapFilter",constructor:function(t){this.generic(t)},_map:null,inverseTransform:null,matrix:null,centerX:0,centerY:0,angle:0,radius:0,wavelength:0,amplitude:0,phase:0,xAmplitude:0,yAmplitude:0,xWavelength:0,yWavelength:0,mode:e.MODE.CLAMP,generic:function(t){return t&&(this.inverseTransform=t,this._map=n),this},affine:function(t){return t&&(this.matrix=t,this._map=r),this},flipX:function(){return this._map=s,this},flipY:function(){return this._map=a,this},flipXY:function(){return this._map=h,this},rotateCW:function(){return this._map=o,this},rotateCCW:function(){return this._map=u,this},polar:function(t,e){return this.centerX=t||0,this.centerY=e||0,this._map=d,this},cartesian:function(t,e){return this.centerX=t||0,this.centerY=e||0,this._map=_,this},twirl:function(t,e,i,n){return this.angle=t||0,this.radius=e||0,this.centerX=i||0,this.centerY=n||0,this._map=l,this},sphere:function(t,e,i){return this.radius=t||0,this.centerX=e||0,this.centerY=i||0,this._map=c,this},ripple:function(t,e,n,r,s,a){return this.radius=t!==i?t:50,this.centerX=s||0,this.centerY=a||0,this.wavelength=e!==i?e:16,this.amplitude=n!==i?n:10,this.phase=r||0,this._map=f,this},combineWith:function(){return this},reset:function(){return this._map=null,this},getMap:function(){return this._map},setMap:function(t){return this._map=t,this},_apply:function(t,e,i,n){return this._isOn&&this._map?this._map.call(this,t,e,i,n):t},apply:function(t){if(this._isOn&&this._map){var e=t.getSelectedData();return t.setSelectedData(this._map.call(this,e[0],e[1],e[2],t))}return t}})}(e,n),function(t,e,i){function n(t,e,i,n){var r,s=t.length,a=new y(t.length);for(i=i||1,n=n||1,r=0;s>r;)a[r]=i*t[r]+n*e[r],r++;return a}function r(t,e){var i,n,r,s=t.length,a=[],h=0;for(i=0;s>i;i++)for(n=0;s>n;n++)r=t[i]*e[n],h+=r,a.push(r);return{kernel:a,sum:h}}function s(t){var e,i=new Array(t);for(e=0;t>e;)i[e]=1,e++;return i}function a(t){var e,i,n,r,s=C.length;if(t--,s>t)e=new y(C[t]);else for(e=new y(C[s-1]);t>=s;){for(i=e,e=new y(i.length+1),e[0]=1,n=0,r=i.length-1;r>n;n++)e[n+1]=i[n]+i[n+1];e[i.length]=1,40>s&&C.push(new Array(e)),s++}return e}function h(t){var e,i=t>>1,n=-i,r=new Array(t);for(e=0;t>e;)r[e]=n,n++,e++;return r}function o(t){var e=a(t);return r(e,e)}function u(t,e){var i=a(t),n=h(t);return 1==e?r(n.reverse(),i):r(i,n)}function l(t,e){var i=s(t),n=h(t);return 1==e?r(n.reverse(),i):r(i,n)}function c(t,e,i){e=e||1,i=i||e;var n,r=t*t,s=r>>1,a=new y(r);for(n=0;r>n;)a[n]=e,n++;return a[s]=i,a}function f(t,e,i,n){var r,s,a,h,o,u=t*t,l=t>>1,c=u>>1,f=new y(u);for(h=0,r=0;l>=r;r++){for(s=0,o=0,a=0;l>=a;a++)f[c+r+s]=h+o,f[c-r-s]=-h-o,f[c-r+s]=-h+o,f[c+r-s]=h-o,s+=t,o+=i;h+=e}return f[c]=n||1,f}function d(t,e,i,n){var r,s,a,h,o,u,l=t*t,c=t>>1,f=l>>1,d=new y(l),_=new y(l),m=1/t,p=1e-8;for(g(e)>p?(o=1,u=i/e):(o=e/i,u=1),r=0,a=0,h=0,s=u*t;c>=r;)_[f+r]=~~(f+a+h+.5),_[f-r]=~~(f-a-h+.5),r++,a+=o,h+=s;for(r=0;c>=r;)d[_[f+r]]=d[_[f-r]]=m,r++;return d[f]=n||1,d}function _(t,e,i,n,r,s,a,h,o,u){var l,c,f,d,_,m,p,g,v,A,w,y,L,C,x,R,D,N,I,U,O,S,k,H,P,G,F,T,W,B,Y,X,z,V,q,j,Q,K,J,$,Z,te,ee,ie,ne,re,se,ae=t.length,he=ae>>2,oe=s,ue=a;if(g=oe*ue,m=oe>>1,p=e*(ue>>1),w=-m-1,L=-p-e,y=m,C=p,B=0,X=e-1,Y=0,z=he-e,c=(he<<1)+he,A=(e<<1)+e,u=u||1,se=0,r)for(U=n[0],O=n[g>>1],S=O-U,k=r[0],H=r[g>>1],P=H-k;u>se;){for(v=new E(ae),l=new M(c),x=0,R=0,f=d=_=0,D=0;e>D;D++,x+=4,R+=3)f+=t[x],d+=t[x+1],_+=t[x+2],l[R]=f,l[R+1]=d,l[R+2]=_;for(R=0,D=0,f=d=_=0,x=A+e;ae>x;x+=4,R+=3,D++)D>=e&&(D=0,f=d=_=0),f+=t[x],d+=t[x+1],_+=t[x+2],l[R+A]=l[R]+f,l[R+A+1]=l[R+1]+d,l[R+A+2]=l[R+2]+_;for(D=0,N=0,I=0,x=0;ae>x;x+=4,D++)D>=e&&(D=0,N++,I+=e),G=D+w,F=I+L,T=D+y,W=I+C,G=B>G?B:G,T=T>X?X:T,F=Y>F?Y:F,W=W>z?z:W,V=G+F,Q=T+W,q=T+F,j=G+W,V=(V<<1)+V,q=(q<<1)+q,j=(j<<1)+j,Q=(Q<<1)+Q,Z=U*(l[Q]-l[q]-l[j]+l[V])+S*t[x],te=U*(l[Q+1]-l[q+1]-l[j+1]+l[V+1])+S*t[x+1],ee=U*(l[Q+2]-l[q+2]-l[j+2]+l[V+2])+S*t[x+2],ie=k*(l[Q]-l[q]-l[j]+l[V])+P*t[x],ne=k*(l[Q+1]-l[q+1]-l[j+1]+l[V+1])+P*t[x+1],re=k*(l[Q+2]-l[q+2]-l[j+2]+l[V+2])+P*t[x+2],K=h*Z+o*ie,J=h*te+o*ne,$=h*ee+o*re,b&&(K=0>K?0:K>255?255:K,J=0>J?0:J>255?255:J,$=0>$?0:$>255?255:$),v[x]=~~K,v[x+1]=~~J,v[x+2]=~~$,v[x+3]=t[x+3];t=v,se++}else for(U=n[0],O=n[g>>1],S=O-U;u>se;){for(v=new E(ae),l=new M(c),x=0,R=0,f=d=_=0,D=0;e>D;D++,x+=4,R+=3)f+=t[x],d+=t[x+1],_+=t[x+2],l[R]=f,l[R+1]=d,l[R+2]=_;for(R=0,D=0,f=d=_=0,x=A+e;ae>x;x+=4,R+=3,D++)D>=e&&(D=0,f=d=_=0),f+=t[x],d+=t[x+1],_+=t[x+2],l[R+A]=l[R]+f,l[R+A+1]=l[R+1]+d,l[R+A+2]=l[R+2]+_;for(D=0,N=0,I=0,x=0;ae>x;x+=4,D++)D>=e&&(D=0,N++,I+=e),G=D+w,F=I+L,T=D+y,W=I+C,G=B>G?B:G,T=T>X?X:T,F=Y>F?Y:F,W=W>z?z:W,V=G+F,Q=T+W,q=T+F,j=G+W,V=(V<<1)+V,q=(q<<1)+q,j=(j<<1)+j,Q=(Q<<1)+Q,Z=U*(l[Q]-l[q]-l[j]+l[V])+S*t[x],te=U*(l[Q+1]-l[q+1]-l[j+1]+l[V+1])+S*t[x+1],ee=U*(l[Q+2]-l[q+2]-l[j+2]+l[V+2])+S*t[x+2],K=h*Z+o,J=h*te+o,$=h*ee+o,b&&(K=0>K?0:K>255?255:K,J=0>J?0:J>255?255:J,$=0>$?0:$>255?255:$),v[x]=~~K,v[x+1]=~~J,v[x+2]=~~$,v[x+3]=t[x+3];t=v,se++}return v}function m(t,e,i,n,r,s,a,h,o){var u,l,c,f,d,_,m,p,g,v,A,w,y,M,C,x,R,D,N,I,U,O,S,k,H,P,G,F=t.length,T=F>>2;for(u=[r,n],l=[a,s],H=[o,h],x=e-1,R=T-e,G=2;G--;){for(m=new E(F),f=u[G],d=l[G],c=f.length,_=d.length,P=H[G],p=new L(d),A=0;_>A;A+=2)p[A+1]*=e;if(b)for(w=0,y=0,g=0;F>g;g+=4,w++){for(w>=e&&(w=0,y+=e),O=0,S=0,k=0,A=0,v=0;c>A;A++,v+=2)M=w+p[v],C=y+p[v+1],M>=0&&x>=M&&C>=0&&R>=C&&(srcOff=M+C<<2,U=f[A],O+=t[srcOff]*U,S+=t[srcOff+1]*U,k+=t[srcOff+2]*U);D=P*O,N=P*S,I=P*k,D=0>D?0:D>255?255:D,N=0>N?0:N>255?255:N,I=0>I?0:I>255?255:I,m[g]=~~D,m[g+1]=~~N,m[g+2]=~~I,m[g+3]=t[g+3]}else for(w=0,y=0,g=0;F>g;g+=4,w++){for(w>=e&&(w=0,y+=e),O=0,S=0,k=0,A=0,v=0;c>A;A++,v+=2)M=w+p[v],C=y+p[v+1],M>=0&&x>=M&&C>=0&&R>=C&&(srcOff=M+C<<2,U=f[A],O+=t[srcOff]*U,S+=t[srcOff+1]*U,k+=t[srcOff+2]*U);D=P*O,N=P*S,I=P*k,m[g]=~~D,m[g+1]=~~N,m[g+2]=~~I,m[g+3]=t[g+3]}t=m}return m}var p=(e.CONSTANTS.SQRT2,e.CONSTANTS.toRad),g=(e.CONSTANTS.toDeg,Math.abs),v=Math.sqrt,A=Math.sin,w=Math.cos,y=e.Array32F,E=e.ImArray,M=e.Array32F,L=e.Array16I,b=(e.Array8U,e._notSupportClamp),C=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],x=e.ConvolutionMatrixFilter=t(e.Filter,{name:"ConvolutionMatrixFilter",constructor:function(t,i,n){this._coeff=new y([1,0]),t&&t.length?this.set(t,~~(v(t.length)+.5),i||1,n||0):(this._matrix=null,this._dim=0),this._matrix2=null,this._dim2=0,this._isGrad=!1,this._doIntegral=0,this._doSeparable=!1,e.useWebGL&&(this._webglInstance=e.WebGLConvolutionMatrixFilterInstance)},_dim:0,_dim2:0,_matrix:null,_matrix2:null,_mat:null,_mat2:null,_coeff:null,_isGrad:!1,_doIntegral:0,_doSeparable:!1,_indices:null,_indices2:null,_indicesf:null,_indicesf2:null,_webglInstance:null,lowPass:function(t){return t=t===i?3:t%2?t:t+1,this.set(c(t),t,1/(t*t),0),this._doIntegral=1,this},highPass:function(t,e){t=t===i?3:t%2?t:t+1,e=e===i?1:e;var n=t*t,r=-e/n,s=c(t,r,1+r);return this.set(s,t,1,0),this._doIntegral=1,this},glow:function(t,e){return t=t===i?.5:t,this.highPass(e,-t)},sharpen:function(t,e){return t=t===i?.5:t,this.highPass(e,t)},verticalBlur:function(t){return t=t===i?3:t%2?t:t+1,this.set(s(t),1,1/t,0),this._dim2=t,this._doIntegral=1,this},horizontalBlur:function(t){return t=t===i?3:t%2?t:t+1,this.set(s(t),t,1/t,0),this._dim2=1,this._doIntegral=1,this},directionalBlur:function(t,e){e=e===i?3:e%2?e:e+1,t*=p;var n=w(t),r=-A(t),s=d(e,n,r,1/e);return this.set(s,e,1,0)},fastGauss:function(t,e){return e=e===i?3:e%2?e:e+1,t=~~(t||1),1>t?t=1:t>3&&(t=3),this.set(c(e),e,1/(e*e),0),this._doIntegral=t,this},binomialLowPass:function(t){t=t===i?3:t%2?t:t+1;var e=a(t),n=1<<t-1,r=1/n;this.set(e,t,r,r),this._matrix2=new y(e);var s=this._computeIndices(this._matrix2,this._dim2);return this._indices2=s[0],this._indicesf2=s[1],this._mat2=s[2],this._doSeparable=!0,this},binomialHighPass:function(t){t=t===i?3:t%2?t:t+1;var e=o(t);return this.set(n(c(t),new y(e.kernel),1,-1/e.sum),t,1,0)},prewittX:function(t){t=t===i?3:t%2?t:t+1;var e=l(t,0);return this.set(e.kernel,t,1,0)},prewittY:function(t){t=t===i?3:t%2?t:t+1;var e=l(t,1);return this.set(e.kernel,t,1,0)},prewittDirectional:function(t,e){e=e===i?3:e%2?e:e+1,t*=p;var r=w(t),s=A(t),a=l(e,0),h=l(e,1);return this.set(n(new y(a.kernel),new y(h.kernel),r,s),e,1,0)},prewitt:function(t){t=t===i?3:t%2?t:t+1;var e=l(t,0),n=l(t,1);this.set(e.kernel,t,1,0),this._isGrad=!0,this._matrix2=new y(n.kernel);var r=this._computeIndices(this._matrix2,this._dim2);return this._indices2=r[0],this._indicesf2=r[1],this._mat2=r[2],this},sobelX:function(t){t=t===i?3:t%2?t:t+1;var e=u(t,0);return this.set(e.kernel,t,1,0)},sobelY:function(t){t=t===i?3:t%2?t:t+1;var e=u(t,1);return this.set(e.kernel,t,1,0)},sobelDirectional:function(t,e){e=e===i?3:e%2?e:e+1,t*=p;var r=w(t),s=A(t),a=u(e,0),h=u(e,1);return this.set(n(new y(a.kernel),new y(h.kernel),r,s),e,1,0)},sobel:function(t){t=t===i?3:t%2?t:t+1;var e=u(t,0),n=u(t,1);this.set(e.kernel,t,1,0),this._matrix2=new y(n.kernel);var r=this._computeIndices(this._matrix2,this._dim2);return this._indices2=r[0],this._indicesf2=r[1],this._mat2=r[2],this._isGrad=!0,this},laplace:function(t){t=t===i?3:t%2?t:t+1;var e=t*t,n=c(t,-1,e-1);return this.set(n,t,1,0),this._doIntegral=1,this},emboss:function(t,e,n){n=n===i?3:n%2?n:n+1,t=t===i?-.25*Math.PI:t*p,e=e||1;var r=e*w(t),s=-e*A(t),a=f(n,r,s,1);return this.set(a,n,1,0)},edges:function(t){return t=t||1,this.set([0,t,0,t,-4*t,t,0,t,0],3,1,0)},set:function(t,e,i,n){this._matrix2=null,this._dim2=0,this._indices2=this._indicesf2=null,this._mat2=null,this._isGrad=!1,this._doIntegral=0,this._doSeparable=!1,this._matrix=new y(t),this._dim=e,this._coeff[0]=i||1,this._coeff[1]=n||0;var r=this._computeIndices(this._matrix,this._dim);return this._indices=r[0],this._indicesf=r[1],this._mat=r[2],this},_computeIndices:function(t,e){var i,n,r,s=[],a=[],h=[],o=t.length,u=e,l=u>>1;for(n=0,r=0,i=0;o>i;)a.push(n-l),a.push(r-l),t[i]&&(s.push(n-l),s.push(r-l),h.push(t[i])),i++,n++,n>=u&&(n=0,r++);return[new L(s),new L(a),new y(h)]},reset:function(){return this._matrix=this._matrix2=null,this._mat=this._mat2=null,this._dim=this._dim2=0,this._indices=this._indices2=this._indicesf=this._indicesf2=null,this._isGrad=!1,this._doIntegral=0,this._doSeparable=!1,this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(t,e){return this.set(t,e)},_apply:function(t,e,i){if(!this._isOn||!this._matrix)return t;if(this._doIntegral)return this._matrix2?_(t,e,i,this._matrix,this._matrix2,this._dim,this._dim2,this._coeff[0],this._coeff[1],this._doIntegral):_(t,e,i,this._matrix,null,this._dim,this._dim,this._coeff[0],this._coeff[1],this._doIntegral);if(this._doSeparable)return m(t,e,i,this._mat,this._mat2,this._indices,this._indices2,this._coeff[0],this._coeff[1]);var n,r,s,a,h,o,u,l,c,f,d,p,v,A,w,y,M,C,x,R,D,N,I=t.length,U=I>>2,O=new E(I),S=e-1,k=U-e,H=this._coeff[0],P=this._coeff[1],G=this._matrix,F=this._matrix2,T=this._isGrad;if(F){for(R=this._indicesf.length,N=new L(this._indicesf),o=0;R>o;o+=2)N[o+1]*=e;for(D=G.length,u=0,l=0,a=0;I>a;a+=4,u++){for(u>=e&&(u=0,l+=e),p=0,v=0,A=0,w=0,y=0,M=0,o=0,h=0;D>o;o++,h+=2)c=u+N[h],f=l+N[h+1],c>=0&&S>=c&&f>=0&&k>=f&&(d=c+f<<2,C=G[o],p+=t[d]*C,v+=t[d+1]*C,A+=t[d+2]*C,x=F[o],w+=t[d]*x,y+=t[d+1]*x,M+=t[d+2]*x);T?(n=g(p)+g(w),r=g(v)+g(y),s=g(A)+g(M)):(n=H*p+P*w,r=H*v+P*y,s=H*A+P*M),b&&(n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s),O[a]=~~n,O[a+1]=~~r,O[a+2]=~~s,O[a+3]=t[a+3]}}else{for(R=this._indices.length,N=new L(this._indices),o=0;R>o;o+=2)N[o+1]*=e;for(G=this._mat,D=G.length,u=0,l=0,a=0;I>a;a+=4,u++){for(u>=e&&(u=0,l+=e),p=0,v=0,A=0,o=0,h=0;D>o;o++,h+=2)c=u+N[h],f=l+N[h+1],c>=0&&S>=c&&f>=0&&k>=f&&(d=c+f<<2,C=G[o],p+=t[d]*C,v+=t[d+1]*C,A+=t[d+2]*C);n=H*p+P,r=H*v+P,s=H*A+P,b&&(n=0>n?0:n>255?255:n,r=0>r?0:r>255?255:r,s=0>s?0:s>255?255:s),O[a]=~~n,O[a+1]=~~r,O[a+2]=~~s,O[a+3]=t[a+3]}}return O},apply:function(t){if(this._isOn&&this._matrix){var e=t.getSelectedData();return t.setSelectedData(this._apply(e[0],e[1],e[2],t))}return t}});x.prototype.bump=x.prototype.emboss,x.prototype.boxBlur=x.prototype.lowPass,x.prototype.gaussBlur=x.prototype.binomialLowPass,x.prototype.gradX=x.prototype.prewittX,x.prototype.gradY=x.prototype.prewittY,x.prototype.gradDirectional=x.prototype.prewittDirectional,x.prototype.grad=x.prototype.prewitt}(e,n),function(t,e){function i(t,e){var i,n,r,s,h,u,l,c,f,d,_,m,p,g=this._structureElement,v=(g.length,this._dim,new o(this._indices)),A=t.length,w=A>>2,y=new a(A),E=v.length,M=E>>1,L=e-1,b=w-e;for(k=0;E>k;k+=2)v[k+1]*=e;for(r=0,s=0,i=0;A>i;i+=4,r++){for(r>=e&&(r=0,s+=e),_=0,m=0,p=0,n=0;M>n;n+=2)h=r+v[n],u=s+v[n+1],h>=0&&L>=h&&u>=0&&b>=u&&(l=h+u<<2,c=t[l],f=t[l+1],d=t[l+2],c>_&&(_=c),f>m&&(m=f),d>p&&(p=d));y[i]=_,y[i+1]=m,y[i+2]=p,y[i+3]=t[i+3]}return y}function n(t,e){var i,n,r,s,h,u,l,c,f,d,_,m,p,g=this._structureElement,v=(g.length,this._dim,new o(this._indices)),A=t.length,w=A>>2,y=new a(A),E=v.length,M=E>>1,L=e-1,b=w-e;for(k=0;E>k;k+=2)v[k+1]*=e;for(r=0,s=0,i=0;A>i;i+=4,r++){for(r>=e&&(r=0,s+=e),_=255,m=255,p=255,n=0;M>n;n+=2)h=r+v[n],u=s+v[n+1],h>=0&&L>=h&&u>=0&&b>=u&&(l=h+u<<2,c=t[l],f=t[l+1],d=t[l+2],_>c&&(_=c),m>f&&(m=f),p>d&&(p=d));y[i]=_,y[i+1]=m,y[i+2]=p,y[i+3]=t[i+3]}return y}function r(t,e){var i,n,r,s,h,u,l,c,f,d,_,m,p,g=this._structureElement,v=(g.length,this._dim,new o(this._indices)),A=t.length,w=A>>2,y=new a(A),E=v.length,M=E>>1,L=e-1,b=w-e;for(k=0;E>k;k+=2)v[k+1]*=e;for(r=0,s=0,i=0;A>i;i+=4,r++){for(r>=e&&(r=0,s+=e),_=255,m=255,p=255,n=0;M>n;n+=2)h=r+v[n],u=s+v[n+1],h>=0&&L>=h&&u>=0&&b>=u&&(l=h+u<<2,c=t[l],f=t[l+1],d=t[l+2],_>c&&(_=c),m>f&&(m=f),p>d&&(p=d));y[i]=_,y[i+1]=m,y[i+2]=p,y[i+3]=t[i+3]}for(t=y,y=new a(A),r=0,s=0,i=0;A>i;i+=4,r++){for(r>=e&&(r=0,s+=e),_=255,m=255,p=255,n=0;M>n;n+=2)h=r+v[n],u=s+v[n+1],h>=0&&L>=h&&u>=0&&b>=u&&(l=h+u<<2,c=t[l],f=t[l+1],d=t[l+2],_>c&&(_=c),m>f&&(m=f),p>d&&(p=d));y[i]=_,y[i+1]=m,y[i+2]=p,y[i+3]=t[i+3]}return y}function s(t,e){var i,n,r,s,h,u,l,c,f,d,_,m,p,g=this._structureElement,v=(g.length,this._dim,new o(this._indices)),A=t.length,w=A>>2,y=new a(A),E=v.length,M=E>>1,L=e-1,b=w-e;for(k=0;E>k;k+=2)v[k+1]*=e;for(r=0,s=0,i=0;A>i;i+=4,r++){for(r>=e&&(r=0,s+=e),_=255,m=255,p=255,n=0;M>n;n+=2)h=r+v[n],u=s+v[n+1],h>=0&&L>=h&&u>=0&&b>=u&&(l=h+u<<2,c=t[l],f=t[l+1],d=t[l+2],_>c&&(_=c),m>f&&(m=f),p>d&&(p=d));y[i]=_,y[i+1]=m,y[i+2]=p,y[i+3]=t[i+3]}for(t=y,y=new a(A),r=0,s=0,i=0;A>i;i+=4,r++){for(r>=e&&(r=0,s+=e),_=255,m=255,p=255,n=0;M>n;n+=2)h=r+v[n],u=s+v[n+1],h>=0&&L>=h&&u>=0&&b>=u&&(l=h+u<<2,c=t[l],f=t[l+1],d=t[l+2],_>c&&(_=c),m>f&&(m=f),p>d&&(p=d));y[i]=_,y[i+1]=m,y[i+2]=p,y[i+3]=t[i+3]}return y}var a=e.ImArray,h=e.Array8U,o=e.Array32I,u=Math.sqrt,l=function(t){var e,i=t*t,n=new h(i);for(e=0;i>e;e++)n[e]=1;return n},c=l(3);e.MorphologicalFilter=t(e.Filter,{name:"MorphologicalFilter",constructor:function(){this._filter=null,this._dim=0,this._structureElement=null,this._indices=null},_filter:null,_dim:0,_structureElement:null,_indices:null,erode:function(t){return this.set(t,n)},dilate:function(t){return this.set(t,i)},opening:function(t){return this.set(t,r)},closing:function(t){return this.set(t,s)},set:function(t,e){this._filter=e,t&&t.length?(this._structureElement=new h(t),this._dim=~~(u(this._structureElement.length)+.5)):t&&t===t-0?(this._structureElement=l(t),this._dim=t):(this._structureElement=c,this._dim=3);var i,n,r,s=[],t=this._structureElement,a=t.length,f=this._dim,d=f>>1;for(n=0,r=0,i=0;a>i;)t[i]&&(s.push(n-d),s.push(r-d)),i++,n++,n>=f&&(n=0,r++);return this._indices=new o(s),this},reset:function(){return this._filter=null,this._dim=0,this._structureElement=null,this._indices=null,this},_apply:function(t,e,i){return this._isOn&&this._dim&&this._filter?this._filter.call(this,t,e,i):t},apply:function(t){if(this._isOn&&this._dim&&this._filter){var e=t.getSelectedData();return t.setSelectedData(this._filter.call(this,e[0],e[1],e[2],t))}return t}})}(e,n),function(t,e,i){function n(t,e){var i,n,r,s,o,u,l,c,f,d,_,m,p,g,v,A,w,y,E=this._dim,M=E*E,L=new h(this._indices),b=t.length,C=b>>2,x=new a(b),R=M<<1,D=e-1,N=C-e;for(c=[],f=[],d=[],n=0;R>n;n+=2)L[n+1]*=e;for(i=0,r=0,s=0;b>i;){for(c.length=0,f.length=0,d.length=0,n=0;R>n;)o=r+L[n],u=s+L[n+1],o>=0&&D>=o&&u>=0&&N>=u&&(l=o+u<<2,_=t[l],m=t[l+1],p=t[l+2],c.push(_),f.push(m),d.push(p)),n+=2;c.sort(),f.sort(),d.sort(),w=c.length,y=w>>1,g=w%2?c[y+1]:~~(.5*(c[y]+c[y+1])),w=f.length,y=w>>1,v=w%2?f[y+1]:~~(.5*(f[y]+f[y+1])),w=d.length,y=w>>1,A=w%2?d[y+1]:~~(.5*(d[y]+d[y+1])),x[i]=g,x[i+1]=v,x[i+2]=A,x[i+3]=t[i+3],i+=4,r++,r>=e&&(r=0,s+=e)}return x}function r(t,e){var i,n,r,s,o,u,l,c,f,d,_,m,p,g=this._dim,v=g*g,A=new h(this._indices),w=t.length,y=w>>2,E=new a(w),M=v<<1,L=e-1,b=y-e;for(n=0;M>n;n+=2)A[n+1]*=e;for(i=0,r=0,s=0;w>i;){for(_=0,m=0,p=0,n=0;M>n;)o=r+A[n],u=s+A[n+1],o>=0&&L>=o&&u>=0&&b>=u&&(l=o+u<<2,c=t[l],f=t[l+1],d=t[l+2],c>_&&(_=c),f>m&&(m=f),d>p&&(p=d)),n+=2;E[i]=_,E[i+1]=m,E[i+2]=p,E[i+3]=t[i+3],i+=4,r++,r>=e&&(r=0,s+=e)}return E}function s(t,e){var i,n,r,s,o,u,l,c,f,d,_,m,p,g=this._dim,v=g*g,A=new h(this._indices),w=t.length,y=w>>2,E=new a(w),M=v<<1,L=e-1,b=y-e;for(n=0;M>n;n+=2)A[n+1]*=e;for(i=0,r=0,s=0;w>i;){for(_=255,m=255,p=255,n=0;M>n;)o=r+A[n],u=s+A[n+1],o>=0&&L>=o&&u>=0&&b>=u&&(l=o+u<<2,c=t[l],f=t[l+1],d=t[l+2],_>c&&(_=c),m>f&&(m=f),p>d&&(p=d)),n+=2;E[i]=_,E[i+1]=m,E[i+2]=p,E[i+3]=t[i+3],i+=4,r++,r>=e&&(r=0,s+=e)}return E}var a=e.ImArray,h=e.Array32I;Math.min,Math.max;var o=e.StatisticalFilter=t(e.Filter,{name:"StatisticalFilter",constructor:function(){this._dim=0,this._indices=null,this._filter=null},_dim:0,_indices:null,_filter:null,median:function(t){return t=t===i?3:t%2?t:t+1,this.set(t,n)},minimum:function(t){return t=t===i?3:t%2?t:t+1,this.set(t,s)},maximum:function(t){return t=t===i?3:t%2?t:t+1,this.set(t,r)},set:function(t,e){this._filter=e,this._dim=t;var i,n,r,s=[],a=t*t,o=t,u=o>>1;for(n=0,r=0,i=0;a>i;)s.push(n-u),s.push(r-u),i++,n++,n>=o&&(n=0,r++);return this._indices=new h(s),this},reset:function(){return this._filter=null,this._dim=0,this._indices=null,this},_apply:function(t,e,i){return this._isOn&&this._dim?this._filter.call(this,t,e,i):t},apply:function(t){if(this._isOn&&this._dim){var e=t.getSelectedData();return t.setSelectedData(this._filter.call(this,e[0],e[1],e[2],t))}return t}});o.prototype.erode=o.prototype.minimum,o.prototype.dilate=o.prototype.maximum}(e,n),n});
/**
*
*   FILTER_PLUGINS
*   @version: 0.6.8
*
*   JavaScript Image Processing Library (Plugins)
*   https://github.com/foo123/FILTER.js
*
**/!function(r,t,n,e){n=n?[].concat(n):[];var a,i=n.length,o=new Array(i),l=new Array(i),u=new Array(i);for(a=0;i>a;a++)o[a]=n[a][0],l[a]=n[a][1];if("object"==typeof module&&module.exports){if("undefined"==typeof module.exports[t]){for(a=0;i>a;a++)u[a]=module.exports[o[a]]||require(l[a])[o[a]];module.exports[t]=e.apply(r,u)}}else if("function"==typeof define&&define.amd)define(["exports"].concat(l),function(n){if("undefined"==typeof n[t]){for(var a=Array.prototype.slice.call(arguments,1),i=0,l=a.length;l>i;i++)u[i]=n[o[i]];n[t]=e.apply(r,u)}});else if("undefined"==typeof r[t]){for(a=0;i>a;a++)u[a]=r[o[a]];r[t]=e.apply(r,u)}}(this,"FILTER_PLUGINS",[["FILTER","./filter"]],function(r){var t=r;return function(r){var t=r._notSupportClamp,n=Math.random;r.NoiseFilter=r.Create({min:-127,max:127,name:"NoiseFilter",init:function(r,t){this.min=r||-127,this.max=t||127},apply:function(r){var e,a,i,o,l,u,s,h,f=this.max-this.min,c=this.min,p=r.length;if(t)for(e=0;p>e;e+=4)i=r[e],o=r[e+1],l=r[e+2],a=f*n()+c,u=i+a,s=o+a,h=l+a,0>u?u=0:u>255&&(u=255),0>s?s=0:s>255&&(s=255),0>h?h=0:h>255&&(h=255),r[e]=~~u,r[e+1]=~~s,r[e+2]=~~h;else for(e=0;p>e;e+=4)i=r[e],o=r[e+1],l=r[e+2],a=f*n()+c,u=i+a,s=o+a,h=l+a,r[e]=~~u,r[e+1]=~~s,r[e+2]=~~h;return r}})}(r),function(r){var t=r._notSupportClamp,n=r.Array32F,e=r.Color.RGB2YCbCr,a=r.Color.YCbCr2RGB;r.HistogramEqualizeFilter=r.Create({name:"HistogramEqualizeFilter",apply:function(r){var i,o,l,u,s,h,f,c,p,g,m,d=0,v=255,C=0,y=r.length,b=y>>2,F=1/b;for(s=new n(256),p=0;256>p;p+=4)s[p]=0,s[p+1]=0,s[p+2]=0,s[p+3]=0;for(p=0;y>p;p+=4)i=r[p],o=r[p+1],l=r[p+2],g=e({r:i,g:o,b:l}),i=r[p]=~~g.cr,o=r[p+1]=~~g.y,l=r[p+2]=~~g.cb,s[o]+=F,o>d?d=o:v>o&&(v=o);for(C=0,p=0;256>p;p+=4)C+=s[p],s[p]=C,C+=s[p+1],s[p+1]=C,C+=s[p+2],s[p+2]=C,C+=s[p+3],s[p+3]=C;if(u=d-v,t)for(p=0;y>p;p+=4)g={cr:r[p],y:r[p+1],cb:r[p+2]},g.y=s[g.y]*u+v,m=a(g),h=m.r,f=m.g,c=m.b,h=0>h?0:h>255?255:h,f=0>f?0:f>255?255:f,c=0>c?0:c>255?255:c,r[p]=~~h,r[p+1]=~~f,r[p+2]=~~c;else for(p=0;y>p;p+=4)g={cr:r[p],y:r[p+1],cb:r[p+2]},g.y=s[g.y]*u+v,m=a(g),r[p]=~~m.r,r[p+1]=~~m.g,r[p+2]=~~m.b;return r}})}(r),function(r){var t=r._notSupportClamp,n=r.Array32F;r.GrayscaleHistogramEqualizeFilter=r.Create({name:"GrayscaleHistogramEqualizeFilter",apply:function(r){var e,a,i,o,l,u,s,h,f=0,c=255,p=0,g=r.length,m=g>>2,d=1/m;for(o=new n(256),h=0;256>h;h+=4)o[h]=0,o[h+1]=0,o[h+2]=0,o[h+3]=0;for(h=0;g>h;h+=4)e=r[h],o[e]+=d,e>f?f=e:c>e&&(c=e);for(p=0,h=0;256>h;h+=4)p+=o[h],o[h]=p,p+=o[h+1],o[h+1]=p,p+=o[h+2],o[h+2]=p,p+=o[h+3],o[h+3]=p;if(i=f-c,t)for(h=0;g>h;h+=4)e=r[h],a=o[e]*i+c,l=~~a,u=~~a,s=~~a,l=0>l?0:l>255?255:l,u=0>u?0:u>255?255:u,s=0>s?0:s>255?255:s,r[h]=~~l,r[h+1]=~~u,r[h+2]=~~s;else for(h=0;g>h;h+=4)e=r[h],a=o[e]*i+c,l=~~a,u=~~a,s=~~a,r[h]=~~l,r[h+1]=~~u,r[h+2]=~~s;return r}})}(r),function(r){var t=r._notSupportClamp,n=r.Array32F;r.RGBHistogramEqualizeFilter=r.Create({name:"RGBHistogramEqualizeFilter",apply:function(r){var e,a,i,o,l,u,s,h,f,c,p,g,m,d,v,C,y=0,b=0,F=0,M=255,A=255,x=255,S=r.length,_=S>>2,E=1/_;for(s=new n(256),h=new n(256),f=new n(256),C=0;256>C;C+=4)s[C]=0,h[C]=0,f[C]=0,s[C+1]=0,h[C+1]=0,f[C+1]=0,s[C+2]=0,h[C+2]=0,f[C+2]=0,s[C+3]=0,h[C+3]=0,f[C+3]=0;for(C=0;S>C;C+=4)e=r[C],a=r[C+1],i=r[C+2],s[e]+=E,h[a]+=E,f[i]+=E,e>y?y=e:M>e&&(M=e),a>b?b=a:A>a&&(A=a),i>F?F=i:x>i&&(x=i);for(c=p=g=0,C=0;256>C;C+=4)c+=s[C],s[C]=c,p+=h[C],h[C]=p,g+=f[C],f[C]=g,c+=s[C+1],s[C+1]=c,p+=h[C+1],h[C+1]=p,g+=f[C+1],f[C+1]=g,c+=s[C+2],s[C+2]=c,p+=h[C+2],h[C+2]=p,g+=f[C+2],f[C+2]=g,c+=s[C+3],s[C+3]=c,p+=h[C+3],h[C+3]=p,g+=f[C+3],f[C+3]=g;if(o=y-M,l=b-A,u=F-x,t)for(C=0;S>C;C+=4)e=r[C],a=r[C+1],i=r[C+2],m=s[e]*o+M,d=h[a]*l+A,v=f[i]*u+x,m=0>m?0:m>255?255:m,d=0>d?0:d>255?255:d,v=0>v?0:v>255?255:v,r[C]=~~m,r[C+1]=~~d,r[C+2]=~~v;else for(C=0;S>C;C+=4)e=r[C],a=r[C+1],i=r[C+2],m=s[e]*o+M,d=h[a]*l+A,v=f[i]*u+x,r[C]=~~m,r[C+1]=~~d,r[C+2]=~~v;return r}})}(r),function(r){var t=Math.sqrt,n=r._notSupportClamp,e=r.Array32F;r.PixelateFilter=r.Create({scale:1,name:"PixelateFilter",init:function(r){this.scale=r||1},apply:function(r,a,i){if(this.scale<=1)return r;this.scale>100&&(this.scale=100);var o,l,u,s,h,f,c,p,g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y,k,G,X,N,z,L,P,T,V,D,U,j,Q,J,K,O,W,Z=r.length,$=Z>>2,rt=(a<<1)+a;for(o=~~(.01*t($)*this.scale),l=a*o,u=i%o,s=a%o,h=(u-1)*a,g=1/(o*o),m=1/(s*o),d=1/(u*o),v=1/(s*u),C=g,y=m,b=d,F=v,_=o-1,E=(o-1)*a,P=0,V=a-1,T=0,D=$-a,M=new e(3*$),H=0,w=0,q=0,A=x=S=0,q=0;a>q;q++,H+=4,w+=3)A+=r[H],x+=r[H+1],S+=r[H+2],M[w]=A,M[w+1]=x,M[w+2]=S;for(w=0,q=0,A=x=S=0,H=rt+a;Z>H;H+=4,w+=3,q++)q>=a&&(q=0,A=x=S=0),A+=r[H],x+=r[H+1],S+=r[H+2],M[w+rt]=M[w]+A,M[w+rt+1]=M[w+1]+x,M[w+rt+2]=M[w+2]+S;for(q=0,B=0,I=0,X=q,N=I,z=X+_,L=N+E,z=z>V?V:z,L=L>D?D:L,U=X+N,J=z+L,j=z+N,Q=X+L,U=(U<<1)+U,j=(j<<1)+j,Q=(Q<<1)+Q,J=(J<<1)+J,p=C,K=p*(M[J]-M[j]-M[Q]+M[U]),O=p*(M[J+1]-M[j+1]-M[Q+1]+M[U+1]),W=p*(M[J+2]-M[j+2]-M[Q+2]+M[U+2]),n&&(K=0>K?0:K>255?255:K,O=0>O?0:O>255?255:O,W=0>W?0:W>255?255:W),K=~~K,O=~~O,W=~~W,R=0,Y=0,k=0,H=0;Z>H;H+=4)G=R+q+k+I<<2,r[G]=K,r[G+1]=O,r[G+2]=W,R++,(R+q>=a||R>=o)&&(R=0,Y++,k+=a),(Y+B>=i||Y>=o)&&(q+=o,q>=a&&(q=0,B+=o,I+=l),R=0,Y=0,k=0,X=q,N=I,z=X+_,L=N+E,z=z>V?V:z,L=L>D?D:L,U=X+N,J=z+L,j=z+N,Q=X+L,U=(U<<1)+U,j=(j<<1)+j,Q=(Q<<1)+Q,J=(J<<1)+J,f=0==z-X-s+1,c=0==L-N-h,p=f&&c?F:f?y:c?b:C,K=p*(M[J]-M[j]-M[Q]+M[U]),O=p*(M[J+1]-M[j+1]-M[Q+1]+M[U+1]),W=p*(M[J+2]-M[j+2]-M[Q+2]+M[U+2]),n&&(K=0>K?0:K>255?255:K,O=0>O?0:O>255?255:O,W=0>W?0:W>255?255:W),K=~~K,O=~~O,W=~~W);return r}})}(r),function(r){var t=Math.sqrt,n=(Math.SQRT2,Math.min,r._notSupportClamp),e=r.Array32F;r.TriangularPixelateFilter=r.Create({scale:1,name:"TriangularPixelateFilter",init:function(r){this.scale=r||1},apply:function(r,a,i){if(this.scale<=1)return r;this.scale>100&&(this.scale=100);var o,l,u,s,h,f,c,p,g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y,k,G,X,N,z,L,P,T,V,D,U,j,Q,J,K,O,W,Z,$,rt,tt,nt,et,at,it,ot=r.length,lt=ot>>2,ut=(a<<1)+a;for(o=~~(.01*t(lt)*this.scale),l=o>>1,u=o-1,s=a*o,h=i%o,f=a%o,c=(h-1)*a,d=1/(o*o),v=1/(f*o),C=1/(h*o),y=1/(f*h),b=2*d,F=2*v,M=2*C,A=2*y,H=u,w=u*a,V=0,U=a-1,D=0,j=lt-a,x=new e(3*lt),q=0,B=0,I=0,S=_=E=0,I=0;a>I;I++,q+=4,B+=3)S+=r[q],_+=r[q+1],E+=r[q+2],x[B]=S,x[B+1]=_,x[B+2]=E;for(B=0,I=0,S=_=E=0,q=ut+a;ot>q;q+=4,B+=3,I++)I>=a&&(I=0,S=_=E=0),S+=r[q],_+=r[q+1],E+=r[q+2],x[B+ut]=x[B]+S,x[B+ut+1]=x[B+1]+_,x[B+ut+2]=x[B+2]+E;for(I=0,R=0,Y=0,z=I,L=Y,P=I-l+H,T=Y+w,P=P>U?U:P,T=T>j?j:T,Q=z+L,O=P+T,J=P+L,K=z+T,Q=(Q<<1)+Q,J=(J<<1)+J,K=(K<<1)+K,O=(O<<1)+O,m=b,rt=m*(x[O]-x[J]-x[K]+x[Q]),tt=m*(x[O+1]-x[J+1]-x[K+1]+x[Q+1]),nt=m*(x[O+2]-x[J+2]-x[K+2]+x[Q+2]),z=I+l,P=I+H,P=P>U?U:P,Q=z+L,O=P+T,J=P+L,K=z+T,Q=(Q<<1)+Q,J=(J<<1)+J,K=(K<<1)+K,O=(O<<1)+O,et=m*(x[O]-x[J]-x[K]+x[Q]),at=m*(x[O+1]-x[J+1]-x[K+1]+x[Q+1]),it=m*(x[O+2]-x[J+2]-x[K+2]+x[Q+2]),n&&(rt=0>rt?0:rt>255?255:rt,tt=0>tt?0:tt>255?255:tt,nt=0>nt?0:nt>255?255:nt,et=0>et?0:et>255?255:et,at=0>at?0:at>255?255:at,it=0>it?0:it>255?255:it),rt=~~rt,tt=~~tt,nt=~~nt,et=~~et,at=~~at,it=~~it,W=rt,Z=tt,$=nt,k=0,G=0,X=0,q=0;ot>q;q+=4)N=k+I+X+Y<<2,r[N]=W,r[N+1]=Z,r[N+2]=$,k++,(k+I>=a||k>=o)&&(k=0,G++,X+=a,W=rt,Z=tt,$=nt),k>u-G&&(W=et,Z=at,$=it),(G+R>=i||G>=o)&&(I+=o,I>=a&&(I=0,R+=o,Y+=s),k=0,G=0,X=0,z=I,L=Y,P=I-l+H,T=Y+w,P=P>U?U:P,T=T>j?j:T,Q=z+L,O=P+T,J=P+L,K=z+T,Q=(Q<<1)+Q,J=(J<<1)+J,K=(K<<1)+K,O=(O<<1)+O,p=0==P-z+l-f+1,g=0==T-L-c,m=p&&g?A:p?F:g?M:b,rt=m*(x[O]-x[J]-x[K]+x[Q]),tt=m*(x[O+1]-x[J+1]-x[K+1]+x[Q+1]),nt=m*(x[O+2]-x[J+2]-x[K+2]+x[Q+2]),z=I+l,P=I+H,P=P>U?U:P,Q=z+L,O=P+T,J=P+L,K=z+T,Q=(Q<<1)+Q,J=(J<<1)+J,K=(K<<1)+K,O=(O<<1)+O,p=0==P-z+l-f+1,m=p&&g?A:p?F:g?M:b,et=m*(x[O]-x[J]-x[K]+x[Q]),at=m*(x[O+1]-x[J+1]-x[K+1]+x[Q+1]),it=m*(x[O+2]-x[J+2]-x[K+2]+x[Q+2]),n&&(rt=0>rt?0:rt>255?255:rt,tt=0>tt?0:tt>255?255:tt,nt=0>nt?0:nt>255?255:nt,et=0>et?0:et>255?255:et,at=0>at?0:at>255?255:at,it=0>it?0:it>255?255:it),rt=~~rt,tt=~~tt,nt=~~nt,et=~~et,at=~~at,it=~~it,W=rt,Z=tt,$=nt);return r}})}(r),function(r){var t=r._notSupportClamp,n=r.Color.RGB2HSV,e=.7083333333333334;r.HSVConverterFilter=r.Create({name:"HSVConverterFilter",apply:function(r){var a,i,o,l,u,s,h,f,c=r.length;if(t)for(l=0;c>l;l+=4)a=r[l],i=r[l+1],o=r[l+2],u=n({r:a,g:i,b:o}),s=u.h*e,f=255*u.s,h=u.v,0>s?s=0:s>255&&(s=255),0>h?h=0:h>255&&(h=255),0>f?f=0:f>255&&(f=255),r[l]=~~s,r[l+1]=~~h,r[l+2]=~~f;else for(l=0;c>l;l+=4)a=r[l],i=r[l+1],o=r[l+2],u=n({r:a,g:i,b:o}),s=u.h*e,f=255*u.s,h=u.v,r[l]=~~s,r[l+1]=~~h,r[l+2]=~~f;return r}})}(r),function(r){var t=(r._notSupportClamp,r.ImArray,r.Color.clampPixel),n=r.Color.RGB2HSV,e=(r.Color.HSV2RGB,r.Color.Color2RGBA);r.HueExtractorFilter=r.Create({range:null,background:0,name:"HueExtractorFilter",init:function(r,t){this.range=r,this.background=t||0},apply:function(r){if(!this.range||!this.range.length)return r;var a,i,o,l,u,s,h,f,c,p,g=r.length,m=this.range[0],d=this.range[this.range.length-1];for(c=e(this.background||0),l=~~t(c.r),u=~~t(c.g),s=~~t(c.b),h=~~t(c.a),f=0;g>f;f+=4)a=r[f],i=r[f+1],o=r[f+2],p=n({r:a,g:i,b:o}).h,(m>p||p>d)&&(r[f]=l,r[f+1]=u,r[f+2]=s,r[f+3]=h);return r}})}(r),function(r){var t=(r._notSupportClamp,Math.min),n=Math.floor,e=r.CHANNEL.RED;r.CHANNEL.GREEN,r.CHANNEL.BLUE,r.CHANNEL.ALPHA,r.ChannelCopyFilter=r.Create({srcImg:null,centerX:0,centerY:0,srcChannel:0,dstChannel:0,name:"ChannelCopyFilter",init:function(r,t,n,a,i){this.srcImg=r||null,this.srcChannel=t||e,this.dstChannel=n||e,this.centerX=a||0,this.centerY=i||0},apply:function(r,e,a){if(!this.srcImg)return r;var i,o,l,u,s,h,f=this.srcImg.getData(),c=r.length,p=(f.length,this.srcImg.width),g=this.srcImg.height,m=this.srcChannel,d=this.dstChannel,v=t(e,p),C=t(a,g),y=this.centerX||0,b=this.centerY||0,F=p>>1,M=g>>1;for(y=n(y*(e-1))-F,b=n(b*(a-1))-M,i=0,o=0,l=0,i=0;c>i;i+=4,o++)o>=e&&(o=0,l++),s=o-y,h=l-b,s>=0&&v>s&&h>=0&&C>h&&(u=s+h*p<<2,r[i+d]=f[u+m]);return r}})}(r),function(r){var t=(r._notSupportClamp,Math.min),n=Math.floor;r.AlphaMaskFilter=r.Create({alphaMask:null,centerX:0,centerY:0,name:"AlphaMaskFilter",init:function(r,t,n){this.alphaMask=r||null,this.centerX=t||0,this.centerY=n||0},apply:function(r,e,a){if(!this.alphaMask)return r;var i,o,l,u,s,h,f=this.alphaMask.getData(),c=this.alphaMask.width,p=this.alphaMask.height,g=r.length,m=(f.length,t(e,c)),d=t(a,p),v=this.centerX||0,C=this.centerY||0,y=c>>1,b=p>>1;for(v=n(v*(e-1))-y,C=n(C*(a-1))-b,o=0,l=0,i=0;g>i;i+=4,o++)o>=e&&(o=0,l++),s=o-v,h=l-C,s>=0&&m>s&&h>=0&&d>h?(u=s+h*c<<2,r[i+3]=f[u+3]):r[i+3]=0;return r}})}(r),function(r,t){var n,e=Math.min,a=Math.max,i=Math.round,o=(Math.floor,Math.abs),l=r._notSupportClamp;r.BlendFilter=r.Create({_blendMode:null,blendImage:null,startX:0,startY:0,amount:1,name:"BlendFilter",init:function(r,t,n){this.startX=0,this.startY=0,this.amount=1,this.blendImage=r||null,this._blendMode=null,t&&this.mode(t,n)},image:function(r){return this.blendImage=r||null,this},mode:function(r,i){return this._blendMode=n[(""+r).toLowerCase()]||null,this.amount=a(0,e(1,t===i?1:i)),this},reset:function(){return this.startX=0,this.startY=0,this.amount=1,this._blendMode=null,this},apply:function(r,t,n){if(!this._blendMode||!this.blendImage)return r;var a,o,l,u,s,h=this.startX||0,f=this.startY||0,c=0,p=0,g=this.blendImage,m=this.amount||1;return u=g.width,s=g.height,0>h&&(c=-h,h=0),0>f&&(p=-f,f=0),h>=t||f>=n?r:c>=u||p>=s?r:(h=i(h),f=i(f),c=i(c),p=i(p),a=e(t-h,u-c),o=e(n-f,s-p),0>=a||0>=o?r:(l=g.getData(),this._blendMode(r,t,n,l,u,s,h,f,c,p,a,o,m)))}}),n={normal:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=E,B=H,I=w,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},lighten:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=x>E?x:E,B=S>H?S:H,I=_>w?_:w,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},darken:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=x>E?E:x,B=S>H?H:S,I=_>w?w:_,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},multiply:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=.003921568627451*x*E,B=.003921568627451*S*H,I=.003921568627451*_*w,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},average:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=.5*(x+E),B=.5*(S+H),I=.5*(_+w),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},add:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=x+E,B=S+H,I=_+w,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},subtract:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=255>x+E?0:x+E-255,B=255>S+H?0:S+H-255,I=255>_+w?0:_+w-255,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},difference:function(r,t,n,e,a,i,u,s,h,f,c,p,g){var m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y;for(Y=1-g,F=u,M=s*t,A=h,x=f*a,m=u+c,d=h+c,v=0,C=p*c;C>v;)y=F+M<<2,b=A+x<<2,S=r[y],_=r[y+1],E=r[y+2],H=e[b],w=e[b+1],q=e[b+2],B=o(H-S),I=o(w-_),R=o(q-E),S=B*g+S*Y,_=I*g+_*Y,E=R*g+E*Y,l&&(S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E),r[y]=~~S,r[y+1]=~~_,r[y+2]=~~E,v++,F++,F>=m&&(F=u,M+=t),A++,A>=d&&(A=h,x+=a);return r},negation:function(r,t,n,e,a,i,u,s,h,f,c,p,g){var m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y;for(Y=1-g,F=u,M=s*t,A=h,x=f*a,m=u+c,d=h+c,v=0,C=p*c;C>v;)y=F+M<<2,b=A+x<<2,S=r[y],_=r[y+1],E=r[y+2],H=e[b],w=e[b+1],q=e[b+2],B=255-o(255-H-S),I=255-o(255-w-_),R=255-o(255-q-E),S=B*g+S*Y,_=I*g+_*Y,E=R*g+E*Y,l&&(S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E),r[y]=~~S,r[y+1]=~~_,r[y+2]=~~E,v++,F++,F>=m&&(F=u,M+=t),A++,A>=d&&(A=h,x+=a);return r},screen:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=255-((255-E)*(255-x)>>8),B=255-((255-H)*(255-S)>>8),I=255-((255-w)*(255-_)>>8),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},exclusion:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=E+x-.003921568627451*2*E*x,B=H+S-.003921568627451*2*H*S,I=w+_-.003921568627451*2*w*_,x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},overlay:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=128>x?.003921568627451*2*E*x:255-.003921568627451*2*(255-E)*(255-x),B=128>S?.003921568627451*2*H*S:255-.003921568627451*2*(255-H)*(255-S),q=128>_?.003921568627451*2*w*_:255-.003921568627451*2*(255-w)*(255-_),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},softlight:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=128>x?2*((E>>1)+64)*.003921568627451*x:255-.003921568627451*2*(255-((E>>1)+64))*(255-x),B=128>S?2*((H>>1)+64)*.003921568627451*S:255-.003921568627451*2*(255-((H>>1)+64))*(255-S),I=128>_?2*((w>>1)+64)*.003921568627451*_:255-.003921568627451*2*(255-((w>>1)+64))*(255-_),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},hardlight:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;for(R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],q=128>E?.003921568627451*2*x*E:255-.003921568627451*2*(255-x)*(255-E),B=128>H?.003921568627451*2*S*H:255-.003921568627451*2*(255-S)*(255-H),I=128>w?.003921568627451*2*_*w:255-.003921568627451*2*(255-_)*(255-w),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},colordodge:function(r,t,n,a,i,o,u,s,h,f,c,p,g){var m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y;for(Y=1-g,F=u,M=s*t,A=h,x=f*i,m=u+c,d=h+c,v=0,C=p*c;C>v;)y=F+M<<2,b=A+x<<2,S=r[y],_=r[y+1],E=r[y+2],H=a[b],w=a[b+1],q=a[b+2],B=255==S?S:e(255,(H<<8)/(255-S)),I=255==_?_:e(255,(w<<8)/(255-_)),R=255==E?S:e(255,(q<<8)/(255-E)),S=B*g+S*Y,_=I*g+_*Y,E=R*g+E*Y,l&&(S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E),r[y]=~~S,r[y+1]=~~_,r[y+2]=~~E,v++,F++,F>=m&&(F=u,M+=t),A++,A>=d&&(A=h,x+=i);return r},colorburn:function(r,t,n,e,i,o,u,s,h,f,c,p,g){var m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y;for(Y=1-g,F=u,M=s*t,A=h,x=f*i,m=u+c,d=h+c,v=0,C=p*c;C>v;)y=F+M<<2,b=A+x<<2,S=r[y],_=r[y+1],E=r[y+2],H=e[b],w=e[b+1],q=e[b+2],B=0==S?S:a(0,255-(255-H<<8)/S),I=0==_?_:a(0,255-(255-w<<8)/_),R=0==E?E:a(0,255-(255-q<<8)/E),S=B*g+S*Y,_=I*g+_*Y,E=R*g+E*Y,l&&(S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E),r[y]=~~S,r[y+1]=~~_,r[y+2]=~~E,v++,F++,F>=m&&(F=u,M+=t),A++,A>=d&&(A=h,x+=i);return r},linearlight:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;for(var Y;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],128>x?(Y=2*x,q=255>Y+E?0:Y+E-255):(Y=2*(x-128),q=Y+E),128>S?(Y=2*S,B=255>Y+H?0:Y+H-255):(Y=2*(S-128),B=Y+H),128>_?(Y=2*_,I=255>Y+w?0:Y+w-255):(Y=2*(_-128),I=Y+w),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},reflect:function(r,t,n,a,i,o,u,s,h,f,c,p,g){var m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y;for(Y=1-g,F=u,M=s*t,A=h,x=f*i,m=u+c,d=h+c,v=0,C=p*c;C>v;)y=F+M<<2,b=A+x<<2,S=r[y],_=r[y+1],E=r[y+2],H=a[b],w=a[b+1],q=a[b+2],B=255==S?S:e(255,H*H/(255-S)),I=255==_?_:e(255,w*w/(255-_)),R=255==E?E:e(255,q*q/(255-E)),S=B*g+S*Y,_=I*g+_*Y,E=R*g+E*Y,l&&(S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E),r[y]=~~S,r[y+1]=~~_,r[y+2]=~~E,v++,F++,F>=m&&(F=u,M+=t),A++,A>=d&&(A=h,x+=i);return r},glow:function(r,t,n,a,i,o,u,s,h,f,c,p,g){var m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y;for(Y=1-g,F=u,M=s*t,A=h,x=f*i,m=u+c,d=h+c,v=0,C=p*c;C>v;)y=F+M<<2,b=A+x<<2,S=r[y],_=r[y+1],E=r[y+2],H=a[b],w=a[b+1],q=a[b+2],B=255==H?H:e(255,S*S/(255-H)),I=255==w?w:e(255,_*_/(255-w)),R=255==q?q:e(255,E*E/(255-q)),S=B*g+S*Y,_=I*g+_*Y,E=R*g+E*Y,l&&(S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E),r[y]=~~S,r[y+1]=~~_,r[y+2]=~~E,v++,F++,F>=m&&(F=u,M+=t),A++,A>=d&&(A=h,x+=i);return r},phoenix:function(r,t,n,i,o,u,s,h,f,c,p,g,m){var d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y,k;for(k=1-m,M=s,A=h*t,x=f,S=c*o,d=s+p,v=f+p,C=0,y=g*p;y>C;)b=M+A<<2,F=x+S<<2,_=r[b],E=r[b+1],H=r[b+2],w=i[F],q=i[F+1],B=i[F+2],I=e(w,_)-a(w,_)+255,R=e(q,E)-a(q,E)+255,Y=e(B,H)-a(B,H)+255,_=I*m+_*k,E=R*m+E*k,H=Y*m+H*k,l&&(_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E,H=0>H?0:H>255?255:H),r[b]=~~_,r[b+1]=~~E,r[b+2]=~~H,C++,M++,M>=d&&(M=s,A+=t),x++,x>=v&&(x=f,S+=o);return r},vividlight:function(r,t,n,i,o,u,s,h,f,c,p,g,m){var d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y,k;k=1-m,M=s,A=h*t,x=f,S=c*o,d=s+p,v=f+p,C=0,y=g*p;for(var G;y>C;)b=M+A<<2,F=x+S<<2,_=r[b],E=r[b+1],H=r[b+2],w=i[F],q=i[F+1],B=i[F+2],128>_?(G=2*_,I=0==G?G:a(0,255-(255-w<<8)/G)):(G=2*(_-128),I=255==G?G:e(255,(w<<8)/(255-G))),128>E?(G=2*E,R=0==G?G:a(0,255-(255-q<<8)/G)):(G=2*(E-128),R=255==G?G:e(255,(q<<8)/(255-G))),128>H?(G=2*H,Y=0==G?G:a(0,255-(255-B<<8)/G)):(G=2*(E-128),Y=255==G?G:e(255,(B<<8)/(255-G))),_=I*m+_*k,E=R*m+E*k,H=Y*m+H*k,l&&(_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E,H=0>H?0:H>255?255:H),r[b]=~~_,r[b+1]=~~E,r[b+2]=~~H,C++,M++,M>=d&&(M=s,A+=t),x++,x>=v&&(x=f,S+=o);return r},pinlight:function(r,t,n,e,a,i,o,u,s,h,f,c,p){var g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R;R=1-p,b=o,F=u*t,M=s,A=h*a,g=o+f,m=s+f,d=0,v=c*f;for(var Y;v>d;)C=b+F<<2,y=M+A<<2,x=r[C],S=r[C+1],_=r[C+2],E=e[y],H=e[y+1],w=e[y+2],128>x?(Y=2*x,q=Y>E?Y:E):(Y=2*(x-128),q=Y>E?E:Y),128>S?(Y=2*S,B=Y>H?Y:H):(Y=2*(x-128),B=Y>H?H:Y),128>_?(Y=2*_,I=Y>w?Y:w):(Y=2*(_-128),I=Y>w?w:Y),x=q*p+x*R,S=B*p+S*R,_=I*p+_*R,l&&(x=0>x?0:x>255?255:x,S=0>S?0:S>255?255:S,_=0>_?0:_>255?255:_),r[C]=~~x,r[C+1]=~~S,r[C+2]=~~_,d++,b++,b>=g&&(b=o,F+=t),M++,M>=m&&(M=s,A+=a);return r},hardmix:function(r,t,n,i,o,u,s,h,f,c,p,g,m){var d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y,k;k=1-m,M=s,A=h*t,x=f,S=c*o,d=s+p,v=f+p,C=0,y=g*p;for(var G;y>C;)b=M+A<<2,F=x+S<<2,_=r[b],E=r[b+1],H=r[b+2],w=i[F],q=i[F+1],B=i[F+2],128>_?(G=2*_,I=0==G?G:a(0,255-(255-w<<8)/G)):(G=2*(_-128),I=255==G?G:e(255,(w<<8)/(255-G))),I=128>I?0:255,128>E?(G=2*E,R=0==G?G:a(0,255-(255-q<<8)/G)):(G=2*(E-128),R=255==G?G:e(255,(q<<8)/(255-G))),R=128>R?0:255,128>H?(G=2*H,Y=0==G?G:a(0,255-(255-B<<8)/G)):(G=2*(H-128),Y=255==G?G:e(255,(B<<8)/(255-G))),Y=128>Y?0:255,_=I*m+_*k,E=R*m+E*k,H=Y*m+H*k,l&&(_=0>_?0:_>255?255:_,E=0>E?0:E>255?255:E,H=0>H?0:H>255?255:H),r[b]=~~_,r[b+1]=~~E,r[b+2]=~~H,C++,M++,M>=d&&(M=s,A+=t),x++,x>=v&&(x=f,S+=o);return r}},n.lineardodge=n.add,n.linearburn=n.subtract}(r),function(r){var t=(r._notSupportClamp,r.Color.RGBA2Color),n=r.Color.Color2RGBA;r.ThresholdFilter=r.Create({thresholds:null,quantizedColors:null,name:"ThresholdFilter",init:function(r,t){this.thresholds=r,this.quantizedColors=t||null},apply:function(r){if(!this.thresholds||!this.thresholds.length)return r;if(!this.quantizedColors||!this.quantizedColors.length)return r;var e,a,i,o,l,u,s,h,f=r.length,c=this.thresholds,p=c.length,g=this.quantizedColors,m=g.length;for(s=0;f>s;s+=4){for(l=t({r:r[s],g:r[s+1],b:r[s+2],a:r[s+3]}),h=0;p>h&&l>c[h];)h++;l=m>h?g[h]:255,u=n(l),e=u.r,a=u.g,i=u.b,o=u.a,r[s]=e,r[s+1]=a,r[s+2]=i,r[s+3]=o}return r}})}(r),function(r){var t=(Math.sqrt,Math.exp,Math.log),n=Math.abs,e=Math.floor,a=r._notSupportClamp,i=r.Array32F;r.BokehFilter=r.Create({centerX:0,centerY:0,radius:10,amount:10,name:"BokehFilter",init:function(r,t,n,e){this.centerX=r||0,this.centerY=t||0,this.radius=n||10,this.amount=e||10},apply:function(r,o,l){var u,s,h,f,c,p,g,m,d,v,C,y,b,F,M,A,x,S,_,E,H,w,q,B,I,R,Y,k,G,X,N,z,L,P=r.length,T=this.centerX||0,V=this.centerY||0,D=this.radius,U=this.amount;if(0>=U)return r;for(u=P>>2,X=0,N=o-1,z=0,L=u-o,T=e(T*(o-1)),V=e(V*(l-1)),h=(u<<1)+u,g=(o<<1)+o,s=new i(h),m=0,d=0,v=0,f=c=p=0,v=0;o>v;v++,m+=4,d+=3)f+=r[m],c+=r[m+1],p+=r[m+2],s[d]=f,s[d+1]=c,s[d+2]=p;for(m=g+o,d=0,v=0,f=c=p=0,m=g+o;P>m;m+=4,d+=3,v++)v>=o&&(v=0,f=c=p=0),f+=r[m],c+=r[m+1],p+=r[m+2],s[d+g]=s[d]+f,s[d+g+1]=s[d+1]+c,s[d+g+2]=s[d+2]+p;for(v=0,C=0,y=0,m=0;P>m;m+=4,v++)v>=o&&(v=0,C++,y+=o),F=v-T,M=C-V,b=n(F)+n(M),A=b>D?~~t((b-D)*U):~~(b/D+.5),A>0&&(x=A*o,S=.25/(A*A),_=v-A,E=y-x,H=v+A,w=y+x,X>_?_=X:H>N&&(H=N),z>E?E=z:w>L&&(w=L),q=_+E,R=H+w,B=H+E,I=_+w,q=(q<<1)+q,B=(B<<1)+B,I=(I<<1)+I,R=(R<<1)+R,Y=S*(s[R]-s[B]-s[I]+s[q]),k=S*(s[R+1]-s[B+1]-s[I+1]+s[q+1]),G=S*(s[R+2]-s[B+2]-s[I+2]+s[q+2]),a&&(Y=0>Y?0:Y>255?255:Y,k=0>k?0:k>255?255:k,G=0>G?0:G>255?255:G),r[m]=~~Y,r[m+1]=~~k,r[m+2]=~~G);return r}})}(r),t});
