/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.1
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(a){function x(a,c){var a=a||{},b;for(b in c)c&&Object.prototype.hasOwnProperty.call(c,b)&&(a[b]=c[b]);return a}a.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;a.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;a.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;a.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;a.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;a.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;a.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;a.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;a.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:a.Array8U;a._notSupportTypedArrays=!a.ImArray.set;a.CONSTANTS={PI:Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI};a.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};a.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};a.LUMA=new a.Array32F([0.212671,0.71516,0.072169]);a.Filter=function(){};a.Filter.prototype={_apply:function(){},apply:function(){},
reset:function(){}};a.CompositeFilter=function(a){this._stack=typeof a!="undefined"&&a.length?a:[]};a.CompositeFilter.prototype={_stack:[],_apply:function(a,c,b){if(!this._stack.length)return a;for(var f=this._stack,e=f.length,g=0,h;g<e;)(h=f[g++])&&(a=h._apply(a,c,b));return a},apply:function(a){if(!this._stack.length)return a;return a.setData(this._apply(im=a.getData(),a.width,a.height))},filters:function(a){if(a)this._stack=a;return this},push:function(a){this._stack.push(a);return this},pop:function(){return this._stack.pop()},
shift:function(){return this._stack.shift()},unshift:function(a){this._stack.unshift(a);return this},concat:function(a){return this.push(a)},getAt:function(a){return this._stack.length>a?this._stack[a]:null},setAt:function(a,c){this._stack.length>a&&(this._stack[a]=c);return this},insertAt:function(a,c){this._stack.splice(a,0,c);return this},removeAt:function(a){this._stack.splice(a,1);return this},remove:function(a){for(var c=this._stack.length;--c>=0;)a===this._stack[c]&&this._stack.splice(c,1);
return this},reset:function(){this._stack.length=0;return this}};a.Create=function(a){var c=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},a=x({init:function(){},reset:function(){return this},apply:function(b){return b}},a);a._apply=a.apply;a.apply=function(b){return b.setData(this._apply(b.getData(),b.width,b.height))};c.prototype=x(c.prototype,a);return c}})(FILTER);
(function(a){var x=Math.sqrt,q=Math.min,c=Math.max;a.Color={blend:function(b,a,e){return{r:b.r-~~((b.r-a.r)*e+0.5),g:b.g-~~((b.g-a.g)*e+0.5),b:b.b-~~((b.b-a.b)*e+0.5)}},toGray:function(b,c,e){var g=a.LUMA;return~~(g[0]*b+g[1]*c+g[2]*e)},distance:function(b,a){var e=b.r-a.r,g=b.g-a.g,c=b.b-a.b;return x(e*e+g*g+c*c)},RGB2Color:function(b){return b.r<<16|b.g<<8|b.b&255},RGBA2Color:function(b){return b.a<<24|b.r<<16|b.g<<8|b.b&255},Color2RGBA:function(b){b=~~b;return{r:b>>16&255,g:b>>8&255,b:b&255,a:b>>
24&255}},RGB2YCbCr:function(b){var a=b.r,e=b.g,b=b.b;return{y:~~(0+0.299*a+0.587*e+0.114*b),cb:~~(128-0.168736*a-0.331264*e+0.5*b),cr:~~(128+0.5*a-0.418688*e-0.081312*b)}},YCbCr2RGB:function(b){var a=b.y,e=b.cb,b=b.cr;return{r:~~(a+1.402*(b-128)),g:~~(a-0.34414*(e-128)-0.71414*(b-128)),b:~~(a+1.772*(e-128))}},RGB2HSV:function(b){var a,e,g,h;e=b.r;g=b.g;h=b.b;a=q(e,g,h);b=c(e,g,h);a=b-a;if(b==0)return{h:0,s:0,v:b};e=e==b?(g-h)/a:g==b?2+(h-e)/a:4+(e-g)/a;e*=60;e<0&&(e+=360);return{h:e,s:a/b,v:b}},HSV2RGB:function(b){var a,
e,g,c,d;g=b.h;d=b.s;b=b.v;if(d==0)return a=e=b,{r:a,g:e,b:b};g/=60;a=~~g;e=g-a;g=b*(1-d);c=b*(1-d*e);d=b*(1-d*(1-e));switch(a){case 0:a=b;e=d;b=g;break;case 1:a=c;e=b;b=g;break;case 2:a=g;e=b;b=d;break;case 3:a=g;e=c;break;case 4:a=d;e=g;break;default:a=b,e=g,b=c}return{r:a,g:e,b:b}}}})(FILTER);
(function(a){function x(b,a){var c=document.createElement("canvas");c.width=b||0;c.height=a||0;return c}var q,c=Math.min,b=a.ImArray;q={normal:function(b){return b},lighten:function(b,a){return a>b?a:b},darken:function(b,a){return a>b?b:a},multiply:function(b,a){return b*a*0.003921568627451},average:function(b,a){return 0.5*(b+a)},add:function(b,a){return Math.min(255,b+a)},substract:function(b,a){return b+a<255?0:b+a-255},difference:function(b,a){return Math.abs(b-a)},negation:function(b,a){return 255-
Math.abs(255-b-a)},screen:function(b,a){return 255-((255-b)*(255-a)>>8)},exclusion:function(b,a){return b+a-2*b*a*0.003921568627451},overlay:function(b,a){return a<128?2*b*a*0.003921568627451:255-2*(255-b)*(255-a)*0.003921568627451},softLight:function(b,a){return a<128?2*((b>>1)+64)*a*0.003921568627451:255-2*(255-((b>>1)+64))*(255-a)*0.003921568627451},hardLight:function(b,a){return b<128?2*a*b*0.003921568627451:255-2*(255-a)*(255-b)*0.003921568627451},colorDodge:function(b,a){return a==255?a:Math.min(255,
(b<<8)/(255-a))},colorBurn:function(b,a){return a==0?a:Math.max(0,255-(255-b<<8)/a)},linearLight:function(b,a){return a<128?q.linearBurn(b,2*a):q.linearDodge(b,2*(a-128))},vividLight:function(b,a){return a<128?q.colorBurn(b,2*a):q.colorDodge(b,2*(a-128))},pinLight:function(b,a){return a<128?q.darken(b,2*a):q.lighten(b,2*(a-128))},hardMix:function(b,a){return q.vividLight(b,a)<128?0:255},reflect:function(b,a){return a==255?a:Math.min(255,b*b/(255-a))},glow:function(b,a){return b==255?b:Math.min(255,
a*a/(255-b))},phoenix:function(b,a){return Math.min(b,a)-Math.max(b,a)+255}};q.linearDodge=q.add;q.linearBurn=q.substract;a.blendModes=q;var f=a._notSupportTypedArrays;a.Image=function(b,a){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=x(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=x(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(b,a)};
a.Image.prototype={width:0,height:0,canvasElement:null,domElement:null,clear:function(){this.context.clearRect(0,0,this.width,this.height);return this},fill:function(b,a,c,d,k){var d=d||this.width,k=k||this.height,r=this.context;r.fillStyle=b||0;r.fillRect(a||0,c||0,d,k);this.imageData=r.getImageData(0,0,this.width,this.height);return this},draw:function(){return this},getPixel:function(b,a){var c=~~(a*this.width+b+0.5);return{red:this.imageData.data[c],green:this.imageData.data[c+1],blue:this.imageData.data[c+
2],alpha:this.imageData.data[c+3]}},setPixel:function(a,c,h,d,k,r){this.context.putImageData(new b([h,d,k,r]),a,c);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new b(this.imageData.data)},_setData:function(b){for(var a=this.imageData.data,c=b.length,d=0;d<c;)a[d]=b[d]&255,d++},setData:function(b){f?this._setData(b):this.imageData.data.set(b);this.context.putImageData(this.imageData,0,0);
this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(b){this.context.putImageData(b,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setWidth:function(b){this._tmpCanvas.width=this.canvasElement.width=this.width=b;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=
this._histogramRefresh=!0;return this},setHeight:function(b){this._tmpCanvas.height=this.canvasElement.height=this.height=b;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setImage:function(b,a){if(typeof b=="undefined"||b==null)return this;var c=this,d;b instanceof Image||b instanceof HTMLCanvasElement||b instanceof HTMLVideoElement?(d=b,this.width=b instanceof HTMLVideoElement?
b.videoWidth:b.width,this.height=b instanceof HTMLVideoElement?b.videoHeight:b.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,this.context=this.canvasElement.getContext("2d"),this.context.drawImage(d,0,0),this.imageData=this.context.getImageData(0,0,this.width,this.height),this._integralRefresh=this._histogramRefresh=!0):(d=new Image,d.onload=function(){c.width=d.width;c.height=d.height;c._tmpCanvas.width=c.canvasElement.width=
c.width;c._tmpCanvas.height=c.canvasElement.height=c.height;c.context=c.canvasElement.getContext("2d");c.context.drawImage(d,0,0);c.imageData=c.context.getImageData(0,0,c.width,c.height);c._histogramRefresh=!0;c._integralRefresh=!0;typeof a!="undefined"&&a.call(c)},d.src=b);d.crossOrigin="";return this},blend:function(b,a,f,d,k){typeof a=="undefined"&&(a="normal");typeof f=="undefined"&&(f=1);f>1&&(f=1);f<0&&(f=0);typeof d=="undefined"&&(d=0);typeof k=="undefined"&&(k=0);var r=0,A=0;d<0&&(r=-d,d=
0);k<0&&(A=-k,k=0);if(!(d>=this.width||k>=this.height)){a=q[a];if(a==void 0||a==null)return this;var o=c(this.width,b.width-r),s=c(this.height,b.height-A),m=this.context.getImageData(d,k,o,s),r=b.context.getImageData(r,A,o,s),b=m.data,r=r.data,l,t,n,u=1-f,v=r.length,C;for(C=0;C<v;C+=4)l=b[C],t=b[C+1],n=b[C+2],A=a(r[C],l),o=a(r[C+1],t),s=a(r[C+2],n),b[C]=A*f+l*u,b[C+1]=o*f+t*u,b[C+2]=s*f+n*u;this.context.putImageData(m,d,k);this._integralRefresh=this._histogramRefresh=!0;return this}},_refresh:function(){this.context=
this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},copy:function(b){this.setData(b.getData())},clone:function(){return new a.Image(this.canvasElement)},integral:function(){this._integralRefresh&&this._computeIntegral();return this._integral},_computeIntegral:function(){var b=this.width,c=b*this.height,f=b<<2,d=new a.Array32F(c),k=new a.Array32F(c),c=new a.Array32F(c),r=this.getPixelData().data,A,o,s,m,l,t;for(m=l=t=s=o=A=0;s<b;)m+=
r[A],l+=r[A+1],t+=r[A+2],d[o]=m,k[o]=l,c[o]=t,A+=4,o++,s++;A=f;for(m=l=t=s=0;A<imLen;)m+=r[A],l+=r[A+1],t+=r[A+2],d[o]=d[o-b]+m,k[o]=k[o-b]+l,c[o]=c[o-b]+t,A+=4,o++,s++,s>=b&&(m=l=t=s=0);this._integral=[d,k,c];this._integralRefresh=!1},histogram:function(){this._histogramRefresh&&this._computeHistogram();return this._histogram},_computeHistogram:function(){for(var b=this.getPixelData().data,c=0,f=b.length,d,k,r,A=0,o=0,s=0,m=255,l=255,t=255,n=new a.Array32F(256),u=new a.Array32F(256),v=new a.Array32F(256),
C=1/(f>>2),c=0;c<256;)n[c]=0,u[c]=0,v[c]=0,c++;for(c=0;c<f;)d=b[c],k=b[c+1],r=b[c+2],n[d]+=C,u[k]+=C,v[r]+=C,d>A&&(A=d),d<m&&(m=d),k>o&&(o=k),k<l&&(l=k),r>s&&(s=r),r<t&&(t=r),c+=4;this._histogram=[n,u,v];this._histogramRefresh=!1},createImageData:function(b,a){this._tmpCanvas.width=this.canvasElement.width=this.width=b;this._tmpCanvas.height=this.canvasElement.height=this.height=a;this.context=this.canvasElement.getContext("2d");this.context.createImageData(b,a);return this.imageData=this.context.getImageData(0,
0,this.width,this.height)},scale:function(b,a){var b=b||1,a=a||b,c=this._tmpCanvas.getContext("2d");c.scale(b,a);c.drawImage(this.canvasElement,0,0);this.canvasElement.width=this.width=~~(b*this.width+0.5);this.canvasElement.height=this.height=~~(a*this.height+0.5);this.context.drawImage(this._tmpCanvas,0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},
flipHorizontal:function(){var b=this._tmpCanvas.getContext("2d");b.translate(this.width,0);b.scale(-1,1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipVertical:function(){var b=this._tmpCanvas.getContext("2d");b.translate(0,this.height);b.scale(1,-1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=
this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this}}})(FILTER);(function(a){a.CustomFilter=function(a){this._handler=a};a.CustomFilter.prototype={_handler:null,_apply:function(a,q,c){if(!this._handler)return a;return this._handler.call(this,a,q,c)},apply:function(a){if(!this._handler)return a;return a.setData(this._handler.call(this,a.getData(),a.width,a.height))}}})(FILTER);
(function(a){var x=a.Array32F,q=a.CONSTANTS.toRad;a.ColorMatrixFilter=function(a){this._matrix=typeof a!="undefined"&&a.length?new x(a):null};a.ColorMatrixFilter.prototype={_matrix:null,channel:function(c,b){var f=(typeof b=="undefined"?0:b)?1:0;switch(c){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case a.CHANNEL.BLUE:return this.concat([0,0,f,0,0,0,0,f,0,0,0,0,1,0,0,0,0,0,0,255]);case a.CHANNEL.GREEN:return this.concat([0,f,0,0,0,0,1,0,0,0,0,f,0,0,0,0,0,0,
0,255]);default:return this.concat([1,0,0,0,0,f,0,0,0,0,f,0,0,0,0,0,0,0,0,255])}},redChannel:function(c){return this.channel(a.CHANNEL.RED,c)},greenChannel:function(c){return this.channel(a.CHANNEL.GREEN,c)},blueChannel:function(c){return this.channel(a.CHANNEL.BLUE,c)},alphaChannel:function(){return this.channel(a.CHANNEL.ALPHA,!0)},maskChannel:function(c){switch(c){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([1,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(c,b){switch(c){case a.CHANNEL.ALPHA:switch(b){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case a.CHANNEL.BLUE:switch(b){case a.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.BLUE:return this;case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case a.CHANNEL.GREEN:switch(b){case a.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(b){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case a.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(c,b){var f,e,g,h;typeof b=="undefined"&&(b=1);f=(c>>16&255)*0.00392156862745098;e=(c>>8&255)*0.00392156862745098;g=(c&255)*0.00392156862745098;h=1-b;return this.concat([h+b*f*a.LUMA[0],b*f*a.LUMA[1],b*f*a.LUMA[2],0,0,b*e*a.LUMA[0],h+b*e*a.LUMA[1],b*e*a.LUMA[2],0,0,b*g*a.LUMA[0],b*g*a.LUMA[1],h+b*g*a.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(c){var b,f,e;b=1-c;f=b*a.LUMA[0];e=b*a.LUMA[1];b*=a.LUMA[2];return this.concat([f+c,e,b,0,0,f,e+c,b,0,0,f,e,b+c,0,0,0,0,0,1,0])},contrast:function(a,b,f){typeof b=="undefined"&&(b=a);typeof f=="undefined"&&(f=a);a+=1;b+=1;f+=1;return this.concat([a,0,0,0,128*(1-a),0,b,0,0,128*(1-b),0,0,f,0,128*(1-f),0,0,0,1,0])},brightness:function(a,b,f){typeof b=="undefined"&&(b=a);typeof f=="undefined"&&(f=a);return this.concat([1,0,0,0,a,0,1,0,0,b,0,0,1,0,f,0,0,0,1,0])},
adjustHue:function(c){c*=q;var b=Math.cos(c),c=Math.sin(c);return this.concat([a.LUMA[0]+b*(1-a.LUMA[0])+c*-a.LUMA[0],a.LUMA[1]+b*-a.LUMA[1]+c*-a.LUMA[1],a.LUMA[2]+b*-a.LUMA[2]+c*(1-a.LUMA[2]),0,0,a.LUMA[0]+b*-a.LUMA[0]+c*0.143,a.LUMA[1]+b*(1-a.LUMA[1])+c*0.14,a.LUMA[2]+b*-a.LUMA[2]+c*-0.283,0,0,a.LUMA[0]+b*-a.LUMA[0]+c*-(1-a.LUMA[0]),a.LUMA[1]+b*-a.LUMA[1]+c*a.LUMA[1],a.LUMA[2]+b*(1-a.LUMA[2])+c*a.LUMA[2],0,0,0,0,0,1,0])},average:function(a,b,f){typeof a=="undefined"&&(a=0.3333);typeof b=="undefined"&&
(b=0.3333);typeof f=="undefined"&&(f=0.3334);return this.concat([a,b,f,0,0,a,b,f,0,0,a,b,f,0,0,0,0,0,1,0])},quickContrastCorrection:function(a){typeof a=="undefined"&&(a=1.2);return this.concat([a,0,0,0,0,0,a,0,0,0,0,0,a,0,0,0,0,0,1,0])},quickSepia:function(c){typeof c=="undefined"&&(c=10);c>100&&(c=100);c*=2.55;return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,40,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,20,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,-c,0,0,0,1,0])},quickSepia2:function(a,b,f){typeof a=="undefined"&&
(a=1);typeof b=="undefined"&&(b=a);typeof f=="undefined"&&(f=a);return this.concat([a*0.5,0.5,0.5,0,0,0.33,b*0.33,0.33,0,0,0.25,0.25,f*0.25,0,0,0,0,0,1,0])},threshold:function(c,b){typeof b=="undefined"&&(b=256);return this.concat([a.LUMA[0]*b,a.LUMA[1]*b,a.LUMA[2]*b,0,-(b-1)*c,a.LUMA[0]*b,a.LUMA[1]*b,a.LUMA[2]*b,0,-(b-1)*c,a.LUMA[0]*b,a.LUMA[1]*b,a.LUMA[2]*b,0,-(b-1)*c,0,0,0,1,0])},threshold_rgb:function(a,b){typeof b=="undefined"&&(b=256);return this.concat([b,0,0,0,-(b-1)*a,0,b,0,0,-(b-1)*a,0,
0,b,0,-(b-1)*a,0,0,0,1,0])},threshold_alpha:function(a,b){typeof a=="undefined"&&(a=0.5);typeof b=="undefined"&&(b=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,b,-b*a])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(a,b){var f;if(this._matrix){f=this._matrix;
var e=a.getMatrix(),g=1-b,h=new x(20);h[0]=g*f[0]+b*e[0];h[1]=g*f[1]+b*e[1];h[2]=g*f[2]+b*e[2];h[3]=g*f[3]+b*e[3];h[4]=g*f[4]+b*e[4];h[5]=g*f[5]+b*e[5];h[6]=g*f[6]+b*e[6];h[7]=g*f[7]+b*e[7];h[8]=g*f[8]+b*e[8];h[9]=g*f[9]+b*e[9];h[10]=g*f[10]+b*e[10];h[11]=g*f[11]+b*e[11];h[12]=g*f[12]+b*e[12];h[13]=g*f[13]+b*e[13];h[14]=g*f[14]+b*e[14];h[15]=g*f[15]+b*e[15];h[16]=g*f[16]+b*e[16];h[17]=g*f[17]+b*e[17];h[18]=g*f[18]+b*e[18];h[19]=g*f[19]+b*e[19];f=h}else f=new x(a.getMatrix());this._matrix=f;return this},
concat:function(a){var b;if(this._matrix){b=this._matrix;var a=new x(a),f=new x(20),e,g,h,d,k;e=a[0];g=a[1];h=a[2];d=a[3];k=a[4];f[0]=e*b[0]+g*b[5]+h*b[10]+d*b[15];f[1]=e*b[1]+g*b[6]+h*b[11]+d*b[16];f[2]=e*b[2]+g*b[7]+h*b[12]+d*b[17];f[3]=e*b[3]+g*b[8]+h*b[13]+d*b[18];f[4]=e*b[4]+g*b[9]+h*b[14]+d*b[19]+k;e=a[5];g=a[6];h=a[7];d=a[8];k=a[9];f[5]=e*b[0]+g*b[5]+h*b[10]+d*b[15];f[6]=e*b[1]+g*b[6]+h*b[11]+d*b[16];f[7]=e*b[2]+g*b[7]+h*b[12]+d*b[17];f[8]=e*b[3]+g*b[8]+h*b[13]+d*b[18];f[9]=e*b[4]+g*b[9]+h*
b[14]+d*b[19]+k;e=a[10];g=a[11];h=a[12];d=a[13];k=a[14];f[10]=e*b[0]+g*b[5]+h*b[10]+d*b[15];f[11]=e*b[1]+g*b[6]+h*b[11]+d*b[16];f[12]=e*b[2]+g*b[7]+h*b[12]+d*b[17];f[13]=e*b[3]+g*b[8]+h*b[13]+d*b[18];f[14]=e*b[4]+g*b[9]+h*b[14]+d*b[19]+k;e=a[15];g=a[16];h=a[17];d=a[18];k=a[19];f[15]=e*b[0]+g*b[5]+h*b[10]+d*b[15];f[16]=e*b[1]+g*b[6]+h*b[11]+d*b[16];f[17]=e*b[2]+g*b[7]+h*b[12]+d*b[17];f[18]=e*b[3]+g*b[8]+h*b[13]+d*b[18];f[19]=e*b[4]+g*b[9]+h*b[14]+d*b[19]+k;b=f}else b=new x(a);this._matrix=b;return this},
combineWith:function(a){return this.concat(a.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(a){this._matrix=a;return this},_apply:function(a){if(!this._matrix)return a;for(var b=a.length,f=this._matrix,e=0,g,h,d,k;e<b;)g=a[e],h=a[e+1],d=a[e+2],k=a[e+3],a[e]=f[0]*g+f[1]*h+f[2]*d+f[3]*k+f[4],a[e+1]=f[5]*g+f[6]*h+f[7]*d+f[8]*k+f[9],a[e+2]=f[10]*g+f[11]*h+f[12]*d+f[13]*k+f[14],a[e+3]=f[15]*g+f[16]*h+f[17]*d+f[18]*k+f[19],e+=4;return a},apply:function(a){if(!this._matrix)return a;
return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(a){function x(a){var c=new b(256),e=0;if(a)for(;e<256;)c[e]=255-e,e++;else for(;e<256;)c[e]=e,e++;return c}function q(a){for(var c=new b(256),e=0;e<256;)c[e]=a,e++;return c}function c(a){if(a)return new b(a);return null}var b=a.ImArray,f=Math.pow,e=Math.exp,g=1/255,h=x(),d=x(1);a.TableLookupFilter=function(a,b,c,e){this._tableR=a||null;this._tableG=b||this._tableR;this._tableB=c||this._tableG;this._tableA=e||null};a.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(a,c,e){a.length||(a=[a]);c||(c=a);e||(e=c);var f=a.length,d=f+1,g=c.length,h=g+1,t=e.length,n=t+1,u=new b(256),v=new b(d),C=new b(256),N=new b(h),Q=new b(256),$=new b(n),j,T=255/(d-1),U=255/(h-1),K=255/(n-1);for(j=0;j<d;)v[j]=~~(T*j),j++;a[0]=~~(255*a[0]);for(j=1;j<f;)a[j]=a[j-1]+~~(255*a[j]),j++;for(j=0;j<h;)N[j]=~~(U*j),j++;c[0]=~~(255*c[0]);for(j=1;j<g;)c[j]=c[j-1]+~~(255*c[j]),j++;for(j=0;j<n;)$[j]=~~(K*j),j++;e[0]=~~(255*e[0]);for(j=1;j<t;)e[j]=e[j-1]+~~(255*e[j]),j++;for(j=
0;j<256;){for(d=0;d<f&&j>a[d];)d++;u[j]=v[d];for(d=0;d<g&&j>c[d];)d++;C[j]=N[d];for(d=0;d<t&&j>e[d];)d++;Q[j]=$[d];j++}return this.concat(u,C,Q)},threshold:function(a,b,c){a=a||0.5;b=b||a;return this.thresholds([a],[b],[c||b])},quantize:function(a){typeof a=="undefined"&&(a=64);a<2&&(a=2);var c=new b(256),e=new b(a),d,f=255/(a-1),g=a/256;for(d=0;d<a;)e[d]=~~(f*d),d++;for(d=0;d<256;)c[d]=e[~~(g*d)],d++;return this.concat(c)},levels:function(a){return this.quantize(a)},posterize:function(a){return this.quantize(a)},
binarize:function(){return this.quantize(2)},solarize:function(a){typeof a=="undefined"&&(a=0.5);for(var c=0,e=new b(256),a=~~(a*256)-1,c=0;c<256;)e[c]=c>a?255-(c<<1):(c<<1)-255,c++;return this.concat(e)},invert:function(){return this.concat(d)},mask:function(a){var c=0,e=a>>16&255,d=a>>8&255;a&=255;tR=new b(256);tG=new b(256);tB=new b(256);for(c=0;c<256;)tR[c]=c&e,tG[c]=c&d,tB[c]=c&a,c++;return this.concat(tR,tG,tB)},replace:function(a,b){if(a==b)return this;var e=a>>16&255,d=a>>8&255,f=a&255,g=
b>>16&255,l=b>>8&255,t=b&255,n=c(h),u=c(h),v=c(h);n[e]=g;u[d]=l;v[f]=t;return this.concat(n,u,v)},extract:function(b,c,e){if(!c||!c.length)return this;var e=e||0,d=e>>8&255,f=e&255,e=q(e>>16&255),d=q(d),f=q(f);switch(b){case a.CHANNEL.BLUE:b=c[0];for(c=c[1];b<=c;)f[b]=b,b++;break;case a.CHANNEL.GREEN:b=c[0];for(c=c[1];b<=c;)d[b]=b,b++;break;default:b=c[0];for(c=c[1];b<=c;)e[b]=b,b++}return this.concat(e,d,f)},gammaCorrection:function(a,c,e){for(var a=a||1,c=c||a,e=e||c,a=1/a,c=1/c,e=1/e,d=new b(256),
h=new b(256),m=new b(256),l=0;l<256;)d[l]=~~(255*f(g*l,a)),h[l]=~~(255*f(g*l,c)),m[l]=~~(255*f(g*l,e)),l++;return this.concat(d,h,m)},exposure:function(a){typeof a=="undefined"&&(a=1);for(var c=0,d=new b(256),c=0;c<256;)d[c]=~~(255*(1-e(-a*c*g))),c++;return this.concat(d)},concat:function(a,b,e){if(!a)return this;var b=b||a,e=e||b,d=this._tableR||x(),f,g,h=c(d),t,n,u;if(b&&e){f=this._tableG||c(d);g=this._tableB||c(f);t=c(f);n=c(g);for(u=0;u<256;)d[u]=a[h[u]],f[u]=b[t[u]],g[u]=e[n[u]],u++;this._tableR=
d;this._tableG=f;this._tableB=g}else{for(u=0;u<256;)d[u]=a[h[u]],u++;this._tableB=this._tableG=this._tableR=d}return this},combineWith:function(a){return this.concat(a.getTable(0),a.getTable(1),a.getTable(2))},getTable:function(b){b=b||a.CHANNEL.RED;switch(b){case a.CHANNEL.ALPHA:return this._tableA;case a.CHANNEL.BLUE:return this._tableB;case a.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(b,c){c=c||a.CHANNEL.RED;switch(c){case a.CHANNEL.ALPHA:return this._tableA=
b,this;case a.CHANNEL.BLUE:return this._tableB=b,this;case a.CHANNEL.GREEN:return this._tableG=b,this;default:return this._tableR=b,this}},_apply:function(a){if(!this._tableR)return a;var b=a.length,c=0,e,d,f,g,h=this._tableR,n=this._tableG,u=this._tableB,v=this._tableA;if(v)for(;c<b;)e=a[c],d=a[c+1],f=a[c+2],g=a[c+3],a[c]=h[e],a[c+1]=n[d],a[c+2]=u[f],a[c+3]=v[g],c+=4;else for(;c<b;)e=a[c],d=a[c+1],f=a[c+2],a[c]=h[e],a[c+1]=n[d],a[c+2]=u[f],c+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(a){var x=a.ImArray,q=Math.min;a.DisplacementMapFilter=function(a){a&&this.setMap(a)};a.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:a.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},_apply:function(c,b,f){if(!this._map)return c;var e=this._map.getData(),g=this._map.width,h=this._map.height,d=g*h,k=new a.Array16I(d<<1),r=q(g,b),A=q(h,f),o=
this.scaleX*0.00390625,s=this.scaleY*0.00390625,m=this.componentX,l=this.componentY,h=this.color>>24&255,t=this.color>>16&255,n=this.color>>8&255,u=this.color&255,v=~~this.startY,C=~~this.startX,N=this.mode,Q=v*b,$=-C,j=-v,T=b-C-1,U=f-v-1,K,M,R,V,W,E=r*A<<2,w=new x(c),p=a.MODE.IGNORE,ca=a.MODE.COLOR,O=a.MODE.WRAP;for(V=R=M=K=A=0;A<d;)W=M+V<<2,k[K]=~~((e[W+m]-128)*o),k[K+1]=~~((e[W+l]-128)*s),A++,K+=2,M++,M>=g&&(M=0,R++,V+=g);A=-4;M=-1;for(ty2=V=R=0;A<E;)if(A+=4,M++,M>=r&&(M=0,R++,V+=b,ty2+=g),!(R<
j||R>U||M<$||M>T)){o=M+C;d=R+v;e=o+V+Q<<2;K=M+ty2<<1;srcx=o+k[K];srcy=d+k[K+1];if(srcy>=f||srcy<0||srcx>=b||srcx<0)switch(N){case p:continue;case ca:w[e]=t;w[e+1]=n;w[e+2]=u;w[e+3]=h;continue;case O:srcy>U&&(srcy-=f);srcy<0&&(srcy+=f);srcx>T&&(srcx-=b);srcx<0&&(srcx+=b);break;default:srcy>U&&(srcy=U),srcy<0&&(srcy=0),srcx>T&&(srcx=T),srcx<0&&(srcx=0)}K=srcx+srcy*b<<2;w[e]=c[K];w[e+1]=c[K+1];w[e+2]=c[K+2];w[e+3]=c[K+3]}return w},apply:function(a){if(!this._map)return a;return a.setData(this._apply(a.getData(),
a.width,a.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function x(a,b){var c,e,d,f,j,g=a.length,h=new A(g);for(d=e=c=f=0;f<g;)j=b-1-c+d<<2,h[f]=a[j],h[f+1]=a[j+1],h[f+2]=a[j+2],h[f+3]=a[j+3],f+=4,c++,c>=b&&(c=0,e++,d+=b);return h}function q(a,b,c){var e,d,f,j,g=a.length,h=new A(g);d=e=f=0;for(c=(c-1)*b;f<g;)j=e+c<<2,h[f]=a[j],h[f+1]=a[j+1],h[f+2]=a[j+2],h[f+3]=a[j+3],f+=4,e++,e>=b&&(e=0,d++,c-=b);return h}function c(a,b,c){var e,d,f,j,g,h=a.length,k=new A(h);d=e=j=0;for(c=(c-1)*b;j<h;)g=b-1-e+c<<2,k[j]=a[g],k[j+1]=a[g+1],k[j+2]=a[g+2],k[j+
3]=a[g+3],j+=4,e++,e>=b&&(e=0,d++,f+=b,c-=b);return k}function b(a,b,c){var e,d,f,j,g=a.length,h=new A(g),k=c*b;e=c=f=0;for(d=k-1;f<g;)j=e+d<<2,h[f]=a[j],h[f+1]=a[j+1],h[f+2]=a[j+2],h[f+3]=a[j+3],f+=4,c++,d-=b,c>=b&&(c=0,d=k-1,e++);return h}function f(a,b){var c,e,d,f,j,g=a.length,h=new A(g);for(d=e=c=f=0;f<g;)j=b-1-e+d<<2,h[f]=a[j],h[f+1]=a[j+1],h[f+2]=a[j+2],h[f+3]=a[j+3],f+=4,c++,d+=b,c>=b&&(d=c=0,e++);return h}function e(b,v,c){var e,d,f,j,g=b.length,h=new A(g),k=this.inverseTransform,l=this.mode,
s=a.MODE.WRAP,o;for(d=e=f=0;f<g;){o=k([e,d],v,c);j=~~o[0];o=~~o[1];if(0>j||j>=v||0>o||o>=c)switch(l){case s:o>=c&&(o-=c);o<0&&(o+=c);j>=v&&(j-=v);j<0&&(j+=v);break;default:o>=c&&(o=c-1),o<0&&(o=0),j>=v&&(j=v-1),j<0&&(j=0)}j=j+o*v<<2;h[f]=b[j];h[f+1]=b[j+1];h[f+2]=b[j+2];h[f+3]=b[j+3];f+=4;e++;e>=v&&(e=0,d++)}return h}function g(b,v,c){var e,d,f,j,g=v*c,h=b.length,k=new A(h),l=this.a,o=this.b,s=this.c,n=this.d,r=this.mode,w=a.MODE.WRAP,p,t=v-1,m=g-v;d=e=c=f=0;for(n*=v;f<h;){j=~~(l*c+s);p=~~(o*d+n);
if(0>j||j>t||0>p||p>m)switch(r){case w:p>m&&(p-=g);p<0&&(p+=g);j>=v&&(j-=v);j<0&&(j+=v);break;default:p>m&&(p=m),p<0&&(p=0),j>t&&(j=t),j<0&&(j=0)}j=j+p<<2;k[f]=b[j];k[f+1]=b[j+1];k[f+2]=b[j+2];k[f+3]=b[j+3];f+=4;c++;c>=v&&(c=0,e++,d+=v)}return k}function h(b,v,c){if(0>=this.radius)return b;var e,d,f,j,g=b.length,h=new A(b),k=this.centerX,n=this.centerY,r=this.radius,t=this.mode,W=a.MODE.WRAP,E,w,p=this.angle/r,q=v-1,O=c-1;for(d=e=f=0;f<g;){E=e-k;w=d-n;j=o(E*E+w*w);if(j<r){w=s(w,E)+p*(r-j);E=~~(k+
j*l(w));w=~~(n+j*m(w));if(0>E||E>q||0>w||w>O)switch(t){case W:w>O&&(w-=c);w<0&&(w+=c);E>q&&(E-=v);E<0&&(E+=v);break;default:w>O&&(w=O),w<0&&(w=0),E>q&&(E=q),E<0&&(E=0)}j=E+w*v<<2;h[f]=b[j];h[f+1]=b[j+1];h[f+2]=b[j+2];h[f+3]=b[j+3]}f+=4;e++;e>=v&&(e=0,d++)}return h}function d(b,v,c){if(0>=this.radius)return b;var e,d,f,j,g=b.length,h=new A(b),k=this.centerX,l=this.centerY;e=this.radius;var s=this.mode,r=a.MODE.WRAP,m,E=e*e,w=1-0.555556,p,q,O,x,z=v-1,B=c-1;for(d=e=f=0;f<g;){j=e-k;m=d-l;O=j*j;x=m*m;
p=O+x;if(p<E){q=E-p;p=o(q);j=t(j/o(O+q))*w;m=t(m/o(x+q))*w;j=~~(e-p*n(j));m=~~(d-p*n(m));if(0>j||j>z||0>m||m>B)switch(s){case r:m>B&&(m-=c);m<0&&(m+=c);j>z&&(j-=v);j<0&&(j+=v);break;default:m>B&&(m=B),m<0&&(m=0),j>z&&(j=z),j<0&&(j=0)}j=j+m*v<<2;h[f]=b[j];h[f+1]=b[j+1];h[f+2]=b[j+2];h[f+3]=b[j+3]}f+=4;e++;e>=v&&(e=0,d++)}return h}function k(a){return a}function r(a){return a}var A=a.ImArray,o=Math.sqrt,s=Math.atan2,m=Math.sin,l=Math.cos,t=Math.asin,n=Math.tan;a.GeometricMapFilter=function(a){this.generic(a)};
a.GeometricMapFilter.prototype={_map:null,inverseTransform:null,a:1,b:1,c:0,d:0,centerX:0,centerY:0,angle:0,radius:0,mode:a.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=e;return this},affine:function(a,b,c,e){this.a=a;this.b=b;this.c=c;this.d=e;this._map=g;return this},flipX:function(){this._map=x;return this},flipY:function(){this._map=q;return this},flipXY:function(){this._map=c;return this},rotateCW:function(){this._map=b;return this},rotateCCW:function(){this._map=f;return this},
polar:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=k;return this},cartesian:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=r;return this},twirl:function(a,b,c,e){this.angle=a||0;this.radius=b||0;this.centerX=c||0;this.centerY=e||0;this._map=h;return this},sphere:function(a,b,c){this.radius=a||0;this.centerX=b||0;this.centerY=c||0;this._map=d;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},
_apply:function(a,b,c){if(!this._map)return a;return this._map.call(this,a,b,c)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function x(a,b,c,e){var d=a.length,f,g=new o(a.length),c=c||1,e=e||1;for(f=0;f<d;)g[f]=c*a[f]+e*b[f],f++;return g}function q(a,b){var c,e,f=a.length,d,g=[],h=0;for(c=0;c<f;c++)for(e=0;e<f;e++)d=a[c]*b[e],h+=d,g.push(d);return{kernel:g,sum:h}}function c(a){var b,c=Array(a);for(b=0;b<a;)c[b]=0,b++;c[a>>1]=1;return c}function b(a){var b,c=Array(a);for(b=0;b<a;)c[b]=1,b++;return c}function f(a){var b=s.length,c,e;a--;if(a<b)c=s[a].slice();else for(c=new o(s[b-1]);b<=a;){e=c.slice();c=[1];
i=0;for(il=e.length-1;i<il;i++)c.push(e[i]+e[i+1]);c.push(1);b<40&&s.push(c.slice());b++}return c}function e(a){var b,c=-(a>>1),e=Array(a);for(b=0;b<a;)e[b]=c,c++,b++;return e}function g(a){a=f(a);return q(a,a)}function h(a,b){var c=f(a),d=e(a);return 1==b?q(d.reverse(),c):q(c,d)}function d(a,c){var f=b(a),d=e(a);return 1==c?q(d.reverse(),f):q(f,d)}function k(a,b){var b=b||1,c=a*a,e,f=new o(c);for(e=0;e<c;)f[e]=b,e++;return f}function r(b,c,e,f,d,g,h,k,l,o){var m=b.length,s,r,n,w,p,u,t,q,z,B,x,P,
S,H,D,G,L,X,Y,I,aa,ba,Z;s=c*e;p=g*h;g>>=1;h=c*(h>>1);e=-g-1;q=-h-c;X=c-1;Y=s-c;s=(s<<1)+s;t=(c<<1)+c;o=o||1;Z=0;if(d){x=f[0];f=f[p>>1];f-=x;P=d[0];d=d[p>>1];for(S=d-P;Z<o;){u=new A(b);d=new a.Array32F(s);for(r=n=w=B=z=p=0;B<c;)r+=b[p],n+=b[p+1],w+=b[p+2],d[z]=r,d[z+1]=n,d[z+2]=w,p+=4,z+=3,B++;p=t+c;z=t;for(r=n=w=B=0;p<m;)r+=b[p],n+=b[p+1],w+=b[p+2],d[z]=d[z-t]+r,d[z+1]=d[z-t+1]+n,d[z+2]=d[z-t+2]+w,p+=4,z+=3,B++,B>=c&&(r=n=w=B=0);for(n=r=B=p=0;p<m;)H=B+e,D=n+q,G=B+g,L=n+h,H<0?H=0:G>X&&(G=X),D<0?D=
0:L>Y&&(L=Y),w=H+D,z=G+L,D=G+D,I=H+L,w=(w<<1)+w,D=(D<<1)+D,I=(I<<1)+I,z=(z<<1)+z,H=x*(d[z]-d[D]-d[I]+d[w])+f*b[p],L=x*(d[z+1]-d[D+1]-d[I+1]+d[w+1])+f*b[p+1],G=x*(d[z+2]-d[D+2]-d[I+2]+d[w+2])+f*b[p+2],aa=P*(d[z]-d[D]-d[I]+d[w])+S*b[p],ba=P*(d[z+1]-d[D+1]-d[I+1]+d[w+1])+S*b[p+1],w=P*(d[z+2]-d[D+2]-d[I+2]+d[w+2])+S*b[p+2],u[p]=~~(k*H+l*aa),u[p+1]=~~(k*L+l*ba),u[p+2]=~~(k*G+l*w),p+=4,B++,B>=c&&(B=0,r++,n+=c);b=u;Z++}}else{x=f[0];f=f[p>>1];f-=x;k=k||1;for(l=l||0;Z<o;){u=new A(b);d=new a.Array32F(s);for(r=
n=w=B=z=p=0;B<c;)r+=b[p],n+=b[p+1],w+=b[p+2],d[z]=r,d[z+1]=n,d[z+2]=w,p+=4,z+=3,B++;p=t+c;z=t;for(r=n=w=B=0;p<m;)r+=b[p],n+=b[p+1],w+=b[p+2],d[z]=d[z-t]+r,d[z+1]=d[z-t+1]+n,d[z+2]=d[z-t+2]+w,p+=4,z+=3,B++,B>=c&&(r=n=w=B=0);for(n=r=B=p=0;p<m;)H=B+e,D=n+q,G=B+g,L=n+h,H<0?H=0:G>X&&(G=X),D<0?D=0:L>Y&&(L=Y),w=H+D,z=G+L,D=G+D,I=H+L,w=(w<<1)+w,D=(D<<1)+D,I=(I<<1)+I,z=(z<<1)+z,H=x*(d[z]-d[D]-d[I]+d[w])+f*b[p],L=x*(d[z+1]-d[D+1]-d[I+1]+d[w+1])+f*b[p+1],G=x*(d[z+2]-d[D+2]-d[I+2]+d[w+2])+f*b[p+2],u[p]=~~(k*
H+l),u[p+1]=~~(k*L+l),u[p+2]=~~(k*G+l),p+=4,B++,B>=c&&(B=0,r++,n+=c);b=u;Z++}}return u}var A=a.ImArray,o=a.Array32F,s=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],m=a.CONSTANTS.toRad,l=Math.abs,t=Math.sqrt,n=Math.sin,u=Math.cos;a.ConvolutionMatrixFilter=function(a,b,c){typeof a!="undefined"&&a.length?(this.set(a,~~(t(a.length)+0.5),b||1),this._bias=c||0):(this._matrix=null,this._dim=0);this._coeff1=this._coeff2=this._matrix2=
null;this._isGrad=!1;this._doFast=0};a.ConvolutionMatrixFilter.prototype={_dim:0,_matrix:null,_factor:1,_bias:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(k(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,b){var a=typeof a=="undefined"?3:a%2?a:a+1,c=a*a,d=-(typeof b=="undefined"?1:b)/c,e=k(a,d);e[c>>1]=1+d;this.set(e,a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},verticalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,d,e=
a;d=c(e);e=b(e);d=q(e,d);return this.set(d.kernel,a,1/d.sum)},horizontalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,d,e=a;d=c(e);e=b(e);d=q(d,e);return this.set(d.kernel,a,1/d.sum)},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=g(a);return this.set(b.kernel,a,1/b.sum)},binomialHighPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=g(a);return this.set(x(k(a),new o(b.kernel),1,-1/b.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},fastGauss:function(a,
b){b=typeof b=="undefined"?3:b%2?b:b+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(k(b),b,1/(b*b));this._doFast=a;return this},sharpen:function(a,b){a=typeof a=="undefined"?0.5:a;return a<=0?this.set([0,-2,0,-2,10,-2,0,-2,0],3,0.5):this.highPass(b,a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(d(a,0).kernel,a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(d(a,1).kernel,a,1)},prewittDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;
a*=m;var c=u(a),e=n(a),f=d(b,0),g=d(b,1);return this.set(x(new o(f.kernel),new o(g.kernel),c,e),b,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=d(a,0),c=d(a,1);this.set(b.kernel,a,1);this._isGrad=!0;this._matrix2=new o(c.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},gradDirectional:function(a,b){return this.prewittDirectional(a,b)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:
a%2?a:a+1;return this.set(h(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(h(a,1).kernel,a,1)},sobelDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=m;var c=u(a),d=n(a),e=h(b,0),f=h(b,1);return this.set(x(new o(e.kernel),new o(f.kernel),c,d),b,1)},sobel:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=h(a,0),c=h(a,1);this.set(b.kernel,a,1);this._matrix2=new o(c.kernel);this._isGrad=!0;return this},laplace:function(a){var a=typeof a=="undefined"?
3:a%2?a:a+1,b=k(a,-1),c=a*a;b[c>>1]=c-1;this.set(b,a,1);this._doFast=1;return this},emboss:function(a,b,c){var c=typeof c=="undefined"?3:c%2?c:c+1,a=typeof a=="undefined"?-0.25*Math.PI:a*m,b=b||1,d=b*u(a),a=-b*n(a),b=c,e=b*b,f=b>>1,g,h=new o(e),k,l,r;k=r=-f*d;l=-f*a;for(g=f=0;f<e;)h[f]=k+l,f++,g++,k+=d,g>=b&&(g=0,k=r,l+=a);h[c*c>>1]=1;return this.set(h,c,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,b,c){this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=
!1;this._doFast=0;this._matrix=new o(a);this._dim=b;this._factor=c||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,b){this._matrix=a;this._dim=b;this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;return this},_apply:function(b,c,d){if(!this._matrix)return b;if(this._doFast)return this._matrix2?r(b,c,d,this._matrix,this._matrix2,this._dim,this._dim,this._coeff1,this._coeff2,this._doFast):r(b,c,d,this._matrix,
null,this._dim,this._dim,this._factor,this._bias,this._doFast);var e=this._dim,f=this._dim,g=e>>1,h=e*f,k=(f>>1)*c,f=this._matrix,n=this._factor,o=this._bias,s=this._matrix2,m,u=this._isGrad,t=new a.Array16I(h<<1),w=new a.Array8U(h),p=c*d,d=b.length,q=new A(d),x,J,z,B,F,P,S=c-1,H=p-c,D=this._coeff1,G=this._coeff2;for(B=z=J=x=p=0;x<h;)w[x]=J+z,t[p]=J-g,t[p+1]=B-k,p+=2,x++,J++,J>=e&&(J=0,z+=e,B+=c);if(s)for(z=J=e=0;e<d;){for(x=p=P=o=n=B=k=g=0;x<h;)F=J+t[p],m=z+t[p+1],F>=0&&F<=S&&m>=0&&m<=H&&(F=F+m<<
2,m=f[w[x]],g+=b[F]*m,k+=b[F+1]*m,B+=b[F+2]*m,m=s[w[x]],n+=b[F]*m,o+=b[F+1]*m,P+=b[F+2]*m),p+=2,x++;u?(q[e]=~~(l(g)+l(n)),q[e+1]=~~(l(k)+l(o)),q[e+2]=~~(l(B)+l(P))):(q[e]=~~(D*g+G*n),q[e+1]=~~(D*k+G*o),q[e+2]=~~(D*B+G*P));q[e+3]=b[e+3];e+=4;J++;J>=c&&(J=0,z+=c)}else for(z=J=e=0;e<d;){for(x=p=B=k=g=0;x<h;)F=J+t[p],m=z+t[p+1],F>=0&&F<=S&&m>=0&&m<=H&&(F=F+m<<2,m=f[w[x]],g+=b[F]*m,k+=b[F+1]*m,B+=b[F+2]*m),p+=2,x++;q[e]=~~(n*g+o);q[e+1]=~~(n*k+o);q[e+2]=~~(n*B+o);q[e+3]=b[e+3];e+=4;J++;J>=c&&(J=0,z+=c)}return q},
apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(a){var x=a.ImArray,q=function(b,c,f){var d=this._dim,k=d>>1,r=d*d,q=k*c,o=new a.Array32I(r<<1),s=c*f,f=b.length,m=new x(f),l,t,n=[],u=[],v=[];r<<=1;var C=c-1,N=s-c;for(t=s=l=0;l<r;)o[l]=s-k,o[l+1]=t-q,l+=2,s++,s>=d&&(s=0,t+=c);for(t=s=d=0;d<f;){n.length=0;u.length=0;for(l=v.length=0;l<r;)k=s+o[l],q=t+o[l+1],k>=0&&k<=C&&q>=0&&q<=N&&(k=k+q<<2,n.push(b[k]),u.push(b[k+1]),v.push(b[k+2])),l+=2;n.sort();u.sort();v.sort();l=(n.length>>1)+1;(k=n.length%2)?(m[d]=n[l],m[d+1]=u[l],m[d+2]=v[l]):(m[d]=
~~(0.5*(n[l-1]+n[l])),m[d+1]=~~(0.5*(u[l-1]+u[l])),m[d+2]=~~(0.5*(v[l-1]+v[l])));m[d+3]=b[d+3];d+=4;s++;s>=c&&(s=0,y++,t+=c)}return m},c=function(b,c,f){var d=this._dim,k=d>>1,r=d*d,q=k*c,o=new a.Array32I(r<<1),s=c*f,f=b.length,m=new x(f),l,t,n,u,v,C;r<<=1;var N=c-1,Q=s-c;for(t=l=s=0;s<r;)o[s]=l-k,o[s+1]=t-q,s+=2,l++,l>=d&&(l=0,t+=c);for(t=l=d=0;d<f;){for(s=C=q=k=0;s<r;)n=l+o[s],u=t+o[s+1],n>=0&&n<=N&&u>=0&&u<=Q&&(v=n+u<<2,n=b[v],u=b[v+1],v=b[v+2],n>k&&(k=n),u>q&&(q=u),v>C&&(C=v)),s+=2;m[d]=k;m[d+
1]=q;m[d+2]=C;m[d+3]=b[d+3];d+=4;l++;l>=c&&(l=0,t+=c)}return m},b=function(b,c,f){var d=this._dim,k=d>>1,r=d*d,q=k*c,o=new a.Array32I(r<<1),s=c*f,f=b.length,m=new x(f),l,t,n,u,v,C;r<<=1;var N=c-1,Q=s-c;for(t=l=s=0;s<r;)o[s]=l-k,o[s+1]=t-q,s+=2,l++,l>=d&&(l=0,t+=c);for(t=l=d=0;d<f;){C=q=k=255;for(s=0;s<r;)n=l+o[s],u=t+o[s+1],n>=0&&n<=N&&u>=0&&u<=Q&&(v=n+u<<2,n=b[v],u=b[v+1],v=b[v+2],n<k&&(k=n),u<q&&(q=u),v<C&&(C=v)),s+=2;m[d]=k;m[d+1]=q;m[d+2]=C;m[d+3]=b[d+3];d+=4;l++;l>=c&&(l=0,t+=c)}return m},f=
function(a){return a};a.StatisticalFilter=function(){this._dim=0;this._apply=f};a.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=q;return this},erode:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=b;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=c;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},
reset:function(){this._apply=f;this._dim=0;return this}}})(FILTER);
