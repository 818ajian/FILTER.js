/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.2
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(c){function z(c,l){var c=c||{},a;for(a in l)l&&Object.prototype.hasOwnProperty.call(l,a)&&(c[a]=l[a]);return c}c.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;c.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;c.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;c.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;c.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;c.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;c.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;c.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;c.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:c.Array8U;c._notSupportTypedArrays=!c.ImArray.set;c.CONSTANTS={PI:Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI};c.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};c.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};c.LUMA=new c.Array32F([0.212671,0.71516,0.072169]);c.Filter=function(){};c.Filter.prototype={_apply:function(){},apply:function(){},
reset:function(){}};c.CompositeFilter=function(c){this._stack=typeof c!="undefined"&&c.length?c:[]};c.CompositeFilter.prototype={_stack:[],_apply:function(c,l,a){if(!this._stack.length)return c;for(var b=this._stack,d=b.length,f=0,h;f<d;)(h=b[f++])&&(c=h._apply(c,l,a));return c},apply:function(c){if(!this._stack.length)return c;return c.setData(this._apply(im=c.getData(),c.width,c.height))},filters:function(c){if(c)this._stack=c;return this},push:function(c){this._stack.push(c);return this},pop:function(){return this._stack.pop()},
shift:function(){return this._stack.shift()},unshift:function(c){this._stack.unshift(c);return this},concat:function(c){return this.push(c)},getAt:function(c){return this._stack.length>c?this._stack[c]:null},setAt:function(c,l){this._stack.length>c&&(this._stack[c]=l);return this},insertAt:function(c,l){this._stack.splice(c,0,l);return this},removeAt:function(c){this._stack.splice(c,1);return this},remove:function(c){for(var l=this._stack.length;--l>=0;)c===this._stack[l]&&this._stack.splice(l,1);
return this},reset:function(){this._stack.length=0;return this}};c.Create=function(c){var l=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},c=z({init:function(){},reset:function(){return this},apply:function(a){return a}},c);c._apply=c.apply;c.apply=function(a){return a.setData(this._apply(a.getData(),a.width,a.height))};l.prototype=z(l.prototype,c);return l}})(FILTER);
(function(c){var z=Math.sqrt,q=Math.min,l=Math.max;c.Color={blend:function(a,b,d){return{r:a.r-~~((a.r-b.r)*d+0.5),g:a.g-~~((a.g-b.g)*d+0.5),b:a.b-~~((a.b-b.b)*d+0.5)}},toGray:function(a,b,d){var f=c.LUMA;return~~(f[0]*a+f[1]*b+f[2]*d)},distance:function(a,b){var d=a.r-b.r,f=a.g-b.g,c=a.b-b.b;return z(d*d+f*f+c*c)},RGB2Color:function(a){return a.r<<16|a.g<<8|a.b&255},RGBA2Color:function(a){return a.a<<24|a.r<<16|a.g<<8|a.b&255},Color2RGBA:function(a){a=~~a;return{r:a>>16&255,g:a>>8&255,b:a&255,a:a>>
24&255}},RGB2YCbCr:function(a){var b=a.r,d=a.g,a=a.b;return{y:~~(0+0.299*b+0.587*d+0.114*a),cb:~~(128-0.168736*b-0.331264*d+0.5*a),cr:~~(128+0.5*b-0.418688*d-0.081312*a)}},YCbCr2RGB:function(a){var b=a.y,d=a.cb,a=a.cr;return{r:~~(b+1.402*(a-128)),g:~~(b-0.34414*(d-128)-0.71414*(a-128)),b:~~(b+1.772*(d-128))}},RGB2HSV:function(a){var b,d,f,c;d=a.r;f=a.g;c=a.b;b=q(d,f,c);a=l(d,f,c);b=a-b;if(a==0)return{h:0,s:0,v:a};d=d==a?(f-c)/b:f==a?2+(c-d)/b:4+(d-f)/b;d*=60;d<0&&(d+=360);return{h:d,s:b/a,v:a}},HSV2RGB:function(a){var b,
d,f,c,e;f=a.h;e=a.s;a=a.v;if(e==0)return b=d=a,{r:b,g:d,b:a};f/=60;b=~~f;d=f-b;f=a*(1-e);c=a*(1-e*d);e=a*(1-e*(1-d));switch(b){case 0:b=a;d=e;a=f;break;case 1:b=c;d=a;a=f;break;case 2:b=f;d=a;a=e;break;case 3:b=f;d=c;break;case 4:b=e;d=f;break;default:b=a,d=f,a=c}return{r:b,g:d,b:a}}}})(FILTER);
(function(c){function z(d,a){var b=document.createElement("canvas");b.width=d||0;b.height=a||0;return b}var q,l=Math.min,a=c.ImArray;q={normal:function(d){return d},lighten:function(d,a){return a>d?a:d},darken:function(d,a){return a>d?d:a},multiply:function(d,a){return d*a*0.003921568627451},average:function(d,a){return 0.5*(d+a)},add:function(d,a){return Math.min(255,d+a)},substract:function(d,a){return d+a<255?0:d+a-255},difference:function(d,a){return Math.abs(d-a)},negation:function(d,a){return 255-
Math.abs(255-d-a)},screen:function(d,a){return 255-((255-d)*(255-a)>>8)},exclusion:function(d,a){return d+a-2*d*a*0.003921568627451},overlay:function(d,a){return a<128?2*d*a*0.003921568627451:255-2*(255-d)*(255-a)*0.003921568627451},softLight:function(d,a){return a<128?2*((d>>1)+64)*a*0.003921568627451:255-2*(255-((d>>1)+64))*(255-a)*0.003921568627451},hardLight:function(d,a){return d<128?2*a*d*0.003921568627451:255-2*(255-a)*(255-d)*0.003921568627451},colorDodge:function(d,a){return a==255?a:Math.min(255,
(d<<8)/(255-a))},colorBurn:function(d,a){return a==0?a:Math.max(0,255-(255-d<<8)/a)},linearLight:function(d,a){return a<128?q.linearBurn(d,2*a):q.linearDodge(d,2*(a-128))},vividLight:function(d,a){return a<128?q.colorBurn(d,2*a):q.colorDodge(d,2*(a-128))},pinLight:function(d,a){return a<128?q.darken(d,2*a):q.lighten(d,2*(a-128))},hardMix:function(d,a){return q.vividLight(d,a)<128?0:255},reflect:function(d,a){return a==255?a:Math.min(255,d*d/(255-a))},glow:function(d,a){return d==255?d:Math.min(255,
a*a/(255-d))},phoenix:function(d,a){return Math.min(d,a)-Math.max(d,a)+255}};q.linearDodge=q.add;q.linearBurn=q.substract;c.blendModes=q;var b=c._notSupportTypedArrays;c.Image=function(d,a){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=z(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=z(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(d,a)};
c.Image.prototype={width:0,height:0,canvasElement:null,domElement:null,clear:function(){var d=this.context;d.clearRect(0,0,this.width,this.height);this.imageData=d.getImageData(0,0,this.width,this.height);return this},fill:function(d,a,b,c,j){var c=c||this.width,j=j||this.height,t=this.context;t.fillStyle=d||0;t.fillRect(a||0,b||0,c,j);this.imageData=t.getImageData(0,0,this.width,this.height);return this},draw:function(){return this},getPixel:function(d,a){var b=~~(a*this.width+d+0.5),c=this.imageData.data;
return{red:c[b],green:c[b+1],blue:c[b+2],alpha:c[b+3]}},setPixel:function(d,b,c,e,j,t){this.context.putImageData(new a([c&255,e&255,j&255,t&255]),d,b);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new a(this.imageData.data)},_setData:function(d){for(var a=this.imageData.data,b=d.length,c=0,j;c<b;)j=~~d[c],j>255?j=255:j<0&&(j=0),a[c]=j,c++},setData:function(d){b?this._setData(d):this.imageData.data.set(d);
this.context.putImageData(this.imageData,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(d){this.context.putImageData(d,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setWidth:function(d){this._tmpCanvas.width=this.canvasElement.width=this.width=d;this.context=
this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setHeight:function(d){this._tmpCanvas.height=this.canvasElement.height=this.height=d;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setImage:function(d,a){if(typeof d=="undefined"||d==null)return this;var b=
this,c;d instanceof Image||d instanceof HTMLCanvasElement||d instanceof HTMLVideoElement?(c=d,this.width=d instanceof HTMLVideoElement?d.videoWidth:d.width,this.height=d instanceof HTMLVideoElement?d.videoHeight:d.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,this.context=this.canvasElement.getContext("2d"),this.context.drawImage(c,0,0),this.imageData=this.context.getImageData(0,0,this.width,this.height),this._integralRefresh=
this._histogramRefresh=!0):(c=new Image,c.onload=function(){b.width=c.width;b.height=c.height;b._tmpCanvas.width=b.canvasElement.width=b.width;b._tmpCanvas.height=b.canvasElement.height=b.height;b.context=b.canvasElement.getContext("2d");b.context.drawImage(c,0,0);b.imageData=b.context.getImageData(0,0,b.width,b.height);b._histogramRefresh=!0;b._integralRefresh=!0;typeof a!="undefined"&&a.call(b)},c.src=d);c.crossOrigin="";return this},blend:function(d,a,b,c,j){typeof a=="undefined"&&(a="normal");
typeof b=="undefined"&&(b=1);b>1&&(b=1);b<0&&(b=0);typeof c=="undefined"&&(c=0);typeof j=="undefined"&&(j=0);var t=0,A=0;c<0&&(t=-c,c=0);j<0&&(A=-j,j=0);if(!(c>=this.width||j>=this.height)){a=q[a];if(a==void 0||a==null)return this;var m=l(this.width,d.width-t),r=l(this.height,d.height-A),n=this.context.getImageData(c,j,m,r),t=d.context.getImageData(t,A,m,r),d=n.data,t=t.data,k,B,w,o=1-b,s=t.length,D;for(D=0;D<s;D+=4)k=d[D],B=d[D+1],w=d[D+2],A=a(t[D],k),m=a(t[D+1],B),r=a(t[D+2],w),d[D]=A*b+k*o,d[D+
1]=m*b+B*o,d[D+2]=r*b+w*o;this.context.putImageData(n,c,j);this._integralRefresh=this._histogramRefresh=!0;return this}},_refresh:function(){this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},copy:function(a){this.setData(a.getData());this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},clone:function(){return new c.Image(this.canvasElement)},integral:function(){this._integralRefresh&&this._computeIntegral();
return this._integral},_computeIntegral:function(){var a=this.width,b=a*this.height,h=a<<2,e=new c.Array32F(b),j=new c.Array32F(b),b=new c.Array32F(b),t=this.getPixelData().data,A,m,r,n,k,l;for(n=k=l=r=m=A=0;r<a;)n+=t[A],k+=t[A+1],l+=t[A+2],e[m]=n,j[m]=k,b[m]=l,A+=4,m++,r++;A=h;for(n=k=l=r=0;A<imLen;)n+=t[A],k+=t[A+1],l+=t[A+2],e[m]=e[m-a]+n,j[m]=j[m-a]+k,b[m]=b[m-a]+l,A+=4,m++,r++,r>=a&&(n=k=l=r=0);this._integral=[e,j,b];this._integralRefresh=!1},histogram:function(){this._histogramRefresh&&this._computeHistogram();
return this._histogram},_computeHistogram:function(){for(var a=this.getPixelData().data,b=0,h=a.length,e,j,t,A=0,m=0,r=0,l=255,k=255,B=255,w=new c.Array32F(256),o=new c.Array32F(256),s=new c.Array32F(256),D=1/(h>>2),b=0;b<256;)w[b]=0,o[b]=0,s[b]=0,b++;for(b=0;b<h;)e=a[b],j=a[b+1],t=a[b+2],w[e]+=D,o[j]+=D,s[t]+=D,e>A&&(A=e),e<l&&(l=e),j>m&&(m=j),j<k&&(k=j),t>r&&(r=t),t<B&&(B=t),b+=4;this._histogram=[w,o,s];this._histogramRefresh=!1},createImageData:function(a,b){this._tmpCanvas.width=this.canvasElement.width=
this.width=a;this._tmpCanvas.height=this.canvasElement.height=this.height=b;this.context=this.canvasElement.getContext("2d");this.context.createImageData(a,b);return this.imageData=this.context.getImageData(0,0,this.width,this.height)},scale:function(a,b){var a=a||1,b=b||a,c=this._tmpCanvas.getContext("2d");c.scale(a,b);c.drawImage(this.canvasElement,0,0);this.canvasElement.width=this.width=~~(a*this.width+0.5);this.canvasElement.height=this.height=~~(b*this.height+0.5);this.context.drawImage(this._tmpCanvas,
0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipHorizontal:function(){var a=this._tmpCanvas.getContext("2d");a.translate(this.width,0);a.scale(-1,1);a.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=
!0;return this},flipVertical:function(){var a=this._tmpCanvas.getContext("2d");a.translate(0,this.height);a.scale(1,-1);a.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this}}})(FILTER);
(function(c){c.CustomFilter=function(c){this._handler=c};c.CustomFilter.prototype={_handler:null,_apply:function(c,q,l){if(!this._handler)return c;return this._handler.call(this,c,q,l)},apply:function(c){if(!this._handler)return c;return c.setData(this._handler.call(this,c.getData(),c.width,c.height))}}})(FILTER);
(function(c){var z=c.Array32F,q=c.CONSTANTS.toRad,l=c._notSupportTypedArrays;c.ColorMatrixFilter=function(a){this._matrix=typeof a!="undefined"&&a.length?new z(a):null};c.ColorMatrixFilter.prototype={_matrix:null,channel:function(a,b){var d=(typeof b=="undefined"?0:b)?1:0;switch(a){case c.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case c.CHANNEL.BLUE:return this.concat([0,0,d,0,0,0,0,d,0,0,0,0,1,0,0,0,0,0,0,255]);case c.CHANNEL.GREEN:return this.concat([0,d,0,0,
0,0,1,0,0,0,0,d,0,0,0,0,0,0,0,255]);default:return this.concat([1,0,0,0,0,d,0,0,0,0,d,0,0,0,0,0,0,0,0,255])}},redChannel:function(a){return this.channel(c.CHANNEL.RED,a)},greenChannel:function(a){return this.channel(c.CHANNEL.GREEN,a)},blueChannel:function(a){return this.channel(c.CHANNEL.BLUE,a)},alphaChannel:function(){return this.channel(c.CHANNEL.ALPHA,!0)},maskChannel:function(a){switch(a){case c.CHANNEL.ALPHA:return this;case c.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,1,0]);case c.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(a,b){switch(a){case c.CHANNEL.ALPHA:switch(b){case c.CHANNEL.ALPHA:return this;case c.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case c.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case c.CHANNEL.BLUE:switch(b){case c.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case c.CHANNEL.BLUE:return this;case c.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case c.CHANNEL.GREEN:switch(b){case c.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case c.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case c.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(b){case c.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case c.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case c.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([c.LUMA[0],c.LUMA[1],c.LUMA[2],0,0,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,0,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(a,b){var d,f,h,e;typeof b=="undefined"&&(b=1);d=(a>>16&255)*0.00392156862745098;f=(a>>8&255)*0.00392156862745098;h=(a&255)*0.00392156862745098;e=1-b;return this.concat([e+b*d*c.LUMA[0],b*d*c.LUMA[1],b*d*c.LUMA[2],0,0,b*f*c.LUMA[0],e+b*f*c.LUMA[1],b*f*c.LUMA[2],0,0,b*h*c.LUMA[0],b*h*c.LUMA[1],e+b*h*c.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(a){var b,d,f;b=1-a;d=b*c.LUMA[0];f=b*c.LUMA[1];b*=c.LUMA[2];return this.concat([d+a,f,b,0,0,d,f+a,b,0,0,d,f,b+a,0,0,0,0,0,1,0])},contrast:function(a,b,d){typeof b=="undefined"&&(b=a);typeof d=="undefined"&&(d=a);a+=1;b+=1;d+=1;this._log=!0;return this.concat([a,0,0,0,128*(1-a),0,b,0,0,128*(1-b),0,0,d,0,128*(1-d),0,0,0,1,0])},brightness:function(a,b,d){typeof b=="undefined"&&(b=a);typeof d=="undefined"&&(d=a);return this.concat([1,0,0,0,a,0,1,0,0,b,0,0,1,0,d,
0,0,0,1,0])},adjustHue:function(a){a*=q;var b=Math.cos(a),a=Math.sin(a);return this.concat([c.LUMA[0]+b*(1-c.LUMA[0])+a*-c.LUMA[0],c.LUMA[1]+b*-c.LUMA[1]+a*-c.LUMA[1],c.LUMA[2]+b*-c.LUMA[2]+a*(1-c.LUMA[2]),0,0,c.LUMA[0]+b*-c.LUMA[0]+a*0.143,c.LUMA[1]+b*(1-c.LUMA[1])+a*0.14,c.LUMA[2]+b*-c.LUMA[2]+a*-0.283,0,0,c.LUMA[0]+b*-c.LUMA[0]+a*-(1-c.LUMA[0]),c.LUMA[1]+b*-c.LUMA[1]+a*c.LUMA[1],c.LUMA[2]+b*(1-c.LUMA[2])+a*c.LUMA[2],0,0,0,0,0,1,0])},average:function(a,b,d){typeof a=="undefined"&&(a=0.3333);typeof b==
"undefined"&&(b=0.3333);typeof d=="undefined"&&(d=0.3334);return this.concat([a,b,d,0,0,a,b,d,0,0,a,b,d,0,0,0,0,0,1,0])},quickContrastCorrection:function(a){typeof a=="undefined"&&(a=1.2);return this.concat([a,0,0,0,0,0,a,0,0,0,0,0,a,0,0,0,0,0,1,0])},quickSepia:function(a){typeof a=="undefined"&&(a=10);a>100&&(a=100);a*=2.55;return this.concat([c.LUMA[0],c.LUMA[1],c.LUMA[2],0,40,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,20,c.LUMA[0],c.LUMA[1],c.LUMA[2],0,-a,0,0,0,1,0])},quickSepia2:function(a,b,d){typeof a==
"undefined"&&(a=1);typeof b=="undefined"&&(b=a);typeof d=="undefined"&&(d=a);return this.concat([a*0.5,0.5,0.5,0,0,0.33,b*0.33,0.33,0,0,0.25,0.25,d*0.25,0,0,0,0,0,1,0])},threshold:function(a,b){typeof b=="undefined"&&(b=256);return this.concat([c.LUMA[0]*b,c.LUMA[1]*b,c.LUMA[2]*b,0,-(b-1)*a,c.LUMA[0]*b,c.LUMA[1]*b,c.LUMA[2]*b,0,-(b-1)*a,c.LUMA[0]*b,c.LUMA[1]*b,c.LUMA[2]*b,0,-(b-1)*a,0,0,0,1,0])},threshold_rgb:function(a,b){typeof b=="undefined"&&(b=256);return this.concat([b,0,0,0,-(b-1)*a,0,b,0,
0,-(b-1)*a,0,0,b,0,-(b-1)*a,0,0,0,1,0])},threshold_alpha:function(a,b){typeof a=="undefined"&&(a=0.5);typeof b=="undefined"&&(b=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,b,-b*a])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(a,b){var d;if(this._matrix){d=
this._matrix;var c=a.getMatrix(),h=1-b,e=new z(20);e[0]=h*d[0]+b*c[0];e[1]=h*d[1]+b*c[1];e[2]=h*d[2]+b*c[2];e[3]=h*d[3]+b*c[3];e[4]=h*d[4]+b*c[4];e[5]=h*d[5]+b*c[5];e[6]=h*d[6]+b*c[6];e[7]=h*d[7]+b*c[7];e[8]=h*d[8]+b*c[8];e[9]=h*d[9]+b*c[9];e[10]=h*d[10]+b*c[10];e[11]=h*d[11]+b*c[11];e[12]=h*d[12]+b*c[12];e[13]=h*d[13]+b*c[13];e[14]=h*d[14]+b*c[14];e[15]=h*d[15]+b*c[15];e[16]=h*d[16]+b*c[16];e[17]=h*d[17]+b*c[17];e[18]=h*d[18]+b*c[18];e[19]=h*d[19]+b*c[19];d=e}else d=new z(a.getMatrix());this._matrix=
d;return this},concat:function(a){var b;if(this._matrix){b=this._matrix;var a=new z(a),c=new z(20),f,h,e,j,t;f=a[0];h=a[1];e=a[2];j=a[3];t=a[4];c[0]=f*b[0]+h*b[5]+e*b[10]+j*b[15];c[1]=f*b[1]+h*b[6]+e*b[11]+j*b[16];c[2]=f*b[2]+h*b[7]+e*b[12]+j*b[17];c[3]=f*b[3]+h*b[8]+e*b[13]+j*b[18];c[4]=f*b[4]+h*b[9]+e*b[14]+j*b[19]+t;f=a[5];h=a[6];e=a[7];j=a[8];t=a[9];c[5]=f*b[0]+h*b[5]+e*b[10]+j*b[15];c[6]=f*b[1]+h*b[6]+e*b[11]+j*b[16];c[7]=f*b[2]+h*b[7]+e*b[12]+j*b[17];c[8]=f*b[3]+h*b[8]+e*b[13]+j*b[18];c[9]=
f*b[4]+h*b[9]+e*b[14]+j*b[19]+t;f=a[10];h=a[11];e=a[12];j=a[13];t=a[14];c[10]=f*b[0]+h*b[5]+e*b[10]+j*b[15];c[11]=f*b[1]+h*b[6]+e*b[11]+j*b[16];c[12]=f*b[2]+h*b[7]+e*b[12]+j*b[17];c[13]=f*b[3]+h*b[8]+e*b[13]+j*b[18];c[14]=f*b[4]+h*b[9]+e*b[14]+j*b[19]+t;f=a[15];h=a[16];e=a[17];j=a[18];t=a[19];c[15]=f*b[0]+h*b[5]+e*b[10]+j*b[15];c[16]=f*b[1]+h*b[6]+e*b[11]+j*b[16];c[17]=f*b[2]+h*b[7]+e*b[12]+j*b[17];c[18]=f*b[3]+h*b[8]+e*b[13]+j*b[18];c[19]=f*b[4]+h*b[9]+e*b[14]+j*b[19]+t;b=c}else b=new z(a);this._matrix=
b;return this},combineWith:function(a){return this.concat(a.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(a){this._matrix=a;return this},_apply:function(a){if(!this._matrix)return a;for(var c=a.length,d=this._matrix,f=0,h,e,j,t,A,m,r;f<c;)h=a[f],e=a[f+1],j=a[f+2],t=a[f+3],A=d[0]*h+d[1]*e+d[2]*j+d[3]*t+d[4],m=d[5]*h+d[6]*e+d[7]*j+d[8]*t+d[9],r=d[10]*h+d[11]*e+d[12]*j+d[13]*t+d[14],h=d[15]*h+d[16]*e+d[17]*j+d[18]*t+d[19],l&&(A<0?A=0:A>255&&(A=255),m<0?m=0:m>255&&(m=255),
r<0?r=0:r>255&&(r=255),h<0?h=0:h>255&&(h=255)),a[f]=~~A,a[f+1]=~~m,a[f+2]=~~r,a[f+3]=~~h,f+=4;return a},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(c){function z(c){var b=new a(256),d=0;if(c)for(;d<256;)b[d]=255-d,d++;else for(;d<256;)b[d]=d,d++;return b}function q(c){for(var b=new a(256),d=0;d<256;)b[d]=c,d++;return b}function l(c){if(c)return new a(c);return null}var a=c.ImArray,b=Math.pow,d=Math.exp,f=1/255,h=z(),e=z(1);c.TableLookupFilter=function(a,c,b,d){this._tableR=a||null;this._tableG=c||this._tableR;this._tableB=b||this._tableG;this._tableA=d||null};c.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(c,b,d){c.length||(c=[c]);b||(b=c);d||(d=b);var e=c.length,f=e+1,h=b.length,k=h+1,l=d.length,w=l+1,o=new a(256),s=new a(f),D=new a(256),N=new a(k),P=new a(256),Z=new a(w),g,S=255/(f-1),T=255/(k-1),K=255/(w-1);for(g=0;g<f;)s[g]=~~(S*g),g++;c[0]=~~(255*c[0]);for(g=1;g<e;)c[g]=c[g-1]+~~(255*c[g]),g++;for(g=0;g<k;)N[g]=~~(T*g),g++;b[0]=~~(255*b[0]);for(g=1;g<h;)b[g]=b[g-1]+~~(255*b[g]),g++;for(g=0;g<w;)Z[g]=~~(K*g),g++;d[0]=~~(255*d[0]);for(g=1;g<l;)d[g]=d[g-1]+~~(255*d[g]),g++;for(g=
0;g<256;){for(f=0;f<e&&g>c[f];)f++;o[g]=s[f];for(f=0;f<h&&g>b[f];)f++;D[g]=N[f];for(f=0;f<l&&g>d[f];)f++;P[g]=Z[f];g++}return this.concat(o,D,P)},threshold:function(a,c,b){a=a||0.5;c=c||a;return this.thresholds([a],[c],[b||c])},quantize:function(c){typeof c=="undefined"&&(c=64);c<2&&(c=2);var b=new a(256),d=new a(c),e,f=255/(c-1),h=c/256;for(e=0;e<c;)d[e]=~~(f*e),e++;for(e=0;e<256;)b[e]=d[~~(h*e)],e++;return this.concat(b)},levels:function(a){return this.quantize(a)},posterize:function(a){return this.quantize(a)},
binarize:function(){return this.quantize(2)},solarize:function(c){typeof c=="undefined"&&(c=0.5);for(var b=0,d=new a(256),c=~~(c*256)-1,b=0;b<256;)d[b]=b>c?255-(b<<1):(b<<1)-255,b++;return this.concat(d)},invert:function(){return this.concat(e)},mask:function(c){var b=0,d=c>>16&255,e=c>>8&255;c&=255;tR=new a(256);tG=new a(256);tB=new a(256);for(b=0;b<256;)tR[b]=b&d,tG[b]=b&e,tB[b]=b&c,b++;return this.concat(tR,tG,tB)},replace:function(a,c){if(a==c)return this;var b=a>>16&255,d=a>>8&255,e=a&255,f=
c>>16&255,k=c>>8&255,B=c&255,w=l(h),o=l(h),s=l(h);w[b]=f;o[d]=k;s[e]=B;return this.concat(w,o,s)},extract:function(a,b,d){if(!b||!b.length)return this;var d=d||0,e=d>>8&255,f=d&255,d=q(d>>16&255),e=q(e),f=q(f);switch(a){case c.CHANNEL.BLUE:a=b[0];for(b=b[1];a<=b;)f[a]=a,a++;break;case c.CHANNEL.GREEN:a=b[0];for(b=b[1];a<=b;)e[a]=a,a++;break;default:a=b[0];for(b=b[1];a<=b;)d[a]=a,a++}return this.concat(d,e,f)},gammaCorrection:function(c,d,e){for(var c=c||1,d=d||c,e=e||d,c=1/c,d=1/d,e=1/e,h=new a(256),
r=new a(256),l=new a(256),k=0;k<256;)h[k]=~~(255*b(f*k,c)),r[k]=~~(255*b(f*k,d)),l[k]=~~(255*b(f*k,e)),k++;return this.concat(h,r,l)},exposure:function(c){typeof c=="undefined"&&(c=1);for(var b=0,e=new a(256),b=0;b<256;)e[b]=~~(255*(1-d(-c*b*f))),b++;return this.concat(e)},concat:function(a,c,b){if(!a)return this;var c=c||a,b=b||c,d=this._tableR||z(),e,f,h=l(d),B,w,o;if(c&&b){e=this._tableG||l(d);f=this._tableB||l(e);B=l(e);w=l(f);for(o=0;o<256;)d[o]=a[h[o]],e[o]=c[B[o]],f[o]=b[w[o]],o++;this._tableR=
d;this._tableG=e;this._tableB=f}else{for(o=0;o<256;)d[o]=a[h[o]],o++;this._tableB=this._tableG=this._tableR=d}return this},combineWith:function(a){return this.concat(a.getTable(0),a.getTable(1),a.getTable(2))},getTable:function(a){a=a||c.CHANNEL.RED;switch(a){case c.CHANNEL.ALPHA:return this._tableA;case c.CHANNEL.BLUE:return this._tableB;case c.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(a,b){b=b||c.CHANNEL.RED;switch(b){case c.CHANNEL.ALPHA:return this._tableA=
a,this;case c.CHANNEL.BLUE:return this._tableB=a,this;case c.CHANNEL.GREEN:return this._tableG=a,this;default:return this._tableR=a,this}},_apply:function(a){if(!this._tableR)return a;var c=a.length,b=0,d,e,f,h,l=this._tableR,w=this._tableG,o=this._tableB,s=this._tableA;if(s)for(;b<c;)d=a[b],e=a[b+1],f=a[b+2],h=a[b+3],a[b]=l[d],a[b+1]=w[e],a[b+2]=o[f],a[b+3]=s[h],b+=4;else for(;b<c;)d=a[b],e=a[b+1],f=a[b+2],a[b]=l[d],a[b+1]=w[e],a[b+2]=o[f],b+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(c){var z=c.ImArray,q=Math.min;c.DisplacementMapFilter=function(c){c&&this.setMap(c)};c.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:c.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(c){this._map=c;return this},_apply:function(l,a,b){if(!this._map)return l;var d=this._map.getData(),f=this._map.width,h=this._map.height,e=f*h,j=new c.Array16I(e<<1),t=q(f,a),A=q(h,b),m=
this.scaleX*0.00390625,r=this.scaleY*0.00390625,n=this.componentX,k=this.componentY,h=this.color>>24&255,B=this.color>>16&255,w=this.color>>8&255,o=this.color&255,s=~~this.startY,D=~~this.startX,N=this.mode,P=s*a,Z=-D,g=-s,S=a-D-1,T=b-s-1,K,M,Q,U,E,F=t*A<<2,x=new z(l),u=c.MODE.IGNORE,p=c.MODE.COLOR,V=c.MODE.WRAP;for(U=Q=M=K=A=0;A<e;)E=M+U<<2,j[K]=~~((d[E+n]-128)*m),j[K+1]=~~((d[E+k]-128)*r),A++,K+=2,M++,M>=f&&(M=0,Q++,U+=f);A=-4;M=-1;for(ty2=U=Q=0;A<F;)if(A+=4,M++,M>=t&&(M=0,Q++,U+=a,ty2+=f),!(Q<
g||Q>T||M<Z||M>S)){m=M+D;e=Q+s;d=m+U+P<<2;K=M+ty2<<1;srcx=m+j[K];srcy=e+j[K+1];if(srcy>=b||srcy<0||srcx>=a||srcx<0)switch(N){case u:continue;case p:x[d]=B;x[d+1]=w;x[d+2]=o;x[d+3]=h;continue;case V:srcy>T&&(srcy-=b);srcy<0&&(srcy+=b);srcx>S&&(srcx-=a);srcx<0&&(srcx+=a);break;default:srcy>T&&(srcy=T),srcy<0&&(srcy=0),srcx>S&&(srcx=S),srcx<0&&(srcx=0)}K=srcx+srcy*a<<2;x[d]=l[K];x[d+1]=l[K+1];x[d+2]=l[K+2];x[d+3]=l[K+3]}return x},apply:function(c){if(!this._map)return c;return c.setData(this._apply(c.getData(),
c.width,c.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(c){function z(a,b){var c,d,e,f,g,h=a.length,j=new A(h);for(e=d=c=f=0;f<h;)g=b-1-c+e<<2,j[f]=a[g],j[f+1]=a[g+1],j[f+2]=a[g+2],j[f+3]=a[g+3],f+=4,c++,c>=b&&(c=0,d++,e+=b);return j}function q(a,c,b){var d,e,f,g,h=a.length,j=new A(h);e=d=f=0;for(b=(b-1)*c;f<h;)g=d+b<<2,j[f]=a[g],j[f+1]=a[g+1],j[f+2]=a[g+2],j[f+3]=a[g+3],f+=4,d++,d>=c&&(d=0,e++,b-=c);return j}function l(a,b,c){var d,e,f,g,h,j=a.length,k=new A(j);e=d=g=0;for(c=(c-1)*b;g<j;)h=b-1-d+c<<2,k[g]=a[h],k[g+1]=a[h+1],k[g+2]=a[h+2],k[g+
3]=a[h+3],g+=4,d++,d>=b&&(d=0,e++,f+=b,c-=b);return k}function a(a,b,c){var d,e,f,g,h=a.length,j=new A(h),k=c*b;d=c=f=0;for(e=k-1;f<h;)g=d+e<<2,j[f]=a[g],j[f+1]=a[g+1],j[f+2]=a[g+2],j[f+3]=a[g+3],f+=4,c++,e-=b,c>=b&&(c=0,e=k-1,d++);return j}function b(a,c){var b,d,e,f,g,h=a.length,j=new A(h);for(e=d=b=f=0;f<h;)g=c-1-d+e<<2,j[f]=a[g],j[f+1]=a[g+1],j[f+2]=a[g+2],j[f+3]=a[g+3],f+=4,b++,e+=c,b>=c&&(e=b=0,d++);return j}function d(a,b,d){var e,f,h,g,j=a.length,k=new A(j),l=this.inverseTransform,r=this.mode,
t=c.MODE.WRAP,m;for(f=e=h=0;h<j;){m=l([e,f],b,d);g=~~m[0];m=~~m[1];if(0>g||g>=b||0>m||m>=d)switch(r){case t:m>=d&&(m-=d);m<0&&(m+=d);g>=b&&(g-=b);g<0&&(g+=b);break;default:m>=d&&(m=d-1),m<0&&(m=0),g>=b&&(g=b-1),g<0&&(g=0)}g=g+m*b<<2;k[h]=a[g];k[h+1]=a[g+1];k[h+2]=a[g+2];k[h+3]=a[g+3];h+=4;e++;e>=b&&(e=0,f++)}return k}function f(a,b,d){var e,f,h,g,j=b*d,k=a.length,m=new A(k),l=this.a,r=this.b,t=this.c,E=this.d,w=this.mode,x=c.MODE.WRAP,u,p=b-1,B=j-b;f=e=d=h=0;for(E*=b;h<k;){g=~~(l*d+t);u=~~(r*f+E);
if(0>g||g>p||0>u||u>B)switch(w){case x:u>B&&(u-=j);u<0&&(u+=j);g>=b&&(g-=b);g<0&&(g+=b);break;default:u>B&&(u=B),u<0&&(u=0),g>p&&(g=p),g<0&&(g=0)}g=g+u<<2;m[h]=a[g];m[h+1]=a[g+1];m[h+2]=a[g+2];m[h+3]=a[g+3];h+=4;d++;d>=b&&(d=0,e++,f+=b)}return m}function h(a,b,d){if(0>=this.radius)return a;var e,f,h,g,j=a.length,l=new A(a),t=this.centerX,w=this.centerY,B=this.radius,q=this.mode,E=c.MODE.WRAP,F,x,u=this.angle/B,p=b-1,V=d-1;for(f=e=h=0;h<j;){F=e-t;x=f-w;g=m(F*F+x*x);if(g<B){x=r(x,F)+u*(B-g);F=~~(t+
g*k(x));x=~~(w+g*n(x));if(0>F||F>p||0>x||x>V)switch(q){case E:x>V&&(x-=d);x<0&&(x+=d);F>p&&(F-=b);F<0&&(F+=b);break;default:x>V&&(x=V),x<0&&(x=0),F>p&&(F=p),F<0&&(F=0)}g=F+x*b<<2;l[h]=a[g];l[h+1]=a[g+1];l[h+2]=a[g+2];l[h+3]=a[g+3]}h+=4;e++;e>=b&&(e=0,f++)}return l}function e(a,b,d){if(0>=this.radius)return a;var e,f,h,g,j=a.length,k=new A(a),l=this.centerX,t=this.centerY;e=this.radius;var r=this.mode,q=c.MODE.WRAP,E,F=e*e,x=1-0.555556,u,p,n,ba,$=b-1,v=d-1;for(f=e=h=0;h<j;){g=e-l;E=f-t;n=g*g;ba=E*
E;u=n+ba;if(u<F){p=F-u;u=m(p);g=B(g/m(n+p))*x;E=B(E/m(ba+p))*x;g=~~(e-u*w(g));E=~~(f-u*w(E));if(0>g||g>$||0>E||E>v)switch(r){case q:E>v&&(E-=d);E<0&&(E+=d);g>$&&(g-=b);g<0&&(g+=b);break;default:E>v&&(E=v),E<0&&(E=0),g>$&&(g=$),g<0&&(g=0)}g=g+E*b<<2;k[h]=a[g];k[h+1]=a[g+1];k[h+2]=a[g+2];k[h+3]=a[g+3]}h+=4;e++;e>=b&&(e=0,f++)}return k}function j(a){return a}function t(a){return a}var A=c.ImArray,m=Math.sqrt,r=Math.atan2,n=Math.sin,k=Math.cos,B=Math.asin,w=Math.tan;c.GeometricMapFilter=function(a){this.generic(a)};
c.GeometricMapFilter.prototype={_map:null,inverseTransform:null,a:1,b:1,c:0,d:0,centerX:0,centerY:0,angle:0,radius:0,mode:c.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=d;return this},affine:function(a,b,c,d){this.a=a;this.b=b;this.c=c;this.d=d;this._map=f;return this},flipX:function(){this._map=z;return this},flipY:function(){this._map=q;return this},flipXY:function(){this._map=l;return this},rotateCW:function(){this._map=a;return this},rotateCCW:function(){this._map=b;return this},
polar:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=j;return this},cartesian:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=t;return this},twirl:function(a,b,c,d){this.angle=a||0;this.radius=b||0;this.centerX=c||0;this.centerY=d||0;this._map=h;return this},sphere:function(a,b,c){this.radius=a||0;this.centerX=b||0;this.centerY=c||0;this._map=e;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},
_apply:function(a,b,c){if(!this._map)return a;return this._map.call(this,a,b,c)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height))},reset:function(){this._map=null;return this}}})(FILTER);
(function(c){function z(a,b,c,d){var g=a.length,e,f=new m(a.length),c=c||1,d=d||1;for(e=0;e<g;)f[e]=c*a[e]+d*b[e],e++;return f}function q(a,b){var c,d,e=a.length,f,h=[],j=0;for(c=0;c<e;c++)for(d=0;d<e;d++)f=a[c]*b[d],j+=f,h.push(f);return{kernel:h,sum:j}}function l(a){var b,c=Array(a);for(b=0;b<a;)c[b]=0,b++;c[a>>1]=1;return c}function a(a){var b,c=Array(a);for(b=0;b<a;)c[b]=1,b++;return c}function b(a){var b=n.length,c,d;a--;if(a<b)c=n[a].slice();else for(c=new m(n[b-1]);b<=a;){d=c.slice();c=[1];
i=0;for(il=d.length-1;i<il;i++)c.push(d[i]+d[i+1]);c.push(1);b<40&&n.push(c.slice());b++}return c}function d(a){var b,c=-(a>>1),d=Array(a);for(b=0;b<a;)d[b]=c,c++,b++;return d}function f(a){a=b(a);return q(a,a)}function h(a,c){var e=b(a),f=d(a);return 1==c?q(f.reverse(),e):q(e,f)}function e(b,c){var e=a(b),f=d(b);return 1==c?q(f.reverse(),e):q(e,f)}function j(a,b){var b=b||1,c=a*a,d,e=new m(c);for(d=0;d<c;)e[d]=b,d++;return e}function t(a,b,d,e,g,f,h,j,k,m){var l=a.length,t,o,x,u,p,w,B,s,v,n,q,z,
R,I,C,H,L,W,X,J,ca,da,Y;t=b*d;p=f*h;f>>=1;h=b*(h>>1);d=-f-1;s=-h-b;W=b-1;X=t-b;t=(t<<1)+t;B=(b<<1)+b;m=m||1;Y=0;if(g){q=e[0];e=e[p>>1];e-=q;z=g[0];g=g[p>>1];for(R=g-z;Y<m;){w=new A(a);g=new c.Array32F(t);for(o=x=u=n=v=p=0;n<b;)o+=a[p],x+=a[p+1],u+=a[p+2],g[v]=o,g[v+1]=x,g[v+2]=u,p+=4,v+=3,n++;p=B+b;v=B;for(o=x=u=n=0;p<l;)o+=a[p],x+=a[p+1],u+=a[p+2],g[v]=g[v-B]+o,g[v+1]=g[v-B+1]+x,g[v+2]=g[v-B+2]+u,p+=4,v+=3,n++,n>=b&&(o=x=u=n=0);for(x=o=n=p=0;p<l;)I=n+d,C=x+s,H=n+f,L=x+h,I<0?I=0:H>W&&(H=W),C<0?C=
0:L>X&&(L=X),u=I+C,v=H+L,C=H+C,J=I+L,u=(u<<1)+u,C=(C<<1)+C,J=(J<<1)+J,v=(v<<1)+v,H=q*(g[v]-g[C]-g[J]+g[u])+e*a[p],L=q*(g[v+1]-g[C+1]-g[J+1]+g[u+1])+e*a[p+1],I=q*(g[v+2]-g[C+2]-g[J+2]+g[u+2])+e*a[p+2],ca=z*(g[v]-g[C]-g[J]+g[u])+R*a[p],da=z*(g[v+1]-g[C+1]-g[J+1]+g[u+1])+R*a[p+1],v=z*(g[v+2]-g[C+2]-g[J+2]+g[u+2])+R*a[p+2],u=j*H+k*ca,C=j*L+k*da,v=j*I+k*v,r&&(u<0?u=0:u>255&&(u=255),C<0?C=0:C>255&&(C=255),v<0?v=0:v>255&&(v=255)),w[p]=~~u,w[p+1]=~~C,w[p+2]=~~v,p+=4,n++,n>=b&&(n=0,o++,x+=b);a=w;Y++}}else{q=
e[0];e=e[p>>1];e-=q;j=j||1;for(k=k||0;Y<m;){w=new A(a);g=new c.Array32F(t);for(o=x=u=n=v=p=0;n<b;)o+=a[p],x+=a[p+1],u+=a[p+2],g[v]=o,g[v+1]=x,g[v+2]=u,p+=4,v+=3,n++;p=B+b;v=B;for(o=x=u=n=0;p<l;)o+=a[p],x+=a[p+1],u+=a[p+2],g[v]=g[v-B]+o,g[v+1]=g[v-B+1]+x,g[v+2]=g[v-B+2]+u,p+=4,v+=3,n++,n>=b&&(o=x=u=n=0);for(x=o=n=p=0;p<l;)I=n+d,C=x+s,H=n+f,L=x+h,I<0?I=0:H>W&&(H=W),C<0?C=0:L>X&&(L=X),u=I+C,v=H+L,C=H+C,J=I+L,u=(u<<1)+u,C=(C<<1)+C,J=(J<<1)+J,v=(v<<1)+v,H=q*(g[v]-g[C]-g[J]+g[u])+e*a[p],L=q*(g[v+1]-g[C+
1]-g[J+1]+g[u+1])+e*a[p+1],I=q*(g[v+2]-g[C+2]-g[J+2]+g[u+2])+e*a[p+2],u=j*H+k,C=j*L+k,v=j*I+k,r&&(u<0?u=0:u>255&&(u=255),C<0?C=0:C>255&&(C=255),v<0?v=0:v>255&&(v=255)),w[p]=~~u,w[p+1]=~~C,w[p+2]=~~v,p+=4,n++,n>=b&&(n=0,o++,x+=b);a=w;Y++}}return w}var A=c.ImArray,m=c.Array32F,r=c._notSupportTypedArrays,n=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],k=c.CONSTANTS.toRad,B=Math.abs,w=Math.sqrt,o=Math.sin,s=Math.cos;c.ConvolutionMatrixFilter=
function(a,b,c){typeof a!="undefined"&&a.length?(this.set(a,~~(w(a.length)+0.5),b||1),this._bias=c||0):(this._matrix=null,this._dim=0);this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0};c.ConvolutionMatrixFilter.prototype={_dim:0,_matrix:null,_factor:1,_bias:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(j(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,b){var a=typeof a=="undefined"?3:a%2?a:a+1,c=a*a,d=-(typeof b=="undefined"?1:b)/c,e=j(a,
d);e[c>>1]=1+d;this.set(e,a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},verticalBlur:function(b){var b=typeof b=="undefined"?3:b%2?b:b+1,c,d=b;c=l(d);d=a(d);c=q(d,c);return this.set(c.kernel,b,1/c.sum)},horizontalBlur:function(b){var b=typeof b=="undefined"?3:b%2?b:b+1,c,d=b;c=l(d);d=a(d);c=q(c,d);return this.set(c.kernel,b,1/c.sum)},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=f(a);return this.set(b.kernel,a,1/b.sum)},binomialHighPass:function(a){var a=
typeof a=="undefined"?3:a%2?a:a+1,b=f(a);return this.set(z(j(a),new m(b.kernel),1,-1/b.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},fastGauss:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(j(b),b,1/(b*b));this._doFast=a;return this},sharpen:function(a,b){a=typeof a=="undefined"?0.5:a;return a<=0?this.set([0,-2,0,-2,10,-2,0,-2,0],3,0.5):this.highPass(b,a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(e(a,0).kernel,
a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(e(a,1).kernel,a,1)},prewittDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=k;var c=s(a),d=o(a),g=e(b,0),f=e(b,1);return this.set(z(new m(g.kernel),new m(f.kernel),c,d),b,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=e(a,0),c=e(a,1);this.set(b.kernel,a,1);this._isGrad=!0;this._matrix2=new m(c.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},
gradDirectional:function(a,b){return this.prewittDirectional(a,b)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(h(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(h(a,1).kernel,a,1)},sobelDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=k;var c=s(a),d=o(a),e=h(b,0),f=h(b,1);return this.set(z(new m(e.kernel),new m(f.kernel),c,d),b,1)},sobel:function(a){var a=typeof a=="undefined"?
3:a%2?a:a+1,b=h(a,0),c=h(a,1);this.set(b.kernel,a,1);this._matrix2=new m(c.kernel);this._isGrad=!0;return this},laplace:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=j(a,-1),c=a*a;b[c>>1]=c-1;this.set(b,a,1);this._doFast=1;return this},emboss:function(a,b,c){var c=typeof c=="undefined"?3:c%2?c:c+1,a=typeof a=="undefined"?-0.25*Math.PI:a*k,b=b||1,d=b*s(a),a=-b*o(a),b=c,e=b*b,f=b>>1,h,j=new m(e),l,t,r;l=r=-f*d;t=-f*a;for(h=f=0;f<e;)j[f]=l+t,f++,h++,l+=d,h>=b&&(h=0,l=r,t+=a);j[c*c>>1]=1;return this.set(j,
c,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,b,c){this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;this._matrix=new m(a);this._dim=b;this._factor=c||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,b){this._matrix=a;this._dim=b;this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;return this},_apply:function(a,b,d){if(!this._matrix)return a;
if(this._doFast)return this._matrix2?t(a,b,d,this._matrix,this._matrix2,this._dim,this._dim,this._coeff1,this._coeff2,this._doFast):t(a,b,d,this._matrix,null,this._dim,this._dim,this._factor,this._bias,this._doFast);var e=this._dim,f=this._dim,h=e>>1,j=e*f,k=(f>>1)*b,f=this._matrix,l=this._factor,m=this._bias,o=this._matrix2,n,w=this._isGrad,x=new c.Array16I(j<<1),u=new c.Array8U(j),p=b*d,d=a.length,q=new A(d),s,z,v,O,G,aa,R=b-1,I=p-b,C=this._coeff1,H=this._coeff2;for(O=v=p=z=s=0;z<j;)u[z]=p+v,x[s]=
p-h,x[s+1]=O-k,s+=2,z++,p++,p>=e&&(p=0,v+=e,O+=b);if(o)for(v=p=e=0;e<d;){for(z=s=l=m=aa=h=k=O=0;z<j;)G=p+x[s],n=v+x[s+1],G>=0&&G<=R&&n>=0&&n<=I&&(G=G+n<<2,n=f[u[z]],O+=a[G]*n,k+=a[G+1]*n,h+=a[G+2]*n,n=o[u[z]],aa+=a[G]*n,m+=a[G+1]*n,l+=a[G+2]*n),s+=2,z++;w?(s=B(O)+B(aa),z=B(k)+B(m),h=B(h)+B(l)):(s=C*O+H*aa,z=C*k+H*m,h=C*h+H*l);r&&(s<0?s=0:s>255&&(s=255),z<0?z=0:z>255&&(z=255),h<0?h=0:h>255&&(h=255));q[e]=~~s;q[e+1]=~~z;q[e+2]=~~h;q[e+3]=a[e+3];e+=4;p++;p>=b&&(p=0,v+=b)}else for(v=p=e=0;e<d;){for(z=
s=h=k=O=0;z<j;)G=p+x[s],n=v+x[s+1],G>=0&&G<=R&&n>=0&&n<=I&&(G=G+n<<2,n=f[u[z]],O+=a[G]*n,k+=a[G+1]*n,h+=a[G+2]*n),s+=2,z++;s=l*O+m;z=l*k+m;h=l*h+m;r&&(s<0?s=0:s>255&&(s=255),z<0?z=0:z>255&&(z=255),h<0?h=0:h>255&&(h=255));q[e]=~~s;q[e+1]=~~z;q[e+2]=~~h;q[e+3]=a[e+3];e+=4;p++;p>=b&&(p=0,v+=b)}return q},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(c){var z=c.ImArray,q=function(a,b,h){var e=this._dim,j=e>>1,l=e*e,A=j*b,m=new c.Array32I(l<<1),r=b*h,h=a.length,n=new z(h),k,B,w=[],o=[],s=[];l<<=1;var q=b-1,N=r-b;for(B=r=k=0;k<l;)m[k]=r-j,m[k+1]=B-A,k+=2,r++,r>=e&&(r=0,B+=b);for(B=r=e=0;e<h;){w.length=0;o.length=0;for(k=s.length=0;k<l;)j=r+m[k],A=B+m[k+1],j>=0&&j<=q&&A>=0&&A<=N&&(j=j+A<<2,w.push(a[j]),o.push(a[j+1]),s.push(a[j+2])),k+=2;w.sort();o.sort();s.sort();k=(w.length>>1)+1;(j=w.length%2)?(n[e]=w[k],n[e+1]=o[k],n[e+2]=s[k]):(n[e]=
~~(0.5*(w[k-1]+w[k])),n[e+1]=~~(0.5*(o[k-1]+o[k])),n[e+2]=~~(0.5*(s[k-1]+s[k])));n[e+3]=a[e+3];e+=4;r++;r>=b&&(r=0,y++,B+=b)}return n},l=function(a,b,h){var e=this._dim,j=e>>1,l=e*e,A=j*b,m=new c.Array32I(l<<1),r=b*h,h=a.length,n=new z(h),k,q,w,o,s,D;l<<=1;var N=b-1,P=r-b;for(q=k=r=0;r<l;)m[r]=k-j,m[r+1]=q-A,r+=2,k++,k>=e&&(k=0,q+=b);for(q=k=e=0;e<h;){for(r=D=A=j=0;r<l;)w=k+m[r],o=q+m[r+1],w>=0&&w<=N&&o>=0&&o<=P&&(s=w+o<<2,w=a[s],o=a[s+1],s=a[s+2],w>j&&(j=w),o>A&&(A=o),s>D&&(D=s)),r+=2;n[e]=j;n[e+
1]=A;n[e+2]=D;n[e+3]=a[e+3];e+=4;k++;k>=b&&(k=0,q+=b)}return n},a=function(a,b,h){var e=this._dim,j=e>>1,l=e*e,q=j*b,m=new c.Array32I(l<<1),r=b*h,h=a.length,n=new z(h),k,B,w,o,s,D;l<<=1;var N=b-1,P=r-b;for(B=k=r=0;r<l;)m[r]=k-j,m[r+1]=B-q,r+=2,k++,k>=e&&(k=0,B+=b);for(B=k=e=0;e<h;){D=q=j=255;for(r=0;r<l;)w=k+m[r],o=B+m[r+1],w>=0&&w<=N&&o>=0&&o<=P&&(s=w+o<<2,w=a[s],o=a[s+1],s=a[s+2],w<j&&(j=w),o<q&&(q=o),s<D&&(D=s)),r+=2;n[e]=j;n[e+1]=q;n[e+2]=D;n[e+3]=a[e+3];e+=4;k++;k>=b&&(k=0,B+=b)}return n},b=
function(a){return a};c.StatisticalFilter=function(){this._dim=0;this._apply=b};c.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=q;return this},erode:function(b){this._dim=typeof b=="undefined"?3:b;this._apply=a;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=l;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),a.width,a.height))},
reset:function(){this._apply=b;this._dim=0;return this}}})(FILTER);
