/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.4
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(d){function O(d,n){var d=d||{},f;for(f in n)n&&Object.prototype.hasOwnProperty.call(n,f)&&(d[f]=n[f]);return d}d.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;d.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;d.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;d.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;d.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;d.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;d.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;d.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;d.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:d.Array8U;d._notSupportTypedArrays=!d.ImArray.set;if(d._notSupportTypedArrays){if(!d.ImArray.prototype.set)d.ImArray.prototype.set=function(d){for(var n=d.length;--n;)this[n]=d[n]};if(typeof CanvasPixelArray!=="undefined")CanvasPixelArray.prototype.set=function(d){for(var n=d.length;--n;)this[n]=d[n]}}d.CONSTANTS={PI:Math.PI,PI2:2*Math.PI,SQRT2:Math.SQRT2,
toRad:Math.PI/180,toDeg:180/Math.PI};d.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};d.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};d.LUMA=new d.Array32F([0.212671,0.71516,0.072169]);d.Filter=function(){};d.Filter.prototype={_apply:function(){},apply:function(){},reset:function(){}};d.CompositeFilter=function(d){this._stack=typeof d!="undefined"&&d.length?d:[]};d.CompositeFilter.prototype={_stack:[],_apply:function(d,n,f,a){if(!this._stack.length)return d;for(var e=this._stack,q=e.length,h=0,g;h<q;)(g=e[h++])&&
(d=g._apply(d,n,f,a));return d},apply:function(d){if(!this._stack.length)return d;return d.setData(this._apply(im=d.getData(),d.width,d.height,d))},filters:function(d){if(d)this._stack=d;return this},push:function(d){this._stack.push(d);return this},pop:function(){return this._stack.pop()},shift:function(){return this._stack.shift()},unshift:function(d){this._stack.unshift(d);return this},concat:function(d){return this.push(d)},getAt:function(d){return this._stack.length>d?this._stack[d]:null},setAt:function(d,
n){this._stack.length>d&&(this._stack[d]=n);return this},insertAt:function(d,n){this._stack.splice(d,0,n);return this},removeAt:function(d){this._stack.splice(d,1);return this},remove:function(d){for(var n=this._stack.length;--n>=0;)d===this._stack[n]&&this._stack.splice(n,1);return this},reset:function(){this._stack.length=0;return this}};d.Create=function(d){var n=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},d=O({init:function(){},reset:function(){return this},apply:function(f){return f}},
d);d._apply=d.apply;d.apply=function(f){return f.setData(this._apply(f.getData(),f.width,f.height,f))};n.prototype=O(n.prototype,d);return n}})(FILTER);
(function(d){var O=Math.sqrt,z=Math.min,n=Math.max;d.Color={blend:function(f,a,e){return{r:f.r-~~((f.r-a.r)*e+0.5),g:f.g-~~((f.g-a.g)*e+0.5),b:f.b-~~((f.b-a.b)*e+0.5)}},toGray:function(f,a,e){var q=d.LUMA;return~~(q[0]*f+q[1]*a+q[2]*e)},distance:function(f,a){var e=f.r-a.r,d=f.g-a.g,h=f.b-a.b;return O(e*e+d*d+h*h)},RGB2Color:function(f){return f.r<<16|f.g<<8|f.b&255},RGBA2Color:function(f){return f.a<<24|f.r<<16|f.g<<8|f.b&255},Color2RGBA:function(f){f=~~f;return{r:f>>>16&255,g:f>>>8&255,b:f&255,
a:f>>>24&255}},RGB2YCbCr:function(f){var a=f.r,e=f.g,f=f.b;return{y:~~(0+0.299*a+0.587*e+0.114*f),cb:~~(128-0.168736*a-0.331264*e+0.5*f),cr:~~(128+0.5*a-0.418688*e-0.081312*f)}},YCbCr2RGB:function(f){var a=f.y,e=f.cb,f=f.cr;return{r:~~(a+1.402*(f-128)),g:~~(a-0.34414*(e-128)-0.71414*(f-128)),b:~~(a+1.772*(e-128))}},RGB2HSV:function(f){var a,e,d,h;e=f.r;d=f.g;h=f.b;a=z(e,d,h);f=n(e,d,h);a=f-a;if(f==0)return{h:0,s:0,v:f};e=e==f?(d-h)/a:d==f?2+(h-e)/a:4+(e-d)/a;e*=60;e<0&&(e+=360);return{h:e,s:a/f,v:f}},
HSV2RGB:function(f){var a,e,d,h,g;d=f.h;g=f.s;f=f.v;if(g==0)return a=e=f,{r:a,g:e,b:f};d/=60;a=~~d;e=d-a;d=f*(1-g);h=f*(1-g*e);g=f*(1-g*(1-e));switch(a){case 0:a=f;e=g;f=d;break;case 1:a=h;e=f;f=d;break;case 2:a=d;e=f;f=g;break;case 3:a=d;e=h;break;case 4:a=g;e=d;break;default:a=f,e=d,f=h}return{r:a,g:e,b:f}}}})(FILTER);
(function(d){function O(a,e){var f=document.createElement("canvas");f.width=a||0;f.height=e||0;return f}var z,n=Math.min,f=d.ImArray;z={normal:function(a){return a},lighten:function(a,e){return e>a?e:a},darken:function(a,e){return e>a?a:e},multiply:function(a,e){return a*e*0.003921568627451},average:function(a,e){return 0.5*(a+e)},add:function(a,e){return Math.min(255,a+e)},substract:function(a,e){return a+e<255?0:a+e-255},difference:function(a,e){return Math.abs(a-e)},negation:function(a,e){return 255-
Math.abs(255-a-e)},screen:function(a,e){return 255-((255-a)*(255-e)>>8)},exclusion:function(a,e){return a+e-2*a*e*0.003921568627451},overlay:function(a,e){return e<128?2*a*e*0.003921568627451:255-2*(255-a)*(255-e)*0.003921568627451},softLight:function(a,e){return e<128?2*((a>>1)+64)*e*0.003921568627451:255-2*(255-((a>>1)+64))*(255-e)*0.003921568627451},hardLight:function(a,e){return a<128?2*e*a*0.003921568627451:255-2*(255-e)*(255-a)*0.003921568627451},colorDodge:function(a,e){return e==255?e:Math.min(255,
(a<<8)/(255-e))},colorBurn:function(a,e){return e==0?e:Math.max(0,255-(255-a<<8)/e)},linearLight:function(a,e){return e<128?z.linearBurn(a,2*e):z.linearDodge(a,2*(e-128))},vividLight:function(a,e){return e<128?z.colorBurn(a,2*e):z.colorDodge(a,2*(e-128))},pinLight:function(a,e){return e<128?z.darken(a,2*e):z.lighten(a,2*(e-128))},hardMix:function(a,e){return z.vividLight(a,e)<128?0:255},reflect:function(a,e){return e==255?e:Math.min(255,a*a/(255-e))},glow:function(a,e){return a==255?a:Math.min(255,
e*e/(255-a))},phoenix:function(a,e){return Math.min(a,e)-Math.max(a,e)+255}};z.linearDodge=z.add;z.linearBurn=z.substract;d.blendModes=z;d.Image=function(a,e){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=O(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=O(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(a,e)};d.Image.prototype={width:0,height:0,
canvasElement:null,domElement:null,setWidth:function(a){this._tmpCanvas.width=this.canvasElement.width=this.width=a;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setHeight:function(a){this._tmpCanvas.height=this.canvasElement.height=this.height=a;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=
this._histogramRefresh=!0;return this},setImage:function(a,e){if(typeof a=="undefined"||a==null)return this;var f=this,d,g;a instanceof Image||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?(d=a,this.width=d instanceof HTMLVideoElement?d.videoWidth:d.width,this.height=d instanceof HTMLVideoElement?d.videoHeight:d.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,g=this.context=this.canvasElement.getContext("2d"),
g.drawImage(a,0,0),this.imageData=g.getImageData(0,0,this.width,this.height),this._integralRefresh=this._histogramRefresh=!0):(d=new Image,d.onload=function(){f.width=d.width;f.height=d.height;f._tmpCanvas.width=f.canvasElement.width=f.width;f._tmpCanvas.height=f.canvasElement.height=f.height;g=f.context=f.canvasElement.getContext("2d");g.drawImage(d,0,0);f.imageData=f.context.getImageData(0,0,f.width,f.height);f._histogramRefresh=!0;f._integralRefresh=!0;typeof e!="undefined"&&e.call(f)},d.src=a);
d.crossOrigin="";return this},getPixel:function(a,e){var f=~~(e*this.width+a+0.5),d=this.imageData.data;return{r:d[f],g:d[f+1],b:d[f+2],a:d[f+3]}},setPixel:function(a,e,d,h,g,r){this.context.putImageData(new f([d&255,h&255,g&255,r&255]),a,e);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new f(this.imageData.data)},setData:function(a){this.imageData.data.set(a);this.context.putImageData(this.imageData,
0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(a){this.context.putImageData(a,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},createImageData:function(a,e){this._tmpCanvas.width=this.canvasElement.width=this.width=a;this._tmpCanvas.height=this.canvasElement.height=
this.height=e;this.context=this.canvasElement.getContext("2d");this.context.createImageData(a,e);return this.imageData=this.context.getImageData(0,0,this.width,this.height)},copy:function(a){this.setData(a.getData());this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},clone:function(){return new d.Image(this.canvasElement)},scale:function(a,e){a=a||1;e=e||a;if(1==a&&1==e)return this;var f=this._tmpCanvas.getContext("2d");f.scale(a,e);f.drawImage(this.canvasElement,0,
0);this.canvasElement.width=this.width=~~(a*this.width+0.5);this.canvasElement.height=this.height=~~(e*this.height+0.5);this.context.drawImage(this._tmpCanvas,0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipHorizontal:function(){var a=this._tmpCanvas.getContext("2d");a.translate(this.width,0);a.scale(-1,1);a.drawImage(this.canvasElement,0,0);
this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipVertical:function(){var a=this._tmpCanvas.getContext("2d");a.translate(0,this.height);a.scale(1,-1);a.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},clear:function(){if(this.width&&
this.height){var a=this.context;a.clearRect(0,0,this.width,this.height);this.imageData=a.getImageData(0,0,this.width,this.height)}return this},fill:function(a,e,f,d,g){if(!d&&this.width&&!g&&this.height)return this;else if(d&&!this.width&&g&&!this.height)this._tmpCanvas.width=this.canvasElement.width=this.width=d+e,this._tmpCanvas.height=this.canvasElement.height=this.height=g+f,this.context=this.canvasElement.getContext("2d"),this.context.createImageData(d,g),this.imageData=this.context.getImageData(0,
0,this.width,this.height);var d=d||this.width,g=g||this.height,r=this.context;r.fillStyle=a||0;r.fillRect(e||0,f||0,d,g);this.imageData=r.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},draw:function(){return this},blend:function(a,e,f,d,g){typeof e=="undefined"&&(e="normal");typeof f=="undefined"&&(f=1);f>1?f=1:f<0&&(f=0);typeof d=="undefined"&&(d=0);typeof g=="undefined"&&(g=0);var r=0,L=0,s=this.context;d<0&&(r=-d,d=0);g<0&&(L=-g,g=0);if(d>=
this.width||g>=this.height)return this;e=z[e];if(e==void 0||e==null)return this;var u=n(this.width,a.width-r),M=n(this.height,a.height-L),H=this.context.getImageData(d,g,u,M),r=a.context.getImageData(r,L,u,M),a=H.data,r=r.data,C,K,v,A=1-f,I=r.length,F;for(F=0;F<I;F+=4)C=a[F],K=a[F+1],v=a[F+2],L=e(r[F],C),u=e(r[F+1],K),M=e(r[F+2],v),a[F]=L*f+C*A,a[F+1]=u*f+K*A,a[F+2]=M*f+v*A;s.putImageData(H,d,g);this.imageData=s.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=
!0;return this},integral:function(){this._integralRefresh&&this._computeIntegral();return this._integral},histogram:function(){this._histogramRefresh&&this._computeHistogram();return this._histogram},_computeIntegral:function(){var a=this.width,e=a*this.height,f=a<<2,h=new d.Array32F(e),g=new d.Array32F(e),e=new d.Array32F(e),r=this.getPixelData().data,L,s,u,M,H,C;for(M=H=C=u=s=L=0;u<a;)M+=r[L],H+=r[L+1],C+=r[L+2],h[s]=M,g[s]=H,e[s]=C,L+=4,s++,u++;L=f;for(M=H=C=u=0;L<imLen;)M+=r[L],H+=r[L+1],C+=r[L+
2],h[s]=h[s-a]+M,g[s]=g[s-a]+H,e[s]=e[s-a]+C,L+=4,s++,u++,u>=a&&(M=H=C=u=0);this._integral=[h,g,e];this._integralRefresh=!1},_computeHistogram:function(){for(var a=this.getPixelData().data,e=0,f=a.length,h,g,r,L=0,s=0,u=0,M=255,H=255,C=255,n=new d.Array32F(256),v=new d.Array32F(256),A=new d.Array32F(256),I=1/(f>>2),e=0;e<256;)n[e]=0,v[e]=0,A[e]=0,e++;for(e=0;e<f;)h=a[e],g=a[e+1],r=a[e+2],n[h]+=I,v[g]+=I,A[r]+=I,h>L&&(L=h),h<M&&(M=h),g>s&&(s=g),g<H&&(H=g),r>u&&(u=r),r<C&&(C=r),e+=4;this._histogram=
[n,v,A];this._histogramRefresh=!1},_refresh:function(){this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this}}})(FILTER);
(function(d){d.CustomFilter=function(d){this._handler=d};d.CustomFilter.prototype={_handler:null,_apply:function(d,z,n,f){if(!this._handler)return d;return this._handler.call(this,d,z,n,f)},apply:function(d){if(!this._handler)return d;return d.setData(this._handler.call(this,d.getData(),d.width,d.height,d))}}})(FILTER);
(function(d){var O=d.Array32F,z=d.CONSTANTS.toRad,n=d._notSupportTypedArrays;d.ColorMatrixFilter=function(f){this._matrix=typeof f!="undefined"&&f.length?new O(f):null};d.ColorMatrixFilter.prototype={_matrix:null,channel:function(f,a){var e=(typeof a=="undefined"?0:a)?1:0;switch(f){case d.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case d.CHANNEL.BLUE:return this.concat([0,0,e,0,0,0,0,e,0,0,0,0,1,0,0,0,0,0,0,255]);case d.CHANNEL.GREEN:return this.concat([0,e,0,0,
0,0,1,0,0,0,0,e,0,0,0,0,0,0,0,255]);default:return this.concat([1,0,0,0,0,e,0,0,0,0,e,0,0,0,0,0,0,0,0,255])}},redChannel:function(f){return this.channel(d.CHANNEL.RED,f)},greenChannel:function(f){return this.channel(d.CHANNEL.GREEN,f)},blueChannel:function(f){return this.channel(d.CHANNEL.BLUE,f)},alphaChannel:function(){return this.channel(d.CHANNEL.ALPHA,!0)},maskChannel:function(f){switch(f){case d.CHANNEL.ALPHA:return this;case d.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,1,0]);case d.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(f,a){switch(f){case d.CHANNEL.ALPHA:switch(a){case d.CHANNEL.ALPHA:return this;case d.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case d.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case d.CHANNEL.BLUE:switch(a){case d.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case d.CHANNEL.BLUE:return this;case d.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case d.CHANNEL.GREEN:switch(a){case d.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case d.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case d.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(a){case d.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case d.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case d.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([d.LUMA[0],d.LUMA[1],d.LUMA[2],0,0,d.LUMA[0],d.LUMA[1],d.LUMA[2],0,0,d.LUMA[0],d.LUMA[1],d.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(f,a){var e,q,h,g;typeof a=="undefined"&&(a=1);e=(f>>16&255)*0.00392156862745098;q=(f>>8&255)*0.00392156862745098;h=(f&255)*0.00392156862745098;g=1-a;return this.concat([g+a*e*d.LUMA[0],a*e*d.LUMA[1],a*e*d.LUMA[2],0,0,a*q*d.LUMA[0],g+a*q*d.LUMA[1],a*q*d.LUMA[2],0,0,a*h*d.LUMA[0],a*h*d.LUMA[1],g+a*h*d.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(f){var a,e,q;a=1-f;e=a*d.LUMA[0];q=a*d.LUMA[1];a*=d.LUMA[2];return this.concat([e+f,q,a,0,0,e,q+f,a,0,0,e,q,a+f,0,0,0,0,0,1,0])},contrast:function(f,a,e){typeof a=="undefined"&&(a=f);typeof e=="undefined"&&(e=f);f+=1;a+=1;e+=1;this._log=!0;return this.concat([f,0,0,0,128*(1-f),0,a,0,0,128*(1-a),0,0,e,0,128*(1-e),0,0,0,1,0])},brightness:function(f,a,e){typeof a=="undefined"&&(a=f);typeof e=="undefined"&&(e=f);return this.concat([1,0,0,0,f,0,1,0,0,a,0,0,1,0,e,
0,0,0,1,0])},adjustHue:function(f){f*=z;var a=Math.cos(f),f=Math.sin(f);return this.concat([d.LUMA[0]+a*(1-d.LUMA[0])+f*-d.LUMA[0],d.LUMA[1]+a*-d.LUMA[1]+f*-d.LUMA[1],d.LUMA[2]+a*-d.LUMA[2]+f*(1-d.LUMA[2]),0,0,d.LUMA[0]+a*-d.LUMA[0]+f*0.143,d.LUMA[1]+a*(1-d.LUMA[1])+f*0.14,d.LUMA[2]+a*-d.LUMA[2]+f*-0.283,0,0,d.LUMA[0]+a*-d.LUMA[0]+f*-(1-d.LUMA[0]),d.LUMA[1]+a*-d.LUMA[1]+f*d.LUMA[1],d.LUMA[2]+a*(1-d.LUMA[2])+f*d.LUMA[2],0,0,0,0,0,1,0])},average:function(f,a,e){typeof f=="undefined"&&(f=0.3333);typeof a==
"undefined"&&(a=0.3333);typeof e=="undefined"&&(e=0.3334);return this.concat([f,a,e,0,0,f,a,e,0,0,f,a,e,0,0,0,0,0,1,0])},quickContrastCorrection:function(f){typeof f=="undefined"&&(f=1.2);return this.concat([f,0,0,0,0,0,f,0,0,0,0,0,f,0,0,0,0,0,1,0])},sepia:function(f){typeof f=="undefined"&&(f=0.5);f>1?f=1:f<0&&(f=0);return this.concat([1-0.607*f,0.769*f,0.189*f,0,0,0.349*f,1-0.314*f,0.168*f,0,0,0.272*f,0.534*f,1-0.869*f,0,0,0,0,0,1,0])},quickSepia:function(f){typeof f=="undefined"&&(f=10);f>100&&
(f=100);f*=2.55;return this.concat([d.LUMA[0],d.LUMA[1],d.LUMA[2],0,40,d.LUMA[0],d.LUMA[1],d.LUMA[2],0,20,d.LUMA[0],d.LUMA[1],d.LUMA[2],0,-f,0,0,0,1,0])},threshold:function(f,a){typeof a=="undefined"&&(a=256);return this.concat([d.LUMA[0]*a,d.LUMA[1]*a,d.LUMA[2]*a,0,-(a-1)*f,d.LUMA[0]*a,d.LUMA[1]*a,d.LUMA[2]*a,0,-(a-1)*f,d.LUMA[0]*a,d.LUMA[1]*a,d.LUMA[2]*a,0,-(a-1)*f,0,0,0,1,0])},threshold_rgb:function(f,a){typeof a=="undefined"&&(a=256);return this.concat([a,0,0,0,-(a-1)*f,0,a,0,0,-(a-1)*f,0,0,a,
0,-(a-1)*f,0,0,0,1,0])},threshold_alpha:function(f,a){typeof f=="undefined"&&(f=0.5);typeof a=="undefined"&&(a=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,a,-a*f])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(f,a){var e;if(this._matrix){e=this._matrix;
var d=f.getMatrix(),h=1-a,g=new O(20);g[0]=h*e[0]+a*d[0];g[1]=h*e[1]+a*d[1];g[2]=h*e[2]+a*d[2];g[3]=h*e[3]+a*d[3];g[4]=h*e[4]+a*d[4];g[5]=h*e[5]+a*d[5];g[6]=h*e[6]+a*d[6];g[7]=h*e[7]+a*d[7];g[8]=h*e[8]+a*d[8];g[9]=h*e[9]+a*d[9];g[10]=h*e[10]+a*d[10];g[11]=h*e[11]+a*d[11];g[12]=h*e[12]+a*d[12];g[13]=h*e[13]+a*d[13];g[14]=h*e[14]+a*d[14];g[15]=h*e[15]+a*d[15];g[16]=h*e[16]+a*d[16];g[17]=h*e[17]+a*d[17];g[18]=h*e[18]+a*d[18];g[19]=h*e[19]+a*d[19];e=g}else e=new O(f.getMatrix());this._matrix=e;return this},
concat:function(d){var a;if(this._matrix){a=this._matrix;var d=new O(d),e=new O(20),q,h,g,r,L;q=d[0];h=d[1];g=d[2];r=d[3];L=d[4];e[0]=q*a[0]+h*a[5]+g*a[10]+r*a[15];e[1]=q*a[1]+h*a[6]+g*a[11]+r*a[16];e[2]=q*a[2]+h*a[7]+g*a[12]+r*a[17];e[3]=q*a[3]+h*a[8]+g*a[13]+r*a[18];e[4]=q*a[4]+h*a[9]+g*a[14]+r*a[19]+L;q=d[5];h=d[6];g=d[7];r=d[8];L=d[9];e[5]=q*a[0]+h*a[5]+g*a[10]+r*a[15];e[6]=q*a[1]+h*a[6]+g*a[11]+r*a[16];e[7]=q*a[2]+h*a[7]+g*a[12]+r*a[17];e[8]=q*a[3]+h*a[8]+g*a[13]+r*a[18];e[9]=q*a[4]+h*a[9]+g*
a[14]+r*a[19]+L;q=d[10];h=d[11];g=d[12];r=d[13];L=d[14];e[10]=q*a[0]+h*a[5]+g*a[10]+r*a[15];e[11]=q*a[1]+h*a[6]+g*a[11]+r*a[16];e[12]=q*a[2]+h*a[7]+g*a[12]+r*a[17];e[13]=q*a[3]+h*a[8]+g*a[13]+r*a[18];e[14]=q*a[4]+h*a[9]+g*a[14]+r*a[19]+L;q=d[15];h=d[16];g=d[17];r=d[18];L=d[19];e[15]=q*a[0]+h*a[5]+g*a[10]+r*a[15];e[16]=q*a[1]+h*a[6]+g*a[11]+r*a[16];e[17]=q*a[2]+h*a[7]+g*a[12]+r*a[17];e[18]=q*a[3]+h*a[8]+g*a[13]+r*a[18];e[19]=q*a[4]+h*a[9]+g*a[14]+r*a[19]+L;a=e}else a=new O(d);this._matrix=a;return this},
combineWith:function(d){return this.concat(d.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(d){this._matrix=d;return this},_apply:function(d){if(!this._matrix)return d;for(var a=d.length,e=this._matrix,q=0,h,g,r,L,s,u,M;q<a;)h=d[q],g=d[q+1],r=d[q+2],L=d[q+3],s=e[0]*h+e[1]*g+e[2]*r+e[3]*L+e[4],u=e[5]*h+e[6]*g+e[7]*r+e[8]*L+e[9],M=e[10]*h+e[11]*g+e[12]*r+e[13]*L+e[14],h=e[15]*h+e[16]*g+e[17]*r+e[18]*L+e[19],n&&(s<0?s=0:s>255&&(s=255),u<0?u=0:u>255&&(u=255),M<0?M=0:M>255&&
(M=255),h<0?h=0:h>255&&(h=255)),d[q]=~~s,d[q+1]=~~u,d[q+2]=~~M,d[q+3]=~~h,q+=4;return d},apply:function(d){if(!this._matrix)return d;return d.setData(this._apply(d.getData(),d.width,d.height,d))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(d){function O(d){var a=new f(256),e=0;if(d)for(;e<256;)a[e]=255-e,e++;else for(;e<256;)a[e]=e,e++;return a}function z(d){for(var a=new f(256),e=0;e<256;)a[e]=d,e++;return a}function n(d){if(d)return new f(d);return null}var f=d.ImArray,a=Math.pow,e=Math.exp,q=1/255,h=O(),g=O(1);d.TableLookupFilter=function(d,a,e,f){this._tableR=d||null;this._tableG=a||this._tableR;this._tableB=e||this._tableG;this._tableA=f||null};d.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(d,a,e){d.length||(d=[d]);a||(a=d);e||(e=a);var g=d.length,h=g+1,q=a.length,C=q+1,n=e.length,v=n+1,A=new f(256),I=new f(h),F=new f(256),P=new f(C),w=new f(256),G=new f(v),p,T=255/(h-1),J=255/(C-1),Q=255/(v-1);for(p=0;p<h;)I[p]=~~(T*p),p++;d[0]=~~(255*d[0]);for(p=1;p<g;)d[p]=d[p-1]+~~(255*d[p]),p++;for(p=0;p<C;)P[p]=~~(J*p),p++;a[0]=~~(255*a[0]);for(p=1;p<q;)a[p]=a[p-1]+~~(255*a[p]),p++;for(p=0;p<v;)G[p]=~~(Q*p),p++;e[0]=~~(255*e[0]);for(p=1;p<n;)e[p]=e[p-1]+~~(255*e[p]),p++;for(p=
0;p<256;){for(h=0;h<g&&p>d[h];)h++;A[p]=I[h];for(h=0;h<q&&p>a[h];)h++;F[p]=P[h];for(h=0;h<n&&p>e[h];)h++;w[p]=G[h];p++}return this.concat(A,F,w)},threshold:function(d,a,e){d=d||0.5;a=a||d;return this.thresholds([d],[a],[e||a])},quantize:function(d){typeof d=="undefined"&&(d=64);d<2&&(d=2);var a=new f(256),e=new f(d),g,h=255/(d-1),q=d/256;for(g=0;g<d;)e[g]=~~(h*g),g++;for(g=0;g<256;)a[g]=e[~~(q*g)],g++;return this.concat(a)},levels:function(d){return this.quantize(d)},posterize:function(d){return this.quantize(d)},
binarize:function(){return this.quantize(2)},solarize:function(d){typeof d=="undefined"&&(d=0.5);for(var a=0,e=new f(256),d=~~(d*256)-1,a=0;a<256;)e[a]=a>d?255-(a<<1):(a<<1)-255,a++;return this.concat(e)},invert:function(){return this.concat(g)},mask:function(d){var a=0,e=d>>16&255,g=d>>8&255;d&=255;tR=new f(256);tG=new f(256);tB=new f(256);for(a=0;a<256;)tR[a]=a&e,tG[a]=a&g,tB[a]=a&d,a++;return this.concat(tR,tG,tB)},replace:function(d,a){if(d==a)return this;var e=d>>16&255,f=d>>8&255,g=d&255,q=
a>>16&255,C=a>>8&255,K=a&255,v=n(h),A=n(h),I=n(h);v[e]=q;A[f]=C;I[g]=K;return this.concat(v,A,I)},extract:function(a,e,f){if(!e||!e.length)return this;var f=f||0,g=f>>8&255,h=f&255,f=z(f>>16&255),g=z(g),h=z(h);switch(a){case d.CHANNEL.BLUE:a=e[0];for(e=e[1];a<=e;)h[a]=a,a++;break;case d.CHANNEL.GREEN:a=e[0];for(e=e[1];a<=e;)g[a]=a,a++;break;default:a=e[0];for(e=e[1];a<=e;)f[a]=a,a++}return this.concat(f,g,h)},gammaCorrection:function(d,e,g){for(var d=d||1,e=e||d,g=g||e,d=1/d,e=1/e,g=1/g,h=new f(256),
M=new f(256),n=new f(256),C=0;C<256;)h[C]=~~(255*a(q*C,d)),M[C]=~~(255*a(q*C,e)),n[C]=~~(255*a(q*C,g)),C++;return this.concat(h,M,n)},exposure:function(a){typeof a=="undefined"&&(a=1);for(var d=0,g=new f(256),d=0;d<256;)g[d]=~~(255*(1-e(-a*d*q))),d++;return this.concat(g)},concat:function(a,d,e){if(!a)return this;var d=d||a,e=e||d,f=this._tableR||O(),g,h,q=n(f),K,v,A;if(d&&e){g=this._tableG||n(f);h=this._tableB||n(g);K=n(g);v=n(h);for(A=0;A<256;)f[A]=a[q[A]],g[A]=d[K[A]],h[A]=e[v[A]],A++;this._tableR=
f;this._tableG=g;this._tableB=h}else{for(A=0;A<256;)f[A]=a[q[A]],A++;this._tableB=this._tableG=this._tableR=f}return this},combineWith:function(d){return this.concat(d.getTable(0),d.getTable(1),d.getTable(2))},getTable:function(a){a=a||d.CHANNEL.RED;switch(a){case d.CHANNEL.ALPHA:return this._tableA;case d.CHANNEL.BLUE:return this._tableB;case d.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(a,e){e=e||d.CHANNEL.RED;switch(e){case d.CHANNEL.ALPHA:return this._tableA=
a,this;case d.CHANNEL.BLUE:return this._tableB=a,this;case d.CHANNEL.GREEN:return this._tableG=a,this;default:return this._tableR=a,this}},_apply:function(a){if(!this._tableR)return a;var d=a.length,e=0,f,g,h,q,n=this._tableR,v=this._tableG,A=this._tableB,I=this._tableA;if(I)for(;e<d;)f=a[e],g=a[e+1],h=a[e+2],q=a[e+3],a[e]=n[f],a[e+1]=v[g],a[e+2]=A[h],a[e+3]=I[q],e+=4;else for(;e<d;)f=a[e],g=a[e+1],h=a[e+2],a[e]=n[f],a[e+1]=v[g],a[e+2]=A[h],e+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(d){var O=d.ImArray,z=Math.min;d.DisplacementMapFilter=function(d){d&&this.setMap(d)};d.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:d.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(d){this._map=d;return this},_apply:function(n,f,a){if(!this._map)return n;var e=this._map.getData(),q=this._map.width,h=this._map.height,g=q*h,r=new d.Array16I(g<<1),L=z(q,f),s=z(h,a),u=
this.scaleX*0.00390625,M=this.scaleY*0.00390625,H=this.componentX,C=this.componentY,h=this.color>>24&255,K=this.color>>16&255,v=this.color>>8&255,A=this.color&255,I=~~this.startY,F=~~this.startX,P=this.mode,w=I*f,G=-F,p=-I,T=f-F-1,J=a-I-1,Q,R,S,N,k,b=L*s<<2,i=new O(n),o=d.MODE.IGNORE,m=d.MODE.COLOR,E=d.MODE.WRAP;for(N=S=R=Q=s=0;s<g;)k=R+N<<2,r[Q]=~~((e[k+H]-128)*u),r[Q+1]=~~((e[k+C]-128)*M),s++,Q+=2,R++,R>=q&&(R=0,S++,N+=q);s=-4;R=-1;for(ty2=N=S=0;s<b;)if(s+=4,R++,R>=L&&(R=0,S++,N+=f,ty2+=q),!(S<
p||S>J||R<G||R>T)){u=R+F;g=S+I;e=u+N+w<<2;Q=R+ty2<<1;srcx=u+r[Q];srcy=g+r[Q+1];if(srcy>=a||srcy<0||srcx>=f||srcx<0)switch(P){case o:continue;case m:i[e]=K;i[e+1]=v;i[e+2]=A;i[e+3]=h;continue;case E:srcy>J&&(srcy-=a);srcy<0&&(srcy+=a);srcx>T&&(srcx-=f);srcx<0&&(srcx+=f);break;default:srcy>J&&(srcy=J),srcy<0&&(srcy=0),srcx>T&&(srcx=T),srcx<0&&(srcx=0)}Q=srcx+srcy*f<<2;i[e]=n[Q];i[e+1]=n[Q+1];i[e+2]=n[Q+2];i[e+3]=n[Q+3]}return i},apply:function(d){if(!this._map)return d;return d.setData(this._apply(d.getData(),
d.width,d.height,d))},reset:function(){this._map=null;return this}}})(FILTER);
(function(d){function O(a,d){var e,f,w,G,p,g=a.length,J=new s(g);for(w=f=e=G=0;G<g;)p=d-1-e+w<<2,J[G]=a[p],J[G+1]=a[p+1],J[G+2]=a[p+2],J[G+3]=a[p+3],G+=4,e++,e>=d&&(e=0,f++,w+=d);return J}function z(a,d,e){var f,w,G,p,g=a.length,J=new s(g);w=f=G=0;for(e=(e-1)*d;G<g;)p=f+e<<2,J[G]=a[p],J[G+1]=a[p+1],J[G+2]=a[p+2],J[G+3]=a[p+3],G+=4,f++,f>=d&&(f=0,w++,e-=d);return J}function n(a,d,e){var f,w,G,p,g,J=a.length,h=new s(J);w=f=p=0;for(e=(e-1)*d;p<J;)g=d-1-f+e<<2,h[p]=a[g],h[p+1]=a[g+1],h[p+2]=a[g+2],h[p+
3]=a[g+3],p+=4,f++,f>=d&&(f=0,w++,G+=d,e-=d);return h}function f(a,d,e){var f,w,G,p,g=a.length,J=new s(g),h=e*d;f=e=G=0;for(w=h-1;G<g;)p=f+w<<2,J[G]=a[p],J[G+1]=a[p+1],J[G+2]=a[p+2],J[G+3]=a[p+3],G+=4,e++,w-=d,e>=d&&(e=0,w=h-1,f++);return J}function a(a,d){var e,f,w,G,p,g=a.length,J=new s(g);for(w=f=e=G=0;G<g;)p=d-1-f+w<<2,J[G]=a[p],J[G+1]=a[p+1],J[G+2]=a[p+2],J[G+3]=a[p+3],G+=4,e++,w+=d,e>=d&&(w=e=0,f++);return J}function e(a,e,f){var g,w,G,p,h=a.length,J=new s(h),q=this.inverseTransform,r=this.mode,
C=d.MODE.WRAP,N;for(w=g=G=0;G<h;){N=q([g,w],e,f);p=~~N[0];N=~~N[1];if(0>p||p>=e||0>N||N>=f)switch(r){case C:N>=f?N-=f:N<0&&(N+=f);p>=e?p-=e:p<0&&(p+=e);break;default:N>=f?N=f-1:N<0&&(N=0),p>=e?p=e-1:p<0&&(p=0)}p=p+N*e<<2;J[G]=a[p];J[G+1]=a[p+1];J[G+2]=a[p+2];J[G+3]=a[p+3];G+=4;g++;g>=e&&(g=0,w++)}return J}function q(a,e,f){var g,w,G,p;f*=e;var h=a.length,J=new s(h);g=this.matrix;var q=g[0],r=g[1],C=g[3],N=g[4],k=g[2],b=g[5],i=this.mode,o=d.MODE.WRAP,m,E=e-1,j=f-e;w=g=G=0;b*=e;C*=e;for(N*=e;G<h;){p=
~~(q*g+r*w+k);m=~~(C*g+N*w+b);if(0>p||p>E||0>m||m>j)switch(i){case o:m>j?m-=f:m<0&&(m+=f);p>=e?p-=e:p<0&&(p+=e);break;default:m>j?m=j:m<0&&(m=0),p>E?p=E:p<0&&(p=0)}p=p+m<<2;J[G]=a[p];J[G+1]=a[p+1];J[G+2]=a[p+2];J[G+3]=a[p+3];G+=4;g++;g>=e&&(g=0,w++)}return J}function h(a,e,f){if(0>=this.radius)return a;var g,w,G,p,h=a.length,J=new s(a),q=this.centerX,r=this.centerY,n=this.radius,N=this.mode,k=d.MODE.WRAP,b,i,o=this.angle/n,m=e-1,E=f-1;for(w=g=G=0;G<h;){b=g-q;i=w-r;p=u(b*b+i*i);if(p<n){i=M(i,b)+o*
(n-p);b=~~(q+p*C(i));i=~~(r+p*H(i));if(0>b||b>m||0>i||i>E)switch(N){case k:i>E?i-=f:i<0&&(i+=f);b>m?b-=e:b<0&&(b+=e);break;default:i>E?i=E:i<0&&(i=0),b>m?b=m:b<0&&(b=0)}p=b+i*e<<2;J[G]=a[p];J[G+1]=a[p+1];J[G+2]=a[p+2];J[G+3]=a[p+3]}G+=4;g++;g>=e&&(g=0,w++)}return J}function g(a,e,f){if(0>=this.radius)return a;var g,w,G,p,h=a.length,J=new s(a),q=this.centerX,r=this.centerY;g=this.radius;var C=this.mode,N=d.MODE.WRAP,k,b=g*g,i=1-0.555556,o,m,E,j,l=e-1,x=f-1;for(w=g=G=0;G<h;){p=g-q;k=w-r;E=p*p;j=k*k;
o=E+j;if(o<b){m=b-o;o=u(m);p=K(p/u(E+m))*i;k=K(k/u(j+m))*i;p=~~(g-o*v(p));k=~~(w-o*v(k));if(0>p||p>l||0>k||k>x)switch(C){case N:k>x?k-=f:k<0&&(k+=f);p>l?p-=e:p<0&&(p+=e);break;default:k>x?k=x:k<0&&(k=0),p>l?p=l:p<0&&(p=0)}p=p+k*e<<2;J[G]=a[p];J[G+1]=a[p+1];J[G+2]=a[p+2];J[G+3]=a[p+3]}G+=4;g++;g>=e&&(g=0,w++)}return J}function r(a){return a}function L(a){return a}var s=d.ImArray,u=Math.sqrt,M=Math.atan2,H=Math.sin,C=Math.cos,K=Math.asin,v=Math.tan;d.GeometricMapFilter=function(a){this.generic(a)};
d.GeometricMapFilter.prototype={_map:null,inverseTransform:null,matrix:null,centerX:0,centerY:0,angle:0,radius:0,mode:d.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=e;return this},affine:function(a){if(a)this.matrix=a,this._map=q;return this},flipX:function(){this._map=O;return this},flipY:function(){this._map=z;return this},flipXY:function(){this._map=n;return this},rotateCW:function(){this._map=f;return this},rotateCCW:function(){this._map=a;return this},polar:function(a,
d){this.centerX=a||0;this.centerY=d||0;this._map=r;return this},cartesian:function(a,d){this.centerX=a||0;this.centerY=d||0;this._map=L;return this},twirl:function(a,d,e,f){this.angle=a||0;this.radius=d||0;this.centerX=e||0;this.centerY=f||0;this._map=h;return this},sphere:function(a,d,e){this.radius=a||0;this.centerX=d||0;this.centerY=e||0;this._map=g;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},_apply:function(a,
d,e,f){if(!this._map)return a;return this._map.call(this,a,d,e,f)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height,a))},reset:function(){this._map=null;return this}}})(FILTER);
(function(d){function O(w,a,d,e){var f=w.length,g,h=new H(w.length),d=d||1,e=e||1;for(g=0;g<f;)h[g]=d*w[g]+e*a[g],g++;return h}function z(w,a){var d,e,f=w.length,g,h=[],q=0;for(d=0;d<f;d++)for(e=0;e<f;e++)g=w[d]*a[e],q+=g,h.push(g);return{kernel:h,sum:q}}function n(w){var a,d=Array(w);for(a=0;a<w;)d[a]=1,a++;return d}function f(w){var a=K.length,d,e,f,g;w--;if(w<a)d=new H(K[w]);else for(d=new H(K[a-1]);a<=w;){e=d;d=new H(e.length+1);d[0]=1;f=0;for(g=e.length-1;f<g;f++)d[f+1]=e[f]+e[f+1];d[e.length]=
1;a<40&&K.push(Array(d));a++}return d}function a(w){var a,d=-(w>>1),e=Array(w);for(a=0;a<w;)e[a]=d,d++,a++;return e}function e(w,d){var e=f(w),g=a(w);return 1==d?z(g.reverse(),e):z(e,g)}function q(w,d){var e=n(w),f=a(w);return 1==d?z(f.reverse(),e):z(e,f)}function h(w,a,d){a=a||1;d=d||a;w*=w;var e=w>>1,f,g=new H(w);for(f=0;f<w;)g[f]=a,f++;g[e]=d;return g}function g(w,a,d,e){for(var f=w*w,g=w>>1,h=f>>1,q,r,k=new H(f),b,i,f=b=0;f<=g;f++){for(r=i=q=0;r<=g;r++)k[h+f+q]=b+i,k[h-f-q]=-b-i,k[h-f+q]=-b+i,
k[h+f-q]=b-i,q+=w,i+=d;b+=a}k[h]=e||1;return k}function r(w,a,d,e){var f=w*w,g=w>>1,h=f>>1,q=new H(f),f=new H(f),r,k,b,i=1/w;A(a)>1.0E-8?(k=1,b=d/a):(k=a/d,b=1);r=d=a=0;for(w*=b;a<=g;)f[h+a]=~~(h+d+r+0.5),f[h-a]=~~(h-d-r+0.5),a++,d+=k,r+=w;for(a=0;a<=g;)q[f[h+a]]=q[f[h-a]]=i,a++;q[h]=e||1;return q}function L(w,a,e,f,g,h,q,r,N,k){var b=w.length,i,o,m,E,j,l,x,y,t,c,D,U,B,n,s,A,v,L,H,u,I,F,K;i=a*e;j=h*q;h>>=1;q=a*(q>>1);e=-h-1;y=-q-a;L=a-1;H=i-a;i=(i<<1)+i;x=(a<<1)+a;k=k||1;K=0;if(g){D=f[0];f=f[j>>1];
f-=D;U=g[0];g=g[j>>1];for(B=g-U;K<k;){l=new M(w);g=new d.Array32F(i);for(o=m=E=c=t=j=0;c<a;)o+=w[j],m+=w[j+1],E+=w[j+2],g[t]=o,g[t+1]=m,g[t+2]=E,j+=4,t+=3,c++;j=x+a;t=x;for(o=m=E=c=0;j<b;)o+=w[j],m+=w[j+1],E+=w[j+2],g[t]=g[t-x]+o,g[t+1]=g[t-x+1]+m,g[t+2]=g[t-x+2]+E,j+=4,t+=3,c++,c>=a&&(o=m=E=c=0);for(m=o=c=j=0;j<b;)n=c+e,s=m+y,A=c+h,v=m+q,n<0?n=0:A>L&&(A=L),s<0?s=0:v>H&&(v=H),E=n+s,t=A+v,s=A+s,u=n+v,E=(E<<1)+E,s=(s<<1)+s,u=(u<<1)+u,t=(t<<1)+t,A=D*(g[t]-g[s]-g[u]+g[E])+f*w[j],v=D*(g[t+1]-g[s+1]-g[u+
1]+g[E+1])+f*w[j+1],n=D*(g[t+2]-g[s+2]-g[u+2]+g[E+2])+f*w[j+2],I=U*(g[t]-g[s]-g[u]+g[E])+B*w[j],F=U*(g[t+1]-g[s+1]-g[u+1]+g[E+1])+B*w[j+1],t=U*(g[t+2]-g[s+2]-g[u+2]+g[E+2])+B*w[j+2],E=r*A+N*I,s=r*v+N*F,t=r*n+N*t,C&&(E<0?E=0:E>255&&(E=255),s<0?s=0:s>255&&(s=255),t<0?t=0:t>255&&(t=255)),l[j]=~~E,l[j+1]=~~s,l[j+2]=~~t,j+=4,c++,c>=a&&(c=0,o++,m+=a);w=l;K++}}else{D=f[0];f=f[j>>1];f-=D;r=r||1;for(N=N||0;K<k;){l=new M(w);g=new d.Array32F(i);for(o=m=E=c=t=j=0;c<a;)o+=w[j],m+=w[j+1],E+=w[j+2],g[t]=o,g[t+1]=
m,g[t+2]=E,j+=4,t+=3,c++;j=x+a;t=x;for(o=m=E=c=0;j<b;)o+=w[j],m+=w[j+1],E+=w[j+2],g[t]=g[t-x]+o,g[t+1]=g[t-x+1]+m,g[t+2]=g[t-x+2]+E,j+=4,t+=3,c++,c>=a&&(o=m=E=c=0);for(m=o=c=j=0;j<b;)n=c+e,s=m+y,A=c+h,v=m+q,n<0?n=0:A>L&&(A=L),s<0?s=0:v>H&&(v=H),E=n+s,t=A+v,s=A+s,u=n+v,E=(E<<1)+E,s=(s<<1)+s,u=(u<<1)+u,t=(t<<1)+t,A=D*(g[t]-g[s]-g[u]+g[E])+f*w[j],v=D*(g[t+1]-g[s+1]-g[u+1]+g[E+1])+f*w[j+1],n=D*(g[t+2]-g[s+2]-g[u+2]+g[E+2])+f*w[j+2],E=r*A+N,s=r*v+N,t=r*n+N,C&&(E<0?E=0:E>255&&(E=255),s<0?s=0:s>255&&(s=
255),t<0?t=0:t>255&&(t=255)),l[j]=~~E,l[j+1]=~~s,l[j+2]=~~t,j+=4,c++,c>=a&&(c=0,o++,m+=a);w=l;K++}}return l}function s(a,e,f,g,h,q,r,s){var n=matRadiusY=3,k=matHalfSideY=1,b,i=new d.Array16I(18),o=new d.Array8U(9),m=e*f,f=a.length,E=new M(f),j,l,x,y,t,c,D,v=e-1,B=m-e;for(t=y=m=l=x=0;l<9;)o[l]=m+y,i[x]=m-k,i[x+1]=t-e,x+=2,l++,m++,m>=n&&(m=0,y+=n,t+=e);if(h)for(y=m=n=0;n<f;)x=t=D=k=l=j=0,c=m+i[0],b=y+i[1],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[0]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[0]],D+=a[c]*
b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[2],b=y+i[3],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[1]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[1]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[4],b=y+i[5],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[2]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[2]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[6],b=y+i[7],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[3]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[3]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[8],b=y+i[9],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,
b=g[o[4]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[4]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[10],b=y+i[11],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[5]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[5]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[12],b=y+i[13],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[6]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[6]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[14],b=y+i[15],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[7]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[7]],D+=a[c]*b,t+=a[c+1]*
b,x+=a[c+2]*b),c=m+i[16],b=y+i[17],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[8]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[8]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),s?(j=A(j)+A(D),l=A(l)+A(t),k=A(k)+A(x)):(j=q*j+r*D,l=q*l+r*t,k=q*k+r*x),C&&(j<0?j=0:j>255&&(j=255),l<0?l=0:l>255&&(l=255),k<0?k=0:k>255&&(k=255)),E[n]=~~j,E[n+1]=~~l,E[n+2]=~~k,E[n+3]=a[n+3],n+=4,m++,m>=e&&(m=0,y+=e);else for(y=m=n=0;n<f;)k=l=j=0,c=m+i[0],b=y+i[1],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[0]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),
c=m+i[2],b=y+i[3],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[1]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[4],b=y+i[5],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[2]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[6],b=y+i[7],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[3]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[8],b=y+i[9],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[4]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[10],b=y+i[11],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[5]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[12],b=y+
i[13],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[6]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[14],b=y+i[15],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[7]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[16],b=y+i[17],c>=0&&c<=v&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[8]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),j=q*j+r,l=q*l+r,k=q*k+r,C&&(j<0?j=0:j>255&&(j=255),l<0?l=0:l>255&&(l=255),k<0?k=0:k>255&&(k=255)),E[n]=~~j,E[n+1]=~~l,E[n+2]=~~k,E[n+3]=a[n+3],n+=4,m++,m>=e&&(m=0,y+=e);return E}function u(a,e,f,g,h,q,r,s){var n=matRadiusY=
5,k=matHalfSideY=2,b,i=new d.Array16I(50),o=new d.Array8U(25),m=e*f,f=a.length,v=new M(f),j,l,x,y,t,c,D,u=e-1,B=m-e;for(t=y=m=l=x=0;l<25;)o[l]=m+y,i[x]=m-k,i[x+1]=t-e,x+=2,l++,m++,m>=n&&(m=0,y+=n,t+=e);if(h)for(y=m=n=0;n<f;)x=t=D=k=l=j=0,c=m+i[0],b=y+i[1],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[0]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[0]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[2],b=y+i[3],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[1]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[1]],D+=a[c]*b,t+=a[c+
1]*b,x+=a[c+2]*b),c=m+i[4],b=y+i[5],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[2]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[2]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[6],b=y+i[7],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[3]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[3]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[8],b=y+i[9],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[4]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[4]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[10],b=y+i[11],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[5]],
j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[5]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[12],b=y+i[13],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[6]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[6]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[14],b=y+i[15],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[7]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[7]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[16],b=y+i[17],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[8]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[8]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+
2]*b),c=m+i[18],b=y+i[19],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[9]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[9]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[20],b=y+i[21],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[10]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[10]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[22],b=y+i[23],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[11]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[11]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[24],b=y+i[25],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[12]],
j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[12]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[26],b=y+i[27],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[13]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[13]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[28],b=y+i[29],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[14]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[14]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[30],b=y+i[31],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[15]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[15]],D+=a[c]*b,t+=a[c+1]*b,
x+=a[c+2]*b),c=m+i[32],b=y+i[33],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[16]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[16]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[34],b=y+i[35],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[17]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[17]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[36],b=y+i[27],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[18]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[18]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[38],b=y+i[39],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,
b=g[o[19]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[19]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[40],b=y+i[41],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[20]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[20]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[42],b=y+i[43],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[21]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[21]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[44],b=y+i[45],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[22]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[22]],D+=a[c]*b,
t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[46],b=y+i[47],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[23]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[23]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),c=m+i[48],b=y+i[49],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[24]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b,b=h[o[24]],D+=a[c]*b,t+=a[c+1]*b,x+=a[c+2]*b),s?(j=A(j)+A(D),l=A(l)+A(t),k=A(k)+A(x)):(j=q*j+r*D,l=q*l+r*t,k=q*k+r*x),C&&(j<0?j=0:j>255&&(j=255),l<0?l=0:l>255&&(l=255),k<0?k=0:k>255&&(k=255)),v[n]=~~j,v[n+1]=~~l,v[n+2]=~~k,v[n+3]=a[n+
3],n+=4,m++,m>=e&&(m=0,y+=e);else for(y=m=n=0;n<f;)k=l=j=0,c=m+i[0],b=y+i[1],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[0]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[2],b=y+i[3],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[1]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[4],b=y+i[5],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[2]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[6],b=y+i[7],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[3]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[8],b=y+i[9],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=
g[o[4]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[10],b=y+i[11],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[5]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[12],b=y+i[13],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[6]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[14],b=y+i[15],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[7]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[16],b=y+i[17],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[8]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[18],b=y+i[19],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[9]],
j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[20],b=y+i[21],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[10]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[22],b=y+i[23],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[11]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[24],b=y+i[25],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[12]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[26],b=y+i[27],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[13]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[28],b=y+i[29],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[14]],j+=
a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[30],b=y+i[31],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[15]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[32],b=y+i[33],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[16]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[34],b=y+i[35],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[17]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[36],b=y+i[27],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[18]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[38],b=y+i[39],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[19]],j+=a[c]*
b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[40],b=y+i[41],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[20]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[42],b=y+i[43],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[21]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[44],b=y+i[45],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[22]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[46],b=y+i[47],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[23]],j+=a[c]*b,l+=a[c+1]*b,k+=a[c+2]*b),c=m+i[48],b=y+i[49],c>=0&&c<=u&&b>=0&&b<=B&&(c=c+b<<2,b=g[o[24]],j+=a[c]*b,
l+=a[c+1]*b,k+=a[c+2]*b),j=q*j+r,l=q*l+r,k=q*k+r,C&&(j<0?j=0:j>255&&(j=255),l<0?l=0:l>255&&(l=255),k<0?k=0:k>255&&(k=255)),v[n]=~~j,v[n+1]=~~l,v[n+2]=~~k,v[n+3]=a[n+3],n+=4,m++,m>=e&&(m=0,y+=e);return v}var M=d.ImArray,H=d.Array32F,C=d._notSupportTypedArrays,K=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],v=d.CONSTANTS.toRad,A=Math.abs,I=Math.sqrt,F=Math.sin,P=Math.cos;d.ConvolutionMatrixFilter=function(a,d,e){typeof a!=
"undefined"&&a.length?(this.set(a,~~(I(a.length)+0.5),d||1),this._bias=e||0):(this._matrix=null,this._dim=0);this._matrix2=null;this._coeff1=this._coeff2=0;this._dim2=this._dim;this._isGrad=!1;this._doFast=0;this._doSeparable=!1};d.ConvolutionMatrixFilter.prototype={_dim:0,_dim2:0,_matrix:null,_matrix2:null,_factor:1,_bias:0,_coeff1:0,_coeff2:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(h(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,d){var a=typeof a=="undefined"?
3:a%2?a:a+1,e=-(typeof d=="undefined"?1:d)/(a*a);this.set(h(a,e,1+e),a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},glow:function(a,d){return this.highPass(d,-(typeof a=="undefined"?0.5:a))},sharpen:function(a,d){return this.highPass(d,typeof a=="undefined"?0.5:a)},verticalBlur:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(n(a),1,1/a);this._dim2=a;this._doFast=1;return this},horizontalBlur:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(n(a),a,1/a);
this._doFast=this._dim2=1;return this},directionalBlur:function(a,d){d=typeof d=="undefined"?3:d%2?d:d+1;a*=v;var e=P(a),f=-F(a);return this.set(r(d,e,f,1/d),d,1)},fastGauss:function(a,d){d=typeof d=="undefined"?3:d%2?d:d+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(h(d),d,1/(d*d));this._doFast=a;return this},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,d=f(a),e=1/(1<<a-1);this.set(d,a,1);this._matrix2=new H(d);this._coeff1=this._coeff2=e;this._doSeparable=!0;return this},binomialHighPass:function(a){var a=
typeof a=="undefined"?3:a%2?a:a+1,d;d=f(a);d=z(d,d);return this.set(O(h(a),new H(d.kernel),1,-1/d.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(q(a,0).kernel,a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(q(a,1).kernel,a,1)},prewittDirectional:function(a,d){d=typeof d=="undefined"?3:d%2?d:d+1;a*=v;var e=P(a),f=F(a),g=q(d,0),h=q(d,1);return this.set(O(new H(g.kernel),new H(h.kernel),
e,f),d,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,d=q(a,0),e=q(a,1);this.set(d.kernel,a,1);this._isGrad=!0;this._matrix2=new H(e.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},gradDirectional:function(a,d){return this.prewittDirectional(a,d)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(e(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:
a%2?a:a+1;return this.set(e(a,1).kernel,a,1)},sobelDirectional:function(a,d){d=typeof d=="undefined"?3:d%2?d:d+1;a*=v;var f=P(a),g=F(a),h=e(d,0),q=e(d,1);return this.set(O(new H(h.kernel),new H(q.kernel),f,g),d,1)},sobel:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,d=e(a,0),f=e(a,1);this.set(d.kernel,a,1);this._matrix2=new H(f.kernel);this._isGrad=!0;return this},laplace:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(h(a,-1,a*a-1),a,1);this._doFast=1;return this},emboss:function(a,
d,e){var e=typeof e=="undefined"?3:e%2?e:e+1,a=typeof a=="undefined"?-0.25*Math.PI:a*v,d=d||1,f=d*P(a),a=-d*F(a);return this.set(g(e,f,a,1),e,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,d,e){this._matrix2=null;this._coeff1=this._coeff2=0;this._isGrad=!1;this._doFast=0;this._doSeparable=!1;this._matrix=new H(a);this._dim2=this._dim=d;this._factor=e||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,
d){this._matrix=a;this._dim2=this._dim=d;this._matrix2=null;this._coeff1=this._coeff2=0;this._isGrad=!1;this._doFast=0;this._doSeparable=!1;return this},_apply:function(a,e,f){if(!this._matrix)return a;if(this._doFast)return this._matrix2?L(a,e,f,this._matrix,this._matrix2,this._dim,this._dim2,this._coeff1,this._coeff2,this._doFast):L(a,e,f,this._matrix,null,this._dim,this._dim2,this._factor,this._bias,this._doFast);else if(this._doSeparable){var g=this._dim,h=this._dim2,q=a.length,r,n,v,k,b,i,o,
m,E,j,l,x,y,t,c,D,H,B,I,K,F,z;n=[h,g];v=[this._matrix2,this._matrix];r=[1,g];g=[0,g>>1];h=[h>>1,0];K=[this._coeff2,this._coeff1];B=e-1;I=e*f-e;for(z=2;--z;){m=new M(a);f=n[z];o=v[z];b=g[z];i=h[z];k=r[z];F=K[z];j=new d.Array16I(f<<1);E=new d.Array8U(f);c=t=y=x=l=0;for(i*=e;x<f;)E[x]=y+t,j[l]=y-b,j[l+1]=c-i,l+=2,x++,y++,y>=k&&(y=0,t+=k,c+=e);for(t=y=k=0;k<q;){for(x=l=b=c=i=0;x<f;)D=y+j[l],H=t+j[l+1],D>=0&&D<=B&&H>=0&&H<=I&&(srcOff=D+H<<2,D=F*o[E[x]],i+=a[srcOff]*D,c+=a[srcOff+1]*D,b+=a[srcOff+2]*D),
l+=2,x++;l=i;x=c;C&&(l<0?l=0:l>255&&(l=255),x<0?x=0:x>255&&(x=255),b<0?b=0:b>255&&(b=255));m[k]=~~l;m[k+1]=~~x;m[k+2]=~~b;m[k+3]=a[k+3];k+=4;y++;y>=e&&(y=0,t+=e)}a=m}return m}else if(3==this._dim)return this._matrix2?s(a,e,f,this._matrix,this._matrix2,this._coeff1,this._coeff2,this._isGrad):s(a,e,f,this._matrix,null,this._factor,this._bias,!1);else if(5==this._dim)return this._matrix2?u(a,e,f,this._matrix,this._matrix2,this._coeff1,this._coeff2,this._isGrad):u(a,e,f,this._matrix,null,this._factor,
this._bias,!1);q=l=this._dim;x=l>>1;m=l*q;k=(q>>1)*e;q=this._matrix;t=this._factor;I=this._bias;r=this._matrix2;n=this._isGrad;v=new d.Array16I(m<<1);g=new d.Array8U(m);f*=e;h=a.length;B=new M(h);K=e-1;E=f-e;j=this._coeff1;y=this._coeff2;for(b=o=f=z=F=0;z<m;)g[z]=f+o,v[F]=f-x,v[F+1]=b-k,F+=2,z++,f++,f>=l&&(f=0,o+=l,b+=e);if(r)for(o=f=l=0;l<h;){for(z=F=t=I=i=x=k=b=0;z<m;)c=f+v[F],D=o+v[F+1],c>=0&&c<=K&&D>=0&&D<=E&&(c=c+D<<2,D=q[g[z]],b+=a[c]*D,k+=a[c+1]*D,x+=a[c+2]*D,D=r[g[z]],i+=a[c]*D,I+=a[c+1]*
D,t+=a[c+2]*D),F+=2,z++;n?(F=A(b)+A(i),z=A(k)+A(I),x=A(x)+A(t)):(F=j*b+y*i,z=j*k+y*I,x=j*x+y*t);C&&(F<0?F=0:F>255&&(F=255),z<0?z=0:z>255&&(z=255),x<0?x=0:x>255&&(x=255));B[l]=~~F;B[l+1]=~~z;B[l+2]=~~x;B[l+3]=a[l+3];l+=4;f++;f>=e&&(f=0,o+=e)}else for(o=f=l=0;l<h;){for(z=F=x=k=b=0;z<m;)c=f+v[F],D=o+v[F+1],c>=0&&c<=K&&D>=0&&D<=E&&(c=c+D<<2,D=q[g[z]],b+=a[c]*D,k+=a[c+1]*D,x+=a[c+2]*D),F+=2,z++;F=t*b+I;z=t*k+I;x=t*x+I;C&&(F<0?F=0:F>255&&(F=255),z<0?z=0:z>255&&(z=255),x<0?x=0:x>255&&(x=255));B[l]=~~F;B[l+
1]=~~z;B[l+2]=~~x;B[l+3]=a[l+3];l+=4;f++;f>=e&&(f=0,o+=e)}return B},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(d){var O=d.ImArray,z=function(a,f,h){var g=this._dim,r=g>>1,n=g*g,s=r*f,u=new d.Array32I(n<<1),z=f*h,h=a.length,H=new O(h),C,K,v,A=[],I=[],F=[];n<<=1;var P=f-1,w=z-f;for(K=z=C=0;C<n;)u[C]=z-r,u[C+1]=K-s,C+=2,z++,z>=g&&(z=0,K+=f);for(K=z=g=0;g<h;){A.length=0;I.length=0;for(C=F.length=0;C<n;)r=z+u[C],s=K+u[C+1],r>=0&&r<=P&&s>=0&&s<=w&&(v=r+s<<2,r=a[v],s=a[v+1],v=a[v+2],A.push(r),I.push(s),F.push(v)),C+=2;A.sort();I.sort();F.sort();s=A.length;v=s>>1;C=s%2?A[v+1]:~~(0.5*(A[v]+A[v+1]));s=I.length;
v=s>>1;r=s%2?I[v+1]:~~(0.5*(I[v]+I[v+1]));s=F.length;v=s>>1;s=s%2?F[v+1]:~~(0.5*(F[v]+F[v+1]));H[g]=C;H[g+1]=r;H[g+2]=s;H[g+3]=a[g+3];g+=4;z++;z>=f&&(z=0,K+=f)}return H},n=function(a,f,h){var g=this._dim,r=g>>1,n=g*g,s=r*f,u=new d.Array32I(n<<1),z=f*h,h=a.length,H=new O(h),C,K,v,A,I,F;n<<=1;var P=f-1,w=z-f;for(K=C=z=0;z<n;)u[z]=C-r,u[z+1]=K-s,z+=2,C++,C>=g&&(C=0,K+=f);for(K=C=g=0;g<h;){for(z=F=s=r=0;z<n;)v=C+u[z],A=K+u[z+1],v>=0&&v<=P&&A>=0&&A<=w&&(I=v+A<<2,v=a[I],A=a[I+1],I=a[I+2],v>r&&(r=v),A>s&&
(s=A),I>F&&(F=I)),z+=2;H[g]=r;H[g+1]=s;H[g+2]=F;H[g+3]=a[g+3];g+=4;C++;C>=f&&(C=0,K+=f)}return H},f=function(a,f,h){var g=this._dim,n=g>>1,z=g*g,s=n*f,u=new d.Array32I(z<<1),M=f*h,h=a.length,H=new O(h),C,K,v,A,I,F;z<<=1;var P=f-1,w=M-f;for(K=C=M=0;M<z;)u[M]=C-n,u[M+1]=K-s,M+=2,C++,C>=g&&(C=0,K+=f);for(K=C=g=0;g<h;){F=s=n=255;for(M=0;M<z;)v=C+u[M],A=K+u[M+1],v>=0&&v<=P&&A>=0&&A<=w&&(I=v+A<<2,v=a[I],A=a[I+1],I=a[I+2],v<n&&(n=v),A<s&&(s=A),I<F&&(F=I)),M+=2;H[g]=n;H[g+1]=s;H[g+2]=F;H[g+3]=a[g+3];g+=4;
C++;C>=f&&(C=0,K+=f)}return H},a=function(a){return a};d.StatisticalFilter=function(){this._dim=0;this._apply=a};d.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=z;return this},erode:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=f;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=n;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),
a.width,a.height,a))},reset:function(){this._apply=a;this._dim=0;return this}}})(FILTER);
