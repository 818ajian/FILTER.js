/** 
*
* FILTER.js Image Processing Filter Library for JavaScript and HTML5 canvas
* http://github.com/foo123/FILTER.js
*
* @version 0.6.3
*
* @author Nikos M. http://nikos-web-development-netai.net
*
**/var FILTER=FILTER||{};
(function(a){function x(a,l){var a=a||{},b;for(b in l)l&&Object.prototype.hasOwnProperty.call(l,b)&&(a[b]=l[b]);return a}a.Array32F=typeof Float32Array!=="undefined"?Float32Array:Array;a.Array64F=typeof Float64Array!=="undefined"?Float64Array:Array;a.Array8I=typeof Int8Array!=="undefined"?Int8Array:Array;a.Array16I=typeof Int16Array!=="undefined"?Int16Array:Array;a.Array32I=typeof Int32Array!=="undefined"?Int32Array:Array;a.Array8U=typeof Uint8Array!=="undefined"?Uint8Array:Array;a.Array16U=typeof Uint16Array!==
"undefined"?Uint16Array:Array;a.Array32U=typeof Uint32Array!=="undefined"?Uint32Array:Array;a.ImArray=typeof Uint8ClampedArray!=="undefined"?Uint8ClampedArray:a.Array8U;a._notSupportTypedArrays=!a.ImArray.set;a.CONSTANTS={PI:Math.PI,SQRT2:Math.SQRT2,toRad:Math.PI/180,toDeg:180/Math.PI};a.CHANNEL={RED:0,GREEN:1,BLUE:2,ALPHA:3};a.MODE={IGNORE:0,WRAP:1,CLAMP:2,COLOR:4};a.LUMA=new a.Array32F([0.212671,0.71516,0.072169]);a.Filter=function(){};a.Filter.prototype={_apply:function(){},apply:function(){},
reset:function(){}};a.CompositeFilter=function(a){this._stack=typeof a!="undefined"&&a.length?a:[]};a.CompositeFilter.prototype={_stack:[],_apply:function(a,l,b,d){if(!this._stack.length)return a;for(var c=this._stack,e=c.length,g=0,f;g<e;)(f=c[g++])&&(a=f._apply(a,l,b,d));return a},apply:function(a){if(!this._stack.length)return a;return a.setData(this._apply(im=a.getData(),a.width,a.height,a))},filters:function(a){if(a)this._stack=a;return this},push:function(a){this._stack.push(a);return this},
pop:function(){return this._stack.pop()},shift:function(){return this._stack.shift()},unshift:function(a){this._stack.unshift(a);return this},concat:function(a){return this.push(a)},getAt:function(a){return this._stack.length>a?this._stack[a]:null},setAt:function(a,l){this._stack.length>a&&(this._stack[a]=l);return this},insertAt:function(a,l){this._stack.splice(a,0,l);return this},removeAt:function(a){this._stack.splice(a,1);return this},remove:function(a){for(var l=this._stack.length;--l>=0;)a===
this._stack[l]&&this._stack.splice(l,1);return this},reset:function(){this._stack.length=0;return this}};a.Create=function(a){var l=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},a=x({init:function(){},reset:function(){return this},apply:function(b){return b}},a);a._apply=a.apply;a.apply=function(b){return b.setData(this._apply(b.getData(),b.width,b.height,b))};l.prototype=x(l.prototype,a);return l}})(FILTER);
(function(a){var x=Math.sqrt,n=Math.min,l=Math.max;a.Color={blend:function(b,d,c){return{r:b.r-~~((b.r-d.r)*c+0.5),g:b.g-~~((b.g-d.g)*c+0.5),b:b.b-~~((b.b-d.b)*c+0.5)}},toGray:function(b,d,c){var e=a.LUMA;return~~(e[0]*b+e[1]*d+e[2]*c)},distance:function(b,d){var c=b.r-d.r,e=b.g-d.g,a=b.b-d.b;return x(c*c+e*e+a*a)},RGB2Color:function(b){return b.r<<16|b.g<<8|b.b&255},RGBA2Color:function(b){return b.a<<24|b.r<<16|b.g<<8|b.b&255},Color2RGBA:function(b){b=~~b;return{r:b>>>16&255,g:b>>>8&255,b:b&255,
a:b>>>24&255}},RGB2YCbCr:function(b){var d=b.r,c=b.g,b=b.b;return{y:~~(0+0.299*d+0.587*c+0.114*b),cb:~~(128-0.168736*d-0.331264*c+0.5*b),cr:~~(128+0.5*d-0.418688*c-0.081312*b)}},YCbCr2RGB:function(b){var d=b.y,c=b.cb,b=b.cr;return{r:~~(d+1.402*(b-128)),g:~~(d-0.34414*(c-128)-0.71414*(b-128)),b:~~(d+1.772*(c-128))}},RGB2HSV:function(b){var d,c,e,a;c=b.r;e=b.g;a=b.b;d=n(c,e,a);b=l(c,e,a);d=b-d;if(b==0)return{h:0,s:0,v:b};c=c==b?(e-a)/d:e==b?2+(a-c)/d:4+(c-e)/d;c*=60;c<0&&(c+=360);return{h:c,s:d/b,v:b}},
HSV2RGB:function(b){var d,c,e,a,f;e=b.h;f=b.s;b=b.v;if(f==0)return d=c=b,{r:d,g:c,b:b};e/=60;d=~~e;c=e-d;e=b*(1-f);a=b*(1-f*c);f=b*(1-f*(1-c));switch(d){case 0:d=b;c=f;b=e;break;case 1:d=a;c=b;b=e;break;case 2:d=e;c=b;b=f;break;case 3:d=e;c=a;break;case 4:d=f;c=e;break;default:d=b,c=e,b=a}return{r:d,g:c,b:b}}}})(FILTER);
(function(a){function x(c,b){var d=document.createElement("canvas");d.width=c||0;d.height=b||0;return d}var n,l=Math.min,b=a.ImArray;n={normal:function(c){return c},lighten:function(c,b){return b>c?b:c},darken:function(c,b){return b>c?c:b},multiply:function(c,b){return c*b*0.003921568627451},average:function(c,b){return 0.5*(c+b)},add:function(c,b){return Math.min(255,c+b)},substract:function(c,b){return c+b<255?0:c+b-255},difference:function(c,b){return Math.abs(c-b)},negation:function(c,b){return 255-
Math.abs(255-c-b)},screen:function(c,b){return 255-((255-c)*(255-b)>>8)},exclusion:function(c,b){return c+b-2*c*b*0.003921568627451},overlay:function(c,b){return b<128?2*c*b*0.003921568627451:255-2*(255-c)*(255-b)*0.003921568627451},softLight:function(c,b){return b<128?2*((c>>1)+64)*b*0.003921568627451:255-2*(255-((c>>1)+64))*(255-b)*0.003921568627451},hardLight:function(c,b){return c<128?2*b*c*0.003921568627451:255-2*(255-b)*(255-c)*0.003921568627451},colorDodge:function(c,b){return b==255?b:Math.min(255,
(c<<8)/(255-b))},colorBurn:function(c,b){return b==0?b:Math.max(0,255-(255-c<<8)/b)},linearLight:function(c,b){return b<128?n.linearBurn(c,2*b):n.linearDodge(c,2*(b-128))},vividLight:function(c,b){return b<128?n.colorBurn(c,2*b):n.colorDodge(c,2*(b-128))},pinLight:function(c,b){return b<128?n.darken(c,2*b):n.lighten(c,2*(b-128))},hardMix:function(c,b){return n.vividLight(c,b)<128?0:255},reflect:function(c,b){return b==255?b:Math.min(255,c*c/(255-b))},glow:function(c,b){return c==255?c:Math.min(255,
b*b/(255-c))},phoenix:function(c,b){return Math.min(c,b)-Math.max(c,b)+255}};n.linearDodge=n.add;n.linearBurn=n.substract;a.blendModes=n;var d=a._notSupportTypedArrays;a.Image=function(c,b){this.height=this.width=0;this.imageData=this.context=null;this.domElement=this.canvasElement=x(this.width,this.height);this.context=this.canvasElement.getContext("2d");this._tmpCanvas=x(this.width,this.height);this._integral=this._histogram=null;this._integralRefresh=this._histogramRefresh=!0;this.setImage(c,b)};
a.Image.prototype={width:0,height:0,canvasElement:null,domElement:null,setWidth:function(c){this._tmpCanvas.width=this.canvasElement.width=this.width=c;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setHeight:function(c){this._tmpCanvas.height=this.canvasElement.height=this.height=c;this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,
0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},setImage:function(c,b){if(typeof c=="undefined"||c==null)return this;var d=this,a,h;c instanceof Image||c instanceof HTMLCanvasElement||c instanceof HTMLVideoElement?(a=c,this.width=a instanceof HTMLVideoElement?a.videoWidth:a.width,this.height=a instanceof HTMLVideoElement?a.videoHeight:a.height,this._tmpCanvas.width=this.canvasElement.width=this.width,this._tmpCanvas.height=this.canvasElement.height=this.height,
h=this.context=this.canvasElement.getContext("2d"),h.drawImage(c,0,0),this.imageData=h.getImageData(0,0,this.width,this.height),this._integralRefresh=this._histogramRefresh=!0):(a=new Image,a.onload=function(){d.width=a.width;d.height=a.height;d._tmpCanvas.width=d.canvasElement.width=d.width;d._tmpCanvas.height=d.canvasElement.height=d.height;h=d.context=d.canvasElement.getContext("2d");h.drawImage(a,0,0);d.imageData=d.context.getImageData(0,0,d.width,d.height);d._histogramRefresh=!0;d._integralRefresh=
!0;typeof b!="undefined"&&b.call(d)},a.src=c);a.crossOrigin="";return this},getPixel:function(c,b){var d=~~(b*this.width+c+0.5),a=this.imageData.data;return{r:a[d],g:a[d+1],b:a[d+2],a:a[d+3]}},setPixel:function(c,d,a,f,h,u){this.context.putImageData(new b([a&255,f&255,h&255,u&255]),c,d);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getData:function(){return new b(this.imageData.data)},setData:function(c){d?this._setData(c):
this.imageData.data.set(c);this.context.putImageData(this.imageData,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},getPixelData:function(){return this.imageData},setPixelData:function(c){this.context.putImageData(c,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},createImageData:function(c,b){this._tmpCanvas.width=this.canvasElement.width=
this.width=c;this._tmpCanvas.height=this.canvasElement.height=this.height=b;this.context=this.canvasElement.getContext("2d");this.context.createImageData(c,b);return this.imageData=this.context.getImageData(0,0,this.width,this.height)},copy:function(b){this.setData(b.getData());this.imageData=this.context.getImageData(0,0,this.width,this.height);return this},clone:function(){return new a.Image(this.canvasElement)},scale:function(b,d){b=b||1;d=d||b;if(1==b&&1==d)return this;var a=this._tmpCanvas.getContext("2d");
a.scale(b,d);a.drawImage(this.canvasElement,0,0);this.canvasElement.width=this.width=~~(b*this.width+0.5);this.canvasElement.height=this.height=~~(d*this.height+0.5);this.context.drawImage(this._tmpCanvas,0,0);this._tmpCanvas.width=this.width;this._tmpCanvas.height=this.height;this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipHorizontal:function(){var b=this._tmpCanvas.getContext("2d");b.translate(this.width,0);b.scale(-1,
1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},flipVertical:function(){var b=this._tmpCanvas.getContext("2d");b.translate(0,this.height);b.scale(1,-1);b.drawImage(this.canvasElement,0,0);this.context.drawImage(this._tmpCanvas,0,0);this.imageData=this.context.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=
!0;return this},clear:function(){if(this.width&&this.height){var b=this.context;b.clearRect(0,0,this.width,this.height);this.imageData=b.getImageData(0,0,this.width,this.height)}return this},fill:function(b,d,a,f,h){if(!f&&this.width&&!h&&this.height)return this;else if(f&&!this.width&&h&&!this.height)this._tmpCanvas.width=this.canvasElement.width=this.width=f+d,this._tmpCanvas.height=this.canvasElement.height=this.height=h+a,this.context=this.canvasElement.getContext("2d"),this.context.createImageData(f,
h),this.imageData=this.context.getImageData(0,0,this.width,this.height);var f=f||this.width,h=h||this.height,u=this.context;u.fillStyle=b||0;u.fillRect(d||0,a||0,f,h);this.imageData=u.getImageData(0,0,this.width,this.height);this._integralRefresh=this._histogramRefresh=!0;return this},draw:function(){return this},blend:function(b,d,a,f,h){typeof d=="undefined"&&(d="normal");typeof a=="undefined"&&(a=1);a>1?a=1:a<0&&(a=0);typeof f=="undefined"&&(f=0);typeof h=="undefined"&&(h=0);var u=0,B=0,m=this.context;
f<0&&(u=-f,f=0);h<0&&(B=-h,h=0);if(f>=this.width||h>=this.height)return this;d=n[d];if(d==void 0||d==null)return this;var q=l(this.width,b.width-u),o=l(this.height,b.height-B),k=this.context.getImageData(f,h,q,o),u=b.context.getImageData(u,B,q,o),b=k.data,u=u.data,z,r,v,w=1-a,E=u.length,F;for(F=0;F<E;F+=4)z=b[F],r=b[F+1],v=b[F+2],B=d(u[F],z),q=d(u[F+1],r),o=d(u[F+2],v),b[F]=B*a+z*w,b[F+1]=q*a+r*w,b[F+2]=o*a+v*w;m.putImageData(k,f,h);this.imageData=m.getImageData(0,0,this.width,this.height);this._integralRefresh=
this._histogramRefresh=!0;return this},integral:function(){this._integralRefresh&&this._computeIntegral();return this._integral},histogram:function(){this._histogramRefresh&&this._computeHistogram();return this._histogram},_setData:function(b){for(var d=this.imageData.data,a=b.length,f=0;f<a;)d[f]=b[f],f++},_computeIntegral:function(){var b=this.width,d=b*this.height,g=b<<2,f=new a.Array32F(d),h=new a.Array32F(d),d=new a.Array32F(d),u=this.getPixelData().data,B,m,q,o,k,l;for(o=k=l=q=m=B=0;q<b;)o+=
u[B],k+=u[B+1],l+=u[B+2],f[m]=o,h[m]=k,d[m]=l,B+=4,m++,q++;B=g;for(o=k=l=q=0;B<imLen;)o+=u[B],k+=u[B+1],l+=u[B+2],f[m]=f[m-b]+o,h[m]=h[m-b]+k,d[m]=d[m-b]+l,B+=4,m++,q++,q>=b&&(o=k=l=q=0);this._integral=[f,h,d];this._integralRefresh=!1},_computeHistogram:function(){for(var b=this.getPixelData().data,d=0,g=b.length,f,h,u,B=0,m=0,q=0,l=255,k=255,z=255,r=new a.Array32F(256),v=new a.Array32F(256),w=new a.Array32F(256),E=1/(g>>2),d=0;d<256;)r[d]=0,v[d]=0,w[d]=0,d++;for(d=0;d<g;)f=b[d],h=b[d+1],u=b[d+2],
r[f]+=E,v[h]+=E,w[u]+=E,f>B&&(B=f),f<l&&(l=f),h>m&&(m=h),h<k&&(k=h),u>q&&(q=u),u<z&&(z=u),d+=4;this._histogram=[r,v,w];this._histogramRefresh=!1},_refresh:function(){this.context=this.canvasElement.getContext("2d");this.imageData=this.context.getImageData(0,0,this.width,this.height);return this}}})(FILTER);
(function(a){a.CustomFilter=function(a){this._handler=a};a.CustomFilter.prototype={_handler:null,_apply:function(a,n,l,b){if(!this._handler)return a;return this._handler.call(this,a,n,l,b)},apply:function(a){if(!this._handler)return a;return a.setData(this._handler.call(this,a.getData(),a.width,a.height,a))}}})(FILTER);
(function(a){var x=a.Array32F,n=a.CONSTANTS.toRad,l=a._notSupportTypedArrays;a.ColorMatrixFilter=function(b){this._matrix=typeof b!="undefined"&&b.length?new x(b):null};a.ColorMatrixFilter.prototype={_matrix:null,channel:function(b,d){var c=(typeof d=="undefined"?0:d)?1:0;switch(b){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,255]);case a.CHANNEL.BLUE:return this.concat([0,0,c,0,0,0,0,c,0,0,0,0,1,0,0,0,0,0,0,255]);case a.CHANNEL.GREEN:return this.concat([0,c,0,0,
0,0,1,0,0,0,0,c,0,0,0,0,0,0,0,255]);default:return this.concat([1,0,0,0,0,c,0,0,0,0,c,0,0,0,0,0,0,0,0,255])}},redChannel:function(b){return this.channel(a.CHANNEL.RED,b)},greenChannel:function(b){return this.channel(a.CHANNEL.GREEN,b)},blueChannel:function(b){return this.channel(a.CHANNEL.BLUE,b)},alphaChannel:function(){return this.channel(a.CHANNEL.ALPHA,!0)},maskChannel:function(b){switch(b){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this.concat([0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])}},swapChannels:function(b,d){switch(b){case a.CHANNEL.ALPHA:switch(d){case a.CHANNEL.ALPHA:return this;case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);default:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0])}case a.CHANNEL.BLUE:switch(d){case a.CHANNEL.ALPHA:return this.concat([1,
0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0]);case a.CHANNEL.BLUE:return this;case a.CHANNEL.GREEN:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);default:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0])}case a.CHANNEL.GREEN:switch(d){case a.CHANNEL.ALPHA:return this.concat([1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]);case a.CHANNEL.BLUE:return this.concat([1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this;default:return this.concat([0,1,0,0,0,1,0,0,0,0,
0,0,1,0,0,0,0,0,1,0])}default:switch(d){case a.CHANNEL.ALPHA:return this.concat([0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0,0]);case a.CHANNEL.BLUE:return this.concat([0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]);case a.CHANNEL.GREEN:return this.concat([0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0]);default:return this}}},desaturate:function(){return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,0,0,0,0,1,0])},grayscale:function(){return this.desaturate()},
colorize:function(b,d){var c,e,g,f;typeof d=="undefined"&&(d=1);c=(b>>16&255)*0.00392156862745098;e=(b>>8&255)*0.00392156862745098;g=(b&255)*0.00392156862745098;f=1-d;return this.concat([f+d*c*a.LUMA[0],d*c*a.LUMA[1],d*c*a.LUMA[2],0,0,d*e*a.LUMA[0],f+d*e*a.LUMA[1],d*e*a.LUMA[2],0,0,d*g*a.LUMA[0],d*g*a.LUMA[1],f+d*g*a.LUMA[2],0,0,0,0,0,1,0])},invert:function(){return this.concat([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0])},invertAlpha:function(){return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,
1,0,0,0,0,0,-1,255])},saturate:function(b){var d,c,e;d=1-b;c=d*a.LUMA[0];e=d*a.LUMA[1];d*=a.LUMA[2];return this.concat([c+b,e,d,0,0,c,e+b,d,0,0,c,e,d+b,0,0,0,0,0,1,0])},contrast:function(b,d,a){typeof d=="undefined"&&(d=b);typeof a=="undefined"&&(a=b);b+=1;d+=1;a+=1;this._log=!0;return this.concat([b,0,0,0,128*(1-b),0,d,0,0,128*(1-d),0,0,a,0,128*(1-a),0,0,0,1,0])},brightness:function(b,d,a){typeof d=="undefined"&&(d=b);typeof a=="undefined"&&(a=b);return this.concat([1,0,0,0,b,0,1,0,0,d,0,0,1,0,a,
0,0,0,1,0])},adjustHue:function(b){b*=n;var d=Math.cos(b),b=Math.sin(b);return this.concat([a.LUMA[0]+d*(1-a.LUMA[0])+b*-a.LUMA[0],a.LUMA[1]+d*-a.LUMA[1]+b*-a.LUMA[1],a.LUMA[2]+d*-a.LUMA[2]+b*(1-a.LUMA[2]),0,0,a.LUMA[0]+d*-a.LUMA[0]+b*0.143,a.LUMA[1]+d*(1-a.LUMA[1])+b*0.14,a.LUMA[2]+d*-a.LUMA[2]+b*-0.283,0,0,a.LUMA[0]+d*-a.LUMA[0]+b*-(1-a.LUMA[0]),a.LUMA[1]+d*-a.LUMA[1]+b*a.LUMA[1],a.LUMA[2]+d*(1-a.LUMA[2])+b*a.LUMA[2],0,0,0,0,0,1,0])},average:function(b,d,a){typeof b=="undefined"&&(b=0.3333);typeof d==
"undefined"&&(d=0.3333);typeof a=="undefined"&&(a=0.3334);return this.concat([b,d,a,0,0,b,d,a,0,0,b,d,a,0,0,0,0,0,1,0])},quickContrastCorrection:function(b){typeof b=="undefined"&&(b=1.2);return this.concat([b,0,0,0,0,0,b,0,0,0,0,0,b,0,0,0,0,0,1,0])},quickSepia:function(b){typeof b=="undefined"&&(b=10);b>100&&(b=100);b*=2.55;return this.concat([a.LUMA[0],a.LUMA[1],a.LUMA[2],0,40,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,20,a.LUMA[0],a.LUMA[1],a.LUMA[2],0,-b,0,0,0,1,0])},quickSepia2:function(b,d,a){typeof b==
"undefined"&&(b=1);typeof d=="undefined"&&(d=b);typeof a=="undefined"&&(a=b);return this.concat([b*0.5,0.5,0.5,0,0,0.33,d*0.33,0.33,0,0,0.25,0.25,a*0.25,0,0,0,0,0,1,0])},threshold:function(b,d){typeof d=="undefined"&&(d=256);return this.concat([a.LUMA[0]*d,a.LUMA[1]*d,a.LUMA[2]*d,0,-(d-1)*b,a.LUMA[0]*d,a.LUMA[1]*d,a.LUMA[2]*d,0,-(d-1)*b,a.LUMA[0]*d,a.LUMA[1]*d,a.LUMA[2]*d,0,-(d-1)*b,0,0,0,1,0])},threshold_rgb:function(b,d){typeof d=="undefined"&&(d=256);return this.concat([d,0,0,0,-(d-1)*b,0,d,0,
0,-(d-1)*b,0,0,d,0,-(d-1)*b,0,0,0,1,0])},threshold_alpha:function(b,d){typeof b=="undefined"&&(b=0.5);typeof d=="undefined"&&(d=256);return this.concat([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,d,-d*b])},RGB2YCbCr:function(){return this.concat([0.5,-0.418688,-0.081312,0,128,0.299,0.587,0.114,0,0,-0.168736,-0.331264,0.5,0,128,0,0,0,1,0])},YCbCr2RGB:function(){return this.concat([1.402,1,0,0,-179.456,-0.71414,1,-0.34414,0,135.45984,0,1,1.772,0,-226.816,0,0,0,1,0])},blend:function(b,d){var a;if(this._matrix){a=
this._matrix;var e=b.getMatrix(),g=1-d,f=new x(20);f[0]=g*a[0]+d*e[0];f[1]=g*a[1]+d*e[1];f[2]=g*a[2]+d*e[2];f[3]=g*a[3]+d*e[3];f[4]=g*a[4]+d*e[4];f[5]=g*a[5]+d*e[5];f[6]=g*a[6]+d*e[6];f[7]=g*a[7]+d*e[7];f[8]=g*a[8]+d*e[8];f[9]=g*a[9]+d*e[9];f[10]=g*a[10]+d*e[10];f[11]=g*a[11]+d*e[11];f[12]=g*a[12]+d*e[12];f[13]=g*a[13]+d*e[13];f[14]=g*a[14]+d*e[14];f[15]=g*a[15]+d*e[15];f[16]=g*a[16]+d*e[16];f[17]=g*a[17]+d*e[17];f[18]=g*a[18]+d*e[18];f[19]=g*a[19]+d*e[19];a=f}else a=new x(b.getMatrix());this._matrix=
a;return this},concat:function(b){var a;if(this._matrix){a=this._matrix;var b=new x(b),c=new x(20),e,g,f,h,u;e=b[0];g=b[1];f=b[2];h=b[3];u=b[4];c[0]=e*a[0]+g*a[5]+f*a[10]+h*a[15];c[1]=e*a[1]+g*a[6]+f*a[11]+h*a[16];c[2]=e*a[2]+g*a[7]+f*a[12]+h*a[17];c[3]=e*a[3]+g*a[8]+f*a[13]+h*a[18];c[4]=e*a[4]+g*a[9]+f*a[14]+h*a[19]+u;e=b[5];g=b[6];f=b[7];h=b[8];u=b[9];c[5]=e*a[0]+g*a[5]+f*a[10]+h*a[15];c[6]=e*a[1]+g*a[6]+f*a[11]+h*a[16];c[7]=e*a[2]+g*a[7]+f*a[12]+h*a[17];c[8]=e*a[3]+g*a[8]+f*a[13]+h*a[18];c[9]=
e*a[4]+g*a[9]+f*a[14]+h*a[19]+u;e=b[10];g=b[11];f=b[12];h=b[13];u=b[14];c[10]=e*a[0]+g*a[5]+f*a[10]+h*a[15];c[11]=e*a[1]+g*a[6]+f*a[11]+h*a[16];c[12]=e*a[2]+g*a[7]+f*a[12]+h*a[17];c[13]=e*a[3]+g*a[8]+f*a[13]+h*a[18];c[14]=e*a[4]+g*a[9]+f*a[14]+h*a[19]+u;e=b[15];g=b[16];f=b[17];h=b[18];u=b[19];c[15]=e*a[0]+g*a[5]+f*a[10]+h*a[15];c[16]=e*a[1]+g*a[6]+f*a[11]+h*a[16];c[17]=e*a[2]+g*a[7]+f*a[12]+h*a[17];c[18]=e*a[3]+g*a[8]+f*a[13]+h*a[18];c[19]=e*a[4]+g*a[9]+f*a[14]+h*a[19]+u;a=c}else a=new x(b);this._matrix=
a;return this},combineWith:function(a){return this.concat(a.getMatrix())},getMatrix:function(){return this._matrix},setMatrix:function(a){this._matrix=a;return this},_apply:function(a){if(!this._matrix)return a;for(var d=a.length,c=this._matrix,e=0,g,f,h,u,B,m,q;e<d;)g=a[e],f=a[e+1],h=a[e+2],u=a[e+3],B=c[0]*g+c[1]*f+c[2]*h+c[3]*u+c[4],m=c[5]*g+c[6]*f+c[7]*h+c[8]*u+c[9],q=c[10]*g+c[11]*f+c[12]*h+c[13]*u+c[14],g=c[15]*g+c[16]*f+c[17]*h+c[18]*u+c[19],l&&(B<0?B=0:B>255&&(B=255),m<0?m=0:m>255&&(m=255),
q<0?q=0:q>255&&(q=255),g<0?g=0:g>255&&(g=255)),a[e]=~~B,a[e+1]=~~m,a[e+2]=~~q,a[e+3]=~~g,e+=4;return a},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._matrix=null;return this}}})(FILTER);
(function(a){function x(a){var c=new b(256),d=0;if(a)for(;d<256;)c[d]=255-d,d++;else for(;d<256;)c[d]=d,d++;return c}function n(a){for(var c=new b(256),d=0;d<256;)c[d]=a,d++;return c}function l(a){if(a)return new b(a);return null}var b=a.ImArray,d=Math.pow,c=Math.exp,e=1/255,g=x(),f=x(1);a.TableLookupFilter=function(a,b,c,d){this._tableR=a||null;this._tableG=b||this._tableR;this._tableB=c||this._tableG;this._tableA=d||null};a.TableLookupFilter.prototype={_tableR:null,_tableG:null,_tableB:null,_tableA:null,
thresholds:function(a,c,d){a.length||(a=[a]);c||(c=a);d||(d=c);var f=a.length,e=f+1,g=c.length,k=g+1,l=d.length,r=l+1,v=new b(256),w=new b(e),E=new b(256),F=new b(k),Q=new b(256),$=new b(r),j,T=255/(e-1),U=255/(k-1),L=255/(r-1);for(j=0;j<e;)w[j]=~~(T*j),j++;a[0]=~~(255*a[0]);for(j=1;j<f;)a[j]=a[j-1]+~~(255*a[j]),j++;for(j=0;j<k;)F[j]=~~(U*j),j++;c[0]=~~(255*c[0]);for(j=1;j<g;)c[j]=c[j-1]+~~(255*c[j]),j++;for(j=0;j<r;)$[j]=~~(L*j),j++;d[0]=~~(255*d[0]);for(j=1;j<l;)d[j]=d[j-1]+~~(255*d[j]),j++;for(j=
0;j<256;){for(e=0;e<f&&j>a[e];)e++;v[j]=w[e];for(e=0;e<g&&j>c[e];)e++;E[j]=F[e];for(e=0;e<l&&j>d[e];)e++;Q[j]=$[e];j++}return this.concat(v,E,Q)},threshold:function(a,b,c){a=a||0.5;b=b||a;return this.thresholds([a],[b],[c||b])},quantize:function(a){typeof a=="undefined"&&(a=64);a<2&&(a=2);var c=new b(256),d=new b(a),f,e=255/(a-1),g=a/256;for(f=0;f<a;)d[f]=~~(e*f),f++;for(f=0;f<256;)c[f]=d[~~(g*f)],f++;return this.concat(c)},levels:function(a){return this.quantize(a)},posterize:function(a){return this.quantize(a)},
binarize:function(){return this.quantize(2)},solarize:function(a){typeof a=="undefined"&&(a=0.5);for(var c=0,d=new b(256),a=~~(a*256)-1,c=0;c<256;)d[c]=c>a?255-(c<<1):(c<<1)-255,c++;return this.concat(d)},invert:function(){return this.concat(f)},mask:function(a){var c=0,d=a>>16&255,f=a>>8&255;a&=255;tR=new b(256);tG=new b(256);tB=new b(256);for(c=0;c<256;)tR[c]=c&d,tG[c]=c&f,tB[c]=c&a,c++;return this.concat(tR,tG,tB)},replace:function(a,b){if(a==b)return this;var c=a>>16&255,d=a>>8&255,f=a&255,e=
b>>16&255,k=b>>8&255,z=b&255,r=l(g),v=l(g),w=l(g);r[c]=e;v[d]=k;w[f]=z;return this.concat(r,v,w)},extract:function(b,c,d){if(!c||!c.length)return this;var d=d||0,f=d>>8&255,e=d&255,d=n(d>>16&255),f=n(f),e=n(e);switch(b){case a.CHANNEL.BLUE:b=c[0];for(c=c[1];b<=c;)e[b]=b,b++;break;case a.CHANNEL.GREEN:b=c[0];for(c=c[1];b<=c;)f[b]=b,b++;break;default:b=c[0];for(c=c[1];b<=c;)d[b]=b,b++}return this.concat(d,f,e)},gammaCorrection:function(a,c,f){for(var a=a||1,c=c||a,f=f||c,a=1/a,c=1/c,f=1/f,g=new b(256),
q=new b(256),l=new b(256),k=0;k<256;)g[k]=~~(255*d(e*k,a)),q[k]=~~(255*d(e*k,c)),l[k]=~~(255*d(e*k,f)),k++;return this.concat(g,q,l)},exposure:function(a){typeof a=="undefined"&&(a=1);for(var d=0,f=new b(256),d=0;d<256;)f[d]=~~(255*(1-c(-a*d*e))),d++;return this.concat(f)},concat:function(a,b,c){if(!a)return this;var b=b||a,c=c||b,d=this._tableR||x(),f,e,g=l(d),z,r,v;if(b&&c){f=this._tableG||l(d);e=this._tableB||l(f);z=l(f);r=l(e);for(v=0;v<256;)d[v]=a[g[v]],f[v]=b[z[v]],e[v]=c[r[v]],v++;this._tableR=
d;this._tableG=f;this._tableB=e}else{for(v=0;v<256;)d[v]=a[g[v]],v++;this._tableB=this._tableG=this._tableR=d}return this},combineWith:function(a){return this.concat(a.getTable(0),a.getTable(1),a.getTable(2))},getTable:function(b){b=b||a.CHANNEL.RED;switch(b){case a.CHANNEL.ALPHA:return this._tableA;case a.CHANNEL.BLUE:return this._tableB;case a.CHANNEL.GREEN:return this._tableG;default:return this._tableR}},setTable:function(b,c){c=c||a.CHANNEL.RED;switch(c){case a.CHANNEL.ALPHA:return this._tableA=
b,this;case a.CHANNEL.BLUE:return this._tableB=b,this;case a.CHANNEL.GREEN:return this._tableG=b,this;default:return this._tableR=b,this}},_apply:function(a){if(!this._tableR)return a;var b=a.length,c=0,d,f,e,g,l=this._tableR,r=this._tableG,v=this._tableB,w=this._tableA;if(w)for(;c<b;)d=a[c],f=a[c+1],e=a[c+2],g=a[c+3],a[c]=l[d],a[c+1]=r[f],a[c+2]=v[e],a[c+3]=w[g],c+=4;else for(;c<b;)d=a[c],f=a[c+1],e=a[c+2],a[c]=l[d],a[c+1]=r[f],a[c+2]=v[e],c+=4;return a},apply:function(a){if(!this._tableR)return a;
return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._tableA=this._tableB=this._tableG=this._tableR=null;return this}}})(FILTER);
(function(a){var x=a.ImArray,n=Math.min;a.DisplacementMapFilter=function(a){a&&this.setMap(a)};a.DisplacementMapFilter.prototype={scaleX:1,scaleY:1,startX:0,startY:0,componentX:0,componentY:0,color:0,mode:a.MODE.CLAMP,_map:null,combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},_apply:function(l,b,d){if(!this._map)return l;var c=this._map.getData(),e=this._map.width,g=this._map.height,f=e*g,h=new a.Array16I(f<<1),u=n(e,b),B=n(g,d),m=
this.scaleX*0.00390625,q=this.scaleY*0.00390625,o=this.componentX,k=this.componentY,g=this.color>>24&255,z=this.color>>16&255,r=this.color>>8&255,v=this.color&255,w=~~this.startY,E=~~this.startX,F=this.mode,Q=w*b,$=-E,j=-w,T=b-E-1,U=d-w-1,L,N,R,V,D,G=u*B<<2,A=new x(l),s=a.MODE.IGNORE,p=a.MODE.COLOR,W=a.MODE.WRAP;for(V=R=N=L=B=0;B<f;)D=N+V<<2,h[L]=~~((c[D+o]-128)*m),h[L+1]=~~((c[D+k]-128)*q),B++,L+=2,N++,N>=e&&(N=0,R++,V+=e);B=-4;N=-1;for(ty2=V=R=0;B<G;)if(B+=4,N++,N>=u&&(N=0,R++,V+=b,ty2+=e),!(R<
j||R>U||N<$||N>T)){m=N+E;f=R+w;c=m+V+Q<<2;L=N+ty2<<1;srcx=m+h[L];srcy=f+h[L+1];if(srcy>=d||srcy<0||srcx>=b||srcx<0)switch(F){case s:continue;case p:A[c]=z;A[c+1]=r;A[c+2]=v;A[c+3]=g;continue;case W:srcy>U&&(srcy-=d);srcy<0&&(srcy+=d);srcx>T&&(srcx-=b);srcx<0&&(srcx+=b);break;default:srcy>U&&(srcy=U),srcy<0&&(srcy=0),srcx>T&&(srcx=T),srcx<0&&(srcx=0)}L=srcx+srcy*b<<2;A[c]=l[L];A[c+1]=l[L+1];A[c+2]=l[L+2];A[c+3]=l[L+3]}return A},apply:function(a){if(!this._map)return a;return a.setData(this._apply(a.getData(),
a.width,a.height,a))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function x(a,b){var c,d,f,e,j,g=a.length,h=new B(g);for(f=d=c=e=0;e<g;)j=b-1-c+f<<2,h[e]=a[j],h[e+1]=a[j+1],h[e+2]=a[j+2],h[e+3]=a[j+3],e+=4,c++,c>=b&&(c=0,d++,f+=b);return h}function n(a,b,c){var d,f,e,j,g=a.length,h=new B(g);f=d=e=0;for(c=(c-1)*b;e<g;)j=d+c<<2,h[e]=a[j],h[e+1]=a[j+1],h[e+2]=a[j+2],h[e+3]=a[j+3],e+=4,d++,d>=b&&(d=0,f++,c-=b);return h}function l(a,b,c){var d,f,e,j,g,h=a.length,k=new B(h);f=d=j=0;for(c=(c-1)*b;j<h;)g=b-1-d+c<<2,k[j]=a[g],k[j+1]=a[g+1],k[j+2]=a[g+2],k[j+
3]=a[g+3],j+=4,d++,d>=b&&(d=0,f++,e+=b,c-=b);return k}function b(a,b,c){var d,f,e,j,g=a.length,h=new B(g),k=c*b;d=c=e=0;for(f=k-1;e<g;)j=d+f<<2,h[e]=a[j],h[e+1]=a[j+1],h[e+2]=a[j+2],h[e+3]=a[j+3],e+=4,c++,f-=b,c>=b&&(c=0,f=k-1,d++);return h}function d(a,b){var c,d,f,e,j,g=a.length,h=new B(g);for(f=d=c=e=0;e<g;)j=b-1-d+f<<2,h[e]=a[j],h[e+1]=a[j+1],h[e+2]=a[j+2],h[e+3]=a[j+3],e+=4,c++,f+=b,c>=b&&(f=c=0,d++);return h}function c(b,c,d){var f,e,g,j,h=b.length,k=new B(h),l=this.inverseTransform,q=this.mode,
u=a.MODE.WRAP,m;for(e=f=g=0;g<h;){m=l([f,e],c,d);j=~~m[0];m=~~m[1];if(0>j||j>=c||0>m||m>=d)switch(q){case u:m>=d&&(m-=d);m<0&&(m+=d);j>=c&&(j-=c);j<0&&(j+=c);break;default:m>=d&&(m=d-1),m<0&&(m=0),j>=c&&(j=c-1),j<0&&(j=0)}j=j+m*c<<2;k[g]=b[j];k[g+1]=b[j+1];k[g+2]=b[j+2];k[g+3]=b[j+3];g+=4;f++;f>=c&&(f=0,e++)}return k}function e(b,c,d){var f,e,g,j,h=c*d,k=b.length,m=new B(k),l=this.a,q=this.b,u=this.c,D=this.d,r=this.mode,A=a.MODE.WRAP,s,p=c-1,z=h-c;e=f=d=g=0;for(D*=c;g<k;){j=~~(l*d+u);s=~~(q*e+D);
if(0>j||j>p||0>s||s>z)switch(r){case A:s>z&&(s-=h);s<0&&(s+=h);j>=c&&(j-=c);j<0&&(j+=c);break;default:s>z&&(s=z),s<0&&(s=0),j>p&&(j=p),j<0&&(j=0)}j=j+s<<2;m[g]=b[j];m[g+1]=b[j+1];m[g+2]=b[j+2];m[g+3]=b[j+3];g+=4;d++;d>=c&&(d=0,f++,e+=c)}return m}function g(b,c,d){if(0>=this.radius)return b;var f,e,g,j,h=b.length,l=new B(b),u=this.centerX,r=this.centerY,z=this.radius,n=this.mode,D=a.MODE.WRAP,G,A,s=this.angle/z,p=c-1,W=d-1;for(e=f=g=0;g<h;){G=f-u;A=e-r;j=m(G*G+A*A);if(j<z){A=q(A,G)+s*(z-j);G=~~(u+
j*k(A));A=~~(r+j*o(A));if(0>G||G>p||0>A||A>W)switch(n){case D:A>W&&(A-=d);A<0&&(A+=d);G>p&&(G-=c);G<0&&(G+=c);break;default:A>W&&(A=W),A<0&&(A=0),G>p&&(G=p),G<0&&(G=0)}j=G+A*c<<2;l[g]=b[j];l[g+1]=b[j+1];l[g+2]=b[j+2];l[g+3]=b[j+3]}g+=4;f++;f>=c&&(f=0,e++)}return l}function f(b,c,d){if(0>=this.radius)return b;var f,e,g,j,h=b.length,k=new B(b),l=this.centerX,u=this.centerY;f=this.radius;var q=this.mode,o=a.MODE.WRAP,D,G=f*f,A=1-0.555556,s,p,n,ba,aa=c-1,t=d-1;for(e=f=g=0;g<h;){j=f-l;D=e-u;n=j*j;ba=D*
D;s=n+ba;if(s<G){p=G-s;s=m(p);j=z(j/m(n+p))*A;D=z(D/m(ba+p))*A;j=~~(f-s*r(j));D=~~(e-s*r(D));if(0>j||j>aa||0>D||D>t)switch(q){case o:D>t&&(D-=d);D<0&&(D+=d);j>aa&&(j-=c);j<0&&(j+=c);break;default:D>t&&(D=t),D<0&&(D=0),j>aa&&(j=aa),j<0&&(j=0)}j=j+D*c<<2;k[g]=b[j];k[g+1]=b[j+1];k[g+2]=b[j+2];k[g+3]=b[j+3]}g+=4;f++;f>=c&&(f=0,e++)}return k}function h(a){return a}function u(a){return a}var B=a.ImArray,m=Math.sqrt,q=Math.atan2,o=Math.sin,k=Math.cos,z=Math.asin,r=Math.tan;a.GeometricMapFilter=function(a){this.generic(a)};
a.GeometricMapFilter.prototype={_map:null,inverseTransform:null,a:1,b:1,c:0,d:0,centerX:0,centerY:0,angle:0,radius:0,mode:a.MODE.CLAMP,generic:function(a){if(a)this.inverseTransform=a,this._map=c;return this},affine:function(a,b,c,d){this.a=a;this.b=b;this.c=c;this.d=d;this._map=e;return this},flipX:function(){this._map=x;return this},flipY:function(){this._map=n;return this},flipXY:function(){this._map=l;return this},rotateCW:function(){this._map=b;return this},rotateCCW:function(){this._map=d;return this},
polar:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=h;return this},cartesian:function(a,b){this.centerX=a||0;this.centerY=b||0;this._map=u;return this},twirl:function(a,b,c,d){this.angle=a||0;this.radius=b||0;this.centerX=c||0;this.centerY=d||0;this._map=g;return this},sphere:function(a,b,c){this.radius=a||0;this.centerX=b||0;this.centerY=c||0;this._map=f;return this},combineWith:function(){return this},getMap:function(){return this._map},setMap:function(a){this._map=a;return this},
_apply:function(a,b,c,d){if(!this._map)return a;return this._map.call(this,a,b,c,d)},apply:function(a){if(!this._map)return a;return a.setData(this._map.call(this,a.getData(),a.width,a.height,a))},reset:function(){this._map=null;return this}}})(FILTER);
(function(a){function x(a,b,c,d){var f=a.length,e,g=new m(a.length),c=c||1,d=d||1;for(e=0;e<f;)g[e]=c*a[e]+d*b[e],e++;return g}function n(a,b){var c,d,f=a.length,e,g=[],h=0;for(c=0;c<f;c++)for(d=0;d<f;d++)e=a[c]*b[d],h+=e,g.push(e);return{kernel:g,sum:h}}function l(a){var b,c=Array(a);for(b=0;b<a;)c[b]=0,b++;c[a>>1]=1;return c}function b(a){var b,c=Array(a);for(b=0;b<a;)c[b]=1,b++;return c}function d(a){var b=o.length,c,d;a--;if(a<b)c=o[a].slice();else for(c=new m(o[b-1]);b<=a;){d=c.slice();c=[1];
i=0;for(il=d.length-1;i<il;i++)c.push(d[i]+d[i+1]);c.push(1);b<40&&o.push(c.slice());b++}return c}function c(a){var b,c=-(a>>1),d=Array(a);for(b=0;b<a;)d[b]=c,c++,b++;return d}function e(a){a=d(a);return n(a,a)}function g(a,b){var f=d(a),e=c(a);return 1==b?n(e.reverse(),f):n(f,e)}function f(a,d){var f=b(a),e=c(a);return 1==d?n(e.reverse(),f):n(f,e)}function h(a,b){var b=b||1,c=a*a,d,f=new m(c);for(d=0;d<c;)f[d]=b,d++;return f}function u(b,c,d,f,e,g,h,k,m,l){var u=b.length,v,r,A,s,p,z,w,n,t,o,x,P,
S,J,C,I,M,X,Y,K,ca,da,Z;v=c*d;p=g*h;g>>=1;h=c*(h>>1);d=-g-1;n=-h-c;X=c-1;Y=v-c;v=(v<<1)+v;w=(c<<1)+c;l=l||1;Z=0;if(e){x=f[0];f=f[p>>1];f-=x;P=e[0];e=e[p>>1];for(S=e-P;Z<l;){z=new B(b);e=new a.Array32F(v);for(r=A=s=o=t=p=0;o<c;)r+=b[p],A+=b[p+1],s+=b[p+2],e[t]=r,e[t+1]=A,e[t+2]=s,p+=4,t+=3,o++;p=w+c;t=w;for(r=A=s=o=0;p<u;)r+=b[p],A+=b[p+1],s+=b[p+2],e[t]=e[t-w]+r,e[t+1]=e[t-w+1]+A,e[t+2]=e[t-w+2]+s,p+=4,t+=3,o++,o>=c&&(r=A=s=o=0);for(A=r=o=p=0;p<u;)J=o+d,C=A+n,I=o+g,M=A+h,J<0?J=0:I>X&&(I=X),C<0?C=
0:M>Y&&(M=Y),s=J+C,t=I+M,C=I+C,K=J+M,s=(s<<1)+s,C=(C<<1)+C,K=(K<<1)+K,t=(t<<1)+t,I=x*(e[t]-e[C]-e[K]+e[s])+f*b[p],M=x*(e[t+1]-e[C+1]-e[K+1]+e[s+1])+f*b[p+1],J=x*(e[t+2]-e[C+2]-e[K+2]+e[s+2])+f*b[p+2],ca=P*(e[t]-e[C]-e[K]+e[s])+S*b[p],da=P*(e[t+1]-e[C+1]-e[K+1]+e[s+1])+S*b[p+1],t=P*(e[t+2]-e[C+2]-e[K+2]+e[s+2])+S*b[p+2],s=k*I+m*ca,C=k*M+m*da,t=k*J+m*t,q&&(s<0?s=0:s>255&&(s=255),C<0?C=0:C>255&&(C=255),t<0?t=0:t>255&&(t=255)),z[p]=~~s,z[p+1]=~~C,z[p+2]=~~t,p+=4,o++,o>=c&&(o=0,r++,A+=c);b=z;Z++}}else{x=
f[0];f=f[p>>1];f-=x;k=k||1;for(m=m||0;Z<l;){z=new B(b);e=new a.Array32F(v);for(r=A=s=o=t=p=0;o<c;)r+=b[p],A+=b[p+1],s+=b[p+2],e[t]=r,e[t+1]=A,e[t+2]=s,p+=4,t+=3,o++;p=w+c;t=w;for(r=A=s=o=0;p<u;)r+=b[p],A+=b[p+1],s+=b[p+2],e[t]=e[t-w]+r,e[t+1]=e[t-w+1]+A,e[t+2]=e[t-w+2]+s,p+=4,t+=3,o++,o>=c&&(r=A=s=o=0);for(A=r=o=p=0;p<u;)J=o+d,C=A+n,I=o+g,M=A+h,J<0?J=0:I>X&&(I=X),C<0?C=0:M>Y&&(M=Y),s=J+C,t=I+M,C=I+C,K=J+M,s=(s<<1)+s,C=(C<<1)+C,K=(K<<1)+K,t=(t<<1)+t,I=x*(e[t]-e[C]-e[K]+e[s])+f*b[p],M=x*(e[t+1]-e[C+
1]-e[K+1]+e[s+1])+f*b[p+1],J=x*(e[t+2]-e[C+2]-e[K+2]+e[s+2])+f*b[p+2],s=k*I+m,C=k*M+m,t=k*J+m,q&&(s<0?s=0:s>255&&(s=255),C<0?C=0:C>255&&(C=255),t<0?t=0:t>255&&(t=255)),z[p]=~~s,z[p+1]=~~C,z[p+2]=~~t,p+=4,o++,o>=c&&(o=0,r++,A+=c);b=z;Z++}}return z}var B=a.ImArray,m=a.Array32F,q=a._notSupportTypedArrays,o=[[1],[1,1],[1,2,1],[1,3,3,1],[1,4,6,4,1],[1,5,10,10,5,1],[1,6,15,20,15,6,1],[1,7,21,35,35,21,7,1],[1,8,28,56,70,56,28,8,1]],k=a.CONSTANTS.toRad,z=Math.abs,r=Math.sqrt,v=Math.sin,w=Math.cos;a.ConvolutionMatrixFilter=
function(a,b,c){typeof a!="undefined"&&a.length?(this.set(a,~~(r(a.length)+0.5),b||1),this._bias=c||0):(this._matrix=null,this._dim=0);this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0};a.ConvolutionMatrixFilter.prototype={_dim:0,_matrix:null,_factor:1,_bias:0,lowPass:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;this.set(h(a),a,1/(a*a));this._doFast=1;return this},highPass:function(a,b){var a=typeof a=="undefined"?3:a%2?a:a+1,c=a*a,d=-(typeof b=="undefined"?1:b)/c,e=h(a,
d);e[c>>1]=1+d;this.set(e,a,1);this._doFast=1;return this},boxBlur:function(a){return this.lowPass(a)},verticalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,c,d=a;c=l(d);d=b(d);c=n(d,c);return this.set(c.kernel,a,1/c.sum)},horizontalBlur:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,c,d=a;c=l(d);d=b(d);c=n(c,d);return this.set(c.kernel,a,1/c.sum)},binomialLowPass:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=e(a);return this.set(b.kernel,a,1/b.sum)},binomialHighPass:function(a){var a=
typeof a=="undefined"?3:a%2?a:a+1,b=e(a);return this.set(x(h(a),new m(b.kernel),1,-1/b.sum),a,1)},gaussBlur:function(a){return this.binomialLowPass(a)},fastGauss:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a=~~(a||1);a<1?a=1:a>3&&(a=3);this.set(h(b),b,1/(b*b));this._doFast=a;return this},sharpen:function(a,b){a=typeof a=="undefined"?0.5:a;return a<=0?this.set([0,-2,0,-2,10,-2,0,-2,0],3,0.5):this.highPass(b,a)},prewittX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(f(a,0).kernel,
a,1)},prewittY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(f(a,1).kernel,a,1)},prewittDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=k;var c=w(a),d=v(a),e=f(b,0),g=f(b,1);return this.set(x(new m(e.kernel),new m(g.kernel),c,d),b,1)},prewitt:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=f(a,0),c=f(a,1);this.set(b.kernel,a,1);this._isGrad=!0;this._matrix2=new m(c.kernel);return this},gradX:function(a){return this.prewittX(a)},gradY:function(a){return this.prewittY(a)},
gradDirectional:function(a,b){return this.prewittDirectional(a,b)},grad:function(a){return this.prewitt(a)},sobelX:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(g(a,0).kernel,a,1)},sobelY:function(a){a=typeof a=="undefined"?3:a%2?a:a+1;return this.set(g(a,1).kernel,a,1)},sobelDirectional:function(a,b){b=typeof b=="undefined"?3:b%2?b:b+1;a*=k;var c=w(a),d=v(a),e=g(b,0),f=g(b,1);return this.set(x(new m(e.kernel),new m(f.kernel),c,d),b,1)},sobel:function(a){var a=typeof a=="undefined"?
3:a%2?a:a+1,b=g(a,0),c=g(a,1);this.set(b.kernel,a,1);this._matrix2=new m(c.kernel);this._isGrad=!0;return this},laplace:function(a){var a=typeof a=="undefined"?3:a%2?a:a+1,b=h(a,-1),c=a*a;b[c>>1]=c-1;this.set(b,a,1);this._doFast=1;return this},emboss:function(a,b,c){var c=typeof c=="undefined"?3:c%2?c:c+1,a=typeof a=="undefined"?-0.25*Math.PI:a*k,b=b||1,d=b*w(a),a=-b*v(a),b=c,e=b*b,f=b>>1,g,h=new m(e),l,u,q;l=q=-f*d;u=-f*a;for(g=f=0;f<e;)h[f]=l+u,f++,g++,l+=d,g>=b&&(g=0,l=q,u+=a);h[c*c>>1]=1;return this.set(h,
c,1)},edges:function(a){a=a||1;return this.set([0,a,0,a,-4*a,a,0,a,0],3,1)},set:function(a,b,c){this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;this._matrix=new m(a);this._dim=b;this._factor=c||1;return this},combineWith:function(){return this},getMatrix:function(){return this._matrix},setMatrix:function(a,b){this._matrix=a;this._dim=b;this._coeff1=this._coeff2=this._matrix2=null;this._isGrad=!1;this._doFast=0;return this},_apply:function(b,c,d){if(!this._matrix)return b;
if(this._doFast)return this._matrix2?u(b,c,d,this._matrix,this._matrix2,this._dim,this._dim,this._coeff1,this._coeff2,this._doFast):u(b,c,d,this._matrix,null,this._dim,this._dim,this._factor,this._bias,this._doFast);var e=this._dim,f=this._dim,g=e>>1,h=e*f,k=(f>>1)*c,f=this._matrix,m=this._factor,l=this._bias,r=this._matrix2,o,v=this._isGrad,A=new a.Array16I(h<<1),s=new a.Array8U(h),p=c*d,d=b.length,w=new B(d),n,x,t,O,H,P,S=c-1,J=p-c,C=this._coeff1,I=this._coeff2;for(O=t=p=x=n=0;x<h;)s[x]=p+t,A[n]=
p-g,A[n+1]=O-k,n+=2,x++,p++,p>=e&&(p=0,t+=e,O+=c);if(r)for(t=p=e=0;e<d;){for(x=n=m=l=P=g=k=O=0;x<h;)H=p+A[n],o=t+A[n+1],H>=0&&H<=S&&o>=0&&o<=J&&(H=H+o<<2,o=f[s[x]],O+=b[H]*o,k+=b[H+1]*o,g+=b[H+2]*o,o=r[s[x]],P+=b[H]*o,l+=b[H+1]*o,m+=b[H+2]*o),n+=2,x++;v?(n=z(O)+z(P),x=z(k)+z(l),g=z(g)+z(m)):(n=C*O+I*P,x=C*k+I*l,g=C*g+I*m);q&&(n<0?n=0:n>255&&(n=255),x<0?x=0:x>255&&(x=255),g<0?g=0:g>255&&(g=255));w[e]=~~n;w[e+1]=~~x;w[e+2]=~~g;w[e+3]=b[e+3];e+=4;p++;p>=c&&(p=0,t+=c)}else for(t=p=e=0;e<d;){for(x=n=g=
k=O=0;x<h;)H=p+A[n],o=t+A[n+1],H>=0&&H<=S&&o>=0&&o<=J&&(H=H+o<<2,o=f[s[x]],O+=b[H]*o,k+=b[H+1]*o,g+=b[H+2]*o),n+=2,x++;n=m*O+l;x=m*k+l;g=m*g+l;q&&(n<0?n=0:n>255&&(n=255),x<0?x=0:x>255&&(x=255),g<0?g=0:g>255&&(g=255));w[e]=~~n;w[e+1]=~~x;w[e+2]=~~g;w[e+3]=b[e+3];e+=4;p++;p>=c&&(p=0,t+=c)}return w},apply:function(a){if(!this._matrix)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},reset:function(){this._matrix2=this._matrix=null;this._dim=0;return this}}})(FILTER);
(function(a){var x=a.ImArray,n=function(b,d,g){var f=this._dim,h=f>>1,l=f*f,n=h*d,m=new a.Array32I(l<<1),q=d*g,g=b.length,o=new x(g),k,z,r=[],v=[],w=[];l<<=1;var E=d-1,F=q-d;for(z=q=k=0;k<l;)m[k]=q-h,m[k+1]=z-n,k+=2,q++,q>=f&&(q=0,z+=d);for(z=q=f=0;f<g;){r.length=0;v.length=0;for(k=w.length=0;k<l;)h=q+m[k],n=z+m[k+1],h>=0&&h<=E&&n>=0&&n<=F&&(h=h+n<<2,r.push(b[h]),v.push(b[h+1]),w.push(b[h+2])),k+=2;r.sort();v.sort();w.sort();k=(r.length>>1)+1;(h=r.length%2)?(o[f]=r[k],o[f+1]=v[k],o[f+2]=w[k]):(o[f]=
~~(0.5*(r[k-1]+r[k])),o[f+1]=~~(0.5*(v[k-1]+v[k])),o[f+2]=~~(0.5*(w[k-1]+w[k])));o[f+3]=b[f+3];f+=4;q++;q>=d&&(q=0,y++,z+=d)}return o},l=function(b,d,g){var f=this._dim,h=f>>1,l=f*f,n=h*d,m=new a.Array32I(l<<1),q=d*g,g=b.length,o=new x(g),k,z,r,v,w,E;l<<=1;var F=d-1,Q=q-d;for(z=k=q=0;q<l;)m[q]=k-h,m[q+1]=z-n,q+=2,k++,k>=f&&(k=0,z+=d);for(z=k=f=0;f<g;){for(q=E=n=h=0;q<l;)r=k+m[q],v=z+m[q+1],r>=0&&r<=F&&v>=0&&v<=Q&&(w=r+v<<2,r=b[w],v=b[w+1],w=b[w+2],r>h&&(h=r),v>n&&(n=v),w>E&&(E=w)),q+=2;o[f]=h;o[f+
1]=n;o[f+2]=E;o[f+3]=b[f+3];f+=4;k++;k>=d&&(k=0,z+=d)}return o},b=function(b,d,g){var f=this._dim,h=f>>1,l=f*f,n=h*d,m=new a.Array32I(l<<1),q=d*g,g=b.length,o=new x(g),k,z,r,v,w,E;l<<=1;var F=d-1,Q=q-d;for(z=k=q=0;q<l;)m[q]=k-h,m[q+1]=z-n,q+=2,k++,k>=f&&(k=0,z+=d);for(z=k=f=0;f<g;){E=n=h=255;for(q=0;q<l;)r=k+m[q],v=z+m[q+1],r>=0&&r<=F&&v>=0&&v<=Q&&(w=r+v<<2,r=b[w],v=b[w+1],w=b[w+2],r<h&&(h=r),v<n&&(n=v),w<E&&(E=w)),q+=2;o[f]=h;o[f+1]=n;o[f+2]=E;o[f+3]=b[f+3];f+=4;k++;k>=d&&(k=0,z+=d)}return o},d=
function(a){return a};a.StatisticalFilter=function(){this._dim=0;this._apply=d};a.StatisticalFilter.prototype={_dim:0,median:function(a){this._dim=typeof a=="undefined"?3:a%2?a:a+1;this._apply=n;return this},erode:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=b;return this},dilate:function(a){this._dim=typeof a=="undefined"?3:a;this._apply=l;return this},_apply:function(a){return a},apply:function(a){if(!this._dim)return a;return a.setData(this._apply(a.getData(),a.width,a.height,a))},
reset:function(){this._apply=d;this._dim=0;return this}}})(FILTER);
